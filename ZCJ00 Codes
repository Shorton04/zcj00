METHOD create_settlement_rules.

  DATA: ls_wbs         TYPE ztb_a2r_wbsitem,
        lv_parent_objnr TYPE j_objnr,
        lv_parent_posid TYPE ps_posid,
        lv_wbs_objnr   TYPE j_objnr,
        lt_cobrb       TYPE TABLE OF cobrb,
        ls_cobrb       TYPE cobrb,
        lt_return      TYPE TABLE OF bapiret2.

  rv_success = abap_false.

  " Build settlement rules table
  LOOP AT it_wbs_items INTO ls_wbs.

    " Skip Level 1 (top level has no parent to settle to)
    IF ls_wbs-stufe = 1.
      CONTINUE.
    ENDIF.

    " Skip if no budget (according to FDS)
    IF ls_wbs-wert2 IS INITIAL.
      CONTINUE.
    ENDIF.

    " Get WBS object number
    SELECT SINGLE objnr FROM prps
      INTO lv_wbs_objnr
      WHERE posid = ls_wbs-posid.

    IF sy-subrc <> 0.
      CONTINUE.
    ENDIF.

    " Get parent WBS from hierarchy (PRHI table)
    SELECT SINGLE p~objnr, p~posid
      FROM prhi AS h
      INNER JOIN prps AS p ON h~up = p~objnr
      INTO (lv_parent_objnr, lv_parent_posid)
      WHERE h~down = lv_wbs_objnr.

    IF sy-subrc = 0 AND lv_parent_objnr IS NOT INITIAL.

      " Prepare settlement rule entry (CJB2 structure)
      CLEAR ls_cobrb.
      ls_cobrb-mandt = sy-mandt.
      ls_cobrb-objnr = lv_wbs_objnr.        " Sender (WBS element)
      ls_cobrb-lfdnr = '001'.               " Settlement rule number
      ls_cobrb-abgsl = 'FUL'.               " Settlement type: FUL (Full)
      ls_cobrb-konty = 'PR'.                " Receiver type: PR (Project/WBS)
      ls_cobrb-empge = lv_parent_objnr.     " Receiver object number (parent WBS)
      ls_cobrb-prozs = '100.00'.            " Settlement percentage: 100%
      ls_cobrb-auskz = 'X'.                 " Active settlement rule
      ls_cobrb-vrgng = 'KOAO'.              " Transaction type
      
      APPEND ls_cobrb TO lt_cobrb.
    ENDIF.
  ENDLOOP.

  " Check if any rules to create
  IF lt_cobrb IS INITIAL.
    rv_success = abap_true.
    RETURN.
  ENDIF.

  " Use standard function to create settlement rules (CJB2 logic)
  CALL FUNCTION 'K_SETTLEMENT_RULE_MAINTAIN'
    TABLES
      t_cobrb      = lt_cobrb
      t_bapiret2   = lt_return
    EXCEPTIONS
      error_passed = 1
      OTHERS       = 2.

  IF sy-subrc = 0.
    " Check return messages for errors
    LOOP AT lt_return TRANSPORTING NO FIELDS WHERE type = 'E' OR type = 'A'.
      EXIT.
    ENDLOOP.

    IF sy-subrc = 0.
      " Errors found
      MESSAGE e024(zcj00). " Error creating settlement rules
      rv_success = abap_false.
      RETURN.
    ELSE.
      " Success - Activate SETC status for all WBS with settlement rules
      LOOP AT it_wbs_items INTO ls_wbs WHERE stufe > 1.
        
        " Skip if no budget
        IF ls_wbs-wert2 IS INITIAL.
          CONTINUE.
        ENDIF.

        SELECT SINGLE objnr FROM prps
          INTO lv_wbs_objnr
          WHERE posid = ls_wbs-posid.

        IF sy-subrc = 0.
          " Activate SETC (Settlement rule exists) status
          CALL FUNCTION 'STATUS_CHANGE_INTERN'
            EXPORTING
              client               = sy-mandt
              objnr                = lv_wbs_objnr
              user_stat            = 'SETC'
              set_inact            = ''
            EXCEPTIONS
              object_not_found     = 1
              status_inconsistent  = 2
              status_not_allowed   = 3
              OTHERS               = 4.
        ENDIF.
      ENDLOOP.

      COMMIT WORK AND WAIT.
      rv_success = abap_true.
    ENDIF.
  ELSE.
    MESSAGE e024(zcj00). " Error creating settlement rules
    rv_success = abap_false.
  ENDIF.

ENDMETHOD.

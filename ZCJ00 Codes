*&---------------------------------------------------------------------*
*& Class ZCL_A2R_WBS_BUILDER Definition
*&---------------------------------------------------------------------*
CLASS zcl_a2r_wbs_builder DEFINITION
  PUBLIC
  FINAL
  CREATE PUBLIC.

  PUBLIC SECTION.

    METHODS:
      copy_template_structure
        IMPORTING
          iv_pspid     TYPE ps_spdid
        CHANGING
          ct_wbs_items TYPE STANDARD TABLE,

      total_up_budget
        CHANGING
          ct_wbs_items TYPE STANDARD TABLE,

      save_request
        IMPORTING
          is_header        TYPE ztb_a2r_wbshdr
          it_wbs_items     TYPE STANDARD TABLE
        RETURNING
          VALUE(rv_reqnum) TYPE char10,

      submit_request
        IMPORTING
          is_header         TYPE ztb_a2r_wbshdr
          it_wbs_items      TYPE STANDARD TABLE
        RETURNING
          VALUE(rv_success) TYPE abap_bool,

      create_project
        IMPORTING
          is_header         TYPE ztb_a2r_wbshdr
          it_wbs_items      TYPE STANDARD TABLE
        RETURNING
          VALUE(rv_success) TYPE abap_bool.

  PRIVATE SECTION.

    METHODS:
      get_next_request_number
        RETURNING
          VALUE(rv_reqnum) TYPE char10,

      " NO ZAUTO_APPROVAL parameter - uses blank approver logic
      check_approver_matrix
        IMPORTING
          iv_bukrs              TYPE bukrs
          iv_profl              TYPE profidproj
          iv_reqtype            TYPE ztb_a2r_reqtype-z_reqtype
        EXPORTING
          ev_appr1              TYPE char8
          ev_appr2              TYPE char8
          ev_auto               TYPE char1        " 'X' if both approvers blank
          ev_error_handler      TYPE char8
        RETURNING
          VALUE(rv_found)       TYPE abap_bool,

      trigger_workflow
        IMPORTING
          is_header         TYPE ztb_a2r_wbshdr
          iv_appr1          TYPE char8
          iv_appr2          TYPE char8
        RETURNING
          VALUE(rv_success) TYPE abap_bool,

      create_wbs_elements
        IMPORTING
          is_header         TYPE ztb_a2r_wbshdr
          it_wbs_items      TYPE STANDARD TABLE
        EXPORTING
          et_wbs_created    TYPE STANDARD TABLE
        RETURNING
          VALUE(rv_success) TYPE abap_bool,

      assign_plan_values
        IMPORTING
          it_wbs_items      TYPE STANDARD TABLE
        RETURNING
          VALUE(rv_success) TYPE abap_bool,

      distribute_im_budget
        IMPORTING
          is_header         TYPE ztb_a2r_wbshdr
          it_wbs_items      TYPE STANDARD TABLE
        RETURNING
          VALUE(rv_success) TYPE abap_bool,

      create_settlement_rules
        IMPORTING
          it_wbs_items      TYPE STANDARD TABLE
        RETURNING
          VALUE(rv_success) TYPE abap_bool,

      activate_statuses
        IMPORTING
          it_wbs_items      TYPE STANDARD TABLE
        RETURNING
          VALUE(rv_success) TYPE abap_bool,

      get_next_project_number
        IMPORTING
          iv_profl          TYPE profidproj
        RETURNING
          VALUE(rv_pspid)   TYPE ps_pspid.

ENDCLASS.








METHOD submit_request.

  DATA: lv_reqnum        TYPE char10,
        lv_appr1         TYPE char8,
        lv_appr2         TYPE char8,
        lv_auto          TYPE char1,
        lv_error_handler TYPE char8,
        lv_found         TYPE abap_bool,
        ls_header        TYPE ztb_a2r_wbshdr.

  " Save the request
  lv_reqnum = save_request(
    is_header    = is_header
    it_wbs_items = it_wbs_items
  ).

  IF lv_reqnum IS INITIAL.
    rv_success = abap_false.
    RETURN.
  ENDIF.

  " FDS Step 1: Check approver matrix
  lv_found = check_approver_matrix(
    EXPORTING
      iv_bukrs   = is_header-bukrs
      iv_profl   = is_header-profl
      iv_reqtype = is_header-z_reqtype
    IMPORTING
      ev_appr1   = lv_appr1
      ev_appr2   = lv_appr2
      ev_auto    = lv_auto
      ev_error_handler = lv_error_handler
  ).

  IF lv_found = abap_false.
    " FDS Step 1: Error if combination not found
    MESSAGE e008(zcj00). " Approver matrix entry not found
    rv_success = abap_false.
    RETURN.
  ENDIF.

  " FDS Step 2: Update status to PENDING
  ls_header = is_header.
  ls_header-zreq_num = lv_reqnum.
  ls_header-request_status = 'PENDING'.

  UPDATE ztb_a2r_wbshdr
    SET request_status = 'PENDING'
    WHERE zreq_num = lv_reqnum.

  " FDS Step 4: Check if both approvers are blank (AUTO-APPROVAL)
  IF lv_auto = 'X'.
    " Both ZAPPROVAL_1 and ZAPPROVAL_2 are blank
    " → Skip workflow, proceed directly to Step 9 (Create Project)
    
    MESSAGE i035(zcj00) WITH lv_reqnum. " Auto-approval: No approvers configured
    
    rv_success = create_project(
      is_header    = ls_header
      it_wbs_items = it_wbs_items
    ).

    IF rv_success = abap_true.
      UPDATE ztb_a2r_wbshdr
        SET request_status = 'APPROVED'
        WHERE zreq_num = lv_reqnum.
      COMMIT WORK.
      MESSAGE s033(zcj00) WITH lv_reqnum. " Project created successfully
    ELSE.
      UPDATE ztb_a2r_wbshdr
        SET request_status = 'ERROR'
        WHERE zreq_num = lv_reqnum.
      COMMIT WORK.
      MESSAGE e034(zcj00) WITH lv_reqnum. " Error creating project
    ENDIF.
    
  ELSE.
    " FDS Step 4: At least one approver exists → Trigger workflow
    rv_success = trigger_workflow(
      is_header = ls_header
      iv_appr1  = lv_appr1
      iv_appr2  = lv_appr2
    ).

    IF rv_success = abap_true.
      COMMIT WORK.
      MESSAGE s015(zcj00) WITH lv_reqnum. " Request submitted for approval
    ELSE.
      ROLLBACK WORK.
      MESSAGE e016(zcj00) WITH lv_reqnum. " Error submitting request
    ENDIF.
  ENDIF.

ENDMETHOD.



METHOD check_approver_matrix.

  DATA: ls_config TYPE ztb_a2r_conftab2.

  SELECT SINGLE * FROM ztb_a2r_conftab2
    INTO ls_config
    WHERE bukrs = iv_bukrs
      AND profl = iv_profl
      AND z_reqtype = iv_reqtype.

  IF sy-subrc = 0.
    ev_appr1 = ls_config-zapproval_1.
    ev_appr2 = ls_config-zapproval_2.
    ev_error_handler = ls_config-zerror_handling.
    
    " AUTO-APPROVAL LOGIC (FDS Step 4):
    " If BOTH approvers are blank → Auto-approve (skip to Step 9)
    IF ls_config-zapproval_1 IS INITIAL AND 
       ls_config-zapproval_2 IS INITIAL.
      ev_auto = 'X'.
    ELSE.
      CLEAR ev_auto.
    ENDIF.
    
    rv_found = abap_true.
  ELSE.
    rv_found = abap_false.
  ENDIF.

ENDMETHOD.

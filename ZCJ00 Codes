METHOD assign_plan_values.

  DATA: ls_wbs    TYPE ztb_a2r_wbsitem,
        lv_objnr  TYPE j_objnr,
        lt_return TYPE TABLE OF bapiret2.

  rv_success = abap_false.

  LOOP AT it_wbs_items INTO ls_wbs.

    " Skip if no budget
    IF ls_wbs-wert2 IS INITIAL.
      CONTINUE.
    ENDIF.

    " Get WBS object number
    SELECT SINGLE objnr FROM prps
      INTO lv_objnr
      WHERE posid = ls_wbs-posid.

    IF sy-subrc = 0.
      
      " Use BAPI to assign plan values (CJ40 logic)
      CALL FUNCTION 'BAPI_BUS2054_SET_BUDGET'
        EXPORTING
          i_object_id    = lv_objnr
          i_fiscal_year  = sy-datum(4)
          i_version      = '0'
          i_budget_value = ls_wbs-wert2
        TABLES
          return         = lt_return.

      " Check for errors
      LOOP AT lt_return TRANSPORTING NO FIELDS WHERE type = 'E' OR type = 'A'.
        EXIT.
      ENDLOOP.

      IF sy-subrc <> 0.
        " Success - commit
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.
      ELSE.
        " Error found
        rv_success = abap_false.
        RETURN.
      ENDIF.
    ENDIF.
  ENDLOOP.

  rv_success = abap_true.

ENDMETHOD.

METHOD create_settlement_rules.

  DATA: lt_cobrb_ins   TYPE TABLE OF cobrb_ins,
        ls_cobrb_ins   TYPE cobrb_ins,
        ls_wbs         TYPE ztb_a2r_wbsitem,
        lv_parent_objnr TYPE j_objnr,
        lv_wbs_objnr   TYPE j_objnr.

  rv_success = abap_false.

  " Loop through WBS items to create settlement rules
  LOOP AT it_wbs_items INTO ls_wbs.

    " Skip Level 1 (no parent to settle to)
    IF ls_wbs-stufe = 1.
      CONTINUE.
    ENDIF.

    " Get WBS object number
    SELECT SINGLE objnr FROM prps
      INTO lv_wbs_objnr
      WHERE posid = ls_wbs-posid.

    IF sy-subrc <> 0.
      CONTINUE.
    ENDIF.

    " Get parent WBS from hierarchy (PRHI table)
    SELECT SINGLE up FROM prhi
      INTO lv_parent_objnr
      WHERE down = lv_wbs_objnr.

    IF sy-subrc = 0 AND lv_parent_objnr IS NOT INITIAL.

      " Prepare settlement rule entry
      CLEAR ls_cobrb_ins.
      ls_cobrb_ins-objnr = lv_wbs_objnr.      " Sender WBS (source)
      ls_cobrb_ins-konty = 'PRJ'.             " Account assignment category
      ls_cobrb_ins-empge = lv_parent_objnr.   " Receiver (parent WBS)
      ls_cobrb_ins-prozs = '100'.             " Settlement percentage
      ls_cobrb_ins-abgsl = 'FUL'.             " Full settlement

      APPEND ls_cobrb_ins TO lt_cobrb_ins.
    ENDIF.
  ENDLOOP.

  " Check if any rules to create
  IF lt_cobrb_ins IS INITIAL.
    rv_success = abap_true.
    RETURN.
  ENDIF.

  " Save settlement rules using K_SRULE_SAVE_UTASK
  CALL FUNCTION 'K_SRULE_SAVE_UTASK'
    TABLES
      t_cobrb_insert = lt_cobrb_ins
    EXCEPTIONS
      OTHERS         = 1.

  IF sy-subrc = 0.
    " Activate SETC status for all WBS with settlement rules
    LOOP AT it_wbs_items INTO ls_wbs WHERE stufe > 1.
      SELECT SINGLE objnr FROM prps
        INTO lv_wbs_objnr
        WHERE posid = ls_wbs-posid.

      IF sy-subrc = 0.
        CALL FUNCTION 'STATUS_CHANGE_INTERN_VB'
          EXPORTING
            objnr              = lv_wbs_objnr
            user_stat          = 'SETC'
            set_inact          = ''
          EXCEPTIONS
            object_not_found   = 1
            status_inconsistent = 2
            OTHERS             = 3.
      ENDIF.
    ENDLOOP.

    COMMIT WORK.
    rv_success = abap_true.
  ELSE.
    MESSAGE e024(zcj00). " Error creating settlement rules
    rv_success = abap_false.
  ENDIF.

ENDMETHOD.


METHOD create_wbs_elements.

  DATA: lv_pspid         TYPE ps_pspid,
        ls_wbs           TYPE ztb_a2r_wbsitem,
        lt_return        TYPE TABLE OF bapiret2,
        ls_return        TYPE bapiret2,
        lv_project_def   TYPE bapi_bus2054_new-project_definition,
        lt_wbs_element   TYPE TABLE OF bapi_bus2054_new,
        ls_wbs_element   TYPE bapi_bus2054_new,
        lv_level1_posid  TYPE ps_posid.

  rv_success = abap_false.

  " Get next available project number
  lv_pspid = get_next_project_number( is_header-profl ).

  IF lv_pspid IS INITIAL.
    MESSAGE e029(zcj00). " Cannot generate project number
    RETURN.
  ENDIF.

  " Set project definition
  lv_project_def = lv_pspid.

  " Call standard function to create project
  CALL FUNCTION 'BAPI_PROJECT_MAINTAIN'
    EXPORTING
      i_project_definition = lv_project_def
      i_description        = is_header-pspnr
      i_company_code       = is_header-bukrs
      i_plant              = is_header-werks
      i_profit_center      = is_header-prctr
      i_start_date         = sy-datum
      i_end_date           = is_header-plsez
      i_responsible        = is_header-vernr
      i_currency           = 'USD'
      i_project_profile    = is_header-profl
    TABLES
      return               = lt_return.

  " Check for errors
  LOOP AT lt_return INTO ls_return WHERE type = 'E' OR type = 'A'.
    MESSAGE ID ls_return-id TYPE 'E' NUMBER ls_return-number
      WITH ls_return-message_v1 ls_return-message_v2
           ls_return-message_v3 ls_return-message_v4.
    rv_success = abap_false.
    RETURN.
  ENDLOOP.

  " Create WBS elements using CJ20N logic
  LOOP AT it_wbs_items INTO ls_wbs.

    " Skip if no budget
    IF ls_wbs-wert2 IS INITIAL.
      CONTINUE.
    ENDIF.

    CLEAR ls_wbs_element.

    " Generate WBS element code
    IF ls_wbs-stufe = 1.
      ls_wbs_element-wbs_element = lv_pspid.
      lv_level1_posid = lv_pspid.
    ELSE.
      ls_wbs_element-wbs_element = |{ lv_pspid }-{ sy-tabix }|.
    ENDIF.

    ls_wbs_element-description = ls_wbs-post1.
    ls_wbs_element-wbs_level   = ls_wbs-stufe.
    ls_wbs_element-cost_center = ls_wbs-kostl.

    " Store created WBS
    ls_wbs-pspnr = ls_wbs_element-wbs_element.
    ls_wbs-posid = ls_wbs_element-wbs_element.
    APPEND ls_wbs TO et_wbs_created.

    APPEND ls_wbs_element TO lt_wbs_element.
  ENDLOOP.

  " Create WBS elements
  CALL FUNCTION 'BAPI_BUS2054_CHANGE_MULTI'
    EXPORTING
      i_project_definition = lv_project_def
    TABLES
      it_wbs_element       = lt_wbs_element
      return               = lt_return.

  " Check for errors
  LOOP AT lt_return INTO ls_return WHERE type = 'E' OR type = 'A'.
    MESSAGE ID ls_return-id TYPE 'E' NUMBER ls_return-number
      WITH ls_return-message_v1 ls_return-message_v2.
    rv_success = abap_false.
    RETURN.
  ENDLOOP.

  " Commit
  CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
    EXPORTING
      wait = 'X'.

  " Link to IM Position
  CALL FUNCTION 'IM_ASSIGN_WBS_TO_POSITION'
    EXPORTING
      i_posnr = is_header-posnr
      i_posid = lv_level1_posid
    EXCEPTIONS
      OTHERS  = 1.

  rv_success = abap_true.

ENDMETHOD.


METHOD distribute_im_budget.

  DATA: lv_im_objnr     TYPE j_objnr,
        lv_wbs_objnr    TYPE j_objnr,
        ls_wbs_level1   TYPE ztb_a2r_wbsitem,
        lv_budget_amount TYPE bpge-wlges.

  rv_success = abap_false.

  " Get Level 1 WBS - CORRECTED: Loop and check instead of WITH KEY
  LOOP AT it_wbs_items INTO ls_wbs_level1.
    IF ls_wbs_level1-stufe = 1.
      EXIT.
    ENDIF.
  ENDLOOP.

  IF ls_wbs_level1 IS INITIAL.
    RETURN.
  ENDIF.

  " Get IM object number
  SELECT SINGLE objnr FROM impr
    INTO lv_im_objnr
    WHERE posnr = is_header-posnr.

  IF sy-subrc <> 0.
    RETURN.
  ENDIF.

  " Get WBS object number
  SELECT SINGLE objnr FROM prps
    INTO lv_wbs_objnr
    WHERE posid = ls_wbs_level1-posid.

  IF sy-subrc <> 0.
    RETURN.
  ENDIF.

  lv_budget_amount = ls_wbs_level1-wert2.

  " Check WBS assignment
  CALL FUNCTION 'IM_CHECK_WBS_ASSIGNMENT'
    EXPORTING
      i_posnr         = is_header-posnr
      i_posid         = ls_wbs_level1-posid
    EXCEPTIONS
      not_assigned    = 1
      OTHERS          = 2.

  IF sy-subrc <> 0.
    MESSAGE e030(zcj00). " WBS not assigned to IM
    RETURN.
  ENDIF.

  " Check budget availability
  CALL FUNCTION 'IM_AVAILABILITY_CHECK'
    EXPORTING
      i_objnr         = lv_im_objnr
      i_amount        = lv_budget_amount
    EXCEPTIONS
      budget_exceeded = 1
      OTHERS          = 2.

  IF sy-subrc <> 0.
    MESSAGE e022(zcj00). " Budget exceeds available
    RETURN.
  ENDIF.

  " Distribute budget from IM to WBS
  UPDATE bpge
    SET wtgev = wtgev + lv_budget_amount
    WHERE objnr = lv_im_objnr.

  IF sy-subrc = 0.
    COMMIT WORK.
    rv_success = abap_true.
  ENDIF.

ENDMETHOD.

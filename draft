CLASS ZCL_A2R_WBS_BUILDER DEFINITION.

  PUBLIC SECTION.
    METHODS: create_project
             IMPORTING iv_pspnr TYPE ps_pspnr
                       iv_projname TYPE string
                       iv_bukrs TYPE bukrs
                       iv_werks TYPE werks
                       iv_plsez TYPE dats,
             create_settlement_rule
             IMPORTING iv_pspnr TYPE ps_pspnr
                       iv_posid TYPE ps_posid,
             update_plan_values
             IMPORTING iv_pspnr TYPE ps_pspnr
                       iv_posid TYPE ps_posid
                       iv_plan_value TYPE curr,
             activate_system_status
             IMPORTING iv_pspnr TYPE ps_pspnr
                       iv_status TYPE string
                       iv_posid TYPE ps_posid.

  PRIVATE SECTION.
    DATA: lv_error TYPE abap_bool.

ENDCLASS.

CLASS ZCL_A2R_WBS_BUILDER IMPLEMENTATION.

  METHOD create_project.
    " Generate Request Number
    CALL FUNCTION 'NUMBER_GET_NEXT'
      EXPORTING
        nr_range_nr = '01'
        object = 'ZCJ00_REQN'
      IMPORTING
        number = lv_req_no.  " Store the generated request number in lv_req_no

    " Create Project Header Entry
    DATA: lv_wbs_header TYPE ZTB_A2R_WBSHDR.

    lv_wbs_header-pspnr = iv_pspnr.
    lv_wbs_header-request = lv_req_no.
    lv_wbs_header-status = 'Draft'.
    lv_wbs_header-bukrs = iv_bukrs.
    lv_wbs_header-werks = iv_werks.
    lv_wbs_header-plsez = iv_plsez.

    INSERT ZTB_A2R_WBSHDR FROM lv_wbs_header.

    " Create WBS Elements
    LOOP AT lt_wbs_elements INTO DATA(ls_wbs).
      DATA: lv_wbs_item TYPE ZTB_A2R_WBSITEM.

      lv_wbs_item-pspnr = iv_pspnr.
      lv_wbs_item-posid = ls_wbs-posid.
      lv_wbs_item-description = ls_wbs-description.
      lv_wbs_item-zbudget_check = ls_wbs-zbudget_check.

      INSERT ZTB_A2R_WBSITEM FROM lv_wbs_item.
    ENDLOOP.

    COMMIT WORK.
    MESSAGE 'Project created successfully' TYPE 'S'.
  ENDMETHOD.

  METHOD create_settlement_rule.
    " Settlement Rule Creation Logic
    CALL FUNCTION 'K_SRULE_SAVE_UTASK'
      EXPORTING
        object_number         = iv_posid
        settlement_receiver   = iv_pspnr
        percentage            = 100
        settlement_type       = 'FUL'.
    COMMIT WORK.
  ENDMETHOD.

  METHOD update_plan_values.
    " Update Plan Values Logic
    SELECT SINGLE zbudget_check FROM ZTB_A2R_WBSITEM WHERE posid = iv_posid
      INTO @DATA(lv_available_budget).

    IF iv_plan_value > lv_available_budget.
      MESSAGE 'Plan value exceeds available budget' TYPE 'E'.
    ENDIF.

    UPDATE ZTB_A2R_WBSITEM SET zbudget_check = iv_plan_value
      WHERE posid = iv_posid.

    COMMIT WORK.
  ENDMETHOD.

  METHOD activate_system_status.
    " System Status Activation
    CALL FUNCTION 'STATUS_CHANGE_INTERN_VB'
      EXPORTING
        object_type = 'PS'
        object_key = iv_pspnr
        status = iv_status
        reason = 'Project Initialization'.
    COMMIT WORK.
  ENDMETHOD.

ENDCLASS.
*&---------------------------------------------------------------------*
*&  Include           MZWBSF01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
FORM get_bunit_list.

  CHECK ok_code IS INITIAL OR ok_code = 'PRJTY' OR ok_code = 'IZWEK'.
  CHECK NOT lv_proj_type IS INITIAL.
  CLEAR:ls_list,lt_list_bunit,lv_id,lt_bunit,lv_template,
        zwbs_proj_tem_tc-profidproj,zwbs_proj_templ-b_unit.
*  IF lv_proj3 IS NOT INITIAL.
  IF lv_proj_type = 'TC'.

    SELECT b~profidproj b~profi_txt
                        INTO TABLE lt_list_bunit
                        FROM zwbs_proj_tem_tc AS a INNER JOIN tcj4t AS b
                        ON a~profidproj = b~profidproj
                        WHERE
                              a~proj_type = lv_proj_type AND
                              b~spras = sy-langu.

    SORT lt_list_bunit BY key.
    lv_id = 'ZWBS_PROJ_TEM_TC-PROFIDPROJ'.
    DELETE ADJACENT DUPLICATES FROM lt_list_bunit COMPARING key.

    IF ok_code = 'IZWEK'.
*      CALL FUNCTION 'CONVERSION_EXIT_POSNR_OUTPUT'
*        EXPORTING
*          input  = zwbs_proj_tem_tc-izwek
*        IMPORTING
*          output = gv_posnr.

      SELECT SINGLE izwek, bukrs INTO @DATA(ls_impr) FROM impr
         WHERE posid = @zwbs_proj_tem_tc-izwek.

      SELECT SINGLE b~profidproj b~profi_txt
                          INTO  ls_list_bunit1
                          FROM zwbs_proj_tem_tc AS a INNER JOIN tcj4t AS b
                          ON a~profidproj = b~profidproj
                          WHERE a~izwek =  ls_impr-izwek AND
                                a~vbukr =  ls_impr-bukrs AND
                                a~proj_type = lv_proj_type AND
                                b~spras = sy-langu.
      IF sy-subrc = 0.
        lv_profid = zwbs_proj_tem_tc-profidproj = ls_list_bunit1-key.
      ELSE.
        SELECT SINGLE b~profidproj b~profi_txt
                         INTO  ls_list_bunit1
                         FROM zwbs_proj_tem_tc AS a INNER JOIN tcj4t AS b
                         ON a~profidproj = b~profidproj
                         WHERE a~izwek = '*' AND
                               a~vbukr =  ls_impr-bukrs AND
                               a~proj_type = lv_proj_type AND
                               b~spras = sy-langu.
        IF sy-subrc = 0.
          lv_profid = zwbs_proj_tem_tc-profidproj = ls_list_bunit1-key.
        ENDIF.
      ENDIF.
    ENDIF.
  ELSE.
    SELECT DISTINCT b~b_unit b~bustxt b~bultxt
                    b~div " Changes for EiCR - 729491
                    INTO TABLE lt_bunit
                    FROM zwbs_proj_templ AS a INNER JOIN t9f15 AS b
                    ON a~b_unit = b~b_unit
                    WHERE a~proj_type = lv_proj_type AND
                          b~gjahr     = sy-datum+0(4).

    LOOP AT lt_bunit INTO DATA(ls_bunit).
      ls_list-key = ls_bunit-b_unit.
      " Begin of Changes for EiCR - 729491
*    CONCATENATE ls_bunit-bustxt ls_bunit-bultxt INTO ls_list-text
*                                                SEPARATED BY '/'.
      CONCATENATE ls_bunit-bultxt ls_bunit-b_unit INTO ls_list-text
                                                  SEPARATED BY ' - '.
      " End of Changes for EiCR - 729491
      APPEND ls_list TO lt_list_bunit.
      CLEAR ls_list.
    ENDLOOP.

    SORT lt_list_bunit BY text. " Changes for EiCR - 729491
    lv_id = 'ZWBS_PROJ_TEMPL-B_UNIT'.
  ENDIF.
*Set Default Values
  CALL FUNCTION 'VRM_SET_VALUES'
    EXPORTING
      id              = lv_id
      values          = lt_list_bunit[]
    EXCEPTIONS
      id_illegal_name = 1
      OTHERS          = 2.
  IF sy-subrc <> 0.
* Implement suitable error handling here
  ENDIF.

ENDFORM.                    " GET_BUNIT_LIST
*&---------------------------------------------------------------------*
FORM get_tree_list.

  CHECK ok_code = 'BUNIT' OR ok_code = 'PRJTY' OR ok_code = 'IZWEK'.

  CLEAR:ls_list,lt_list,lv_template,lv_id,lt_project.

  IF ok_code = 'BUNIT' OR ok_code = 'IZWEK'.
*  IF lv_proj3 IS NOT INITIAL.
    IF lv_proj_type = 'TC'.
      CHECK NOT lv_profid IS INITIAL.
      SELECT b~pspid b~post1 INTO TABLE lt_project
                             FROM zwbs_proj_tem_tc AS a INNER JOIN proj AS
                             b
                             ON a~project = b~pspid
                             WHERE a~proj_type  = lv_proj_type AND
                                   a~profidproj = lv_profid.
    ELSE.
      CHECK NOT lv_bunit IS INITIAL.
*    CLEAR:ls_list,lt_list,lv_template,lv_id,lt_project.
      SELECT b~pspid b~post1 INTO TABLE lt_project
                             FROM zwbs_proj_templ AS a INNER JOIN proj AS b
                             ON a~project = b~pspid
                             WHERE a~proj_type = lv_proj_type AND
                                   a~b_unit    = lv_bunit.
    ENDIF.

    LOOP AT lt_project INTO ls_project.
      CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
        EXPORTING
          input  = ls_project-pspid
        IMPORTING
          output = ls_list-key.
      ls_list-text = ls_project-post1.
      APPEND ls_list TO lt_list.
    ENDLOOP.
  ENDIF.
*  IF lv_proj_type = 'TC'.
*    READ TABLE lt_list[] INTO ls_list INDEX 1.
*    IF sy-subrc = 0.
*      lv_template = ls_list-key.
*    ENDIF.
*  ENDIF.
  IF ok_code = 'IZWEK'.
    SELECT SINGLE izwek INTO @DATA(lv_izwek) FROM impr
       WHERE posid = @zwbs_proj_tem_tc-izwek.

    SELECT SINGLE izwek, profidproj, project
                        INTO  @DATA(ls_proj_tem_tc)
                        FROM zwbs_proj_tem_tc
                        WHERE izwek =  @lv_izwek
                          AND proj_type = @lv_proj_type
                          AND profidproj = @lv_profid.
    IF sy-subrc = 0.
      lv_template = zwbs_proj_tem_tc-project = ls_proj_tem_tc-project.
    ELSE.
      SELECT SINGLE izwek, profidproj, project
                        INTO @ls_proj_tem_tc
                        FROM zwbs_proj_tem_tc
                        WHERE izwek =  '*'
                          AND proj_type = @lv_proj_type
                          AND profidproj = @lv_profid.
      IF sy-subrc = 0.
        lv_template = zwbs_proj_tem_tc-project = ls_proj_tem_tc-project.
      ENDIF.
    ENDIF.
  ENDIF.

  lv_id = 'LV_TEMPLATE'.
  CALL FUNCTION 'VRM_SET_VALUES'
    EXPORTING
      id              = lv_id
      values          = lt_list[]
    EXCEPTIONS
      id_illegal_name = 1
      OTHERS          = 2.
  IF sy-subrc <> 0.
* Implement suitable error handling here
  ENDIF.

ENDFORM.                    " GET_TREE_LIST
*&---------------------------------------------------------------------*
*&      Form  SHOW_TREE_STRUCTURE
*&---------------------------------------------------------------------*
FORM show_tree_structure.

  IF lo_proj_tree IS INITIAL.
    CREATE OBJECT lo_cont_proj
      EXPORTING
        container_name = 'PROJ_CONTROL'.

    ls_hierarchy_header-heading = 'Project Structure: Description'.
    ls_hierarchy_header-tooltip = 'Project Structure: Description'.
    ls_hierarchy_header-width   = 40.

    CREATE OBJECT lo_proj_tree
      EXPORTING
        parent                      = lo_cont_proj
        node_selection_mode         = 0
        item_selection              = space
        hierarchy_column_name       = lc_hierarchy_short_text
        hierarchy_header            = ls_hierarchy_header
      EXCEPTIONS
        lifetime_error              = 1
        cntl_system_error           = 2
        create_error                = 3
        illegal_node_selection_mode = 4
        failed                      = 5
        illegal_column_name         = 6.
    IF NOT sy-subrc IS INITIAL.
      MESSAGE a000(tree_control_msg).
*   Fehler beim Aufruf einer Methode des Tree Controls
    ENDIF.

    CALL METHOD lo_proj_tree->add_column
      EXPORTING
        name           = lc_hierarchy_technical_key
        width          = 30
        alignment      = cl_gui_column_tree=>align_left
        header_text    = 'Identification'
        header_tooltip = 'Identification'.

***********************************************************************
* The following lines are a workaround for a bug in the CFW
* In future they will be obsolete !!!!!
***********************************************************************
    CALL METHOD lo_proj_tree->set_alignment
      EXPORTING
        alignment = 15.
  ENDIF.

  IF NOT lo_proj_tree IS INITIAL.
    CALL FUNCTION 'CNPB_H_COLUMNS_TOGGLE'
      IMPORTING
        et_treeitm_u = lt_treeitm_u.

    CALL METHOD lo_proj_tree->update_nodes_and_items
      EXPORTING
        node_table                     = lt_treev_node_u
        item_table                     = lt_treeitm_u
        item_table_structure_name      = 'CNPB_H_TREEITM_UPD'
      EXCEPTIONS
        failed                         = 1
        cntl_system_error              = 2
        error_in_tables                = 3
        dp_error                       = 4
        table_structure_name_not_found = 5.

    CALL METHOD lo_proj_tree->hierarchy_header_set_text
      EXPORTING
        text              = 'Project Structure:Description'
      EXCEPTIONS
        failed            = 1
        cntl_system_error = 2.

    CALL METHOD lo_proj_tree->column_set_heading_text
      EXPORTING
        column_name       = lc_hierarchy_technical_key
        text              = 'Identification'
      EXCEPTIONS
        failed            = 1
        column_not_found  = 2
        hierarchy_column  = 3
        cntl_system_error = 4.
  ENDIF.                             "tree_control not initial

  IF ok_code = 'TREE' OR ok_code = 'ACTION' OR ok_code = 'IZWEK'.
    CLEAR:ls_proj,ls_objects_in_hierarchy,gt_treeitm,gt_treev_node,
          gs_objects_in_tree.

    CALL FUNCTION 'CNPB_H_PROJ_HIER_REFRESH'.

    SELECT SINGLE * FROM proj INTO ls_proj WHERE pspid = lv_template.

    CHECK sy-subrc = 0.

*  IF lv_proj3 IS NOT INITIAL.
    IF lv_proj_type = 'TC'.
      CALL FUNCTION 'CONVERSION_EXIT_POSNR_OUTPUT'
        EXPORTING
          input  = zwbs_proj_tem_tc-izwek
        IMPORTING
          output = gv_posnr.

      SELECT SINGLE bukrs werks INTO (lv_vbukr, lv_werks)
        FROM impr WHERE posid = gv_posnr.

      IF sy-subrc NE 0.

        SELECT SINGLE bukrs werks INTO (lv_vbukr, lv_werks)
          FROM impr WHERE posid = zwbs_proj_tem_tc-izwek.
      ENDIF.
*      lv_vbukr = ls_proj-vbukr.
*      lv_werks = ls_proj-werks.
    ENDIF.

    ls_objects_in_hierarchy-proj = abap_true.
    ls_objects_in_hierarchy-prps = abap_true.
    ls_objects_in_hierarchy-pstx = abap_true.

    IF ok_code = 'TREE' OR ok_code = 'IZWEK'..
      CALL FUNCTION 'CNPB_H_PROJ_HIER_SELECT'
        EXPORTING
          i_objects_in_hierarchy = ls_objects_in_hierarchy
          i_vsnmr                = ''
          i_pspid                = lv_template
          i_aufnr                = ''
          i_flg_enqueue          = lv_enqueue
          i_expand_levels        = 06
          i_drag_drop_handle     = lv_drag_drop_handle
          i_hier_col_is_key      = lv_hier_col_is_key
        IMPORTING
          et_treeitm             = gt_treeitm
          et_treev_node          = gt_treev_node
          e_flg_enqueue          = lv_enqueue
          e_objects_in_hierarchy = gs_objects_in_tree
        EXCEPTIONS
          OTHERS                 = 1.
      IF NOT sy-subrc IS INITIAL.
        EXIT.
      ENDIF.
    ENDIF.

    CALL METHOD lo_proj_tree->delete_all_nodes.
    CALL METHOD lo_proj_tree->hierarchy_header_set_text
      EXPORTING
        text              = 'Project Structure:Description'
      EXCEPTIONS
        failed            = 1
        cntl_system_error = 2.

    CALL METHOD lo_proj_tree->add_nodes_and_items
      EXPORTING
        node_table                     = gt_treev_node
        item_table                     = gt_treeitm
        item_table_structure_name      = 'CNPB_H_TREEITM'
      EXCEPTIONS
        failed                         = 1
        cntl_system_error              = 3
        error_in_tables                = 4
        dp_error                       = 5
        table_structure_name_not_found = 6.
    CALL METHOD lo_proj_tree->expand_root_nodes
      EXPORTING
        level_count         = 0
        expand_subtree      = space
      EXCEPTIONS
        failed              = 1
        illegal_level_count = 2
        cntl_system_error   = 3.

    CALL METHOD lo_proj_tree->hierarchy_header_set_width
      EXPORTING
        width             = 40
        width_pix         = space
      EXCEPTIONS
        failed            = 1
        cntl_system_error = 2.
    CALL METHOD lo_proj_tree->column_set_width
      EXPORTING
        column_name       = lc_hierarchy_technical_key
        width             = 21
        width_pix         = space
      EXCEPTIONS
        failed            = 1
        column_not_found  = 2
        hierarchy_column  = 3
        cntl_system_error = 4.
  ELSEIF ok_code = 'PRJTY' OR ok_code = 'BUNIT'.
    CLEAR:ls_proj,ls_objects_in_hierarchy,gt_treeitm,gt_treev_node,
          gs_objects_in_tree.
    CALL FUNCTION 'CNPB_H_PROJ_HIER_REFRESH'.
    CALL METHOD lo_proj_tree->delete_all_nodes.
  ENDIF.

ENDFORM.                    " SHOW_TREE_STRUCTURE
*&---------------------------------------------------------------------*
*&      Form  PROCESS_DATA
*&---------------------------------------------------------------------*
FORM process_data.
  DATA: lv_answer TYPE c.
  CLEAR:lv_project_st,lv_project_new,lv_project_int,ls_table,lv_oflag,
        lv_project_int,lt_table,ls_default,lv_offset,lv_type,lv_stat,
        lv_req_type,lv_ag_flag,ls_cf_control,lv_init_run,lt_table_init,
        ls_proj_templ,lv_grp_allowed,lv_vernr,lv_astnr,lv_vgsbr,lv_plsez.

  REFRESH CONTROL:'TC_WBS'   FROM SCREEN '0500',
                  'TC_CAPEX' FROM SCREEN '0900'.

*Request Type
  CASE abap_true.
*1 Create
    WHEN lv_rb1.
*      IF lv_proj3 IS NOT INITIAL.
      IF lv_proj_type = 'TC'.
        lv_type = 1.
        IF lv_profid IS INITIAL.
          MESSAGE i368(00) WITH text-021 DISPLAY LIKE 'E'.
          EXIT.
        ENDIF.
        IF lv_template IS INITIAL.
          MESSAGE i368(00) WITH text-008 DISPLAY LIKE 'E'.
          EXIT.
        ENDIF.
*        IF lv_werks IS INITIAL.
*          MESSAGE i368(00) WITH text-015 DISPLAY LIKE 'E'.
*          EXIT.
*        ENDIF.
        IF lv_vbukr IS INITIAL.
          MESSAGE i368(00) WITH text-018 DISPLAY LIKE 'E'.
          EXIT.
        ENDIF.
* Mark for Intial Run to mark fields
        lv_init_run = abap_true.
* CR 626062 - Ended
        PERFORM wbs_create_data.
      ELSE.
*1 Create
        lv_type = 1.
        IF lv_bunit IS INITIAL.
          MESSAGE i368(00) WITH text-017 DISPLAY LIKE 'E'.
          EXIT.
        ENDIF.
        IF lv_template IS INITIAL.
          MESSAGE i368(00) WITH text-008 DISPLAY LIKE 'E'.
          EXIT.
        ENDIF.
        IF lv_werks IS INITIAL.
          MESSAGE i368(00) WITH text-015 DISPLAY LIKE 'E'.
          EXIT.
        ENDIF.
        " Begin of changes by AKOTA for EiCR-766523
        IF lv_vbukr IS INITIAL.
          MESSAGE i368(00) WITH text-018 DISPLAY LIKE 'E'.
          EXIT.
        ENDIF.
        SELECT SINGLE bukrs INTO lv_vbukr FROM t001k
         WHERE bwkey EQ lv_werks
           AND bukrs EQ lv_vbukr.
        IF sy-subrc NE 0.
          CONCATENATE text-020 lv_werks text-019 lv_vbukr
                INTO DATA(lv_messg) SEPARATED BY space.
          MESSAGE i368(00) WITH lv_messg DISPLAY LIKE 'E'.
          EXIT.
        ENDIF.
        " End of changes by AKOTA for EiCR-766523
*      ELSE.
*        SELECT SINGLE COUNT(*) FROM t001k WHERE bwkey = lv_werks AND
*                                                bukrs = lv_bukrs.
*        IF sy-subrc <> 0.
*          MESSAGE i283(m7) WITH lv_werks DISPLAY LIKE 'E'.
*          EXIT.
*        ENDIF.
        IF lv_lonzacode IS INITIAL.
          IF lv_werks = '0003' OR lv_werks = '0014'.
            MESSAGE i368(00) WITH text-016 DISPLAY LIKE 'E'.
            EXIT.
          ENDIF.
        ENDIF.
* CR 626062 --> Added
* Set Acct.Assignment.Element & Billing element flags
* Mark for Intial Run to mark fields
        lv_init_run = abap_true.
* CR 626062 - Ended
        PERFORM wbs_create_data.
      ENDIF.
    WHEN lv_rb2.
*2 Change
      IF lv_project IS INITIAL.
        MESSAGE i368(00) WITH text-010 DISPLAY LIKE 'E'.
        EXIT.
      ENDIF.
*Validate Project based on Selection
      IF lv_proj_type = 'TC'."Bypass Check for CAPEX
      ELSE.
        IF lv_proj_type <> lv_project+0(2).
          MESSAGE i368(00) WITH text-022 DISPLAY LIKE 'E'.
          EXIT.
        ENDIF.
      ENDIF.
      lv_type = 2.
      SELECT SINGLE * FROM prps INTO @DATA(ls_prps_uni) WHERE posid = @lv_project.
      IF sy-subrc = 0 AND ls_prps_uni-zunifier_proj IS INITIAL.
        PERFORM wbs_change_data.
      ELSE.
        CALL FUNCTION 'POPUP_CONTINUE_YES_NO'
          EXPORTING
*           DEFAULTOPTION       = 'Y'
            textline1    = text-025
            textline2    = text-026
            titel        = 'Message'
            start_column = 25
            start_row    = 6
          IMPORTING
            answer       = lv_answer.
        IF lv_answer = 'J'.
          PERFORM wbs_change_data.
        ELSE.
          EXIT.
        ENDIF.
        .
      ENDIF.
    WHEN lv_rb3.
*3 Close
      lv_type = 3.
      IF lv_project IS INITIAL.
        MESSAGE i368(00) WITH text-010 DISPLAY LIKE 'E'.
        EXIT.
      ENDIF.
      PERFORM wbs_close_data.
    WHEN lv_rb4.
*4 UnClose
      lv_type = 4.
      IF lv_project IS INITIAL.
        MESSAGE i368(00) WITH text-010 DISPLAY LIKE 'E'.
        EXIT.
      ENDIF.
      PERFORM wbs_unclose_data.
    WHEN lv_rb5.
*5 Reopen
      lv_type = 5.
      IF lv_proj_type = 'TC'.
        PERFORM get_request_data.
        EXIT.
      ENDIF.
  ENDCASE.

*Status Texts
  SELECT SINGLE:text FROM t9m49 INTO lv_stat
                                WHERE status  = zwbs_header-status AND
                                      sprache = lc_spras,
                ddtext FROM dd07t INTO lv_req_type
                                  WHERE domname    = 'ZZWBS_TYPE' AND
                                        ddlanguage = lc_spras AND
                                        domvalue_l = lv_type.

  IF NOT lv_oflag IS INITIAL.
    CALL FUNCTION 'POPUP_TO_INFORM'
      EXPORTING
        titel = 'Information'
        txt1  = text-011
        txt2  = text-012.
    EXIT.
  ENDIF.

*Check for GROUPING flag based on Selected Template
  SELECT SINGLE * FROM zwbs_proj_templ INTO @ls_proj_templ
                  WHERE ( proj_type = @lv_proj_type           AND
                          b_unit    = @lv_bunit               AND
                          project   = @lv_template )          OR
                        ( proj_type = @zwbs_header-proj_type  AND
                          project   = @zwbs_header-pspid_templ ).

  CHECK NOT zwbs_header IS INITIAL.

*Mark for Intial Run to mark fields
  lv_init_run = abap_true.

  CALL SCREEN 400.

ENDFORM.                    " PROCESS_DATA
*&--------------------------------------------------------------------*
*&      Form  START_GOS
*&--------------------------------------------------------------------*
*       Start a new instance of the GOS service...
*----------------------------------------------------------------------*
*      --> IV_OBJKEY    Object key to which the GOS records should be
*                       linked to
*      --> IV_RW_MODE   Read/ Write Mode
*      <-- CO_GOS       Object reference to GOS manager
*----------------------------------------------------------------------*
FORM start_gos  USING    iv_objkey  TYPE any
                         iv_rw_mode TYPE sgs_rwmod
                CHANGING co_gos     TYPE REF TO cl_gos_manager.

* Datadeclarations (local)
  DATA ls_object TYPE borident.

* Processing ----------------------------------------------------------
* -- reuqest available?
  CHECK NOT iv_objkey IS INITIAL.

* -- clear an existing old instance
  IF co_gos IS BOUND.
    FREE co_gos.
  ENDIF.

* -- create a new object service...
  ls_object-objkey  = iv_objkey.
  ls_object-objtype = 'Z_WBS'.

  CREATE OBJECT co_gos
    EXPORTING
      is_object        = ls_object
      ip_start_direct  = ' '
      ip_no_instance   = ' '
      ip_no_commit     = ' '
    EXCEPTIONS
      object_invalid   = 1
      callback_invalid = 2
      OTHERS           = 3.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
               WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

  CHECK co_gos IS BOUND.

* -- set rw mode...
  CALL METHOD co_gos->set_rw_mode
    EXPORTING
      ip_mode = iv_rw_mode.

ENDFORM.                    " start_gos

*----------------------------------------------------------------------*
*   INCLUDE TABLECONTROL_FORMS                                         *
*----------------------------------------------------------------------*

*&---------------------------------------------------------------------*
*&      Form  USER_OK_TC                                               *
*&---------------------------------------------------------------------*
FORM user_ok_tc USING    p_tc_name TYPE dynfnam
                         p_table_name
                         p_mark_name
                CHANGING p_ok      LIKE sy-ucomm.

*&SPWIZARD: BEGIN OF LOCAL DATA----------------------------------------*
  DATA: l_ok       TYPE sy-ucomm,
        l_offset   TYPE i,
        lv_selline TYPE syst_stepl.
*&SPWIZARD: END OF LOCAL DATA------------------------------------------*

*&SPWIZARD: Table control specific operations                          *
*&SPWIZARD: evaluate TC name and operations                            *
  SEARCH p_ok FOR p_tc_name.
  IF sy-subrc <> 0.
    EXIT.
  ENDIF.
  l_offset = strlen( p_tc_name ) + 1.
  l_ok = p_ok+l_offset.
*&SPWIZARD: execute general and TC specific operations                 *
  CASE l_ok.
    WHEN 'INSR'.                      "insert row
      PERFORM fcode_insert_row USING    p_tc_name
                                        p_table_name.
      CLEAR p_ok.
      lv_insr_flag = 'X'.   lv_insr_flag_up = 'X'.

    WHEN 'DELE'.                      "delete row
      PERFORM fcode_delete_row USING    p_tc_name
                                        p_table_name
                                        p_mark_name.
      CLEAR p_ok.

    WHEN 'SUM'.
      READ TABLE lt_table INTO ls_table WITH KEY stufe = '1'.
      IF sy-subrc = 0.
        SELECT SINGLE * FROM prps INTO @DATA(ls_prps_uni) WHERE posid = @ls_table-pspid.
        IF ( lv_type = 1 OR sy-subrc = 0 ) AND ls_prps_uni-zmaint_sys NE 'UN'.
          PERFORM fcode_total_up.
        ENDIF.
      ENDIF.
*      PERFORM fcode_total_up. " USING    p_tc_name
      "           p_table_name
      "          p_mark_name.
      CLEAR p_ok.

    WHEN 'P--' OR                     "top of list
         'P-'  OR                     "previous page
         'P+'  OR                     "next page
         'P++'.                       "bottom of list
      PERFORM compute_scrolling_in_tc USING p_tc_name
                                            l_ok.
      CLEAR p_ok.
*     WHEN 'L--'.                       "total left
*       PERFORM FCODE_TOTAL_LEFT USING P_TC_NAME.
*
*     WHEN 'L-'.                        "column left
*       PERFORM FCODE_COLUMN_LEFT USING P_TC_NAME.
*
*     WHEN 'R+'.                        "column right
*       PERFORM FCODE_COLUMN_RIGHT USING P_TC_NAME.
*
*     WHEN 'R++'.                       "total right
*       PERFORM FCODE_TOTAL_RIGHT USING P_TC_NAME.
*
    WHEN 'MARK'.                      "mark all filled lines
      PERFORM fcode_tc_mark_lines USING p_tc_name
                                        p_table_name
                                        p_mark_name   .
      CLEAR p_ok.

    WHEN 'DMRK'.                      "demark all filled lines
      PERFORM fcode_tc_demark_lines USING p_tc_name
                                          p_table_name
                                          p_mark_name .
      CLEAR p_ok.

*     WHEN 'SASCEND'   OR
*          'SDESCEND'.                  "sort column
*       PERFORM FCODE_SORT_TC USING P_TC_NAME
*                                   l_ok.
    WHEN 'COMMENT'.
      GET CURSOR LINE lv_selline.
      READ TABLE lt_table INTO ls_table INDEX lv_selline.
      IF NOT ls_table IS INITIAL.
        PERFORM handle_remarks USING ls_table.
*Check if Text already Exists
        READ TABLE lt_remarks INTO ls_remarks
                              WITH KEY pspid = ls_table-pspid.
        IF sy-subrc = 0.
          ls_table-long_text = abap_true.
        ELSE.
          ls_table-long_text = abap_false.
        ENDIF.
        MODIFY lt_table FROM ls_table INDEX lv_selline.
      ENDIF.
      CLEAR p_ok.
      ""* Begin of changes by AKOTA for CR 668561
    WHEN 'FIND'.
      PERFORM fcode_tc_find USING p_tc_name
                                  p_table_name
                                  p_mark_name
                                  p_ok.
      CLEAR p_ok.
      ""* End of changes by AKOTA for CR 668561
  ENDCASE.

ENDFORM.                              " USER_OK_TC

*&---------------------------------------------------------------------*
*&      Form  FCODE_INSERT_ROW                                         *
*&---------------------------------------------------------------------*
FORM fcode_insert_row
              USING    p_tc_name           TYPE dynfnam
                       p_table_name.

*&SPWIZARD: BEGIN OF LOCAL DATA----------------------------------------*
  DATA l_lines_name       LIKE feld-name.
  DATA l_selline          LIKE sy-stepl.
  DATA l_lastline         TYPE i.
  DATA l_line             TYPE i.
  DATA l_table_name       LIKE feld-name.
  FIELD-SYMBOLS <tc>                 TYPE cxtab_control.
  FIELD-SYMBOLS <table>              TYPE STANDARD TABLE.
  FIELD-SYMBOLS <lines>              TYPE i.
*&SPWIZARD: END OF LOCAL DATA------------------------------------------*

  ASSIGN (p_tc_name) TO <tc>.

*&SPWIZARD: get the table, which belongs to the tc                     *
  CONCATENATE p_table_name '[]' INTO l_table_name. "table body
  ASSIGN (l_table_name) TO <table>.                "not headerline

*&SPWIZARD: get looplines of TableControl                              *
  CONCATENATE 'G_' p_tc_name '_LINES' INTO l_lines_name.
  ASSIGN (l_lines_name) TO <lines>.

  DATA lv_tc_line TYPE i.
  DATA(string) = 'SELECT = ABAP_TRUE'.

  CLEAR lv_tc_line.
  LOOP AT <table> TRANSPORTING NO FIELDS WHERE (string).
    lv_tc_line = sy-tabix.
  ENDLOOP.

*&SPWIZARD: get current line                                           *
  GET CURSOR LINE l_selline.
  IF l_selline IS INITIAL.
    l_selline = lv_tc_line.
  ENDIF.
  IF sy-subrc <> 0 AND lv_tc_line IS INITIAL. " append line to table
    l_selline = <tc>-lines + 1.
*&SPWIZARD: set top line                                               *
    IF l_selline > <lines>.
      <tc>-top_line = l_selline - <lines> + 1 .
    ELSE.
      <tc>-top_line = 1.
    ENDIF.
  ELSE.                               " insert line into table
    l_selline = <tc>-top_line + l_selline - 1.
    l_lastline = <tc>-top_line + <lines> - 1.
  ENDIF.
*&SPWIZARD: set new cursor line                                        *
  l_line = l_selline - <tc>-top_line + 1.

*&SPWIZARD: insert initial line                                        *
*  INSERT INITIAL LINE INTO <table> INDEX l_selline.
*  IF lv_proj3 IS INITIAL AND gv_capex IS INITIAL.
*  ELSE.
*    ls_default-select = 'X'.
*  ENDIF.
  INSERT ls_default INTO <table> INDEX l_selline.
  <tc>-lines = <tc>-lines + 1.
*&SPWIZARD: set cursor                                                 *
  SET CURSOR LINE l_line.

ENDFORM.                              " FCODE_INSERT_ROW

*&---------------------------------------------------------------------*
*&      Form  FCODE_DELETE_ROW                                         *
*&---------------------------------------------------------------------*
FORM fcode_delete_row
              USING    p_tc_name           TYPE dynfnam
                       p_table_name
                       p_mark_name   .

*&SPWIZARD: BEGIN OF LOCAL DATA----------------------------------------*
  DATA l_table_name       LIKE feld-name.

  FIELD-SYMBOLS <tc>         TYPE cxtab_control.
  FIELD-SYMBOLS <table>      TYPE STANDARD TABLE.
  FIELD-SYMBOLS <wa>.
  FIELD-SYMBOLS <mark_field>.
*&SPWIZARD: END OF LOCAL DATA------------------------------------------*

  ASSIGN (p_tc_name) TO <tc>.

*&SPWIZARD: get the table, which belongs to the tc                     *
  CONCATENATE p_table_name '[]' INTO l_table_name. "table body
  ASSIGN (l_table_name) TO <table>.                "not headerline

*&SPWIZARD: delete marked lines                                        *
  DESCRIBE TABLE <table> LINES <tc>-lines.

  LOOP AT <table> ASSIGNING <wa>.
*&SPWIZARD: access to the component 'FLAG' of the table header         *
    ASSIGN COMPONENT p_mark_name OF STRUCTURE <wa> TO <mark_field>.
    IF <mark_field> = 'X'.
*Capture Deleted Records
      MOVE-CORRESPONDING <wa> TO ls_table.
      IF NOT ls_table-updkz IS INITIAL OR "Inserted Record
             lv_type = 1.                 "Create Case
        DELETE <table> INDEX syst-tabix.
        IF sy-subrc = 0.
          APPEND ls_table TO lt_table_dl.
          <tc>-lines = <tc>-lines - 1.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                              " FCODE_DELETE_ROW

*&---------------------------------------------------------------------*
*&      Form  COMPUTE_SCROLLING_IN_TC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_TC_NAME  name of tablecontrol
*      -->P_OK       ok code
*----------------------------------------------------------------------*
FORM compute_scrolling_in_tc USING    p_tc_name
                                      p_ok.
*&SPWIZARD: BEGIN OF LOCAL DATA----------------------------------------*
  DATA l_tc_new_top_line     TYPE i.
  DATA l_tc_name             LIKE feld-name.
  DATA l_tc_lines_name       LIKE feld-name.
  DATA l_tc_field_name       LIKE feld-name.

  FIELD-SYMBOLS <tc>         TYPE cxtab_control.
  FIELD-SYMBOLS <lines>      TYPE i.
*&SPWIZARD: END OF LOCAL DATA------------------------------------------*

  ASSIGN (p_tc_name) TO <tc>.
*&SPWIZARD: get looplines of TableControl                              *
  CONCATENATE 'G_' p_tc_name '_LINES' INTO l_tc_lines_name.
  ASSIGN (l_tc_lines_name) TO <lines>.


*&SPWIZARD: is no line filled?                                         *
  IF <tc>-lines = 0.
*&SPWIZARD: yes, ...                                                   *
    l_tc_new_top_line = 1.
  ELSE.
*&SPWIZARD: no, ...                                                    *
    CALL FUNCTION 'SCROLLING_IN_TABLE'
      EXPORTING
        entry_act      = <tc>-top_line
        entry_from     = 1
        entry_to       = <tc>-lines
        last_page_full = 'X'
        loops          = <lines>
        ok_code        = p_ok
        overlapping    = 'X'
      IMPORTING
        entry_new      = l_tc_new_top_line
      EXCEPTIONS
*       NO_ENTRY_OR_PAGE_ACT  = 01
*       NO_ENTRY_TO    = 02
*       NO_OK_CODE_OR_PAGE_GO = 03
        OTHERS         = 0.
  ENDIF.

*&SPWIZARD: get actual tc and column                                   *
  GET CURSOR FIELD l_tc_field_name
             AREA  l_tc_name.

  IF syst-subrc = 0.
    IF l_tc_name = p_tc_name.
*&SPWIZARD: et actual column                                           *
      SET CURSOR FIELD l_tc_field_name LINE 1.
    ENDIF.
  ENDIF.

*&SPWIZARD: set the new top line                                       *
  <tc>-top_line = l_tc_new_top_line.


ENDFORM.                              " COMPUTE_SCROLLING_IN_TC

*&---------------------------------------------------------------------*
*&      Form  FCODE_TC_MARK_LINES
*&---------------------------------------------------------------------*
*       marks all TableControl lines
*----------------------------------------------------------------------*
*      -->P_TC_NAME  name of tablecontrol
*----------------------------------------------------------------------*
FORM fcode_tc_mark_lines USING p_tc_name
                               p_table_name
                               p_mark_name.
*&SPWIZARD: EGIN OF LOCAL DATA-----------------------------------------*
  DATA l_table_name       LIKE feld-name.

  FIELD-SYMBOLS <tc>         TYPE cxtab_control.
  FIELD-SYMBOLS <table>      TYPE STANDARD TABLE.
  FIELD-SYMBOLS <wa>.
  FIELD-SYMBOLS <mark_field>.
*&SPWIZARD: END OF LOCAL DATA------------------------------------------*

  ASSIGN (p_tc_name) TO <tc>.

*&SPWIZARD: get the table, which belongs to the tc                     *
  CONCATENATE p_table_name '[]' INTO l_table_name. "table body
  ASSIGN (l_table_name) TO <table>.                "not headerline

*&SPWIZARD: mark all filled lines                                      *
  LOOP AT <table> ASSIGNING <wa>.

*&SPWIZARD: access to the component 'FLAG' of the table header         *
    ASSIGN COMPONENT p_mark_name OF STRUCTURE <wa> TO <mark_field>.

    <mark_field> = 'X'.
  ENDLOOP.
ENDFORM.                                          "fcode_tc_mark_lines

*&---------------------------------------------------------------------*
*&      Form  FCODE_TC_DEMARK_LINES
*&---------------------------------------------------------------------*
*       demarks all TableControl lines
*----------------------------------------------------------------------*
*      -->P_TC_NAME  name of tablecontrol
*----------------------------------------------------------------------*
FORM fcode_tc_demark_lines USING p_tc_name
                                 p_table_name
                                 p_mark_name .
*&SPWIZARD: BEGIN OF LOCAL DATA----------------------------------------*
  DATA l_table_name       LIKE feld-name.

  FIELD-SYMBOLS <tc>         TYPE cxtab_control.
  FIELD-SYMBOLS <table>      TYPE STANDARD TABLE.
  FIELD-SYMBOLS <wa>.
  FIELD-SYMBOLS <mark_field>.
*&SPWIZARD: END OF LOCAL DATA------------------------------------------*

  ASSIGN (p_tc_name) TO <tc>.

*&SPWIZARD: get the table, which belongs to the tc                     *
  CONCATENATE p_table_name '[]' INTO l_table_name. "table body
  ASSIGN (l_table_name) TO <table>.                "not headerline

*&SPWIZARD: demark all filled lines                                    *
  LOOP AT <table> ASSIGNING <wa>.

*&SPWIZARD: access to the component 'FLAG' of the table header         *
    ASSIGN COMPONENT p_mark_name OF STRUCTURE <wa> TO <mark_field>.

    <mark_field> = space.
  ENDLOOP.
ENDFORM.                                          "fcode_tc_mark_lines
""* Begin of changes by AKOTA for CR 668561
FORM fcode_tc_find USING p_tc_name
                         p_table_name
                         p_mark_name
                         p_ok.

  DATA: lv_tc_new_top_line TYPE i,
        lv_tc_name         TYPE scrfname,
        lv_tc_lines_name   TYPE scrfname,
        lv_tc_field_name   TYPE scrfname,
        lt_fields          TYPE TABLE OF sval,
        ls_fields          TYPE sval.

  FIELD-SYMBOLS: <fs_tc>    TYPE cxtab_control,
                 <fs_lines> TYPE i.

  ASSIGN (p_tc_name) TO <fs_tc>.

  " Get lines of table control                              *
  CONCATENATE 'G_' p_tc_name '_LINES' INTO lv_tc_lines_name.
  ASSIGN (lv_tc_lines_name) TO <fs_lines>.

  CLEAR: ls_fields.
  ls_fields-tabname = 'PRPS'.
  ls_fields-fieldname = 'POSID'.
  APPEND ls_fields TO lt_fields.

  CALL FUNCTION 'POPUP_GET_VALUES'
    EXPORTING
      popup_title = 'Find WBS element'
    TABLES
      fields      = lt_fields.

  READ TABLE lt_fields INTO ls_fields INDEX 1.

  IF sy-subrc EQ 0.
    READ TABLE lt_table WITH KEY pspid = ls_fields-value
      TRANSPORTING NO FIELDS.
    IF sy-subrc EQ 0.
      lv_tc_new_top_line = sy-tabix.
      " Set the new top line
      <fs_tc>-top_line = lv_tc_new_top_line.
      SET CURSOR FIELD 'ZWBS_ITEM-PSPID' LINE lv_tc_new_top_line.
    ENDIF.
  ENDIF.

ENDFORM.
""* Begin of changes by AKOTA for CR 668561

*&---------------------------------------------------------------------*
*&      Form  GET_TEXT
*&---------------------------------------------------------------------*
FORM get_text.

  CHECK sy-batch IS INITIAL AND sy-binpt IS INITIAL.

  CLEAR:ls_text,lt_text.

  CALL METHOD lo_editor->get_text_as_r3table
    IMPORTING
      table = lt_text.

  CALL METHOD lo_editor->flush.

*Check for Additional Lines
  IF lines( lt_text ) > lv_rlines.
    READ TABLE lt_text INTO ls_text INDEX ( lv_rlines + 1 ).
    IF ls_text IS INITIAL.
      DELETE lt_text INDEX ( lv_rlines + 1 ).
    ENDIF.
  ENDIF.

*  CHECK ok_code EQ 'SUBMIT'   OR
*        ok_code EQ 'RESUBMIT' OR
*        ok_code EQ 'EXAMINE'  OR
*        ok_code EQ 'APPROVE'  OR
*        ok_code EQ 'REJECT'.
*
*  IF lt_text IS INITIAL.
*    MESSAGE e368(00) WITH text-019.
*  ENDIF.
*  IF sy-ucomm = 'REJECT'.
*    IF lt_text IS INITIAL.
*      MESSAGE 'Please type rejection reason in the Remark area below' TYPE 'E'.
*    ELSE.
*      EXPORT lt_text = lt_text TO MEMORY ID 'REJECT'.
*    ENDIF.
*  ENDIF.
ENDFORM.                    " GET_TEXT
*&--------------------------------------------------------------------*
*&      Form  CREATE_TEXT_EDITOR
*&--------------------------------------------------------------------*
FORM create_text_editor .

  CHECK sy-batch IS INITIAL AND sy-binpt IS INITIAL.

  IF lo_editor IS INITIAL.
    CREATE OBJECT lo_editor
      EXPORTING
        repid                      = sy-repid
        dynnr                      = sy-dynnr
        dynpro_container           = 'REMARKS'
        wordwrap_mode              = 2
        wordwrap_position          = 72
        wordwrap_to_linebreak_mode = 1.
  ENDIF.

  CHECK lo_editor IS BOUND.

  IF lines( lt_text ) = lv_rlines AND NOT lt_text IS INITIAL.
    APPEND INITIAL LINE TO lt_text.
  ENDIF.
  CALL METHOD lo_editor->set_text_as_r3table
    EXPORTING
      table = lt_text.

  IF NOT lt_text IS INITIAL AND NOT lv_rlines IS INITIAL.
    CALL METHOD lo_editor->select_lines
      EXPORTING
        from_line = 1
        to_line   = lv_rlines.
    CALL METHOD lo_editor->protect_selection
      EXPORTING
        protect_mode = lc_true.
    CALL METHOD lo_editor->set_selection_pos_in_line
      EXPORTING
        line                   = ( lv_rlines + 1 )
        pos                    = 0
      EXCEPTIONS
        error_cntl_call_method = 1
        OTHERS                 = 2.
    IF sy-subrc <> 0.
*    implement suitable error handling here
    ENDIF.
  ENDIF.

*--- statusbar in text-control
  CALL METHOD lo_editor->set_statusbar_mode
    EXPORTING
      statusbar_mode = lc_true.

*--- Toolbar in text-control
  CALL METHOD lo_editor->set_toolbar_mode
    EXPORTING
      toolbar_mode = lc_true.

*Set Visibility for Remarks
  IF NOT lv_dflag IS INITIAL.
    CALL METHOD lo_editor->set_readonly_mode
      EXPORTING
        readonly_mode          = lc_true
      EXCEPTIONS
        error_cntl_call_method = 1
        invalid_parameter      = 2
        OTHERS                 = 3.
    IF sy-subrc <> 0.
    ENDIF.
  ENDIF.

  CALL METHOD lo_editor->flush.

ENDFORM.                    " CREATE_TEXT_EDITOR
*&--------------------------------------------------------------------*
*&      Form  SUBMIT_DATA
*&--------------------------------------------------------------------*
FORM submit_data.

  CHECK lv_error IS INITIAL.

  CLEAR:ls_head,lt_wbs_item.

  MOVE-CORRESPONDING zwbs_header TO ls_head.
*Request Number
  PERFORM get_request CHANGING ls_head.

  PERFORM collect_data USING 'S' ' '.

  PERFORM update_data.
*Clear Buffers to avoid Lock Issues on Project/WBS
  PERFORM clear_proj_buffer.
*Workflow
  PERFORM workflow USING lc_submit.

  PERFORM status_message.

ENDFORM.                    " SUBMIT_DATA
*&--------------------------------------------------------------------*
*&      Form  GET_REQUEST
*&--------------------------------------------------------------------*
FORM get_request  CHANGING cs_head TYPE zwbs_header.

  IF cs_head-request IS INITIAL.
    IF zwbs_header-request IS INITIAL.
      CALL FUNCTION 'NUMBER_GET_NEXT'
        EXPORTING
          nr_range_nr             = '01'
          object                  = 'ZPSR_REQNO'
          quantity                = '1'
          toyear                  = '0000'
        IMPORTING
          number                  = zwbs_header-request
        EXCEPTIONS
          interval_not_found      = 1
          number_range_not_intern = 2
          object_not_found        = 3
          quantity_is_0           = 4
          quantity_is_not_1       = 5
          interval_overflow       = 6
          buffer_overflow         = 7
          OTHERS                  = 8.
      IF sy-subrc <> 0.
      ENDIF.
    ENDIF.
    cs_head-request       = zwbs_header-request.
    cs_head-created_by    = sy-uname.
    cs_head-created_on    = sy-datum.
    cs_head-creation_time = sy-uzeit.
  ELSE.
    cs_head-changed_by  = sy-uname.
    cs_head-changed_on  = sy-datum.
    cs_head-change_time = sy-uzeit.
  ENDIF.

ENDFORM.                    " GET_REQUEST
*&--------------------------------------------------------------------*
*&      Form  COLLECT_DATA
*&--------------------------------------------------------------------*
FORM collect_data USING iv_type          TYPE char1
                        pv_approver_step TYPE flag.

*Action
*S - 'SUBMIT'
*A - 'APPROVE'
*R - 'REJECT'
*D - 'DELETE'
*C - CANCELLED
*'' - 'SAVE'

*Status
*0  Saved/Incomplete
*1  Submitted
*2  Accepted
*3  Rejected
*6  Deleted
*Record Status
  CASE iv_type.
    WHEN ' '.
      ls_head-status = 0.
      lv_status      = 'Saved'.
    WHEN 'S'.
      ls_head-status = 1.
      lv_status      = 'Submitted'.
    WHEN 'A'.
      ls_head-status = 2.
      lv_status      = 'Approved'.
      lv_wf_status   = 'A'.
    WHEN 'R'.
      ls_head-status = 3.
      lv_status      = 'Rejected'.
      lv_wf_status   = 'R'.
    WHEN 'D'.
      ls_head-status = 6.
      lv_status      = 'Deleted'.
      lv_wf_status   = 'D'.
    WHEN 'C'.
      ls_head-status = 6.
      lv_status      = 'Cancelled'.
      lv_wf_status   = 'C'.
  ENDCASE.

*  IF lv_proj3 = 'X'      AND
  IF lv_proj_type = 'TC'     AND
     sy-ucomm     = 'SUBMIT' AND
     lv_type      = '1'.
    PERFORM fcode_total_up.
    DELETE lt_table WHERE budget IS INITIAL.
    IF lt_table IS INITIAL.
      lv_no_budget = 'X'.
      MESSAGE 'Request cannot be submitted with empty Budget' TYPE 'E'.
      EXIT." LEAVE SCREEN.
    ENDIF.
  ENDIF.

*  IF lv_proj3 = 'X' AND
  IF lv_proj_type = 'TC'     AND
     sy-ucomm     = 'SUBMIT' AND
     lv_type      = '2'.
    READ TABLE lt_table INTO ls_table WITH KEY stufe = '1'.
    IF sy-subrc = 0.
      SELECT SINGLE * FROM prps INTO @DATA(ls_prps_uni) WHERE posid = @ls_table-pspid.
      IF sy-subrc = 0 AND ls_prps_uni-zunifier_proj IS INITIAL.
        PERFORM fcode_total_up.
      ENDIF.
    ENDIF.
  ENDIF.
*Update Records
  LOOP AT lt_table INTO ls_table.
    CLEAR:ls_item,ls_item_db.
    MOVE-CORRESPONDING ls_table TO ls_item.
    ls_item-request   = ls_head-request.
*    ls_item-pspid_new = ls_item-pspid.
*Database Values
    READ TABLE lt_wbs_item_db INTO ls_item_db
                              WITH KEY request = ls_item-request
                                       pspid   = ls_item-pspid.
    IF sy-subrc = 0.
*Creation Details
      ls_item-created_by    = ls_item_db-created_by.
      ls_item-created_on    = ls_item_db-created_on.
      ls_item-creation_time = ls_item_db-creation_time.
*Last Change Details
      ls_item-changed_by    = sy-uname.
      ls_item-changed_on    = sy-datum.
      ls_item-change_time   = sy-uzeit.
    ELSE.
*Creation Details
*      IF lv_proj3 IS INITIAL.
      ls_item-pspid_new     = ls_item-pspid.
*      ELSE.
*        ls_item-pspid         = ls_table-pspid_new.
*      ENDIF.
      ls_item-created_by    = sy-uname.
      ls_item-created_on    = sy-datum.
      ls_item-creation_time = sy-uzeit.
    ENDIF.
*Assign Project Definition for WBS during Approval
    IF NOT   ls_head-pspid IS INITIAL AND
             ls_head-type = 1         AND
             iv_type      = 'A'       AND
             pv_approver_step = abap_false.
      " Skip this check for approver Steps
      ls_item-pspid_new+0(lv_offset) = ls_head-pspid+0(lv_offset).
    ENDIF.

    APPEND ls_item TO lt_wbs_item.
  ENDLOOP.

*Deleted Records
  LOOP AT lt_table_dl INTO ls_table.
    CLEAR:ls_item,ls_item_db.
    MOVE-CORRESPONDING ls_table TO ls_item.
    ls_item-request = ls_head-request.
    READ TABLE lt_wbs_item_db INTO ls_item_db
                              WITH KEY request = ls_item-request
                                       pspid   = ls_item-pspid.
    IF sy-subrc = 0.
*Creation Details
      ls_item-created_by    = ls_item_db-created_by.
      ls_item-created_on    = ls_item_db-created_on.
      ls_item-creation_time = ls_item_db-creation_time.
*Last Change Details
      ls_item-changed_by    = sy-uname.
      ls_item-changed_on    = sy-datum.
      ls_item-change_time   = sy-uzeit.
*Set Deletion
      ls_item-deleted       = abap_true.

      APPEND ls_item TO lt_wbs_item.
    ENDIF.
  ENDLOOP.

  SORT lt_wbs_item.

ENDFORM.                    " COLLECT_DATA
*&--------------------------------------------------------------------*
*&      Form  UPDATE_DATA
*&--------------------------------------------------------------------*
FORM update_data.
*  DATA: lv_pspid_len5 TYPE char2.
*  DATA: lv_pspid_len4 TYPE char2.
*  DATA: lv_pspid_len3 TYPE char2.
*  DATA: lv_pspid_len2 TYPE char2.
*  DATA: lv_len(2) TYPE n.
*  IF lv_proj3 = 'X' AND sy-ucomm = 'SUBMIT' AND
*       lv_type = '1'."OR gv_capex IS NOT
*
*    SORT lt_wbs_item BY stufe DESCENDING.
*    READ TABLE lt_wbs_item INTO ls_item INDEX 1.
*    IF sy-subrc = 0.
*      DATA(lv_stufe5) = ls_item-stufe.
*      lv_pspid_len5 = strlen( ls_item-pspid_new ).
**      l_ok          = p_ok+l_offset.
*    ENDIF.
*
*    " Level 5 deletion.
*    CLEAR: ls_item.
*    LOOP AT lt_wbs_item INTO ls_item WHERE stufe = lv_stufe5.
*      IF ls_item-budget IS INITIAL.
*        IF ls_item-stufe NE 1.
*          DELETE lt_wbs_item.
*        ENDIF.
*      ENDIF.
*    ENDLOOP.
*
*    "Level 4 deletion
*    DATA(lv_stufe4)     = lv_stufe5 - 1.
*    lv_pspid_len4 = lv_pspid_len5 - 1.
*    CLEAR: ls_item.
*    LOOP AT lt_wbs_item INTO ls_item WHERE stufe = lv_stufe4.
*      LOOP AT lt_wbs_item INTO DATA(ls_item4) WHERE stufe = lv_stufe5.
*        IF ls_item4-pspid_new+0(lv_pspid_len4) =
*           ls_item-pspid_new+0(lv_pspid_len4).
*          DATA(lv_flag) = 'X'.
*          EXIT.
*        ENDIF.
*      ENDLOOP.
*      IF lv_flag IS INITIAL.
*        IF ls_item-stufe NE 1.
*          DELETE lt_wbs_item.
*        ENDIF.
*      ENDIF.
*      CLEAR: lv_flag.
**        READ TABLE lt_wbs_item INTO DATA(ls_item4) WITH KEY
**                stufe = lv_stufe5.
**        pspid_new = ls_item-pspid_new+0(lv_pspid_len4).
**        IF sy-subrc NE 0.
**          DELETE lt_wbs_item.
**        ENDIF.
*    ENDLOOP.
*
*    "Level 3 deletion.
*    DATA(lv_stufe3) = lv_stufe4 - 1.
*    lv_pspid_len3 = lv_pspid_len4 - 1.
*    CLEAR: ls_item.
*    LOOP AT lt_wbs_item INTO ls_item WHERE stufe = lv_stufe3.
*      CLEAR: ls_item4, lv_flag.
*      LOOP AT lt_wbs_item INTO ls_item4 WHERE stufe = lv_stufe5.
*        IF ls_item4-pspid_new+0(lv_pspid_len3) =
*           ls_item-pspid_new+0(lv_pspid_len3).
*          lv_flag = 'X'.
*          EXIT.
*        ENDIF.
*      ENDLOOP.
*      IF lv_flag IS INITIAL.
*        IF ls_item-stufe NE 1.
*          DELETE lt_wbs_item.
*        ENDIF.
*      ENDIF.
*      CLEAR: lv_flag.
**        READ TABLE lt_wbs_item INTO ls_item4 WITH KEY
**            stufe = lv_stufe5
**        pspid_new = ls_item-pspid_new+0(lv_pspid_len3).
**        IF sy-subrc NE 0.
**          DELETE lt_wbs_item.
**        ENDIF.
*    ENDLOOP.
*
*    "Level 2 Deletion.
*    DATA(lv_stufe2) = lv_stufe3 - 1.
*    lv_pspid_len2 = lv_pspid_len3 - 1.
*    CLEAR: ls_item.
*    LOOP AT lt_wbs_item INTO ls_item WHERE stufe = lv_stufe2.
*      CLEAR: ls_item4, lv_flag.
*      LOOP AT lt_wbs_item INTO ls_item4 WHERE stufe = lv_stufe5.
*        IF ls_item4-pspid_new+0(lv_pspid_len2) =
*           ls_item-pspid_new+0(lv_pspid_len2).
*          lv_flag = 'X'.
*          EXIT.
*        ENDIF.
*      ENDLOOP.
*      IF lv_flag IS INITIAL.
*        IF ls_item-stufe NE 1.
*          DELETE lt_wbs_item.
*        ENDIF.
*      ENDIF.
*      CLEAR: lv_flag.
*    ENDLOOP.
*    SORT lt_wbs_item.

*  ENDIF.
*Update Database
  IF NOT ls_head IS INITIAL.
    MODIFY zwbs_header FROM ls_head.
  ENDIF.
  IF NOT lt_wbs_item IS INITIAL.
    MODIFY zwbs_item FROM TABLE lt_wbs_item.
  ENDIF.

*Update Texts
  PERFORM update_text_data.

*Update Change log.
  PERFORM register_log.

ENDFORM.                    " UPDATE_DATA
*&--------------------------------------------------------------------*
*&      Form  WORKFLOW
*&--------------------------------------------------------------------*
FORM workflow USING iv_event TYPE swr_struct-event.

  DATA:lv_object_type     TYPE swr_struct-object_typ,
       lv_object_key      TYPE swr_struct-object_key,
       lv_event           TYPE swr_struct-event,
       lv_commit          TYPE swr_struct-commitflag,
       lv_return_code     LIKE sy-subrc,
       lv_event_id        LIKE swr_struct-event_id,
       lv_agent           TYPE swd_aobjid,
       lv_reqno_temp      TYPE char10,
       lt_input_container TYPE STANDARD TABLE OF swr_cont,
       ls_input_container TYPE swr_cont,
       lt_message_lines   TYPE STANDARD TABLE OF swr_messag,
       lt_message_struct  TYPE STANDARD TABLE OF swr_mstruc.

  DATA:lv_capex_approver   TYPE char10,
       lv_pm_approver      TYPE char10,
       lv_co_approver      TYPE char14,
       lv_r2r_acc_approver TYPE char10,
       lv_auto_approver    TYPE flag,
       lv_md_approver      TYPE char10,
       lv_r2r_sr_approver  TYPE char10.

  CLEAR:lv_object_type,lv_object_key,lv_event,lv_commit,lv_return_code,
        lv_event_id,ls_input_container,lv_agent,lv_reqno_temp,
        lv_pm_approver,lv_co_approver,lv_r2r_acc_approver,
        lv_auto_approver,
        lv_md_approver,lv_r2r_sr_approver.

  REFRESH:lt_input_container,lt_message_lines,lt_message_struct.

  PERFORM get_positions CHANGING "lv_capex_approver
                                 lv_pm_approver
                                 lv_co_approver
                                 lv_r2r_acc_approver
                                 lv_auto_approver
                                 lv_md_approver
                                 lv_r2r_sr_approver.

*--Set Workflow parameters
  lv_object_type = 'Z_WBS'.
  lv_object_key  = zwbs_header-request.
  lv_event       = iv_event.
  lv_commit      = ' '.

  PERFORM fill_container_elements USING "lv_capex_approver
                                        lv_pm_approver
                                        lv_co_approver
                                        lv_r2r_acc_approver
                                        lv_auto_approver
                                        lv_md_approver
                                        lv_r2r_sr_approver
                               CHANGING lt_input_container.

  CALL FUNCTION 'SAP_WAPI_CREATE_EVENT'
    EXPORTING
      object_type     = lv_object_type
      object_key      = lv_object_key
      event           = lv_event
      commit_work     = lv_commit
      user            = sy-uname
    IMPORTING
      return_code     = lv_return_code
      event_id        = lv_event_id
    TABLES
      input_container = lt_input_container
      message_lines   = lt_message_lines
      message_struct  = lt_message_struct.

  IF lv_return_code NE 0 OR lv_event_id IS INITIAL.
    ROLLBACK WORK.
  ELSE.
    COMMIT WORK AND WAIT.
  ENDIF.

ENDFORM.                    " WORKFLOW
*&--------------------------------------------------------------------*
*&      Form  STATUS_MESSAGE
*&--------------------------------------------------------------------*
FORM status_message.

  CHECK lv_error IS INITIAL.

  CLEAR lv_text.
  CONCATENATE 'Request' ls_head-request lv_status INTO lv_text
              SEPARATED BY space.
  MESSAGE i368(00) WITH lv_text.
  IF lv_wf_status IS INITIAL.
    PERFORM clear_proj_buffer.
*    IF ok_code = 'SUBMIT'.
*      CALL TRANSACTION 'ZCJ00'.
*    ELSE.
    LEAVE TO SCREEN 0.
*    ENDIF.
  ELSE.
    LEAVE PROGRAM.
  ENDIF.

ENDFORM.                    " STATUS_MESSAGE
*&---------------------------------------------------------------------*
*&      Form  GET_REQUEST_DATA
*&---------------------------------------------------------------------*
FORM get_request_data.

  DATA:lv_pm_approver_step      TYPE flag,
       lv_capex_approver_step   TYPE flag,
       lv_co_approver_step      TYPE flag,
       lv_r2r_acc_approver_step TYPE flag,
       lv_r2r_sr_approver_step  TYPE flag.

  CLEAR:ls_head,lt_wbs_item,lt_wbs_item_db,lt_table,ls_default,lv_type,
        lv_dflag,lv_sflag,lv_wf_flag,lv_cflag,lv_rflag,
        lv_pm_approver_step,
        lv_co_approver_step,lv_r2r_acc_approver_step,
        lv_r2r_sr_approver_step,
        lv_init_run,lv_ucflag,lt_table_init,ls_head_db,ls_proj,
        ls_head_init, sy-ucomm,ls_proj_templ.

  REFRESH CONTROL:'TC_WBS'   FROM SCREEN '0500',
                  'TC_CAPEX' FROM SCREEN '0900'.

  IMPORT:gv_at_capex_approver_step = gv_at_capex_approver_step
  " --> Other Steps
"FROM MEMORY ID 'ZWBS_AT_CAPEX_APPROVER_STEP',
         gv_at_pm_approver_step = gv_at_pm_approver_step
         " --> Other Steps
                                  FROM MEMORY ID
                                  'ZWBS_AT_PM_APPROVER_STEP',
         gv_at_co_approver_step = gv_at_co_approver_step
         " --> Other Steps
                                  FROM MEMORY ID
                                  'ZWBS_AT_CO_APPROVER_STEP',
         gv_at_r2r_acc_approver_step = gv_at_r2r_acc_approver_step
         " --> Other Steps
                                       FROM MEMORY ID
                                       'ZWBS_AT_R2R_ACC_APPROVER_STEP',
         gv_at_r2r_sr_approver_step = gv_at_r2r_sr_approver_step
         " --> Other Steps
                                      FROM MEMORY ID
                                      'ZWBS_AT_R2R_SR_APPROVER_STEP',
         gv_auto_approver_step = gv_auto_approver_step
         " --> Other Steps
                                 FROM MEMORY ID
                                 'ZWBS_AUTO_APPROVER_STEP',
         lv_wf_flag = lv_wf_flag FROM MEMORY ID 'ZWBS_WF_FLAG'.

  IF gv_at_capex_approver_step IS NOT INITIAL.
    lv_capex_approver_step = abap_true.
  ELSEIF gv_at_pm_approver_step IS NOT INITIAL.
    lv_pm_approver_step = abap_true.
  ELSEIF gv_at_co_approver_step IS NOT INITIAL.
    lv_co_approver_step = abap_true.
  ELSEIF gv_at_r2r_acc_approver_step IS NOT INITIAL.
    lv_r2r_acc_approver_step = abap_true.
  ELSEIF gv_at_r2r_sr_approver_step IS NOT INITIAL.
    lv_r2r_sr_approver_step = abap_true.
  ENDIF.
*Check if we are using a Regular Request or a Saved Request
  IF lv_rb5 IS INITIAL.
    SELECT SINGLE * FROM zwbs_header INTO ls_head
                    WHERE request = zwbs_header-request.
  ELSE.
    SELECT SINGLE * FROM zwbs_header INTO ls_head
                    WHERE request = zwbs_header-request AND
                          status  = '0'.
  ENDIF.

  IF sy-tcode = 'ZCJ02N' AND NOT lv_wf_flag IS INITIAL.
*Lock Project for further Editing
    CALL FUNCTION 'CJDW_ENQUEUE'
      EXPORTING
        object_id         = ls_head-pspid
      EXCEPTIONS
        foreign_lock      = 1
        invalid_type      = 2
        missing_parameter = 3
        system_failure    = 4
        OTHERS            = 5.
    IF sy-subrc <> 0.
      IF NOT gv_auto_approver_step IS INITIAL."Auto Approval
        MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
      ELSE.
        MESSAGE ID sy-msgid TYPE 'I' NUMBER sy-msgno
                            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4
                            DISPLAY LIKE 'E'.
      ENDIF.
      EXIT.
    ENDIF.
  ENDIF.

*Case Type
  lv_type = ls_head-type.

  SELECT * FROM zwbs_item INTO TABLE lt_wbs_item
                          WHERE request = zwbs_header-request.

  CHECK NOT lt_wbs_item IS INITIAL.

  lt_wbs_item_db = lt_wbs_item.

  IF ls_head-type = 1.
    SELECT SINGLE * FROM proj INTO ls_proj
                    WHERE pspid = ls_head-pspid_templ.
  ELSE.
    SELECT SINGLE * FROM proj INTO ls_proj
                    WHERE pspid = ls_head-pspid.
  ENDIF.

  SELECT * FROM prps INTO TABLE lt_prps
                     FOR ALL ENTRIES IN lt_wbs_item
                     WHERE posid = lt_wbs_item-pspid.

  MOVE-CORRESPONDING:ls_head TO zwbs_header,
                     ls_proj TO ls_head_init,
                     ls_head TO ls_head_db.
*User Details
  PERFORM user_details USING zwbs_header-created_by.

*WBS Status
  CLEAR:lt_wbs_elements,lt_wbs_status.
  lt_wbs_elements = CORRESPONDING #( lt_wbs_item MAPPING wbs_element = pspid ).
  PERFORM get_wbs_status USING lt_wbs_elements.

  LOOP AT lt_wbs_item INTO ls_item.
    MOVE-CORRESPONDING ls_item TO ls_table.
    READ TABLE lt_prps INTO ls_prps WITH KEY posid = ls_item-pspid.
*Default Values while adding a new record
    IF ls_default IS INITIAL.
      ls_default = ls_table.
      ls_default-updkz = 'I'.
      CLEAR:ls_default-pspid,ls_default-post1,ls_default-stufe,
          ls_default-zasset,ls_default-zrevstr,ls_default-zarea,
          ls_default-zscopcha,ls_default-zopportunity_id,
          ls_default-zsynergy_id,ls_default-imprf,
          ls_default-zcustom,ls_default-mtart,ls_default-z_material,
          ls_default-pbukr,ls_default-pgsbr,ls_default-prctr,
          ls_default-werks,ls_default-zibpflag,ls_default-zibpflgmc,
          ls_default-belkz,ls_default-fakkz,ls_default-zibp_res_proj,
          ls_default-zibpaufnr,ls_default-zibpebeln,ls_default-zfcw,
          ls_default-zmaint_sys,ls_default-zstate_code_pv,
          ls_default-zstage_st_dt,ls_default-zstage_end_dt,
          ls_default-astnr_n,ls_default-astna,ls_default-vernr_n,
          ls_default-verna.
      ""* Changes by AKOTA for CR 668561
    ENDIF.
*Default Values in the table
    PERFORM assign_table_values USING 'X'.
*Status
    PERFORM assign_wbs_status CHANGING ls_table.

    APPEND ls_table TO lt_table.
    CLEAR:ls_table,ls_prps.
  ENDLOOP.

*Retrieve Texts
*Header Texts
  CLEAR:lv_rlines,lv_tdname,ls_header,lt_lines,lt_text,lt_remarks.
  lv_tdname = zwbs_header-request.
  PERFORM get_wbs_text USING lv_tdname lc_rem_id.
  IF NOT lt_lines IS INITIAL.
    lv_rlines = lines( lt_lines ).
    lt_text = CORRESPONDING #( lt_lines MAPPING text = tdline ).
    APPEND INITIAL LINE TO lt_text.
  ENDIF.
*Item Texts
  LOOP AT lt_table ASSIGNING <fs_table>.
    CLEAR:lv_tdname,ls_header,lt_lines.
    ls_table = <fs_table>.
    CONCATENATE ls_table-request ls_table-pspid INTO lv_tdname.
    PERFORM get_wbs_text USING lv_tdname lc_com_id.
    IF NOT lt_lines IS INITIAL.
      <fs_table>-long_text = abap_true.
      ls_remarks-pspid     = ls_table-pspid.
      ls_remarks-thead     = ls_header.
      ls_remarks-tline     = lt_lines.
      APPEND ls_remarks TO lt_remarks.
      CLEAR ls_remarks.
    ENDIF.
  ENDLOOP.
  UNASSIGN <fs_table>.

*Log Text
  CLEAR:lv_tdname,ls_header,lt_lines.
  lv_tdname = zwbs_header-request.
  PERFORM get_log_text USING lv_tdname.
  IF NOT lt_lines IS INITIAL.
    gt_log = CORRESPONDING #( lt_lines MAPPING text = tdline ).
  ENDIF.

  IF lv_pm_approver_step     = abap_false AND
     gv_auto_approver_step   = abap_false AND
    lv_co_approver_step      = abap_false AND
    lv_r2r_acc_approver_step = abap_false AND
    lv_r2r_sr_approver_step  = abap_false.
    IF lv_dflag IS INITIAL AND ls_head-status NE 1
                           AND ls_head-status NE 2.
      lv_dflag = abap_true.
    ENDIF.

    IF lv_wf_flag IS INITIAL.
      IF sy-tcode = 'ZCJ02N'.
        MESSAGE 'Changes not allowed, Display Only' TYPE 'I'.
      ENDIF.
      lv_dflag = abap_true.
      lv_sflag = abap_true.
    ENDIF.
  ENDIF.

*Check for Close & Unclose Case
  IF lv_type = 3.
    lv_cflag  = abap_true.
  ELSEIF lv_type = 4.
    lv_ucflag = abap_true.
  ENDIF.

*Check for R2R Settlement Rule Approver
  IF NOT lv_r2r_sr_approver_step IS INITIAL.
    lv_rflag = abap_true.
  ENDIF.

*Status Texts
  CLEAR:lv_stat,lv_req_type.
  SELECT SINGLE:text FROM t9m49 INTO lv_stat
                          WHERE status  = zwbs_header-status AND
                                sprache = lc_spras,
          ddtext FROM dd07t INTO lv_req_type
                            WHERE domname    = 'ZZWBS_TYPE' AND
                                  ddlanguage = lc_spras AND
                                  domvalue_l = lv_type.
*Mark for Intial Run to mark fields
  lv_init_run = abap_true.

*HOLD Initial Image for further processing
  APPEND LINES OF lt_table TO lt_table_init.

*Check for GROUPING flag based on Selected Template
  SELECT SINGLE * FROM zwbs_proj_templ INTO @ls_proj_templ
                  WHERE ( proj_type = @lv_proj_type           AND
                          b_unit    = @lv_bunit               AND
                          project   = @lv_template )          OR
                        ( proj_type = @zwbs_header-proj_type  AND
                          project   = @zwbs_header-pspid_templ ).

  CALL SCREEN 400.

ENDFORM.                    " GET_REQUEST_DATA
*&--------------------------------------------------------------------*
*&      Form  show_dms_link
*&--------------------------------------------------------------------*
*       Open a browser window and display the DMS url
*----------------------------------------------------------------------*
FORM show_dms_link USING iv_url TYPE char512.

* Datadeclarations (local)
  DATA:lo_container   TYPE REF TO cl_gui_custom_container,
       lo_html_viewer TYPE REF TO cl_gui_html_viewer,
       lv_url         TYPE char512.

  CHECK NOT iv_url IS INITIAL.

  lv_url = iv_url.

* Processing ----------------------------------------------------------
  CREATE OBJECT lo_html_viewer
    EXPORTING
      parent             = lo_container
    EXCEPTIONS
      cntl_error         = 1
      cntl_install_error = 2
      dp_install_error   = 3
      dp_error           = 4
      OTHERS             = 5.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
               WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    EXIT.
  ENDIF.

  CHECK lo_html_viewer IS BOUND.

* -- display URL
  CALL METHOD lo_html_viewer->show_url
    EXPORTING
      url                    = lv_url
      in_place               = ' '
    EXCEPTIONS
      cntl_error             = 1
      cnht_error_not_allowed = 2
      cnht_error_parameter   = 3
      dp_error_general       = 4
      OTHERS                 = 5.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
               WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

* -- destroy instance
  CALL METHOD lo_html_viewer->free
    EXCEPTIONS
      cntl_error        = 1
      cntl_system_error = 2
      OTHERS            = 3.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
               WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

  FREE lo_html_viewer.

ENDFORM.                    " show_dms_link
*&--------------------------------------------------------------------*
*&      Form  EXLCUDE_FCODE
*&--------------------------------------------------------------------*
FORM exlcude_fcode.

  CLEAR lt_fcode.

  CASE sy-tcode.
    WHEN 'ZCJ01'.
      APPEND:'DELETE'  TO lt_fcode,
             'APPROVE' TO lt_fcode,
             'REJECT'  TO lt_fcode.
*      IF lv_proj3 IS INITIAL.
      IF lv_proj_type NE 'TC'.
        APPEND: 'ATTACH'   TO lt_fcode,
                'DOWNLOAD' TO lt_fcode,
                'UPLOAD'   TO lt_fcode,
                'SAVE'     TO lt_fcode.
      ENDIF.
    WHEN 'ZCJ02N'.
      APPEND:'DELETE'   TO lt_fcode,
             'SUBMIT'   TO lt_fcode,
             'ATTACH'   TO lt_fcode,
             'DOWNLOAD' TO lt_fcode,
             'UPLOAD'   TO lt_fcode.
      IF NOT lv_sflag IS INITIAL.
        APPEND:'APPROVE' TO lt_fcode,
               'REJECT'  TO lt_fcode.
      ELSEIF NOT lv_rflag IS INITIAL.
        APPEND 'REJECT'  TO lt_fcode.
      ENDIF.
    WHEN 'ZCJ03'.
      APPEND:'SUBMIT'   TO lt_fcode,
             'DELETE'   TO lt_fcode,
             'ATTACH'   TO lt_fcode,
             'DOWNLOAD' TO lt_fcode,
             'UPLOAD'   TO lt_fcode,
             'APPROVE'  TO lt_fcode,
             'REJECT'   TO lt_fcode,
             'CANCEL'   TO lt_fcode,
             'EXIT'     TO lt_fcode,
             'SAVE'     TO lt_fcode.
    WHEN OTHERS.
  ENDCASE.

  IF sy-dynnr = '0100' OR sy-dynnr = '0700'.
    APPEND:'CANCEL' TO lt_fcode,
           'EXIT'   TO lt_fcode.
  ENDIF.

*Show Change log ONLY for CHANGE Scenario
  IF lv_type NE 2 OR sy-tcode = 'ZCJ01'.
    APPEND 'LOG' TO lt_fcode.
  ENDIF.
  IF sy-tcode = 'ZCJ03'.
    IF gv_capex IS INITIAL. "NE 'X'.
      APPEND 'APPR_LOG' TO lt_fcode.
    ENDIF.
  ELSE.
    APPEND 'APPR_LOG' TO lt_fcode.
  ENDIF.

*Cancel Request in case of Reopen Request
  IF lv_rb5 IS INITIAL.
    APPEND 'CANCEL_REQ' TO lt_fcode.
  ENDIF.

ENDFORM.                    " EXLCUDE_FCODE
*&---------------------------------------------------------------------*
*&      Form  SCREEN_0400
*&---------------------------------------------------------------------*
FORM screen_0400.

  CASE sy-tcode.
    WHEN 'ZCJ01'.
*      IF lv_proj3 IS NOT INITIAL OR
      IF lv_proj_type = 'TC' OR
         gv_capex IS NOT INITIAL.
        LOOP AT SCREEN.
          CASE zwbs_header-type.
            WHEN 1.
              CASE screen-name.
                WHEN 'ZWBS_HEADER-REQUEST'       OR
                     "'ZWBS_HEADER-CREATED_BY'    OR
                     'ZWBS_HEADER-CREATED_ON'    OR
                     'ZWBS_HEADER-CREATION_TIME' OR
                     'ZWBS_HEADER-CHANGED_BY'    OR
                     'ZWBS_HEADER-CHANGED_ON'    OR
                     'ZWBS_HEADER-CHANGE_TIME'   OR
                     'ZWBS_HEADER-STATUS'        OR
                     "'LV_FULLNAME'               OR
                     'LV_DEPARTMENT'             OR
                     'LV_LOCATION'               OR
                     'DEPARTMENT'                OR
                     'LOCATION'                  OR
                     'LV_STAT'                   OR
                     'ZWBS_HEADER-ZPRGMAN'       OR
                     'ZWBS_HEADER-ZPRODCOD'      OR
                  'ZWBS_HEADER-ZPRJ_CODE_PV'.
                  screen-active = 0.
                  MODIFY SCREEN.
                WHEN 'ZWBS_HEADER-PRCTR' OR
                     'ZWBS_HEADER-VBUKR' OR
                     'ZWBS_HEADER-PRCTR'.
                  screen-input = 0.
                  screen-required = 0.
                  MODIFY SCREEN.
*                WHEN 'ZWBS_HEADER-PLSEZ'.
*                  IF zwbs_header-izwek = 'LS'.
*                    screen-input = 0.
*                    MODIFY SCREEN.
*                  ENDIF.
              ENDCASE.
            WHEN 2.
              CASE screen-name.
                WHEN 'ZWBS_HEADER-REQUEST'       OR
                     "'ZWBS_HEADER-CREATED_BY'    OR
                     'ZWBS_HEADER-CREATED_ON'    OR
                     'ZWBS_HEADER-CREATION_TIME' OR
                     'ZWBS_HEADER-CHANGED_BY'    OR
                     'ZWBS_HEADER-CHANGED_ON'    OR
                     'ZWBS_HEADER-CHANGE_TIME'   OR
                     'ZWBS_HEADER-PSPID_TEMPL'   OR
                     'ZWBS_HEADER-STATUS'        OR
                     "'LV_FULLNAME'               OR
                     'LV_DEPARTMENT'             OR
                     'LV_LOCATION'               OR
                     'DEPARTMENT'                OR
                     'LOCATION'                  OR
                     'ZWBS_HEADER-ZPRGMAN'       OR
                     'ZWBS_HEADER-ZPRODCOD'      OR
                     'LV_STAT'                   OR
                     'ZWBS_HEADER-ZPRJ_CODE_PV'.
                  screen-active = 0.
                  MODIFY SCREEN.
                WHEN 'ZWBS_HEADER-PRCTR' OR
                      'ZWBS_HEADER-VBUKR' OR
                      'ZWBS_HEADER-PRCTR' OR
                      'ZWBS_HEADER-PLSEZ'.
                  screen-input = 0.
                  screen-required = 0.
                  MODIFY SCREEN.
              ENDCASE.
          ENDCASE.
        ENDLOOP.
      ELSE.
        LOOP AT SCREEN.
          CASE zwbs_header-type.
            WHEN 1.
*              CASE screen-group1.
*                WHEN 'CPX'.
*                  screen-active = 0.
*                  MODIFY SCREEN.
*              ENDCASE.
              CASE screen-name.
                WHEN 'ZWBS_HEADER-REQUEST'       OR
                     'ZWBS_HEADER-CREATED_BY'    OR
                     'ZWBS_HEADER-CREATED_ON'    OR
                     'ZWBS_HEADER-CREATION_TIME' OR
                     'ZWBS_HEADER-CHANGED_BY'    OR
                     'ZWBS_HEADER-CHANGED_ON'    OR
                     'ZWBS_HEADER-CHANGE_TIME'   OR
                     'ZWBS_HEADER-STATUS'        OR
                     'LV_FULLNAME'               OR
                     'LV_DEPARTMENT'             OR
                     'LV_LOCATION'               OR
                     'DEPARTMENT'                OR
                     'LOCATION'                  OR
                     'ZWBS_HEADER-ASTNA'         OR
                     'ZWBS_HEADER-ASTNR'         OR
                     'ZWBS_HEADER-VERNA'         OR
                     'ZWBS_HEADER-VERNR'         OR
                     'LV_STAT'                   OR
                     'ZWBS_HEADER-PLFAZ'         OR
                     'ZWBS_HEADER-IZWEK'.
*                  screen-input = 0.
*                  screen-invisible = 1.
                  screen-active = 0.
                  MODIFY SCREEN.
              ENDCASE.
            WHEN 2.
              CASE screen-name.
                WHEN 'ZWBS_HEADER-REQUEST'       OR
                     'ZWBS_HEADER-CREATED_BY'    OR
                     'ZWBS_HEADER-CREATED_ON'    OR
                     'ZWBS_HEADER-CREATION_TIME' OR
                     'ZWBS_HEADER-CHANGED_BY'    OR
                     'ZWBS_HEADER-CHANGED_ON'    OR
                     'ZWBS_HEADER-CHANGE_TIME'   OR
                     'ZWBS_HEADER-PSPID_TEMPL'   OR
                     'ZWBS_HEADER-STATUS'        OR
                     'LV_FULLNAME'               OR
                     'LV_DEPARTMENT'             OR
                     'LV_LOCATION'               OR
                     'DEPARTMENT'                OR
                     'LOCATION'                  OR
                     'ZWBS_HEADER-ASTNA'         OR
                     'ZWBS_HEADER-ASTNR'         OR
                     'ZWBS_HEADER-VERNA'         OR
                     'ZWBS_HEADER-VERNR'         OR
                     'LV_STAT'                   OR
                     'ZWBS_HEADER-PLFAZ'         OR
                     'ZWBS_HEADER-IZWEK'.
                  screen-active = 0.
                  MODIFY SCREEN.
              ENDCASE.
            WHEN 3.
              CASE screen-name.
                WHEN 'ZWBS_HEADER-REQUEST'       OR
                     'ZWBS_HEADER-CREATED_BY'    OR
                     'ZWBS_HEADER-CREATED_ON'    OR
                     'ZWBS_HEADER-CREATION_TIME' OR
                     'ZWBS_HEADER-CHANGED_BY'    OR
                     'ZWBS_HEADER-CHANGED_ON'    OR
                     'ZWBS_HEADER-CHANGE_TIME'   OR
                     'ZWBS_HEADER-PSPID_TEMPL'   OR
                     'ZWBS_HEADER-STATUS'        OR
                     'LV_FULLNAME'               OR
                     'LV_DEPARTMENT'             OR
                     'LV_LOCATION'               OR
                     'DEPARTMENT'                OR
                     'LOCATION'                  OR
                     'ZWBS_HEADER-ASTNA'         OR
                     'ZWBS_HEADER-ASTNR'         OR
                     'ZWBS_HEADER-VERNA'         OR
                     'ZWBS_HEADER-VERNR'         OR
                     'LV_STAT'                   OR
                     'ZWBS_HEADER-PLFAZ'         OR
                     'ZWBS_HEADER-IZWEK'.
                  screen-active = 0.
                  MODIFY SCREEN.
                WHEN OTHERS.
                  screen-input = 0.
                  MODIFY SCREEN.
              ENDCASE.
            WHEN 4.
              CASE screen-name.
                WHEN 'ZWBS_HEADER-REQUEST'       OR
                     'ZWBS_HEADER-CREATED_BY'    OR
                     'ZWBS_HEADER-CREATED_ON'    OR
                     'ZWBS_HEADER-CREATION_TIME' OR
                     'ZWBS_HEADER-CHANGED_BY'    OR
                     'ZWBS_HEADER-CHANGED_ON'    OR
                     'ZWBS_HEADER-CHANGE_TIME'   OR
                     'ZWBS_HEADER-PSPID_TEMPL'   OR
                     'ZWBS_HEADER-STATUS'        OR
                     'LV_FULLNAME'               OR
                     'LV_DEPARTMENT'             OR
                     'LV_LOCATION'               OR
                     'DEPARTMENT'                OR
                     'LOCATION'                  OR
                     'ZWBS_HEADER-ASTNA'         OR
                     'ZWBS_HEADER-ASTNR'         OR
                     'ZWBS_HEADER-VERNA'         OR
                     'ZWBS_HEADER-VERNR'         OR
                     'LV_STAT'                   OR
                     'ZWBS_HEADER-PLFAZ'         OR
                     'ZWBS_HEADER-IZWEK'.

                  screen-active = 0.
                  MODIFY SCREEN.
                WHEN OTHERS.
                  screen-input = 0.
                  MODIFY SCREEN.
              ENDCASE.
          ENDCASE.
        ENDLOOP.
      ENDIF.
    WHEN 'ZCJ02N'.
*      IF lv_proj3 IS NOT INITIAL OR
      IF lv_proj_type = 'TC' OR
         gv_capex IS NOT INITIAL.
        LOOP AT SCREEN.
          CASE zwbs_header-type.
            WHEN 1.
              CASE screen-name.
                WHEN "'ZWBS_HEADER-REQUEST'       OR
                     "'ZWBS_HEADER-CREATED_BY'    OR
                     "'ZWBS_HEADER-CREATED_ON'    OR
                     "'ZWBS_HEADER-CREATION_TIME' OR
                     "'ZWBS_HEADER-CHANGED_BY'    OR
                     "'ZWBS_HEADER-CHANGED_ON'    OR
                     "'ZWBS_HEADER-CHANGE_TIME'   OR
                     "'ZWBS_HEADER-STATUS'        OR
                     "'LV_FULLNAME'               OR
                     "'LV_DEPARTMENT'             OR
                     "'LV_LOCATION'               OR
                     "'DEPARTMENT'                OR
                     "'LOCATION'                  OR
                     "'LV_STAT'                   OR
                     'ZWBS_HEADER-ZPRGMAN'       OR
                     'ZWBS_HEADER-ZPRODCOD'      OR
                     'ZWBS_HEADER-ZPRJ_CODE_PV'.
                  screen-active = 0.
                  MODIFY SCREEN.

                WHEN 'ZWBS_HEADER-PRCTR' OR
                      'ZWBS_HEADER-VBUKR'.
                  screen-input = 0.
                  screen-required = 0.
                  MODIFY SCREEN.
              ENDCASE.

            WHEN 2.
              CASE screen-name.
                WHEN "'ZWBS_HEADER-REQUEST'       OR
                     "'ZWBS_HEADER-CREATED_BY'    OR
                     "'ZWBS_HEADER-CREATED_ON'    OR
                     "'ZWBS_HEADER-CREATION_TIME' OR
                     "'ZWBS_HEADER-CHANGED_BY'    OR
                     "'ZWBS_HEADER-CHANGED_ON'    OR
                     "'ZWBS_HEADER-CHANGE_TIME'   OR
                     "'ZWBS_HEADER-PSPID_TEMPL'   OR
                     "'ZWBS_HEADER-STATUS'        OR
                     "'LV_FULLNAME'               OR
                     "'LV_DEPARTMENT'             OR
                     "'LV_LOCATION'               OR
                     "'DEPARTMENT'                OR
                     "'LOCATION'                  OR
                     'ZWBS_HEADER-ZPRGMAN'       OR
                     'ZWBS_HEADER-ZPRODCOD'      OR
                     "'LV_STAT'                   OR
                     'ZWBS_HEADER-ZPRJ_CODE_PV'.
                  screen-active = 0.
                  MODIFY SCREEN.
                WHEN 'ZWBS_HEADER-PRCTR' OR
                    'ZWBS_HEADER-VBUKR'.
                  screen-input = 0.
                  screen-required = 0.
                  MODIFY SCREEN.

              ENDCASE.
          ENDCASE.
        ENDLOOP.
      ELSE.
        LOOP AT SCREEN.
          CASE zwbs_header-type.
            WHEN 2 OR 3 OR 4.
              CASE screen-name.
                WHEN 'ZWBS_HEADER-PSPID_TEMPL'.
                  screen-active = 0.
                  MODIFY SCREEN.
              ENDCASE.
          ENDCASE.
          CASE screen-name.
            WHEN 'ZWBS_HEADER-ZPRJ_CODE_PV'.
              IF zwbs_header-zprj_code_pv IS INITIAL.
                screen-active = 0.
                MODIFY SCREEN.
              ENDIF.
            WHEN 'ZWBS_HEADER-ASTNA' OR
                 'ZWBS_HEADER-ASTNR' OR
                 'ZWBS_HEADER-VERNA' OR
                 'ZWBS_HEADER-VERNR' OR
                 'ZWBS_HEADER-PLFAZ' OR
                 'ZWBS_HEADER-IZWEK'.
              screen-active = 0.
              MODIFY SCREEN.
          ENDCASE.
        ENDLOOP.
      ENDIF.
      IF NOT lv_cflag  IS INITIAL OR
         NOT lv_ucflag IS INITIAL OR
         NOT lv_dflag  IS INITIAL OR
         NOT lv_rflag  IS INITIAL.
        LOOP AT SCREEN.
          screen-input = 0.
          MODIFY SCREEN.
        ENDLOOP.
      ENDIF.
    WHEN 'ZCJ03'.
      LOOP AT lt_table INTO ls_table WHERE budget > 0.
*        lv_proj3 = 'X'.
        lv_proj_type = 'TC'.
        EXIT.
      ENDLOOP.
*      IF lv_proj3 IS NOT INITIAL OR
      IF lv_proj_type = 'TC' OR
         gv_capex IS NOT INITIAL.
        LOOP AT SCREEN.
          CASE screen-name.
            WHEN 'ZWBS_HEADER-ZPRGMAN' OR
                 'ZWBS_HEADER-ZPRODCOD' OR
                 'ZWBS_HEADER-ZPRJ_CODE_PV'.
              screen-active = 0.
              MODIFY SCREEN.
          ENDCASE.
        ENDLOOP.
      ELSE.
        LOOP AT SCREEN.
          CASE zwbs_header-type.
            WHEN 1 OR 2 OR 3 OR 4.
              CASE screen-name.
                WHEN 'ZWBS_HEADER-PSPID_TEMPL' OR
                  'ZWBS_HEADER-ASTNA' OR
                  'ZWBS_HEADER-ASTNR' OR
                 'ZWBS_HEADER-VERNA' OR
                 'ZWBS_HEADER-VERNR' OR
                 'ZWBS_HEADER-PLFAZ' OR
                 'ZWBS_HEADER-IZWEK'.
                  screen-active = 0.
                  MODIFY SCREEN.
              ENDCASE.
          ENDCASE.
          CASE screen-name.
            WHEN 'ZWBS_HEADER-ZPRJ_CODE_PV'.
              IF zwbs_header-zprj_code_pv IS INITIAL.
                screen-active = 0.
                MODIFY SCREEN.
              ENDIF.
          ENDCASE.
        ENDLOOP.
      ENDIF.
      LOOP AT SCREEN.
        screen-input = 0.
        MODIFY SCREEN.
      ENDLOOP.
  ENDCASE.

*Highlight Changed Values for Change Project Header
  IF lv_type = '2'.
    LOOP AT SCREEN.
      CASE screen-name.
        WHEN 'ZWBS_HEADER-WERKS'   OR
             'ZWBS_HEADER-POST1'   OR
             'ZWBS_HEADER-VGSBR'   OR
*             'ZWBS_HEADER-ZPRGMAN' OR
             'ZWBS_HEADER-PLSEZ'   OR
             'ZWBS_HEADER-PRCTR'.
          CLEAR lv_field.
          lv_field = screen-name+12.
          ASSIGN COMPONENT lv_field OF STRUCTURE zwbs_header  TO
          FIELD-SYMBOL(<fs1>).
          IF sy-tcode = 'ZCJ01'.
            ASSIGN COMPONENT lv_field OF STRUCTURE ls_head_db
                                      TO FIELD-SYMBOL(<fs2>).
          ELSE.
            ASSIGN COMPONENT lv_field OF STRUCTURE ls_head_init
                                      TO <fs2>.
          ENDIF.
          IF <fs1> IS ASSIGNED AND
             <fs2> IS ASSIGNED AND
             <fs1> NE <fs2>.
            screen-intensified = 1.
          ENDIF.
          UNASSIGN:<fs1>,<fs2>.
          MODIFY SCREEN.
        WHEN OTHERS.
      ENDCASE.
    ENDLOOP.
  ENDIF.

ENDFORM.                    " SCREEN_0400
*&---------------------------------------------------------------------*
*&      Form  CLEAR_PROJ_BUFFER
*&---------------------------------------------------------------------*
FORM clear_proj_buffer .

  CALL FUNCTION 'CNPB_H_PROJ_HIER_REFRESH'.

  CALL FUNCTION 'CJPN_FREE_BUFFER'.

  CALL FUNCTION 'CJDW_DEQUEUE_ALL'.

ENDFORM.                    " CLEAR_PROJ_BUFFER
*&---------------------------------------------------------------------*
*&      Form  ASSIGN_TABLE_VALUES
*&---------------------------------------------------------------------*
FORM assign_table_values USING iv_flag.

*Plant Name
  IF NOT ls_table-werks IS INITIAL.
    SELECT SINGLE name1 FROM t001w INTO ls_table-werks_name
                        WHERE werks = ls_table-werks.
  ENDIF.

*Asset Box Name
  IF NOT ls_table-zasset IS INITIAL.
    SELECT SINGLE box_name FROM zfasset_box INTO ls_table-box_name
                           WHERE asset_box = ls_table-zasset.
  ENDIF.

*Revenue Stream Text
  IF NOT ls_table-zrevstr IS INITIAL.
    SELECT SINGLE zrevstr_name FROM zkrevstr INTO ls_table-zrevstr_name
                               WHERE zrevstr = ls_table-zrevstr.
  ENDIF.

*Misc. Categroy Text
  IF NOT ls_table-zarea IS INITIAL.
    SELECT SINGLE zarea_name FROM zkarea INTO ls_table-zarea_name
                             WHERE zarea = ls_table-zarea.
  ENDIF.

*Status of Contract Text
  IF NOT ls_table-zscopcha IS INITIAL.
    SELECT SINGLE zscopcha_name FROM zkscopcha INTO
    ls_table-zscopcha_name
                             WHERE zscopcha = ls_table-zscopcha.
  ENDIF.

*Synergy Sales Text
  IF NOT ls_table-zsynergy_id IS INITIAL.
    SELECT SINGLE zsynergy_type FROM zwbs_synergy INTO
    ls_table-zsynergy_type
                      WHERE zsynergy_id = ls_table-zsynergy_id
                      .
  ENDIF.

*Sold-to party Name
  IF NOT ls_table-zcustom IS INITIAL.
    SELECT SINGLE name1 FROM kna1 INTO ls_table-kunag_name
                           WHERE kunnr = ls_table-zcustom.
  ENDIF.

*Material Description
  IF NOT ls_table-z_material IS INITIAL.
    SELECT SINGLE maktx FROM makt INTO ls_table-maktx
                     WHERE matnr = ls_table-z_material AND
                           spras = 'E'.
    IF ls_table-mtart IS INITIAL.
      SELECT SINGLE mtart FROM mara INTO ls_table-mtart
                      WHERE matnr = ls_table-z_material.
    ENDIF.
  ENDIF.

  CHECK iv_flag IS INITIAL.

*Custom Fields Control
  CLEAR:ls_cf_control,lv_cf_control.
  SELECT SINGLE * FROM zwbs_cf_control INTO ls_cf_control
                                       WHERE proj_type =
                                    zwbs_header-proj_type
                              AND  bukrs = ls_table-pbukr
                             AND  prctr = ls_table-prctr.
  " PRCTR check added as part of CR 626062
* CR 626062--> New Access Sequence Added.
  IF sy-subrc <> 0.
    SELECT SINGLE * FROM zwbs_cf_control INTO ls_cf_control
                                    WHERE proj_type =
                                    zwbs_header-proj_type
                                     AND  bukrs = '*'
                               AND  prctr = ls_table-prctr.
    IF sy-subrc <> 0.
      SELECT SINGLE * FROM zwbs_cf_control INTO ls_cf_control
                                   WHERE proj_type =
                                   zwbs_header-proj_type
                                  AND  bukrs = ls_table-pbukr
                                  AND  prctr = '*'.
      IF sy-subrc <> 0.
        SELECT SINGLE * FROM zwbs_cf_control INTO ls_cf_control
                                   WHERE proj_type =
                                   zwbs_header-proj_type
                                    AND  bukrs = '*'
                                    AND  prctr = '*'.
      ENDIF.
    ENDIF.
  ENDIF.
* CR 626062 ended

*Default for Levels other than 1 and 2.
  IF ls_table-stufe   NE 1           AND
     ls_table-stufe   NE 2           AND
ls_temp-stufe    IS INITIAL     AND  "First Time Access
lv_init_run      IS NOT INITIAL AND
( ls_table-zchange IS NOT INITIAL OR zwbs_header-type EQ 1 ).
    IF NOT ls_cf_control IS INITIAL.
      CASE ls_table-stufe.
        WHEN 3.
          IF NOT ls_cf_control-level3 IS INITIAL.
            lv_cf_control = abap_true.
          ENDIF.
        WHEN 4.
          IF NOT ls_cf_control-level4 IS INITIAL.
            lv_cf_control = abap_true.
          ENDIF.
        WHEN 5.
          IF NOT ls_cf_control-level5 IS INITIAL.
            lv_cf_control = abap_true.
          ENDIF.
        WHEN 6.
          IF NOT ls_cf_control-level6 IS INITIAL.
            lv_cf_control = abap_true.
          ENDIF.
      ENDCASE.
    ENDIF.
    IF NOT lv_cf_control IS INITIAL.
*Indicator: Account assignment element
      ls_table-belkz = abap_true.
*Indicator: Billing element
      ls_table-fakkz = abap_true.
    ENDIF.
  ENDIF.

ENDFORM.                    " ASSIGN_TABLE_VALUES
*&---------------------------------------------------------------------*
*&      Form  VALIDATE_DATA
*&---------------------------------------------------------------------*
FORM validate_data.

  DATA:lv_bukrs_valid TYPE ps_pbukr,
       lv_prctr_valid TYPE prctr,
       lv_grp_count1  TYPE i,
       lv_grp_count2  TYPE i.

  DATA: lv_message TYPE char80,
        lv_stufe   TYPE char1.

  CHECK ok_code NE 'CANCEL_REQ'.

*  IF lv_proj3 IS NOT INITIAL OR
  IF lv_proj_type = 'TC' OR
     gv_capex IS NOT INITIAL.
    CHECK ok_code IS NOT INITIAL AND
          ok_code NP 'TC_CAPEX*' AND
          ok_code NE 'DELETE'    AND
          ok_code NE 'CLOSE'     AND
          ok_code NE 'UNCLOSE'   AND
          ok_code NE 'REJECT'    AND
          ok_code NE 'SOP'       AND
          ok_code NE 'ATTACH'    AND
          ok_code NE 'SAVE'.
  ELSE.
    CHECK ok_code IS NOT INITIAL AND
          ok_code NP 'TC_WBS*'   AND
          ok_code NE 'DELETE'    AND
          ok_code NE 'CLOSE'     AND
          ok_code NE 'UNCLOSE'   AND
          ok_code NE 'REJECT'    AND
          ok_code NE 'SOP'.
  ENDIF.
  CLEAR:lv_cursor,lv_text,lv_error,lv_verror,lv_tline,lv_cond,
        lv_cerror,lv_wf_pos_flag,ls_wf_control,lv_bukrs_valid,
        lv_prctr_valid,lv_pcba_flag,lv_pcasset_flag,lv_raerror.

*  IF lv_proj3 IS NOT INITIAL OR
  IF lv_proj_type = 'TC' OR
     gv_capex IS NOT INITIAL.
    DATA(lt_table_tmp) = lt_table.
    SORT lt_table_tmp BY stufe DESCENDING.
    READ TABLE lt_table_tmp INTO DATA(ls_bp) INDEX 1.
    SORT lt_table_tmp BY stufe ASCENDING.
  ENDIF.

  REFRESH: lt_messg. " Changes by AKOTA for EiCR 787082
*Mandatory Field Check
  LOOP AT lt_table INTO ls_table.
    ""**Start of Changes by AKOTA for CR 668561.
    " For create, change will be initial
    IF zwbs_header-type EQ 2.
      "Consider Change flag ONLY in case of Change Project/WBS
      CHECK ls_table-zchange IS NOT INITIAL.
    ENDIF.
    ""**End of Changes by AKOTA for CR 668561.
    CHECK ls_table-status IS INITIAL.

    lv_tline = sy-tabix.

* CR-573097-Workflow Control data based on Comp.Code and Profit Center
* to be made for Unclose/Close case also
    IF  lv_error IS INITIAL AND ls_wf_control IS INITIAL
    AND sy-tcode = 'ZCJ01'  AND ( lv_type = 3 OR lv_type = 4 ).
      PERFORM build_valid_wf_params CHANGING lv_bukrs_valid
                                             lv_prctr_valid.

      PERFORM get_wf_control USING    lv_bukrs_valid
                                      lv_prctr_valid
                                      lv_maint_sys
                             CHANGING ls_wf_control.
      IF ls_wf_control IS INITIAL.
        lv_cursor      = 'ZWBS_ITEM-PRCTR'.
        lv_error       = abap_true.
        lv_wf_pos_flag = abap_true.
      ENDIF.
      IF NOT lv_error IS INITIAL.
        EXIT.
      ENDIF.
    ENDIF.

*Exclude Check for Cases - Close or Unclose
    IF lv_type NE 3 AND lv_type NE 4.
*Level
      PERFORM validate_field USING ls_table-stufe
                                  'ZWBS_ITEM-STUFE'
                                  'Level'
                              CHANGING lv_error.
      IF NOT lv_error IS INITIAL.
        EXIT.
      ENDIF.
*WBS Element - PSPID
      PERFORM validate_field USING ls_table-pspid
                                  'ZWBS_ITEM-PSPID'
                                  'WBS Element'
                              CHANGING lv_error.
      IF NOT lv_error IS INITIAL.
        EXIT.
      ENDIF.
*For Customer WBS -> In the creation (new projects) and change requests
*(only newly added WBS lines) to prevent the users submitting requests
*if the project number (CZ.XXXX) of the WBS is not the same as the
*project number on the headers.
      IF lv_proj_type NE 'TC' AND gv_capex IS INITIAL AND
       ( lv_type = 2 AND NOT ls_table-zchange IS INITIAL ).
        IF ls_table-pspid+0(7) <> zwbs_header-pspid+0(7).
          lv_cursor = 'ZWBS_ITEM-PSPID'.
          lv_error  = abap_true.
          lv_verror = abap_true.
        ENDIF.
        IF NOT lv_error IS INITIAL.
          EXIT.
        ENDIF.
      ENDIF.
*      IF lv_proj3 IS NOT INITIAL OR
      IF lv_proj_type = 'TC' OR gv_capex IS NOT INITIAL.
        CHECK lv_type = 1 OR "Validate also in case of creation, where ZCHANGE is always blank.
              NOT ls_table-zchange IS INITIAL.
        CLEAR lv_cf_control_capex.
        PERFORM custom_fields_mand_check_capex
                                USING 'AKSTL'
                             CHANGING  lv_cf_control_capex.
        IF NOT lv_cf_control_capex IS INITIAL.
          PERFORM validate_field USING ls_table-akstl
                                      'ZWBS_ITEM-AKSTL'
                                      'Cost center'
                                  CHANGING lv_error.
        ENDIF.

        CLEAR lv_cf_control_capex.
        PERFORM custom_fields_mand_check_capex
                                USING 'PGSBR'
                             CHANGING  lv_cf_control_capex.
        IF NOT lv_cf_control_capex IS INITIAL.
          PERFORM validate_field USING ls_table-pgsbr
                                      'ZWBS_ITEM-PGSBR'
                                      'Business Area'
                                  CHANGING lv_error.
        ENDIF.

        CLEAR lv_cf_control_capex.
        PERFORM custom_fields_mand_check_capex
                                USING 'BUDGET'
                             CHANGING  lv_cf_control_capex.
        IF NOT lv_cf_control_capex IS INITIAL.
          PERFORM validate_field USING ls_table-budget
                                      'ZWBS_ITEM-Budget'
                                      'Budget'
                                  CHANGING lv_error.
        ENDIF.

*        IF zwbs_header-pwhie = 'JPY' OR zwbs_header-pwhie = 'IDR'.
*          IF ls_table-budget IS NOT INITIAL.
*            lv_budget = ls_table-budget.
*            SPLIT lv_budget  AT '.' INTO DATA(lv_value) DATA(lv_decimal).
*            IF lv_decimal GT 0.
*              CONCATENATE 'Decimal Places are not permitted for'
*              zwbs_header-pwhie 'Currency' INTO lv_msg_curr SEPARATED BY space. "lv_msg_curr.
*              MESSAGE lv_msg_curr TYPE 'S' DISPLAY LIKE 'E'.
*            ELSE.
*              CLEAR: lv_msg_curr.
*            ENDIF.
*          ENDIF.
*        ENDIF.

        CLEAR lv_cf_control_capex.
        PERFORM custom_fields_mand_check_capex
                                USING 'PLSEZ'
                             CHANGING  lv_cf_control_capex.
        IF NOT lv_cf_control_capex IS INITIAL.
          PERFORM validate_field USING ls_table-plsez
                                      'ZWBS_ITEM-plsez'
                                      'Finish Date'
                                  CHANGING lv_error.
        ENDIF.

        CLEAR lv_cf_control_capex.
        PERFORM custom_fields_mand_check_capex
                                USING 'ASTNR'
                             CHANGING  lv_cf_control_capex.
        IF NOT lv_cf_control_capex IS INITIAL.
          PERFORM validate_field USING ls_table-astnr
                                      'ZWBS_ITEM-astnr'
                                      'Applicant'
                                  CHANGING lv_error.
        ENDIF.

        CLEAR lv_cf_control_capex.
        PERFORM custom_fields_mand_check_capex
                                USING 'WERKS'
                             CHANGING  lv_cf_control_capex.
        IF NOT lv_cf_control_capex IS INITIAL.
          PERFORM validate_field USING ls_table-werks
                                      'ZWBS_ITEM-Werks'
                                      'Plant'
                                  CHANGING lv_error.
        ENDIF.

        CLEAR lv_cf_control_capex.
        PERFORM custom_fields_mand_check_capex
                                USING 'VERNR'
                             CHANGING  lv_cf_control_capex.
        IF NOT lv_cf_control_capex IS INITIAL.
          PERFORM validate_field USING ls_table-vernr
                                      'ZWBS_ITEM-vernr'
                                      'User Responsible'
                                  CHANGING lv_error.


        ENDIF.
        CLEAR lv_cf_control_capex.
        PERFORM custom_fields_mand_check_capex
                                USING 'IMPRF'
                             CHANGING  lv_cf_control_capex.
        IF NOT lv_cf_control_capex IS INITIAL.
          PERFORM validate_field USING ls_table-imprf
                                      'ZWBS_ITEM-imprf'
                                      'Investment Profile'
                                  CHANGING lv_error.


        ENDIF.
        CLEAR lv_cf_control_capex.
        PERFORM custom_fields_mand_check_capex
                                USING 'POSID'
                             CHANGING  lv_cf_control_capex.
        IF NOT lv_cf_control_capex IS INITIAL.
          PERFORM validate_field USING ls_table-posid
                                      'ZWBS_ITEM-posid'
                                      'Investment Program'
                                  CHANGING lv_error.
        ENDIF.


        IF NOT lv_error IS INITIAL.
          EXIT.
        ENDIF.
      ENDIF.
      ""* Begin of changes by AKOTA for CR 689451
      " Validate at the time of suBmission only

      IF ls_table-zchange EQ 'I' AND zwbs_header-request IS INITIAL.
        PERFORM f_validate_wbs USING ls_table-pspid
                                  CHANGING lv_error.
      ENDIF.
      ""* End of changes by AKOTA for CR 689451
*Description - POST1
      PERFORM validate_field USING ls_table-post1
                                  'ZWBS_ITEM-POST1'
                                  'Description'
                              CHANGING lv_error.
      IF NOT lv_error IS INITIAL.
        EXIT.
      ENDIF.
*      IF lv_proj3 IS INITIAL AND
      IF lv_proj_type NE 'TC' AND
         gv_capex IS INITIAL.
*      IF ls_table-stufe = 1 AND ls_table-post1 <> zwbs_header-post1.
*        lv_cursor = 'ZWBS_ITEM-POST1'.
*        lv_error  = abap_true.
*        lv_verror = abap_true.
*        IF NOT lv_error IS INITIAL.
*          EXIT.
*        ENDIF.
*      ENDIF.
*Company code - PBUKR
        PERFORM validate_field USING ls_table-pbukr
                                    'ZWBS_ITEM-PBUKR'
                                    'Company Code'
                                CHANGING lv_error.
*Validate Value
        IF lv_error IS INITIAL.
          PERFORM get_condition USING 'ZWBS_ITEM-PBUKR'
                                CHANGING lv_cond.
          PERFORM validate_field_value USING ls_table-pbukr
                                             lv_cond
                                             'ZWBS_ITEM-PBUKR'
                                             'Company Code'
                                             'T001'
                                    CHANGING lv_error.
        ENDIF.
        IF NOT lv_error IS INITIAL.
          EXIT.
        ENDIF.
*Description - PGSBR
        PERFORM validate_field USING ls_table-pgsbr
                                    'ZWBS_ITEM-PGSBR'
                                    'Business Area'
                                CHANGING lv_error.
        IF NOT lv_error IS INITIAL.
          EXIT.
        ENDIF.
*Profit Center - PRCTR
        PERFORM validate_field USING ls_table-prctr
                                    'ZWBS_ITEM-PRCTR'
                                    'Profit Center'
                               CHANGING lv_error.
*Validate Value
        IF lv_error IS INITIAL.
          PERFORM get_condition USING 'ZWBS_ITEM-PRCTR'
                                CHANGING lv_cond.
          PERFORM validate_field_value USING ls_table-prctr
                                             lv_cond
                                             'ZWBS_ITEM-PRCTR'
                                             'Profit Center'
                                             'T9F14'  "'CEPC'
                                    CHANGING lv_error.
        ENDIF.

*Validate WF Control data based on Comp.Code and Profit Center
        IF lv_error IS INITIAL AND ls_wf_control IS INITIAL AND
         ( sy-tcode = 'ZCJ01' OR NOT ls_table-zchange IS INITIAL ).
          IF lv_type = 2 .
            PERFORM build_valid_wf_params CHANGING lv_bukrs_valid
                                                   lv_prctr_valid.
            PERFORM get_wf_control USING   lv_bukrs_valid
                                           lv_prctr_valid
                                           lv_maint_sys
                                  CHANGING ls_wf_control.
          ELSE.
            PERFORM get_wf_control USING    ls_table-pbukr
                                            ls_table-prctr
                                            lv_maint_sys
                                   CHANGING ls_wf_control.
          ENDIF.

          IF ls_wf_control IS INITIAL.
            lv_cursor      = 'ZWBS_ITEM-PRCTR'.
            lv_error       = abap_true.
            lv_wf_pos_flag = abap_true.
          ENDIF.
        ENDIF.
        IF NOT lv_error IS INITIAL.
          EXIT.
        ENDIF.
      ENDIF.
*Check for mismatch between Business Area and Profit Center
*NOT Required anymore as this does not make sense for Intercompany
*Scenario
      IF lv_proj_type NE 'TC' AND gv_capex IS INITIAL.
        IF lv_type = 1 OR ( lv_type = 2 AND NOT ls_table-zchange IS INITIAL ).
          CLEAR lv_prctr.
          IF strlen( ls_table-prctr ) > 2 AND ls_table-prctr+0(2) = '00'.
            lv_prctr = ls_table-prctr+8(2).
          ELSE.
            lv_prctr = ls_table-prctr.
          ENDIF.
          IF ls_table-pgsbr+0(2) = '00'.
            IF ls_table-pgsbr+2(2) <> lv_prctr."zwbs_header-prctr+8(2).
              lv_cursor = 'ZWBS_ITEM-PGSBR'.
              lv_error  = abap_true.
              lv_verror = abap_true.
            ENDIF.
          ELSE.
            IF ls_table-pgsbr <> lv_prctr."zwbs_header-prctr+8(2).
              lv_cursor = 'ZWBS_ITEM-PGSBR'.
              lv_error  = abap_true.
              lv_verror = abap_true.
            ENDIF.
          ENDIF.
          IF NOT lv_error IS INITIAL.
            EXIT.
          ENDIF.
        ENDIF.
      ENDIF.
*For Customer WBS -> In the creation (new projects) and change requests
*(All open WBS, even if they do not add or update a line) to prevent
*the users submitting requests if the BA/PC is not valid anymore for the company code
*Profit Center Validation
      IF lv_proj_type NE 'TC' AND gv_capex IS INITIAL.
        IF NOT ls_table-prctr IS INITIAL AND NOT ls_table-pbukr IS INITIAL.
          SELECT SINGLE COUNT(*) FROM t9f14
                                 WHERE gjahr EQ sy-datum+0(4)  AND
                                       bukrs EQ ls_table-pbukr AND
                                       prctr EQ ls_table-prctr.
          IF sy-subrc <> 0.
            lv_cursor    = 'ZWBS_ITEM-PRCTR'.
            lv_error     = abap_true.
            lv_pcba_flag = abap_true.
          ENDIF.
          IF NOT lv_error IS INITIAL.
            EXIT.
          ENDIF.
        ENDIF.
*Business Area Validation
*        IF NOT ls_table-pgsbr IS INITIAL AND NOT ls_table-werks IS INITIAL.
*          SELECT SINGLE COUNT(*) FROM t134g
*                                 WHERE werks = ls_table-werks AND
*                                       gsber = ls_table-pgsbr.
*          IF sy-subrc <> 0.
*            lv_cursor    = 'ZWBS_ITEM-PGSBR'.
*            lv_error     = abap_true.
*            lv_pcba_flag = abap_true.
*          ENDIF.
*          IF NOT lv_error IS INITIAL.
*            EXIT.
*          ENDIF.
*        ENDIF.
      ENDIF.
*Plant - WERKS
*      IF lv_proj3 IS INITIAL AND
      IF lv_proj_type NE 'TC' AND gv_capex IS INITIAL.
        PERFORM validate_field USING ls_table-werks
                                    'ZWBS_ITEM-WERKS'
                                    'Plant'
                               CHANGING lv_error.
*Validate Value
        IF lv_error IS INITIAL.
          PERFORM get_condition USING 'ZWBS_ITEM-WERKS'
                                CHANGING lv_cond.
          PERFORM validate_field_value USING ls_table-werks
                                             lv_cond
                                             'ZWBS_ITEM-WERKS'
                                             'Plant'
                                             'T001K'
                                    CHANGING lv_error.
        ENDIF.
        IF NOT lv_error IS INITIAL.
          EXIT.
        ENDIF.
*Results Analysis Key - ABGSL
        IF NOT ls_table-abgsl IS INITIAL.
*--------------------------------------------------------------------*
          CLEAR:lv_rakey_flag,lv_abgsl.
          CONCATENATE '%' ls_table-abgsl '%' INTO lv_abgsl.
          SELECT SINGLE COUNT(*) FROM zvv_param
                        WHERE lookup_name EQ   'ZK_CGT_RA_KKA2_EXIT' AND
                              free_key    EQ   'ABGSL'               AND
                              indicator1  EQ   abap_true             AND
                            ( value1      LIKE lv_abgsl              OR
                              value2      LIKE lv_abgsl              OR
                              value3      LIKE lv_abgsl ).
          IF sy-subrc = 0.
            lv_rakey_flag = abap_true.
          ENDIF.
*--------------------------------------------------------------------*
*      IF ls_table-abgsl = 'ZRA-14' AND ls_table-grpkz IS INITIAL.
          CLEAR lv_wbs_rakey_flag.
          IF NOT lv_rakey_flag IS INITIAL.
            IF ls_table-grpkz IS INITIAL.
              PERFORM check_wbs_rakey CHANGING lv_wbs_rakey_flag.
              IF NOT lv_wbs_rakey_flag IS INITIAL.
                lv_cursor  = 'ZWBS_ITEM-ABGSL'.
                lv_error   = abap_true.
                lv_verror  = abap_true.
                lv_raerror = abap_false.
                EXIT.
              ENDIF.
            ELSE.
              PERFORM check_wbs_rakey_parent CHANGING lv_wbs_rakey_flag.
              IF NOT lv_wbs_rakey_flag IS INITIAL.
                lv_cursor  = 'ZWBS_ITEM-ABGSL'.
                lv_error   = abap_true.
                lv_verror  = abap_true.
                lv_raerror = abap_true.
                EXIT.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
*    PERFORM validate_field USING ls_table-abgsl
*                                'ZWBS_ITEM-ABGSL'
*                                'Results Analysis Key'
*                            CHANGING lv_error.
*Validate Value
*    IF lv_error IS INITIAL.
*    PERFORM get_condition USING 'ZWBS_ITEM-ABGSL'
*                          CHANGING lv_cond.
*    PERFORM validate_field_value USING ls_table-abgsl
*                                       lv_cond
*                                       'ZWBS_ITEM-ABGSL'
*                                       'Results Analysis Key'
*                                       'ZWBS_PROJ_RAKEY'
*                              CHANGING lv_error.
**    ENDIF.
*    IF NOT lv_error IS INITIAL.
*      EXIT.
*    ENDIF.

*Custom Fields Control
      ""* Begin of changes by AKOTA for CR 668561
*      CLEAR lv_cf_control.
*      PERFORM custom_fields_mandatory_check
*                              USING zwbs_header-proj_type
*                                    ls_table-pbukr
*                                    ls_table-prctr
*                                    'ZFCW'
*                           CHANGING  lv_cf_control.
*      CLEAR lv_cf_control.
*      PERFORM custom_fields_mandatory_check
*                              USING zwbs_header-proj_type
*                                    ls_table-pbukr
*                                    ls_table-prctr
*                                    'ZIBPFLAG'
*                           CHANGING  lv_cf_control.
      ""* End of changes by AKOTA for CR 668561
* CR 626062 - Check Mandatory settings for each custom fields
      CLEAR lv_cf_control.
      PERFORM custom_fields_mandatory_check
                              USING zwbs_header-proj_type
                                    ls_table-pbukr
                                    ls_table-prctr
                                    'ZASSET'
                           CHANGING  lv_cf_control.

* CR 626062 - Ended
      IF NOT lv_cf_control IS INITIAL AND
       ( zwbs_header-type = 1 OR  "Create
       ( zwbs_header-type = 2 AND "Change
       ( NOT ls_table-zchange IS INITIAL OR
         NOT ls_table-updkz IS INITIAL ) ) ).
        PERFORM validate_field USING ls_table-zasset
                                    'ZWBS_ITEM-ZASSET'
                                    'Asset Box Id'
                                CHANGING lv_error.
      ENDIF.
*Validate Value
      IF lv_error IS INITIAL AND NOT ls_table-zasset IS INITIAL.
        PERFORM get_condition USING 'ZWBS_ITEM-ZASSET'
                              CHANGING lv_cond.
        PERFORM validate_field_value USING ls_table-zasset
                                           lv_cond
                                           'ZWBS_ITEM-ZASSET'
                                           'Asset Box Id'
                                           'ZFASSET_BOX'
                                  CHANGING lv_error.
      ENDIF.
      IF NOT lv_error IS INITIAL.
        EXIT.
      ENDIF.
*Check for Deletion Indicator on Asset Box
      IF lv_error IS INITIAL AND NOT ls_table-zasset IS INITIAL.
        SELECT SINGLE COUNT(*) FROM zfasset_box
                      WHERE asset_box = ls_table-zasset AND
                            loevm     = space.
        IF sy-subrc <> 0.
          lv_cursor = 'ZWBS_ITEM-ZASSET'.
          lv_error  = abap_true.
          lv_verror = abap_true.
        ENDIF.
      ENDIF.
*PRCTR must be equal to ZFASSET_BOX-PRCTR for the asset box selected.
*If not give error message Asset box profit not coherent with WBS one.
      IF ( lv_type = 1 OR ( lv_type = 2 AND NOT ls_table-zchange IS INITIAL ) ) AND
           NOT ls_table-prctr IS INITIAL AND NOT ls_table-zasset IS INITIAL AND
           zwbs_header-zmaint_sys <> 'PV'.
        SELECT SINGLE COUNT(*) FROM zfasset_box
                      WHERE asset_box = ls_table-zasset AND
                            prctr     = ls_table-prctr. " AND
        "werks     = ls_table-werks.
        IF sy-subrc <> 0.
          SELECT SINGLE COUNT(*) FROM zfasset_box
                        WHERE asset_box = ls_table-zasset AND
                              dsprc     = ls_table-prctr. "AND
          "dswrk     = ls_table-werks.
          IF sy-subrc <> 0.

            lv_cursor       = 'ZWBS_ITEM-PRCTR'.
            lv_error        = abap_true.
            lv_verror       = abap_true.
            lv_pcasset_flag = abap_true.
          ENDIF.
        ENDIF.
      ENDIF.
      IF NOT lv_error IS INITIAL.
        EXIT.
      ENDIF.
*Revenue Stream - ZREVSTR
* CR 626062 - Check Mandatory settings for each custom fields
      CLEAR lv_cf_control.
      PERFORM custom_fields_mandatory_check
                              USING zwbs_header-proj_type
                                    ls_table-pbukr
                                    ls_table-prctr
                                    'ZREVSTR'
                           CHANGING  lv_cf_control.

* CR 626062 - Ended

      IF NOT lv_cf_control IS INITIAL AND
       ( zwbs_header-type = 1 OR  "Create
       ( zwbs_header-type = 2 AND "Change
       ( NOT ls_table-zchange IS INITIAL OR
         NOT ls_table-updkz IS INITIAL ) ) ).
        PERFORM validate_field USING ls_table-zrevstr
                                    'ZWBS_ITEM-ZREVSTR'
                                    'Revenue Stream'
                                CHANGING lv_error.
      ENDIF.
*Validate Value
      IF lv_error IS INITIAL AND NOT ls_table-zrevstr IS INITIAL.
        PERFORM get_condition USING 'ZWBS_ITEM-ZREVSTR'
                              CHANGING lv_cond.
        PERFORM validate_field_value USING ls_table-zrevstr
                                           lv_cond
                                           'ZWBS_ITEM-ZREVSTR'
                                           'Revenue Stream'
                                           'ZKREVSTR'
                                  CHANGING lv_error.
      ENDIF.
      IF NOT lv_error IS INITIAL.
        EXIT.
      ENDIF.
*Misc. Categroy - ZAREA
*    PERFORM validate_field USING ls_table-zarea
*                                'ZWBS_ITEM-ZAREA'
*                                'Misc. Categroy'
*                            CHANGING lv_error.
*Validate Value
* CR 626062 - Check Mandatory settings for each custom fields
      CLEAR lv_cf_control.
      PERFORM custom_fields_mandatory_check
                              USING zwbs_header-proj_type
                                    ls_table-pbukr
                                    ls_table-prctr
                                    'ZAREA'
                           CHANGING  lv_cf_control.
* CR 626062 - Ended
      IF lv_cf_control = abap_true. " CR 626062 Added
        PERFORM validate_field USING ls_table-zarea
                                     'ZWBS_ITEM-ZAREA'
                                     'Misc. Categroy'
                             CHANGING lv_error.
      ENDIF.                        " CR 626062 Ended

      IF  lv_error IS INITIAL AND NOT ls_table-zarea IS INITIAL.
        PERFORM get_condition USING 'ZWBS_ITEM-ZAREA'
                              CHANGING lv_cond.
        PERFORM validate_field_value USING ls_table-zarea
                                           lv_cond
                                           'ZWBS_ITEM-ZAREA'
                                           'Misc. Categroy'
                                           'ZKAREA'
                                  CHANGING lv_error.
      ENDIF.
      IF NOT lv_error IS INITIAL.
        EXIT.
      ENDIF.
*Status of Contract - ZSCOPCHA
* CR 626062 - Check Mandatory settings for each custom fields
      CLEAR lv_cf_control.
      PERFORM custom_fields_mandatory_check
                              USING zwbs_header-proj_type
                                    ls_table-pbukr
                                    ls_table-prctr
                                    'ZSCOPCHA'
                           CHANGING  lv_cf_control.
* CR 626062 - Ended

      IF NOT lv_cf_control IS INITIAL AND
       ( zwbs_header-type = 1 OR  "Create
       ( zwbs_header-type = 2 AND "Change
       ( NOT ls_table-zchange IS INITIAL OR
         NOT ls_table-updkz IS INITIAL ) ) ).
        PERFORM validate_field USING ls_table-zscopcha
                                    'ZWBS_ITEM-ZSCOPCHA'
" Begin of changes by AKOTA for EiCR-766523
                                    'Opportunity Type'
*                                    'Status of Contract'
" End of changes by AKOTA for EiCR-766523
                                CHANGING lv_error.
      ENDIF.
*Validate Value
      IF lv_error IS INITIAL AND NOT ls_table-zscopcha IS INITIAL.
        PERFORM get_condition USING 'ZWBS_ITEM-ZSCOPCHA'
                              CHANGING lv_cond.
        PERFORM validate_field_value USING ls_table-zscopcha
                                           lv_cond
                                           'ZWBS_ITEM-ZSCOPCHA'
" Begin of changes by AKOTA for EiCR-766523
                                           'Opportunity Type'
*                                           'Status of Contract'
" End of changes by AKOTA for EiCR-766523
                                           'ZKSCOPCHA'
                                  CHANGING lv_error.
      ENDIF.
      IF NOT lv_error IS INITIAL.
        EXIT.
      ENDIF.

*Synergy Sales - ZSYNERGY_ID
* CR 626062 - Check Mandatory settings for each custom fields
      CLEAR lv_cf_control.
      PERFORM custom_fields_mandatory_check
                              USING zwbs_header-proj_type
                                    ls_table-pbukr
                                    ls_table-prctr
                                    'ZSYNERGY_ID'
                           CHANGING  lv_cf_control.
* CR 626062 - Ended
      IF lv_cf_control = abap_true. " CR 626062 Added
        PERFORM validate_field USING ls_table-zsynergy_id
                                     'ZWBS_ITEM-ZSYNERGY_ID'
                                     'Synergy Sales'
                             CHANGING lv_error.
      ENDIF.    " CR 626062 Ended

**Validate Value
      IF lv_error IS INITIAL AND NOT ls_table-zsynergy_id IS INITIAL.
        PERFORM get_condition USING 'ZWBS_ITEM-ZSYNERGY_ID'
                              CHANGING lv_cond.
        PERFORM validate_field_value USING ls_table-zsynergy_id
                                           lv_cond
                                           'ZWBS_ITEM-ZSYNERGY_ID'
                                           'Synergy Sales'
                                           'ZWBS_SYNERGY'
                                  CHANGING lv_error.
*    ENDIF.
        IF NOT lv_error IS INITIAL.
          EXIT.
        ENDIF.
      ENDIF.
*Sold-to Party - ZCUSTOM
* CR 626062 - Check Mandatory settings for each custom fields
      CLEAR lv_cf_control.
      PERFORM custom_fields_mandatory_check
                              USING zwbs_header-proj_type
                                    ls_table-pbukr
                                    ls_table-prctr
                                    'ZCUSTOM'
                           CHANGING  lv_cf_control.
* CR 626062 - Ended

      IF NOT lv_cf_control IS INITIAL AND
       ( zwbs_header-type = 1 OR  "Create
       ( zwbs_header-type = 2 AND "Change
       ( NOT ls_table-zchange IS INITIAL OR
         NOT ls_table-updkz IS INITIAL ) ) ).
        PERFORM validate_field USING ls_table-zcustom
                                     'ZWBS_ITEM-ZCUSTOM'
                                     'Sold-to Party'
                            CHANGING lv_error.
      ENDIF.
*Validate Value
      IF lv_error IS INITIAL AND NOT ls_table-zcustom IS INITIAL.
        PERFORM get_condition USING 'ZWBS_ITEM-ZCUSTOM'
                              CHANGING lv_cond.
        PERFORM validate_field_value USING ls_table-zcustom
                                           lv_cond
                                           'ZWBS_ITEM-ZCUSTOM'
                                           'Sold-to Party'
                                           'KNA1'
                                  CHANGING lv_error.
*Validate Customer against Company and raise a Warning for Extension
        IF lv_error IS INITIAL   AND
           lv_ag_flag IS INITIAL AND
         ( sy-tcode = 'ZCJ01'    OR sy-tcode = 'ZCJ02N' ) AND
          gv_auto_approver_step IS INITIAL.
          ""* Begin of changes by AKOTA for CR 668561
*          SELECT SINGLE COUNT(*) FROM knb1
*                                 WHERE kunnr = ls_table-zcustom AND
*                                       bukrs = ls_table-pbukr.
*          IF sy-subrc <> 0.
*            CALL FUNCTION 'POPUP_TO_INFORM'
*              EXPORTING
*                titel = 'Information'
*                txt1  = text-013
*                txt2  = text-014.
*            lv_cursor  = 'ZWBS_ITEM-ZCUSTOM'.
*            lv_error   = abap_true.
*            lv_cerror  = abap_true.
*            lv_ag_flag = abap_true.
          IF ls_table-zchange EQ 'I' OR zwbs_header-type EQ 1.
            PERFORM validate_customer USING ls_table-zcustom
                              ls_table-stufe
                              ls_table-pbukr
                              ls_table-werks
                              " Changes for EiCR - 729491
                              ls_table-pgsbr " Changes for EiCR - 729491
                     CHANGING lv_error.
          ENDIF.
          ""* End of changes by AKOTA for CR 668561
        ENDIF.
      ENDIF.
      IF NOT lv_error IS INITIAL.
        EXIT.
      ENDIF.
*Material Type - MTART
*    IF ls_table-stufe = '3' OR ls_table-stufe = '4'.
*    IF ls_table-stufe GE 3.
*      PERFORM validate_field USING ls_table-mtart
*                                  'ZWBS_ITEM-MTART'
*                                  'Material Type'
*                              CHANGING lv_error.
*    ENDIF.
*Validate Value
* CR 626062 - Check Mandatory settings for each custom fields
      CLEAR lv_cf_control.
      PERFORM custom_fields_mandatory_check
                              USING zwbs_header-proj_type
                                    ls_table-pbukr
                                    ls_table-prctr
                                    'MTART'
                           CHANGING  lv_cf_control.
* CR 626062 - Ended
      IF lv_cf_control = abap_true. " CR 626062 Added
        PERFORM validate_field USING ls_table-mtart
                                     'ZWBS_ITEM-MTART'
                                     'Material Type'
                             CHANGING lv_error.
      ENDIF.    " CR 626062 Ended

      IF lv_error IS INITIAL AND NOT ls_table-mtart IS INITIAL.
        PERFORM get_condition USING 'ZWBS_ITEM-MTART'
                              CHANGING lv_cond.
        PERFORM validate_field_value USING ls_table-mtart
                                           lv_cond
                                           'ZWBS_ITEM-MTART'
                                           'Material Type'
                                           'T134'
                                  CHANGING lv_error.
      ENDIF.
      IF NOT lv_error IS INITIAL.
        EXIT.
      ENDIF.
*Material - MATNR
*    IF ls_table-stufe = '3' OR ls_table-stufe = '4'.
*    IF ls_table-stufe GE 3.
*      PERFORM validate_field USING ls_table-z_material
*                                  'ZWBS_ITEM-Z_MATERIAL'
*                                  'Material'
*                              CHANGING lv_error.
*    ENDIF.
*Validate Value

* CR 626062 - Check Mandatory settings for each custom fields
      CLEAR lv_cf_control.
      PERFORM custom_fields_mandatory_check
                              USING zwbs_header-proj_type
                                    ls_table-pbukr
                                    ls_table-prctr
                                    'Z_MATERIAL'
                           CHANGING  lv_cf_control.
* CR 626062 - Ended
      IF lv_cf_control = abap_true. " CR 626062 Added
        PERFORM validate_field USING ls_table-z_material
                                     'ZWBS_ITEM-Z_MATERIAL'
                                     'Material'
                             CHANGING lv_error.
      ENDIF.    " CR 626062 Ended

      IF lv_error IS INITIAL AND NOT ls_table-z_material IS INITIAL.
        PERFORM get_condition USING 'ZWBS_ITEM-Z_MATERIAL'
                              CHANGING lv_cond.
        PERFORM validate_field_value USING ls_table-z_material
                                           lv_cond
                                           'ZWBS_ITEM-Z_MATERIAL'
                                           'Material'
                                           'MARA'
                                  CHANGING lv_error.
        ""* Begin of changes by AKOTA for CR 668561
        PERFORM validate_material USING ls_table-z_material
                                        ls_table-werks
                                        ls_table-pspid
                                        ls_table-prctr
                               CHANGING lv_error.
        ""* End of changes by AKOTA for CR 668561
      ENDIF.
      IF NOT lv_error IS INITIAL.
        EXIT.
      ENDIF.
    ENDIF.

*WBS New Status for Close/Unclose
    IF ( lv_type = 3 OR lv_type = 4 )     AND
       ( NOT ls_table-zclose   IS INITIAL OR
         NOT ls_table-zunclose IS INITIAL ).
      IF lv_rflag IS INITIAL.
* CR 626062 - Check Mandatory settings for each custom fields
        CLEAR lv_cf_control.
        PERFORM custom_fields_mandatory_check
                                USING zwbs_header-proj_type
                                      ls_table-pbukr
                                      ls_table-prctr
                                      'ZSTATUS'
                             CHANGING  lv_cf_control.

        IF lv_cf_control = abap_true.                       " CR 626062
          PERFORM validate_field USING ls_table-zstatus
                                      'ZWBS_ITEM-ZSTATUS'
                                      'To be Status'
                                  CHANGING lv_error.
        ENDIF. " Ended

        IF lv_error IS INITIAL AND NOT ls_table-zstatus IS INITIAL.
          PERFORM get_condition USING 'ZWBS_ITEM-ZSTATUS'
                                CHANGING lv_cond.
          PERFORM validate_field_value USING ls_table-zstatus
                                             lv_cond
                                             'ZWBS_ITEM-ZSTATUS'
                                             'To be Status'
                                             'ZWBS_STATUS'
                                    CHANGING lv_error.
        ENDIF.
        IF NOT lv_error IS INITIAL.
          EXIT.
        ENDIF.
      ENDIF.
*Approval Decision
      IF NOT zwbs_header-request IS INITIAL.
* CR 626062 - Check Mandatory settings for each custom fields
        CLEAR lv_cf_control.
        PERFORM custom_fields_mandatory_check
                                USING zwbs_header-proj_type
                                      ls_table-pbukr
                                      ls_table-prctr
                                      'ACCEPT'
                             CHANGING  lv_cf_control.

        IF lv_cf_control = abap_true.                       " CR 626062
          PERFORM validate_field USING ls_table-accept
                                      'ZWBS_ITEM-ACCEPT'
                                      'Pre-Approval'
                                  CHANGING lv_error.
        ENDIF. " Ended

        IF NOT lv_error IS INITIAL.
          EXIT.
        ENDIF.
      ENDIF.
    ENDIF.

* CR 626062 - Validation for new fields
*---------------Lifecycle Phase---------------------*
* CR 626062 - Check Mandatory settings for each custom fields
    CLEAR lv_cf_control.
    PERFORM custom_fields_mandatory_check
                            USING zwbs_header-proj_type
                                  ls_table-pbukr
                                  ls_table-prctr
                                  'ZIPM_PR_CODE'
                         CHANGING  lv_cf_control.
* CR 626062 - Ended

    IF NOT lv_cf_control IS INITIAL AND
     ( zwbs_header-type = 1 OR  "Create
     ( zwbs_header-type = 2 AND "Change
     ( NOT ls_table-zchange IS INITIAL OR
       NOT ls_table-updkz IS INITIAL ) ) ).
      PERFORM validate_field USING ls_table-zipm_pr_code
                                  'ZWBS_ITEM-ZIPM_PR_CODE'
                                  'Lifecycle Phase'
                              CHANGING lv_error.
    ENDIF.
*Validate Value
    IF lv_error IS INITIAL AND NOT ls_table-zipm_pr_code IS INITIAL.
      PERFORM get_condition USING 'ZWBS_ITEM-ZIPM_PR_CODE'
                            CHANGING lv_cond.
      PERFORM validate_field_value USING ls_table-zipm_pr_code
                                         lv_cond
                                         'ZWBS_ITEM-ZIPM_PR_CODE'
                                         'Lifecycle Phase'
                                         'ZWBS_LIFE_CYCLE'
                                CHANGING lv_error.
    ENDIF.
    IF NOT lv_error IS INITIAL.
      EXIT.
    ENDIF.

*---------------WBS Forecast Status---------------------*
* CR 626062 - Check Mandatory settings for each custom fields
    CLEAR lv_cf_control.
    PERFORM custom_fields_mandatory_check
                            USING zwbs_header-proj_type
                                  ls_table-pbukr
                                  ls_table-prctr
                                  'ZZFCST_STATUS'
                         CHANGING  lv_cf_control.
* CR 626062 - Ended

    IF NOT lv_cf_control IS INITIAL AND
     ( zwbs_header-type = 1 OR  "Create
     ( zwbs_header-type = 2 AND "Change
     ( NOT ls_table-zchange IS INITIAL OR
       NOT ls_table-updkz IS INITIAL ) ) ).
      PERFORM validate_field USING ls_table-zzfcst_status
                                  'ZWBS_ITEM-ZZFCST_STATUS'
                                  'WBS Forecast Status'
                              CHANGING lv_error.
    ENDIF.
*Validate Value
    IF lv_error IS INITIAL AND NOT ls_table-zzfcst_status IS INITIAL.
      PERFORM get_condition USING 'ZWBS_ITEM-FCST_STATUS'
                            CHANGING lv_cond.
      PERFORM validate_field_value USING ls_table-zzfcst_status
                                         lv_cond
                                         'ZWBS_ITEM-ZZFCST_STATUS'
                                         'WBS Forecast Status'
                                         'ZWBS_FCAST_STAT'
                                CHANGING lv_error.
      " Begin of Changes for EiCR - 729491
*      IF lv_error IS INITIAL AND lv_ag_flag IS INITIAL AND
*       ( sy-tcode = 'ZCJ01' OR sy-tcode = 'ZCJ02N' ) AND
*        gv_auto_approver_step IS INITIAL.
*
*        IF ( ls_table-zchange EQ 'I' OR ls_table-zchange EQ 'U' )
*        OR ( zwbs_header-type EQ 1 OR zwbs_header-type EQ 2 ).
*
*          CLEAR: lv_status, lv_zibpflag.
*          SELECT SINGLE zzfcst_status zibpflag
*            INTO (lv_status, lv_zibpflag)
*            FROM prps
*           WHERE posid EQ ls_table-pspid.
*          IF sy-subrc EQ 0.
*            IF  lv_status NE 'CONT'
*            AND lv_zibpflag EQ 'X'
*            AND ls_table-zzfcst_status EQ 'CONT'
*            AND ( ls_table-belkz EQ '' OR ls_table-fakkz EQ '' ).
*              lv_cursor = 'ZWBS_ITEM-ZZFCST_STATUS'.
**              lv_error = abap_true.
*              CLEAR: lv_messg.
*              CONCATENATE text-e28 text-e29
*                INTO lv_messg SEPARATED BY space.
*              MESSAGE lv_messg TYPE 'S' DISPLAY LIKE 'W'.
*            ENDIF.
*          ENDIF.
*
*        ENDIF.
*      ENDIF.
      " End of Changes for EiCR - 729491
    ENDIF.
    IF NOT lv_error IS INITIAL.
      EXIT.
    ENDIF.

*---------------Service Bundle---------------------*
* CR 626062 - Check Mandatory settings for each custom fields
    CLEAR lv_cf_control.
    PERFORM custom_fields_mandatory_check
                            USING zwbs_header-proj_type
                                  ls_table-pbukr
                                  ls_table-prctr
                                  'ZZSERV_BUND'
                         CHANGING  lv_cf_control.
* CR 626062 - Ended

    IF NOT lv_cf_control IS INITIAL AND
     ( zwbs_header-type = 1 OR  "Create
     ( zwbs_header-type = 2 AND "Change
     ( NOT ls_table-zchange IS INITIAL OR
       NOT ls_table-updkz IS INITIAL ) ) ).
      PERFORM validate_field USING ls_table-zzserv_bund
                                  'ZWBS_ITEM-ZZSERV_BUND'
                                  'Service Bundle'
                              CHANGING lv_error.
    ENDIF.
*Validate Value
    IF lv_error IS INITIAL AND NOT ls_table-zzserv_bund IS INITIAL.
      PERFORM get_condition USING 'ZWBS_ITEM-SERV_BUND'
                            CHANGING lv_cond.
      PERFORM validate_field_value USING ls_table-zzserv_bund
                                         lv_cond
                                         'ZWBS_ITEM-ZZSERV_BUND'
                                         'Service Bundle'
                                         'ZWBS_SERVICE_BUN'
                                CHANGING lv_error.
    ENDIF.
    IF NOT lv_error IS INITIAL.
      EXIT.
    ENDIF.

*---------------Free Text(Comments on "WBS
*Element")---------------------*
* CR 626062 - Check Mandatory settings for each custom fields
    CLEAR lv_cf_control.
    PERFORM custom_fields_mandatory_check
                            USING zwbs_header-proj_type
                                  ls_table-pbukr
                                  ls_table-prctr
                                  'ZZFREE_TEXT'
                         CHANGING  lv_cf_control.
* CR 626062 - Ended
    IF NOT lv_cf_control IS INITIAL AND
     ( zwbs_header-type = 1 OR  "Create
     ( zwbs_header-type = 2 AND "Change
     ( NOT ls_table-zchange IS INITIAL OR
       NOT ls_table-updkz IS INITIAL ) ) ).
      PERFORM validate_field USING ls_table-zzfree_text
                                   'ZWBS_ITEM-ZZFREE_TEXT'
                                   'Free Text(Comments on "WBS Element")'
                            CHANGING lv_error.
    ENDIF.
    IF NOT lv_error IS INITIAL.
      EXIT.
    ENDIF.
* CR 626062 - Ended
  ENDLOOP.
  " Begin of changes by AKOTA for EiCR 787082
  " Display warning messages if any
  IF lt_messg[] IS NOT INITIAL.
    DATA:lt_fcat TYPE slis_t_fieldcat_alv,
         ls_fcat TYPE slis_fieldcat_alv.

    SORT lt_messg.
    DELETE ADJACENT DUPLICATES FROM lt_messg.

    CLEAR ls_fcat.
    ls_fcat-fieldname = 'MSG_TEXT'.
    ls_fcat-outputlen = 256.
    ls_fcat-seltext_l = 'Messages'.
    APPEND ls_fcat TO lt_fcat.
    " Popup to display all warning messages
    CALL FUNCTION 'REUSE_ALV_POPUP_TO_SELECT'
      EXPORTING
        i_title               = 'Warnings'
        i_selection           = ' '
        i_zebra               = 'X'
        i_screen_start_column = 10
        i_screen_start_line   = 2
        i_screen_end_column   = 150
        i_screen_end_line     = 15
        i_tabname             = '0'
        it_fieldcat           = lt_fcat
      TABLES
        t_outtab              = lt_messg
      EXCEPTIONS
        program_error         = 1
        OTHERS                = 2.
    IF sy-subrc <> 0.
* Implement suitable error handling here
    ENDIF.
  ENDIF.
  " End of changes by AKOTA for EiCR 787082

  CHECK lv_error IS INITIAL.
*For Customer WBS -> In the creation (new projects) and
*change requests (only newly added WBS lines) to prevent
*the users submitting requests if the parent level is missing
  DATA:lv_upper_level TYPE ps_posid,
       lv_up          TYPE ps_stufe,
       lv_index       TYPE i.

  CLEAR:lv_level_flag,lv_tline.
  IF lv_proj_type NE 'TC' AND gv_capex IS INITIAL AND
     zwbs_header-zmaint_sys NE 'PV' AND
   ( lv_type = 1  OR lv_type = 2 ).
    DATA(lt_table_temp) = lt_table.
    CLEAR lt_table_temp.
    LOOP AT lt_table INTO ls_table.
      INSERT ls_table INTO lt_table_temp INDEX 1.
    ENDLOOP.
    SORT lt_table_temp BY pspid DESCENDING stufe DESCENDING.
    LOOP AT lt_table_temp INTO ls_table.
      CHECK lv_type = 1 OR ( lv_type = 2 AND ls_table-zchange = 'I' ).
      CLEAR:lv_index,lv_upper_level,lv_up.
      lv_index = sy-tabix + 1.
*Add Levels to WBS based on Hierarchy
      LOOP AT lt_table_temp INTO ls_temp FROM lv_index.
*Upper Level
        IF ls_temp-stufe < ls_table-stufe.
          lv_upper_level = ls_temp-pspid.
          lv_up          = ls_temp-stufe.
          EXIT.
        ENDIF.
      ENDLOOP.
      IF lv_up <> ( ls_table-stufe - 1 ).
        lv_error      = abap_true.
        lv_level_flag = abap_true.
        lv_cursor     = 'ZWBS_ITEM-PSPID'.
        EXIT.
      ENDIF.
*Only at submission command the project structure based on the project mask sections must be checked.
*Dynamic check based on TCJED project mask checking for each element that the same root is there
*on the submitted structure as follow
*Level 1 C+.00000
*Level 2 C+.00000.0000
*Level 3 C+.00000.0000.XX
*Level 4 C+.00000.0000.XX.X
*Level 5 C+.00000.0000.XX.X.X
      IF NOT lv_upper_level IS INITIAL.
        IF lv_up <> 1.
          DATA(lv_up_len) = strlen( lv_upper_level ).
        ELSE.
          lv_up_len = 7.
        ENDIF.
        IF lv_upper_level+0(lv_up_len) <> ls_table-pspid+0(lv_up_len).
          lv_error      = abap_true.
          lv_level_flag = abap_true.
          lv_cursor     = 'ZWBS_ITEM-PSPID'.
          EXIT.
        ENDIF.
      ENDIF.
    ENDLOOP.
    IF NOT lv_level_flag IS INITIAL.
      READ TABLE lt_table TRANSPORTING NO FIELDS
                          WITH KEY pspid = ls_table-pspid.
      IF sy-subrc = 0.
        lv_tline = sy-tabix.
      ENDIF.
    ENDIF.
  ENDIF.

  CHECK lv_error IS INITIAL.
*Indicator: Grouping WBS element
  CLEAR:lv_grp_flag,lv_agrp_flag,lv_grp_count1,lv_grp_count2.
  IF ( zwbs_header-type = 1   OR  "Create
       zwbs_header-type = 2 ) AND "Change
     NOT ls_proj_templ-grouping IS INITIAL.
    CLEAR lv_tline.
    LOOP AT lt_table INTO ls_table.
      CLEAR:lv_rakey_flag,lv_abgsl.
      lv_tline = sy-tabix.
      IF NOT ls_table-abgsl IS INITIAL.
*--------------------------------------------------------------------*
        CONCATENATE '%' ls_table-abgsl '%' INTO lv_abgsl.
        SELECT SINGLE COUNT(*) FROM zvv_param
                      WHERE lookup_name EQ   'ZK_CGT_RA_KKA2_EXIT' AND
                            free_key    EQ   'ABGSL'               AND
                            indicator1  EQ   abap_true             AND
                          ( value1      LIKE lv_abgsl              OR
                            value2      LIKE lv_abgsl              OR
                            value3      LIKE lv_abgsl ).
        IF sy-subrc = 0.
          lv_rakey_flag = abap_true.
        ENDIF.
*--------------------------------------------------------------------*
*      IF ls_table-abgsl = 'ZRA-14' AND ls_table-grpkz IS INITIAL.
        IF NOT lv_rakey_flag IS INITIAL.
          IF ls_table-grpkz IS INITIAL.
            CLEAR lv_wbs_rakey_flag.
            PERFORM check_wbs_rakey CHANGING lv_wbs_rakey_flag.
            IF NOT lv_wbs_rakey_flag IS INITIAL.
              DATA(lv_group_rakey) = abap_true.
              EXIT.
            ENDIF.
          ELSE.
            PERFORM check_wbs_rakey_parent CHANGING lv_wbs_rakey_flag.
            IF NOT lv_wbs_rakey_flag IS INITIAL.
              lv_group_rakey = abap_true.
              EXIT.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
      IF NOT ls_table-grpkz IS INITIAL.
*        IF ls_table-abgsl <> 'ZRA-14'.
        IF lv_rakey_flag IS INITIAL.
          lv_group_rakey = abap_true.
          EXIT.
        ENDIF.
        DATA(lv_group_exists) = abap_true.
        IF ls_table-grpkz = '1'.
          lv_grp_count1 = lv_grp_count1 + 1.
        ELSEIF ls_table-grpkz = '2'.
          lv_grp_count2 = lv_grp_count2 + 1.
        ENDIF.
      ENDIF.
*Check for Grouping 2 and IC Case
      IF ls_table-grpkz = '2'.
        DATA(lv_group_rakey_ic) = abap_false.
        PERFORM check_wbs_rakey_ic CHANGING lv_group_rakey_ic.
      ENDIF.
    ENDLOOP.
    IF NOT lv_group_rakey_ic IS INITIAL.
      lv_grp_flag = 5.
    ELSEIF NOT lv_group_rakey IS INITIAL.
      lv_grp_flag = 4.
    ELSEIF lv_group_exists IS INITIAL.
      lv_grp_flag = 1.
    ELSEIF lv_grp_count1 GT 1.
      lv_grp_flag = 2.
    ELSEIF lv_grp_count1 GE 1 AND lv_grp_count2 GE 1.
      lv_grp_flag = 3.
    ENDIF.
    CLEAR:lv_group_rakey,lv_group_rakey_ic.
    IF NOT lv_grp_flag IS INITIAL.
      lv_error  = abap_true.
      lv_verror = abap_true.
      lv_cursor = 'ZWBS_ITEM-GRPKZ'.
      EXIT.
    ENDIF.
  ENDIF.

  CHECK lv_error IS INITIAL.
*Check for Automatic Grouping Indicator on Project Template
  IF NOT lv_grp_count1 IS INITIAL OR NOT lv_grp_count2 IS INITIAL.
    IF ls_proj-grtop IS INITIAL AND lv_grp_count1 > 0.
      lv_agrp_flag = 1.
    ELSEIF NOT ls_proj-grtop IS INITIAL AND lv_grp_count2 > 0.
      lv_agrp_flag = 2.
    ENDIF.
    IF NOT lv_agrp_flag IS INITIAL.
      lv_error  = abap_true.
      lv_verror = abap_true.
      lv_cursor = 'ZWBS_ITEM-GRPKZ'.
      EXIT.
    ENDIF.
  ENDIF.

ENDFORM.                    " VALIDATE_DATA
*&--------------------------------------------------------------------*
*&      Form  VALIDATE_FIELD
*&--------------------------------------------------------------------*
FORM validate_field USING    iv_value
                             VALUE(p_1051)
                             VALUE(p_1052)
                    CHANGING cv_error.

  CHECK cv_error IS INITIAL.

  IF iv_value IS INITIAL.
    lv_cursor = p_1051.
    lv_text   = p_1052.
    cv_error  = abap_true.
  ENDIF.

ENDFORM.                    " VALIDATE_FIELD
**&--------------------------------------------------------------------*
**&      Form  GET_CONDITION
**&--------------------------------------------------------------------*
FORM get_condition  USING    VALUE(p_1515)
                    CHANGING cv_cond TYPE string.

  DATA lv_stufe TYPE char3.

  CLEAR:lv_cvalue,cv_cond,lv_verror,lv_raerror.

  CASE p_1515.
    WHEN 'ZWBS_ITEM-PBUKR'.
      CONCATENATE text-004 ls_table-pbukr text-004
                  INTO lv_cvalue.
      CONCATENATE 'BUKRS' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
    WHEN 'ZWBS_ITEM-PRCTR'.
      CONCATENATE text-004 sy-datum+0(4) text-004
                  INTO lv_cvalue.
      CONCATENATE 'GJAHR' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
      CLEAR lv_cvalue.
      CONCATENATE text-004 ls_table-pbukr text-004
                  INTO lv_cvalue.
      CONCATENATE cv_cond 'AND BUKRS' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
      CLEAR lv_cvalue.
      CONCATENATE text-004 ls_table-prctr text-004
                  INTO lv_cvalue.
      CONCATENATE cv_cond 'AND PRCTR' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
    WHEN 'ZWBS_ITEM-WERKS'.
      CONCATENATE text-004 ls_table-pbukr text-004
                  INTO lv_cvalue.
      CONCATENATE 'BUKRS' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
      CLEAR lv_cvalue.
      CONCATENATE text-004 ls_table-werks text-004
                  INTO lv_cvalue.
      CONCATENATE cv_cond 'AND BWKEY' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
    WHEN 'ZWBS_ITEM-ABGSL'.
      CONCATENATE text-004 zwbs_header-proj_type text-004
                  INTO lv_cvalue.
      CONCATENATE 'PROJ_TYPE' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
      CLEAR lv_cvalue.
      CONCATENATE text-004 ls_table-abgsl text-004
                  INTO lv_cvalue.
      CONCATENATE cv_cond 'AND ABGSL' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
    WHEN 'ZWBS_ITEM-ZASSET'.
      CONCATENATE text-004 ls_table-zasset text-004
                  INTO lv_cvalue.
      CONCATENATE 'ASSET_BOX' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
*      CLEAR lv_cvalue.
*      CONCATENATE text-004 'X' text-004
*                  INTO lv_cvalue.
*      CONCATENATE cv_cond 'AND MTART' ' = ' lv_cvalue
*                  INTO cv_cond SEPARATED BY space
*                  RESPECTING BLANKS.
    WHEN 'ZWBS_ITEM-ZREVSTR'.
      CONCATENATE text-004 ls_table-zrevstr text-004
                  INTO lv_cvalue.
      CONCATENATE 'ZREVSTR' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
    WHEN 'ZWBS_ITEM-ZAREA'.
      CONCATENATE text-004 ls_table-zarea text-004
                  INTO lv_cvalue.
      CONCATENATE 'ZAREA' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
    WHEN 'ZWBS_ITEM-ZSCOPCHA'.
      CONCATENATE text-004 ls_table-zscopcha text-004
                  INTO lv_cvalue.
      CONCATENATE 'ZSCOPCHA' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
    WHEN 'ZWBS_ITEM-ZOPPORTUNITY_ID'.
      CONCATENATE text-004 ls_table-zopportunity_id text-004
                  INTO lv_cvalue.
      CONCATENATE 'ZOPPORTUNITY_ID' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
    WHEN 'ZWBS_ITEM-ZSYNERGY_ID'.
      CONCATENATE text-004 ls_table-zsynergy_id text-004
                  INTO lv_cvalue.
      CONCATENATE 'ZSYNERGY_ID' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
    WHEN 'ZWBS_ITEM-ZCUSTOM'.
      CONCATENATE text-004 ls_table-zcustom text-004
                  INTO lv_cvalue.
      CONCATENATE 'KUNNR' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
    WHEN 'ZWBS_ITEM-MTART'.
      CONCATENATE text-004 ls_table-mtart text-004
                  INTO lv_cvalue.
      CONCATENATE 'MTART' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
    WHEN 'ZWBS_ITEM-Z_MATERIAL'.
      CONCATENATE text-004 ls_table-z_material text-004
                  INTO lv_cvalue.
      CONCATENATE cv_cond 'MATNR' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
      CLEAR lv_cvalue.
      CONCATENATE text-004 ls_table-mtart text-004
                  INTO lv_cvalue.
      CONCATENATE cv_cond 'AND MTART' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
    WHEN 'ZWBS_ITEM-ZSTATUS'.
      CONCATENATE text-004 zwbs_header-type text-004
                  INTO lv_cvalue.
      CONCATENATE 'TYPE' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
      CLEAR lv_cvalue.
      CONCATENATE text-004 ls_table-stat_curr text-004
                  INTO lv_cvalue.
      CONCATENATE cv_cond 'AND STAT_CURR' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
      CLEAR lv_cvalue.
      CONCATENATE text-004 ls_table-zstatus text-004
                  INTO lv_cvalue.
      CONCATENATE cv_cond 'AND STAT_NEW' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.
* CR 626062 - New Conditions added
    WHEN 'ZWBS_ITEM-ZIPM_PR_CODE'.
      CONCATENATE text-004 ls_table-zipm_pr_code text-004
                INTO lv_cvalue.
      CONCATENATE 'ZIPM_PR_CODE' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.

    WHEN 'ZWBS_ITEM-FCST_STATUS'.
      CONCATENATE text-004 ls_table-zzfcst_status text-004
                INTO lv_cvalue.
      CONCATENATE 'FCST_STATUS' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.

    WHEN 'ZWBS_ITEM-SERV_BUND'.
      CONCATENATE text-004 ls_table-zzserv_bund text-004
                INTO lv_cvalue.
      CONCATENATE 'SERV_BUND' ' = ' lv_cvalue
                  INTO cv_cond SEPARATED BY space
                  RESPECTING BLANKS.

* CR 626062 - Ended
  ENDCASE.

  CONDENSE cv_cond.

ENDFORM.                    " GET_CONDITION
*&--------------------------------------------------------------------*
*&      Form  VALIDATE_FIELD_VALUE
*&--------------------------------------------------------------------*
FORM validate_field_value USING    iv_value
                                   iv_cond
                                   VALUE(p_1369)
                                   VALUE(p_1370)
                                   VALUE(p_1371)
                          CHANGING cv_error.

  DATA lv_table TYPE tabname.

  CHECK cv_error IS INITIAL.

  IF NOT iv_value IS INITIAL.
    lv_table = p_1371.
    SELECT SINGLE COUNT(*) FROM (lv_table) WHERE (iv_cond).
    IF sy-subrc <> 0.
      lv_cursor = p_1369.
      lv_text   = p_1370.
      cv_error  = abap_true.
      lv_verror = abap_true.
    ENDIF.
  ENDIF.

ENDFORM.                    " VALIDATE_FIELD_VALUE

FORM validate_material USING p_matnr
                             p_werks
                             p_pspnr
                             p_prctr
                    CHANGING cv_error.

  DATA: lv_spart     TYPE mara-spart,
        lv_prctr_mat TYPE marc-prctr,
        lv_prctr_wbs TYPE prps-prctr,
        lv_lvorm     TYPE marc-lvorm,
        lv_messg     TYPE string.

  CHECK cv_error IS INITIAL.

  SELECT SINGLE spart INTO lv_spart
    FROM mara
   WHERE matnr EQ p_matnr
     AND lvorm EQ space.
  IF sy-subrc NE 0.
    lv_cursor = 'ZWBS_ITEM-Z_MATERIAL'.
    cv_error  = abap_true.
    CLEAR: lv_messg.
    CALL FUNCTION 'CONVERSION_EXIT_MATN1_OUTPUT'
      EXPORTING
        input  = p_matnr
      IMPORTING
        output = p_matnr.
    CONCATENATE text-e09 p_matnr text-e13
      INTO lv_messg SEPARATED BY space.
    MESSAGE lv_messg TYPE 'S' DISPLAY LIKE 'E'.
  ELSE.
    IF lv_spart NE '00'.
* check profit center of material and profit center of wbs
      SELECT SINGLE prctr lvorm INTO (lv_prctr_mat, lv_lvorm)
        FROM marc
       WHERE matnr EQ p_matnr
         AND werks EQ p_werks.
      IF sy-subrc NE 0.
        lv_cursor = 'ZWBS_ITEM-Z_MATERIAL'.
        cv_error  = abap_true.
        CLEAR: lv_messg.
        CALL FUNCTION 'CONVERSION_EXIT_MATN1_OUTPUT'
          EXPORTING
            input  = p_matnr
          IMPORTING
            output = p_matnr.
        CONCATENATE text-e09 p_matnr text-e12 p_werks
          INTO lv_messg SEPARATED BY space.
        MESSAGE lv_messg TYPE 'S' DISPLAY LIKE 'E'.
      ELSE.
        IF lv_lvorm EQ 'X'.
          lv_cursor = 'ZWBS_ITEM-Z_MATERIAL'.
          cv_error  = abap_true.
          CLEAR: lv_messg.
          CALL FUNCTION 'CONVERSION_EXIT_MATN1_OUTPUT'
            EXPORTING
              input  = p_matnr
            IMPORTING
              output = p_matnr.
          CONCATENATE text-e09 p_matnr text-e11 p_werks
            INTO lv_messg SEPARATED BY space.
          MESSAGE lv_messg TYPE 'S' DISPLAY LIKE 'E'.
* if profit center of material <> profit center of wbs
        ELSEIF lv_prctr_mat NE p_prctr.
          lv_cursor = 'ZWBS_ITEM-Z_MATERIAL'.
          cv_error  = abap_true.
          CLEAR: lv_messg.
          CALL FUNCTION 'CONVERSION_EXIT_MATN1_OUTPUT'
            EXPORTING
              input  = p_matnr
            IMPORTING
              output = p_matnr.
          CONCATENATE text-e03 p_matnr text-e10 p_pspnr
            INTO lv_messg SEPARATED BY space.
          MESSAGE lv_messg TYPE 'S' DISPLAY LIKE 'E'.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.
ENDFORM.
FORM validate_customer USING p_zcustom
                             p_stufe
                             p_pbukr
                             p_werks " Changes for EiCR - 729491
                             p_pgsbr " Changes for EiCR - 729491
                    CHANGING cv_error.

  DATA: lv_vbund TYPE vbund,
        lt_tvko  TYPE TABLE OF tvko-vkorg,
        ls_tvko  TYPE tvko-vkorg,
        lv_loevm TYPE kna1-loevm,
        lv_line  TYPE i,
        lv_messg TYPE string, " Changes by AKOTA for EiCR 787082
        ls_messg TYPE ts_messg,
        lv_ktokd TYPE kna1-ktokd.

  DATA: lt_ktokd  TYPE TABLE OF ktokd,
        lt_tktokd TYPE TABLE OF ktokd,
        lv_ktokd2 TYPE ktokd,
        lr_ktokd  TYPE RANGE OF ktokd,
        ls_ktokd  LIKE LINE OF lr_ktokd.
  " Begin of Changes for EiCR - 729491
  DATA: lv_spaku    TYPE tvta-spaku,
        lv_msg1     TYPE char50,
        lv_msg2     TYPE char50,
        lv_sortl    TYPE kna1-sortl,
        lv_csh2pkey TYPE zaps_cust-csh2pkey,
        lv_prdplant TYPE werks_d.
  " End of Changes for EiCR - 729491
  CHECK cv_error IS INITIAL.

  IF p_zcustom IS NOT INITIAL.
    " Begin of Changes for EiCR - 729491
    SELECT SINGLE vbund ktokd loevm sortl
      INTO (lv_vbund, lv_ktokd, lv_loevm, lv_sortl)
      " End of Changes for EiCR - 729491
      FROM kna1
     WHERE kunnr EQ p_zcustom.
    IF sy-subrc EQ 0.
      IF lv_loevm EQ 'X'.
        lv_cursor = 'ZWBS_ITEM-ZCUSTOM'.
        cv_error  = abap_true.
        CLEAR: lv_messg.
        CONCATENATE text-e14 p_zcustom text-e15 text-e16
          INTO lv_messg SEPARATED BY space.
        MESSAGE lv_messg TYPE 'S' DISPLAY LIKE 'E'.
      ENDIF.

      CHECK cv_error IS INITIAL.
      IF NOT ( lv_ktokd EQ 'ZINT' AND lv_sortl EQ p_pbukr ).
        " Changes for EiCR - 729491
        CLEAR: lv_loevm.
        SELECT SINGLE loevm FROM knb1
          INTO lv_loevm
         WHERE kunnr = p_zcustom AND
               bukrs = p_pbukr.
        " Begin of changes by AKOTA for EiCR 787082
        IF sy-subrc <> 0
        AND ( sy-ucomm EQ 'SUBMIT' OR ok_code EQ 'SUBMIT' ).
*          lv_cursor = 'ZWBS_ITEM-ZCUSTOM'.
          CLEAR: ls_messg.
          " Begin of Changes for EiCR - 729491
*CONCATENATE text-e14 ls_table-zcustom INTO lv_messg SEPARATED BY space.
*        MESSAGE lv_messg TYPE 'S' DISPLAY LIKE 'W'.
          " End of Changes for EiCR - 729491
*          lv_line = lv_tline - tc_wbs-top_line + 1.
*          SET CURSOR FIELD lv_cursor LINE lv_line.
*          MESSAGE w889(co) WITH lv_messg text-e20
*                                ls_table-pbukr text-e17.
          CONCATENATE text-e14 ls_table-zcustom text-e20 ls_table-pbukr
          text-e17
            INTO ls_messg-msg_text SEPARATED BY space.
          APPEND ls_messg TO lt_messg.
        ELSEIF lv_loevm EQ 'X'
        AND ( sy-ucomm EQ 'SUBMIT' OR ok_code EQ 'SUBMIT' ).
*          lv_cursor = 'ZWBS_ITEM-ZCUSTOM'.
          CLEAR: ls_messg.
          " Begin of Changes for EiCR - 729491
*CONCATENATE text-e14 ls_table-zcustom INTO lv_messg SEPARATED BY space.
*        MESSAGE lv_messg TYPE 'S' DISPLAY LIKE 'W'.
          " End of Changes for EiCR - 729491
*          lv_line = lv_tline - tc_wbs-top_line + 1.
*          SET CURSOR FIELD lv_cursor LINE lv_line.
*          MESSAGE w889(co) WITH lv_messg text-e21
*                                ls_table-pbukr text-e16.
          CONCATENATE text-e14 ls_table-zcustom text-e21 ls_table-pbukr
          text-e16
            INTO ls_messg-msg_text SEPARATED BY space.
          APPEND ls_messg TO lt_messg.
          " End of changes by AKOTA for EiCR 787082
        ENDIF.
      ENDIF.
      CHECK cv_error IS INITIAL.
      " Begin of Changes for EiCR - 729491
      CLEAR: lv_bukrs.
      SELECT SINGLE bukrs INTO lv_bukrs
        FROM t001k
       WHERE bwkey EQ p_werks.
      IF sy-subrc EQ 0.
        " Get Sales org by passing company code
        CLEAR: ls_tvko.
        SELECT SINGLE vkorg INTO ls_tvko
          FROM tvko
         WHERE bukrs EQ lv_bukrs.
        IF sy-subrc EQ 0.
          CLEAR: lv_spaku.
          SELECT SINGLE spaku
            FROM tvta INTO lv_spaku
           WHERE vkorg = ls_tvko
             AND vtweg = '01'
             AND spart = p_pgsbr+2(2).
          IF sy-subrc EQ 0 AND lv_spaku IS NOT INITIAL.

            SELECT SINGLE loevm FROM knvv
              INTO lv_loevm
             WHERE kunnr = p_zcustom AND
                   vkorg = ls_tvko AND
                   spart = lv_spaku.
            IF sy-subrc EQ 0.
              " Begin of changes by AKOTA for EiCR 787082
              IF lv_loevm EQ 'X' AND ( sy-ucomm EQ 'SUBMIT' OR ok_code
              EQ 'SUBMIT' ).
*                lv_cursor = 'ZWBS_ITEM-ZCUSTOM'.
                CLEAR: ls_messg.
*                CONCATENATE text-e14 p_zcustom
*                            text-e32 INTO lv_msg1 SEPARATED BY space.
*CONCATENATE ls_tvko text-e31 lv_spaku text-e34 INTO lv_msg2
*                SEPARATED BY space.
*
*                MESSAGE w889(co) WITH lv_msg1 lv_msg2 text-e16.

                CONCATENATE text-e14 p_zcustom text-e32 ls_tvko text-e31
                            lv_spaku text-e34 text-e16
                 INTO ls_messg-msg_text SEPARATED BY space.
                APPEND ls_messg TO lt_messg.
              ENDIF.
            ELSE.
              IF ( sy-ucomm EQ 'SUBMIT' OR ok_code EQ 'SUBMIT' ).
*                lv_cursor = 'ZWBS_ITEM-ZCUSTOM'.
                CLEAR: ls_messg.
*                CONCATENATE text-e14 p_zcustom text-e18 INTO lv_msg1
*                    SEPARATED BY space.
*CONCATENATE ls_tvko text-e31 lv_spaku text-e34 INTO lv_msg2
*                SEPARATED BY space.
*
*                MESSAGE w889(co) WITH lv_msg1 lv_msg2 text-e17.
                CONCATENATE text-e14 p_zcustom text-e18 ls_tvko text-e31
                            lv_spaku text-e34 text-e17
                 INTO ls_messg-msg_text SEPARATED BY space.
                APPEND ls_messg TO lt_messg.
                " End of changes by AKOTA for EiCR 787082
              ENDIF.
            ENDIF.
            SELECT SINGLE COUNT(*) FROM knvp
             WHERE kunnr = p_zcustom AND
                   parvw = 'WE'.
            IF sy-subrc NE 0.
              lv_cursor = 'ZWBS_ITEM-ZCUSTOM'.
              cv_error  = abap_true.
              CLEAR: lv_messg.
              CONCATENATE text-e14 p_zcustom text-e15 text-e16
                INTO lv_messg SEPARATED BY space.
              MESSAGE e889(co) WITH text-e35 text-e36.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.

      REFRESH: lr_ktokd, lt_ktokd, lt_tktokd.
      SELECT SINGLE * FROM zvv_param
        INTO @DATA(ls_param)
       WHERE lookup_name EQ 'ZIBP_WBS_ACCGRP'
         AND indicator1 EQ 'X'.

      IF sy-subrc EQ 0.
        IF NOT ls_param-value1 IS INITIAL.
          SPLIT ls_param-value1 AT ',' INTO TABLE lt_tktokd.
          APPEND LINES OF lt_tktokd TO lt_ktokd.
        ENDIF.
        IF NOT ls_param-value2 IS INITIAL.
          REFRESH lt_tktokd.
          SPLIT ls_param-value2 AT ',' INTO TABLE lt_tktokd.
          APPEND LINES OF lt_tktokd TO lt_ktokd.
        ENDIF.
        IF NOT ls_param-value3 IS INITIAL.
          REFRESH lt_tktokd.
          SPLIT ls_param-value3 AT ',' INTO TABLE lt_tktokd.
          APPEND LINES OF lt_tktokd TO lt_ktokd.
        ENDIF.

        LOOP AT lt_ktokd INTO lv_ktokd2.
          CLEAR: ls_ktokd.
          ls_ktokd-sign = 'I'.
          ls_ktokd-option = 'EQ'.
          ls_ktokd-low = lv_ktokd2.
          APPEND ls_ktokd TO lr_ktokd.
        ENDLOOP.
      ENDIF.

      IF ( sy-ucomm EQ 'SUBMIT' OR ok_code EQ 'SUBMIT' ) AND
      lv_ktokd NOT IN lr_ktokd.
*        lv_cursor = 'ZWBS_ITEM-ZCUSTOM'.
*        MESSAGE w889(co) WITH text-e37 text-e38.
        CLEAR: ls_messg.
        CONCATENATE text-e37 text-e38 INTO ls_messg-msg_text
          SEPARATED BY space.
        APPEND ls_messg TO lt_messg.
      ENDIF.

      CHECK cv_error IS INITIAL.
      IF p_stufe NE '1' AND p_pbukr NE zwbs_header-vbukr.
        IF lv_vbund(1) = 'B' OR lv_vbund(1) = 'E'.
        ELSE.
          lv_cursor = 'ZWBS_ITEM-ZCUSTOM'.
          SELECT SINGLE COUNT(*) FROM zwbs_excep
                   WHERE pbukr  = @p_pbukr           AND
                         spbukr = @zwbs_header-vbukr AND
                         active = 'X'.
          IF sy-subrc IS INITIAL.
            " Begin of changes by AKOTA for EiCR 787082
            IF ( sy-ucomm EQ 'SUBMIT' OR ok_code EQ 'SUBMIT' ).
*            MESSAGE text-e27 TYPE 'S' DISPLAY LIKE 'W'.
              CLEAR: ls_messg.
              ls_messg-msg_text = text-e27.
              APPEND ls_messg TO lt_messg.
              " End of changes by AKOTA for EiCR 787082
            ENDIF.
          ELSE.
            cv_error = abap_true.
            MESSAGE text-e04 TYPE 'S' DISPLAY LIKE 'E'.
          ENDIF.
        ENDIF.
      ENDIF.
      " Begin of Changes for EiCR - 729491

      CHECK cv_error IS INITIAL.
      " Validation 1 for WBS/Invoicing Plant
*      CLEAR: lv_bukrs.
*      SELECT SINGLE bukrs INTO lv_bukrs
*        FROM t001k
*       WHERE bwkey EQ p_werks.
*      IF sy-subrc EQ 0
*      AND ( sy-ucomm EQ 'SUBMIT' OR ok_code EQ 'SUBMIT' ).
*        " Get Sales org by passing company code
*        CLEAR: ls_tvko.
*        SELECT SINGLE vkorg INTO ls_tvko
*          FROM tvko
*         WHERE bukrs EQ lv_bukrs.
*        IF sy-subrc EQ 0.
*          " Build Cust Ship to Picaso Key
*          CLEAR: lv_spaku.
*          SELECT SINGLE spaku
*            FROM tvta INTO lv_spaku
*           WHERE vkorg = ls_tvko
*             AND vtweg = '01'
*             AND spart = p_pgsbr+2(2).
*          IF sy-subrc EQ 0 AND lv_spaku IS NOT INITIAL.
*            CLEAR: lv_csh2pkey.
*            CONCATENATE p_zcustom ls_tvko
*                        '01' lv_spaku
*                   INTO lv_csh2pkey.
*
*            SELECT SINGLE csh2pkey INTO lv_csh2pkey
*              FROM zaps_cust
*             WHERE csh2pkey EQ lv_csh2pkey.
*            " If not found, display error
*            IF sy-subrc NE 0.
*              lv_cursor = 'ZWBS_ITEM-ZCUSTOM'.
*              CLEAR: lv_messg.
*CONCATENATE text-e14 p_zcustom text-e18 INTO lv_msg1 SEPARATED BY
*space.
*CONCATENATE ls_tvko text-e31 lv_spaku text-e33 INTO lv_msg2 SEPARATED
*BY space.
*
*              MESSAGE w889(co) WITH lv_msg1 lv_msg2 text-e17.
*            ENDIF.
*          ENDIF.
*        ENDIF.
*      ENDIF.
*      CHECK cv_error IS INITIAL.
      " Validation 2 for Production Plant
      CLEAR: lv_prdplant.
      SELECT SINGLE prd_plant INTO lv_prdplant
        FROM zibp_wbs_plants
       WHERE wbs_plant EQ p_werks
         AND bus_area EQ p_pgsbr.

      IF sy-subrc NE 0.
        SELECT SINGLE prd_plant INTO lv_prdplant
          FROM zibp_wbs_plants
         WHERE wbs_plant EQ p_werks.
      ENDIF.

      CLEAR: lv_bukrs.
      SELECT SINGLE bukrs INTO lv_bukrs
        FROM t001k
       WHERE bwkey EQ lv_prdplant.

      IF sy-subrc EQ 0
AND ( sy-ucomm EQ 'SUBMIT' OR ok_code EQ 'SUBMIT' ).
        " Get Sales org by passing company code
        CLEAR: ls_tvko.
        SELECT SINGLE vkorg INTO ls_tvko
          FROM tvko
         WHERE bukrs EQ lv_bukrs.
        IF sy-subrc EQ 0.
          " Build Cust Ship to Picaso Key
          CLEAR: lv_spaku.
          SELECT SINGLE spaku
            FROM tvta INTO lv_spaku
           WHERE vkorg = ls_tvko
             AND vtweg = '01'
             AND spart = p_pgsbr+2(2).
          IF sy-subrc EQ 0 AND lv_spaku IS NOT INITIAL.
*            CLEAR: lv_csh2pkey.
*            CONCATENATE p_zcustom ls_tvko
*                        '01' lv_spaku
*                   INTO lv_csh2pkey.
*
*            SELECT SINGLE csh2pkey INTO lv_csh2pkey
*              FROM zaps_cust
*             WHERE csh2pkey EQ lv_csh2pkey.
*            " If not found, display error
*            IF sy-subrc NE 0.
*              lv_cursor = 'ZWBS_ITEM-ZCUSTOM'.
*              CLEAR: lv_messg.
*CONCATENATE text-e14 p_zcustom text-e18 INTO lv_msg1 SEPARATED BY
*space.
*CONCATENATE ls_tvko text-e31 lv_spaku text-e19 INTO lv_msg2 SEPARATED
*BY space.
*
*              MESSAGE w889(co) WITH lv_msg1 lv_msg2 text-e17.
*            ENDIF.
            SELECT SINGLE loevm FROM knvv
              INTO lv_loevm
             WHERE kunnr = p_zcustom AND
                   vkorg = ls_tvko AND
                   spart = lv_spaku.
            IF sy-subrc EQ 0.
              " Begin of changes by AKOTA for EiCR 787082
              IF lv_loevm EQ 'X' AND ( sy-ucomm EQ 'SUBMIT' OR ok_code
              EQ 'SUBMIT' ).
*                lv_cursor = 'ZWBS_ITEM-ZCUSTOM'.
                CLEAR: ls_messg.
*                CONCATENATE text-e14 p_zcustom
*                            text-e32 INTO lv_msg1 SEPARATED BY space.
*CONCATENATE ls_tvko text-e31 lv_spaku text-e19 INTO lv_msg2
*                SEPARATED BY space.
*
*                MESSAGE w889(co) WITH lv_msg1 lv_msg2 text-e16.
                CONCATENATE text-e14 p_zcustom text-e32 ls_tvko text-e31
                lv_spaku
                            text-e19 text-e16 INTO ls_messg-msg_text
                     SEPARATED BY space.
                APPEND ls_messg TO lt_messg.
              ENDIF.
            ELSE.
              IF ( sy-ucomm EQ 'SUBMIT' OR ok_code EQ 'SUBMIT' ).
*                lv_cursor = 'ZWBS_ITEM-ZCUSTOM'.
                CLEAR: ls_messg.
*                CONCATENATE text-e14 p_zcustom text-e18 INTO lv_msg1
*                    SEPARATED BY space.
*CONCATENATE ls_tvko text-e31 lv_spaku text-e19 INTO lv_msg2
*                SEPARATED BY space.
*
*                MESSAGE w889(co) WITH lv_msg1 lv_msg2 text-e17.
                CONCATENATE text-e14 p_zcustom text-e18 ls_tvko text-e31
                lv_spaku
                            text-e19 text-e17 INTO ls_messg-msg_text
                     SEPARATED BY space.
                APPEND ls_messg TO lt_messg.
                " End of changes by AKOTA for EiCR 787082
              ENDIF.
            ENDIF.
            " End of Changes for EiCR - 729491
          ENDIF.
        ENDIF.
      ENDIF.
      " End of Changes for EiCR - 729491
    ELSE.
      lv_cursor = 'ZWBS_ITEM-ZCUSTOM'.
      cv_error  = abap_true.
      MESSAGE text-e08 TYPE 'S' DISPLAY LIKE 'E'.
    ENDIF.
  ENDIF.
ENDFORM.
""* End of changes by AKOTA for CR 668561
""* Begin of changes by AKOTA for CR 689451
FORM f_validate_wbs USING p_pspid
                 CHANGING cv_error.

  DATA: lv_posid TYPE prps-posid,
        lv_loevm TYPE prps-loevm.

  CHECK cv_error IS INITIAL.

  IF p_pspid IS NOT INITIAL.

    SELECT SINGLE posid loevm
      INTO (lv_posid, lv_loevm)
      FROM prps
     WHERE posid EQ p_pspid.
    IF sy-subrc EQ 0.
      cv_error  = abap_true.
      lv_cursor = 'ZWBS_ITEM-PSPID'.
      CLEAR: lv_messg.

      CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
        EXPORTING
          input  = lv_posid
        IMPORTING
          output = lv_posid.

      IF lv_loevm EQ 'X'.
        CONCATENATE text-e24 lv_posid text-e25 text-e26
          INTO lv_messg SEPARATED BY space.
      ELSE.
        CONCATENATE text-e24 lv_posid text-e25
          INTO lv_messg SEPARATED BY space.
      ENDIF.
      MESSAGE lv_messg TYPE 'S' DISPLAY LIKE 'E'.
    ENDIF.
  ENDIF.
ENDFORM.
""* End of changes by AKOTA for CR 689451
*&--------------------------------------------------------------------*
*&      Form  CLEAR_FCODE
*&--------------------------------------------------------------------*
FORM clear_fcode.

  IF NOT lv_error IS INITIAL  AND
       ( sy-ucomm = 'SUBMIT'  OR
         sy-ucomm = 'APPROVE' OR
         sy-ucomm = 'REJECT' ).
    CLEAR:ok_code,sy-ucomm.
  ENDIF.

ENDFORM.                    " CLEAR_FCODE
*&--------------------------------------------------------------------*
*&      Form  HANDLE_REMARKS
*&--------------------------------------------------------------------*
FORM handle_remarks USING is_table TYPE ts_table.

  CLEAR:lv_tdname,lv_mode,ls_header,ls_lines,ls_result,ls_remarks,
        lv_lines,lt_lines.

  IF NOT is_table-request IS INITIAL.
    CONCATENATE is_table-request is_table-pspid INTO lv_tdname.
  ELSE.
    lv_tdname = is_table-pspid.
  ENDIF.

  IF sy-tcode = 'ZCJ03' OR NOT lv_dflag IS INITIAL.
    lv_mode = abap_true.
  ELSE.
    lv_mode = abap_false.
  ENDIF.

*Check if Text already Exists
  READ TABLE lt_remarks INTO ls_remarks
                        WITH KEY pspid = is_table-pspid.
  IF ls_remarks-tline[] IS INITIAL.
    CALL FUNCTION 'INIT_TEXT'
      EXPORTING
        id       = lc_com_id
        language = lc_spras
        name     = lv_tdname
        object   = lc_object
      IMPORTING
        header   = ls_header
      TABLES
        lines    = lt_lines
      EXCEPTIONS
        id       = 1
        language = 2
        name     = 3
        object   = 4
        OTHERS   = 5.
    IF sy-subrc <> 0.
    ENDIF.
    ls_lines-tdformat = '*'.
    APPEND ls_lines TO lt_lines.
  ELSE.
    ls_header = ls_remarks-thead.
    lt_lines  = ls_remarks-tline.
  ENDIF.

  CALL FUNCTION 'EDIT_TEXT'
    EXPORTING
      display       = lv_mode
      header        = ls_header
      save          = space
      program       = sy-repid
    IMPORTING
      newheader     = ls_header
      result        = ls_result
    TABLES
      lines         = lt_lines
    EXCEPTIONS
      id            = 1
      language      = 2
      linesize      = 3
      name          = 4
      object        = 5
      textformat    = 6
      communication = 7
      error_message = 8
      OTHERS        = 9.
  IF sy-subrc <> 0.
    EXIT.
  ENDIF.
*Check if Text exists after Editing
  IF ls_header-tdtxtlines = 1.
    READ TABLE lt_lines INTO ls_lines INDEX 1.
    IF ls_lines-tdline IS INITIAL.
      REFRESH lt_lines.
    ENDIF.
  ENDIF.

* Process based on user action:
* User wants to update
  IF ( ls_result-function = 'U' OR ls_result-function = 'I' ) AND
   NOT ls_result-userexit = 'C'.
    DESCRIBE TABLE lt_lines LINES lv_lines.
    IF lv_lines > 0.
      READ TABLE lt_remarks ASSIGNING <fs_remarks>
                            WITH KEY pspid = ls_table-pspid.
      IF sy-subrc = 0.
        <fs_remarks>-pspid = ls_table-pspid.
        <fs_remarks>-thead  = ls_header.
        <fs_remarks>-tline  = lt_lines.
      ELSE.
        ls_remarks-pspid = ls_table-pspid.
        ls_remarks-thead  = ls_header.
        ls_remarks-tline  = lt_lines.
        APPEND ls_remarks TO lt_remarks.
        CLEAR ls_remarks.
      ENDIF.
    ENDIF.
* User wants to delete current text
  ELSEIF ls_result-function = 'D' AND
     NOT ls_result-userexit = 'C'.
*    CLEAR lv_exists .
    CALL FUNCTION 'DELETE_TEXT'
      EXPORTING
        client          = sy-mandt
        id              = lc_com_id
        language        = lc_spras
        name            = lv_tdname
        object          = lc_object
        savemode_direct = 'X'
        textmemory_only = 'X'
      EXCEPTIONS
        not_found       = 1
        OTHERS          = 2.
    IF sy-subrc <> 0.
    ENDIF.
* Do nothing - replace old long text data (also if Function = space or
* userexit = C)
  ELSE.
  ENDIF.

ENDFORM.                    " HANDLE_REMARKS
*&---------------------------------------------------------------------*
*&      Form  DELETE_DATA
*&---------------------------------------------------------------------*
FORM delete_data.

  CLEAR:ls_head,lt_wbs_item.

  MOVE-CORRESPONDING zwbs_header TO ls_head.
*Request Number
  PERFORM get_request CHANGING ls_head.

  PERFORM collect_data USING 'D' ' '.

  PERFORM update_data.

**Update Workflow Status
*  PERFORM update_status.
*
*  PERFORM send_mail USING 'R'.

  PERFORM status_message.

ENDFORM.                    " DELETE_DATA
*&---------------------------------------------------------------------*
*&      Form  SIMULATE_CHANGE_DATA
*&---------------------------------------------------------------------*
FORM simulate_change_data USING pv_type TYPE char1.

*Valid only Master Data Team
  CHECK lv_error IS INITIAL.

  CLEAR:lt_return,lv_error.

  CASE pv_type.
*Create
    WHEN 1.
      PERFORM wbs_request_create USING 'X'.
*Change
    WHEN 2.
      PERFORM wbs_request_change USING 'X'.
    WHEN OTHERS.
  ENDCASE.

  IF NOT lt_return IS INITIAL.
    CALL FUNCTION 'FINB_BAPIRET2_DISPLAY'
      EXPORTING
        it_message = lt_return.
*  Begin of change by LCHENNA for CR 797199
    IF gv_auto_approver_step IS INITIAL.
      CLEAR lt_return. " lt_return is used for
    ENDIF.             "sending error email to PM and MDM
*  End of change by LCHENNA for CR 797199
  ENDIF.

ENDFORM.                    " SIMULATE_CHANGE_DATA
*&---------------------------------------------------------------------*
*&      Form  APPROVE_DATA
*&---------------------------------------------------------------------*
FORM approve_data.

  DATA:lv_pm_approver_step      TYPE flag,
       lv_capex_approver_step   TYPE flag,
       lv_co_approver_step      TYPE flag,
       lv_r2r_acc_approver_step TYPE flag,
       lv_r2r_sr_approver_step  TYPE flag,
       lv_pspid                 TYPE ps_pspid,
       lv_key                   TYPE sweinstcou-objkey,
       lv_event                 TYPE swetypecou-event,
       lt_event_container       TYPE TABLE OF swcont.

  CONSTANTS:lc_a TYPE char1 VALUE 'A'.

  CHECK lt_return IS INITIAL.

  CLEAR:ls_head,lt_wbs_item,lv_project_st,lv_project_str,lv_offset,
  lv_error.

  MOVE-CORRESPONDING zwbs_header TO ls_head.

  CLEAR:gv_approver_step,gv_auto_approver_step,
        gv_r2r_acc_app_response,gv_co_app_response,
        gv_pm_app_response,gv_mdm_app_response,gv_capex_app_response,
        gv_at_pm_approver_step,lv_pm_approver_step,
        gv_at_capex_approver_step,lv_capex_approver_step,
        gv_at_co_approver_step,lv_co_approver_step,
        gv_at_r2r_acc_approver_step,lv_r2r_acc_approver_step,
        gv_at_r2r_sr_approver_step,lv_r2r_sr_approver_step,
        gv_r2r_sr_app_response,gv_auto_approver_step_error,
        lv_wf_flag.
*-------------------
  IMPORT: gv_at_capex_approver_step = gv_at_capex_approver_step
  " CAPEX Approver Step
                                FROM MEMORY ID
                                'ZWBS_AT_CAPEX_APPROVER_STEP',
         gv_at_pm_approver_step = gv_at_pm_approver_step
         " PM Approver Step
                                 FROM MEMORY ID
                                 'ZWBS_AT_PM_APPROVER_STEP',
         gv_at_co_approver_step = gv_at_co_approver_step
         " CO Approver Step
                                FROM MEMORY ID
                                'ZWBS_AT_CO_APPROVER_STEP',
         gv_at_r2r_acc_approver_step  =  gv_at_r2r_acc_approver_step
         " R2R Acc Approver Step
                                FROM MEMORY ID
                                'ZWBS_AT_R2R_ACC_APPROVER_STEP',
         gv_at_r2r_sr_approver_step  =  gv_at_r2r_sr_approver_step
         " R2R SR Approver Step
                                FROM MEMORY ID
                                'ZWBS_AT_R2R_SR_APPROVER_STEP',
         gv_auto_approver_step  =  gv_auto_approver_step
         " Auto Approver Step
                                FROM MEMORY ID 'ZWBS_AUTO_APPROVER_STEP'
                                ,
         lv_wf_flag = lv_wf_flag FROM MEMORY ID 'ZWBS_WF_FLAG'.
  " MD Approver Step

  IF gv_at_capex_approver_step IS NOT INITIAL.
    lv_capex_approver_step = abap_true.
  ELSEIF gv_at_pm_approver_step IS NOT INITIAL.
    lv_pm_approver_step = abap_true.
  ELSEIF gv_at_co_approver_step IS NOT INITIAL.
    lv_co_approver_step = abap_true.
  ELSEIF gv_at_r2r_acc_approver_step IS NOT INITIAL.
    lv_r2r_acc_approver_step = abap_true.
  ELSEIF gv_at_r2r_sr_approver_step IS NOT INITIAL.
    lv_r2r_sr_approver_step = abap_true.
  ENDIF.
*-------------------

  CASE abap_true.
********************************
* CAPEX Approver Step
    WHEN lv_capex_approver_step.
* Request Number
      PERFORM get_request CHANGING ls_head.
      PERFORM collect_data USING 'A' lv_capex_approver_step.
      " A or something else? Check if
      " new status per new step?
      PERFORM update_data.
      FREE MEMORY ID 'ZWBS_CAPEX_APPROVER_RESPONSE'.
      gv_capex_app_response      = lc_a.
      EXPORT:gv_capex_app_response = gv_capex_app_response TO MEMORY ID
                             'ZWBS_CAPEX_APPROVER_RESPONSE'.

* PM APPROVER STEP
    WHEN lv_pm_approver_step.
********************************
* Request Number
      PERFORM get_request CHANGING ls_head.
      PERFORM collect_data USING 'A' lv_pm_approver_step.
      " A or something else? Check if
      " new status per new step?
      PERFORM update_data.
      FREE MEMORY ID 'ZWBS_PM_APPROVER_RESPONSE'.
      gv_pm_app_response      = lc_a.
      EXPORT:gv_pm_app_response = gv_pm_app_response TO MEMORY ID
                             'ZWBS_PM_APPROVER_RESPONSE'.

*      LEAVE. " Leave transactions after all updates
********************************
* CO APPROVER STEP
    WHEN lv_co_approver_step.
********************************
* Request Number
      PERFORM get_request CHANGING ls_head.
      PERFORM collect_data USING 'A' lv_co_approver_step.
      " A or something else? Check if
      " new status per new step?
      PERFORM update_data.
      FREE MEMORY ID 'ZWBS_CO_APPROVER_RESPONSE'.
      gv_co_app_response = lc_a.
      EXPORT:
       gv_co_app_response = gv_co_app_response TO MEMORY ID
                             'ZWBS_CO_APPROVER_RESPONSE'.

*      LEAVE. " Leave transactions after all updates
********************************
* R2R Acc APPROVER STEP
    WHEN lv_r2r_acc_approver_step.
********************************
* Request Number
      PERFORM get_request CHANGING ls_head.
      PERFORM collect_data USING 'A' lv_r2r_acc_approver_step.
      " A or something else? Check if
      " new status per new step?
      PERFORM update_data.
      FREE MEMORY ID 'ZWBS_R2R_ACC_APPROVER_RESPONSE'.
      gv_r2r_acc_app_response = lc_a.
      EXPORT:
       gv_r2r_acc_app_response = gv_r2r_acc_app_response TO MEMORY ID
                             'ZWBS_R2R_ACC_APPROVER_RESPONSE'.

*      LEAVE. " Leave transactions after all updates
********************************
* R2R SR APPROVER STEP
    WHEN lv_r2r_sr_approver_step.
********************************
* Request Number
      PERFORM get_request CHANGING ls_head.
      PERFORM collect_data USING 'A' lv_r2r_sr_approver_step.
      " A or something else? Check if
      " new status per new step?
      PERFORM update_data.
      FREE MEMORY ID 'ZWBS_R2R_SR_APPROVER_RESPONSE'.
      gv_r2r_sr_app_response = lc_a.
      EXPORT:gv_r2r_sr_app_response = gv_r2r_sr_app_response TO MEMORY
      ID
                                   'ZWBS_R2R_SR_APPROVER_RESPONSE'.
*      LEAVE. " Leave transactions after all updates

    WHEN lv_wf_flag OR gv_auto_approver_step.
      "MDM or Auto Approval Steps

*Check for Partial Approved Lines for Cases Close & Unclose
*Skip Auto Approval and Re-direct to MDM in this case
      IF NOT gv_auto_approver_step IS INITIAL AND
           ( lv_type = 3 OR lv_type = 4 ).
        LOOP AT lt_table TRANSPORTING NO FIELDS
                         WHERE ( zclose   EQ abap_true   OR
                                 zunclose EQ abap_true ) AND
                                 accept   NE 'X'.
          EXIT.
        ENDLOOP.
        IF sy-subrc = 0.
          MESSAGE 'Partial Approved Lines Exist,Redirected to MDM' TYPE
          'E'.
        ENDIF.
      ENDIF.

      FREE MEMORY ID 'ZWBS_MDM_APPROVER_RESPONSE'.
      gv_mdm_app_response = lc_a.
      EXPORT gv_mdm_app_response = gv_mdm_app_response TO MEMORY ID
                                   'ZWBS_MDM_APPROVER_RESPONSE'.

      IF gv_capex IS NOT INITIAL.
        FREE MEMORY ID 'ZWBS_CAPEX_APPROVER_RESPONSE'.
        gv_capex_app_response = lc_a.
        EXPORT gv_capex_app_response = gv_capex_app_response TO MEMORY
        ID
                                     'ZWBS_CAPEX_APPROVER_RESPONSE'.
      ENDIF.
      IF ls_head-type = 1.
*Determine Number for Project/WBS
        IF gv_capex IS NOT INITIAL.
          CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
            EXPORTING
              input  = zwbs_header-pspid
            IMPORTING
              output = lv_proj3_type.
          lv_project_st = lv_proj3_type.
        ELSE.
*          lv_project_st = ls_head-proj_type.
          lv_project_st = ls_head-pspid+0(2).
        ENDIF.
        CALL FUNCTION 'CN_SUCHE_FREIE_NUMMER'
          EXPORTING
            search_imp      = '1'
            refresh         = abap_true
            proj_s_imp      = lv_project_st
          IMPORTING
            proj_exp        = lv_project_new
          EXCEPTIONS
            wrong_search    = 1
            search_canceled = 2
            OTHERS          = 3.
        IF sy-subrc <> 0.
* Implement suitable error handling here
        ENDIF.

        IF lv_project_new IS INITIAL.
          MESSAGE ID 'CJ' TYPE 'I' NUMBER '132' DISPLAY LIKE 'E'.
          EXIT.
        ENDIF.

        CALL FUNCTION 'CONVERSION_EXIT_ABPSN_INPUT'
          EXPORTING
            input  = lv_project_new
          IMPORTING
            output = ls_head-pspid.

*Check if Project Already Exists
        CALL FUNCTION 'CJDW_PROJ_SELECT_SINGLE'
          EXPORTING
            pspid     = ls_head-pspid
          EXCEPTIONS
            not_found = 1.
        IF sy-subrc <> 1.
          MESSAGE ID 'CJ' TYPE 'I' NUMBER '010' WITH ls_head-pspid
          DISPLAY LIKE 'E'.
          EXIT.
        ENDIF.

*Lock Project for further Editing
        CALL FUNCTION 'CJDW_ENQUEUE'
          EXPORTING
            object_id         = ls_head-pspid
          EXCEPTIONS
            foreign_lock      = 1
            invalid_type      = 2
            missing_parameter = 3
            system_failure    = 4
            OTHERS            = 5.
        IF sy-subrc <> 0.
          EXIT.
        ENDIF.

        FIND FIRST OCCURRENCE OF '.' IN lv_project_new MATCH OFFSET
        lv_offset.
        lv_offset = lv_offset + 1.
        lv_project_str = lv_project_new+lv_offset.
        DATA(lv_len) = strlen( lv_project_str ).
        lv_offset = lv_offset + lv_len - 1.
      ENDIF.

*Request Number
      PERFORM get_request CHANGING ls_head.

      PERFORM collect_data USING 'A' gv_approver_step .

      PERFORM update_data.

*Simulation for Errors
      PERFORM simulate_change_data USING ls_head-type.

*Process Request
      PERFORM process_request_data USING ls_head-type.

*Update Workflow Status
      PERFORM update_status.

      PERFORM send_mail USING 'A'.

** Trigger the event for Unifier Project to send the Idoc to snaplogic.
      IF gv_capex = 'X' AND lv_error IS INITIAL.
        READ TABLE lt_wbs_item INTO DATA(ls_uni_itm) WITH KEY stufe = '1'.
        IF sy-subrc = 0.
          SELECT SINGLE * FROM prps INTO @DATA(ls_uni_prps)
            WHERE posid = @ls_uni_itm-pspid_new.
          IF sy-subrc = 0 AND ls_uni_prps-zunifier_proj = 'X'.
            CALL FUNCTION 'CONVERSION_EXIT_ABPRJ_OUTPUT'
              EXPORTING
                input  = ls_uni_prps-psphi
              IMPORTING
                output = lv_pspid.
            lv_key    = lv_pspid.
            lv_key+24 = ls_uni_prps-psphi.

            IF lv_type = 1 AND zwbs_header-status = '2'.
              lv_event = 'UPCProjectEnabled'.
            ELSEIF lv_type = 1 AND ls_head-status = '2'.
              lv_event = 'UPCProjectEnabled'.
            ELSEIF lv_type = 2 AND zwbs_header-status = '2'.
              lv_event = 'UPCProjectUpdated'.
            ELSEIF lv_type = 2 AND ls_head-status = '2'.
              lv_event = 'UPCProjectUpdated'.
            ELSEIF lv_type = 2 AND zwbs_header-status = '3'.
              lv_event = 'UPCProjectRejected'.
            ELSEIF lv_type = 2 AND ls_head-status = '3'.
              lv_event = 'UPCProjectRejected'.
            ENDIF.

            IF lv_event IS NOT INITIAL.
              CALL FUNCTION 'SWE_EVENT_CREATE'
                EXPORTING
                  objtype         = 'ZBUS2001'
                  objkey          = lv_key
                  event           = lv_event
*                 CREATOR         = ' '
*                 START_WITH_DELAY              = ' '
*                 TAKE_WORKITEM_REQUESTER       = ' '
                TABLES
                  event_container = lt_event_container
*   EXCEPTIONS
*                 OBJTYPE_NOT_FOUND             = 1
*                 OTHERS          = 2
                .
              IF sy-subrc <> 0.
*  Implement suitable error handling here
              ELSE.
                COMMIT WORK.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.

*      PERFORM status_message.

*****************************************************************
*    WHEN gv_approver_step. " Other Approvers' Step
** Request Number
*      PERFORM get_request CHANGING ls_head.
*
*      PERFORM collect_data USING 'A'
*                                 gv_approver_step.
*      " A or something else? Check if
*      " new status per new step?
*      PERFORM update_data.
*
*      FREE MEMORY ID:
*        'ZWBS_PM_APPROVER_RESPONSE',
*        'ZWBS_CO_APPROVER_RESPONSE',
*        'ZWBS_R2R_ACC_APPROVER_RESPONSE'.
*
*      gv_r2r_acc_app_response = gv_co_app_response =
*      gv_pm_app_response      = lc_a.
*
*
*      EXPORT:
*       gv_pm_app_response = gv_pm_app_response TO MEMORY ID
*                             'ZWBS_PM_APPROVER_RESPONSE',
*       gv_co_app_response = gv_co_app_response TO MEMORY ID
*                             'ZWBS_CO_APPROVER_RESPONSE',
*       gv_r2r_acc_app_response = gv_r2r_acc_app_response
*              TO MEMORY ID
*                             'ZWBS_R2R_ACC_APPROVER_RESPONSE'.
*
*      LEAVE. " Leave transactions after all updates
*********************************************************************
  ENDCASE.

  PERFORM status_message.

ENDFORM.                    " APPROVE_DATA
*&---------------------------------------------------------------------*
*&      Form  REJECT_DATA
*&---------------------------------------------------------------------*
FORM reject_data .

  DATA:lv_pm_approver_step      TYPE flag,
       lv_co_approver_step      TYPE flag,
       lv_r2r_acc_approver_step TYPE flag,
       lv_r2r_sr_approver_step  TYPE flag,
       lv_pspid                 TYPE ps_pspid,
       lv_key                   TYPE sweinstcou-objkey,
       lv_event                 TYPE swetypecou-event,
       lt_event_container       TYPE TABLE OF swcont..

  CONSTANTS:lc_r TYPE char1 VALUE 'R'.

  CLEAR:gv_pm_app_response,
        gv_co_app_response,
        gv_r2r_acc_app_response,
        gv_mdm_app_response,
        gv_r2r_sr_app_response,
        gv_at_pm_approver_step,
        gv_at_co_approver_step,
        gv_at_r2r_acc_approver_step,
        gv_at_r2r_sr_approver_step,
        gv_auto_approver_step,
        lv_wf_flag,
        lv_pm_approver_step,
        lv_co_approver_step,
        lv_r2r_acc_approver_step,
        lv_r2r_sr_approver_step.

  IMPORT:gv_at_pm_approver_step = gv_at_pm_approver_step
  " --> PM Approver Step
                               FROM MEMORY ID 'ZWBS_AT_PM_APPROVER_STEP'
                               ,
        gv_at_co_approver_step = gv_at_co_approver_step
        " --> CO Approver Step
                               FROM MEMORY ID 'ZWBS_AT_CO_APPROVER_STEP'
                               ,
        gv_at_r2r_acc_approver_step  =  gv_at_r2r_acc_approver_step
        " --> R2R Acc Approver Step
                               FROM MEMORY ID
                               'ZWBS_AT_R2R_ACC_APPROVER_STEP',
        gv_at_r2r_sr_approver_step  =  gv_at_r2r_sr_approver_step
        " --> R2R SR Approver Step
                               FROM MEMORY ID
                               'ZWBS_AT_R2R_SR_APPROVER_STEP',
        lv_wf_flag = lv_wf_flag FROM MEMORY ID 'ZWBS_WF_FLAG'.
  " --> MD Approver Step

  IF gv_at_pm_approver_step IS NOT INITIAL.
    lv_pm_approver_step = abap_true.
  ELSEIF gv_at_co_approver_step IS NOT INITIAL.
    lv_co_approver_step = abap_true.
  ELSEIF gv_at_r2r_acc_approver_step IS NOT INITIAL.
    lv_r2r_acc_approver_step = abap_true.
  ELSEIF gv_at_r2r_sr_approver_step IS NOT INITIAL.
    lv_r2r_sr_approver_step = abap_true.
  ENDIF.

  CASE abap_true.
    WHEN lv_pm_approver_step.
      EXPORT gv_pm_app_response  = lc_r TO MEMORY ID
                              'ZWBS_PM_APPROVER_RESPONSE'.
    WHEN lv_co_approver_step.
      EXPORT gv_co_app_response  = lc_r TO MEMORY ID
                             'ZWBS_CO_APPROVER_RESPONSE'.
    WHEN lv_r2r_acc_approver_step.
      EXPORT gv_r2r_acc_app_response = lc_r TO MEMORY ID
                            'ZWBS_R2R_ACC_APPROVER_RESPONSE'.
    WHEN lv_r2r_sr_approver_step.
      EXPORT gv_r2r_sr_app_response = lc_r TO MEMORY ID
                            'ZWBS_R2R_SR_APPROVER_RESPONSE'.
    WHEN lv_wf_flag.
      EXPORT gv_mdm_app_response = lc_r TO MEMORY ID
                             'ZWBS_MDM_APPROVER_RESPONSE'.

  ENDCASE.

  CLEAR:ls_head,lt_wbs_item.

  MOVE-CORRESPONDING zwbs_header TO ls_head.
*Request Number
  PERFORM get_request CHANGING ls_head.

  PERFORM collect_data USING 'R' ' '.

*Maintain Reason for Rejection
*  perform rejection_reason using lc_false.

  PERFORM update_data.

*Update Workflow Status
  PERFORM update_status.

  PERFORM send_mail USING 'R'.

** Trigger the event for Unifier Project to send the Idoc to snaplogic.
  IF gv_capex = 'X' AND lv_error IS INITIAL.
    READ TABLE lt_wbs_item INTO DATA(ls_uni_itm) WITH KEY stufe = '1'.
    IF sy-subrc = 0.
      SELECT SINGLE * FROM prps INTO @DATA(ls_uni_prps)
        WHERE posid = @ls_uni_itm-pspid_new.
      IF sy-subrc = 0 AND ls_uni_prps-zunifier_proj = 'X'.
        CALL FUNCTION 'CONVERSION_EXIT_ABPRJ_OUTPUT'
          EXPORTING
            input  = ls_uni_prps-psphi
          IMPORTING
            output = lv_pspid.
        lv_key    = lv_pspid.
        lv_key+24 = ls_uni_prps-psphi.

*            IF lv_type = 1 AND zwbs_header-status = '2'.
*              lv_event = 'UPCProjectEnabled'.
*            ELSEIF lv_type = 2 AND zwbs_header-status = '2'.
*              lv_event = 'UPCProjectUpdated'.
*            ELSE
        IF lv_type = 2 AND ls_head-status = '3'.
          lv_event = 'UPCProjectRejected'.
        ENDIF.

        IF lv_event IS NOT INITIAL.
          CALL FUNCTION 'SWE_EVENT_CREATE'
            EXPORTING
              objtype         = 'ZBUS2001'
              objkey          = lv_key
              event           = lv_event
*             CREATOR         = ' '
*             START_WITH_DELAY              = ' '
*             TAKE_WORKITEM_REQUESTER       = ' '
            TABLES
              event_container = lt_event_container
*   EXCEPTIONS
*             OBJTYPE_NOT_FOUND             = 1
*             OTHERS          = 2
            .
          IF sy-subrc <> 0.
*  Implement suitable error handling here
          ELSE.
            COMMIT WORK.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

  PERFORM status_message.

ENDFORM.                    " REJECT_DATA
*&---------------------------------------------------------------------*
*&      Form  UPDATE_STATUS
*&---------------------------------------------------------------------*
FORM update_status .

  CHECK lv_error IS INITIAL.

  FREE MEMORY ID 'ZWBS_WF_STATUS'.
  IF NOT lv_wf_status IS INITIAL.
    EXPORT lv_status = lv_wf_status TO MEMORY ID 'ZWBS_WF_STATUS'.
  ENDIF.

ENDFORM.                    " UPDATE_STATUS
*&--------------------------------------------------------------------*
*&      Form  UPDATE_TEXT_DATA
*&--------------------------------------------------------------------*
FORM update_text_data.

  CLEAR:lv_tdname,ls_header,lt_lines,lt_log.

*Header Text
  lv_tdname = zwbs_header-request.

  CALL FUNCTION 'INIT_TEXT'
    EXPORTING
      id       = lc_rem_id
      language = lc_spras
      name     = lv_tdname
      object   = lc_object
    IMPORTING
      header   = ls_header
    TABLES
      lines    = lt_lines
    EXCEPTIONS
      id       = 1
      language = 2
      name     = 3
      object   = 4
      OTHERS   = 5.
  IF sy-subrc <> 0.
    EXIT.
  ENDIF.

  IF NOT lt_text IS INITIAL AND
     lines( lt_text ) NE lv_rlines.
*Add timestamp to Remarks Section
    CALL FUNCTION 'TEXT_CREATE_HISTORY_LINE'
      IMPORTING
        history_line = ls_log-text.
    IF ls_log-text+0(1) = '*'.
      CLEAR ls_log-text+0(1).
      CONDENSE ls_log-text.
    ENDIF.
    IF lv_rlines IS INITIAL.
      lv_rlines = 1.
    ELSE.
      lv_rlines = lv_rlines + 1.
      APPEND INITIAL LINE TO lt_log.
    ENDIF.
    APPEND ls_log TO lt_log.

    INSERT LINES OF lt_log INTO lt_text INDEX lv_rlines.

    lt_lines = CORRESPONDING #( lt_text MAPPING tdline = text ).
    CALL FUNCTION 'SAVE_TEXT'
      EXPORTING
        client   = sy-mandt
        header   = ls_header
      TABLES
        lines    = lt_lines
      EXCEPTIONS
        id       = 1
        language = 2
        name     = 3
        object   = 4
        OTHERS   = 5.
    IF sy-subrc <> 0.
    ENDIF.
  ENDIF.

*Item Texts
  LOOP AT lt_remarks INTO ls_remarks.
    CLEAR:ls_header,lt_lines.
*Line Item Identifier
    ls_header = ls_remarks-thead.
    CLEAR ls_header-tdname.
    CONCATENATE ls_head-request ls_remarks-pspid INTO ls_header-tdname.

    lt_lines = ls_remarks-tline.
    CALL FUNCTION 'SAVE_TEXT'
      EXPORTING
        client   = sy-mandt
        header   = ls_header
      TABLES
        lines    = lt_lines
      EXCEPTIONS
        id       = 1
        language = 2
        name     = 3
        object   = 4
        OTHERS   = 5.
    IF sy-subrc <> 0.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " UPDATE_TEXT_DATA
*&---------------------------------------------------------------------*
*&      Form  PROCESS_REQUEST_DATA
*&---------------------------------------------------------------------*
FORM process_request_data USING pv_type TYPE char1.

  CHECK lv_error IS INITIAL.

  CLEAR:lt_return,lv_error.

  CASE pv_type.
*Create
    WHEN 1.
      PERFORM wbs_request_create USING space.
*Change
    WHEN 2.
      PERFORM wbs_request_change USING space.
*Close or Unclose
    WHEN 3 OR 4.
      PERFORM wbs_request_status_change.
    WHEN OTHERS.
  ENDCASE.

  IF NOT lt_return IS INITIAL.
    CALL FUNCTION 'FINB_BAPIRET2_DISPLAY'
      EXPORTING
        it_message = lt_return.
  ENDIF.

  IF gv_capex IS NOT INITIAL.
*Add timestamp to Log Table
    IF NOT gt_appr_log IS INITIAL.
      CALL FUNCTION 'TEXT_CREATE_HISTORY_LINE'
        IMPORTING
          history_line = gs_appr_log-text.
      IF gs_appr_log-text+0(1) = '*'.
        CLEAR gs_appr_log-text+0(1).
        CONDENSE gs_appr_log-text.
      ENDIF.
      INSERT gs_appr_log INTO gt_appr_log INDEX 1.
      APPEND INITIAL LINE TO gt_appr_log.
*    APPEND LINES OF lt_log TO gt_appr_log.

      CLEAR:lv_tdname,ls_header,lt_lines.
*Log
      lv_tdname = zwbs_header-request.
      CALL FUNCTION 'INIT_TEXT'
        EXPORTING
          id       = 'ZALG'
          language = lc_spras
          name     = lv_tdname
          object   = lc_object
        IMPORTING
          header   = ls_header
        TABLES
          lines    = lt_lines
        EXCEPTIONS
          id       = 1
          language = 2
          name     = 3
          object   = 4
          OTHERS   = 5.
      IF sy-subrc <> 0.
        EXIT.
      ENDIF.

      IF NOT gt_appr_log IS INITIAL.
        lt_lines = CORRESPONDING #( gt_appr_log MAPPING tdline = text ).
        CALL FUNCTION 'SAVE_TEXT'
          EXPORTING
            client   = sy-mandt
            header   = ls_header
          TABLES
            lines    = lt_lines
          EXCEPTIONS
            id       = 1
            language = 2
            name     = 3
            object   = 4
            OTHERS   = 5.
        IF sy-subrc <> 0.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

ENDFORM.                    " PROCESS_REQUEST_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_REPORT_DATA
*&---------------------------------------------------------------------*
FORM get_report_data.

  CLEAR:lt_wbs_header,lt_wbs_item.

*Header Details
  SELECT * FROM zwbs_header INTO TABLE lt_wbs_header
                            WHERE request      IN s_req    AND
                                  pspid        IN s_pspid  AND
                                  zprj_code_pv IN s_prjcod AND
                                  proj_type    IN s_prjtyp AND
                                  type         IN s_type   AND
                                  status       IN s_status AND
                                  created_on   IN s_crton  AND
                                  created_on   IN s_prdon  AND
                                  vbukr        IN s_vbukr  AND
                                  prctr        IN s_prctr  AND
                                  werks        IN s_werks  AND
                                  zprodcod     IN s_code   AND
                                  zprgman      IN s_pgman  AND
                                  izwek        IN s_izwek  AND
                                  zmaint_sys   IN s_msys   AND
                                  created_by   IN s_crt_by
                                  ORDER BY request.

  CHECK NOT lt_wbs_header IS INITIAL.

*Item Details
  SELECT * FROM zwbs_item INTO TABLE lt_wbs_item
                       FOR ALL ENTRIES IN lt_wbs_header
                       WHERE request    EQ lt_wbs_header-request AND
                             stufe      IN s_stufe               AND
                             zmaint_sys IN s_msys.

  SORT lt_wbs_item.
*Workflow Details
  CLEAR:lt_sww_wi2obj,lt_swpsteplog,lt_swwwihead.
  LOOP AT lt_wbs_header INTO ls_head.
    SELECT * FROM sww_wi2obj APPENDING TABLE lt_sww_wi2obj
                             WHERE catid  = 'BO'            AND
                                   instid = ls_head-request AND
                                   typeid = 'Z_WBS'.
  ENDLOOP.

  SORT lt_sww_wi2obj.
  IF NOT lt_sww_wi2obj IS INITIAL.
    SELECT * FROM swpsteplog INTO TABLE lt_swpsteplog
                             FOR ALL ENTRIES IN lt_sww_wi2obj
                       WHERE wf_id      EQ lt_sww_wi2obj-top_wi_id
                       AND
*node_id    IN (12,89)                 AND
                             pred_wi_id EQ space.
    IF NOT lt_swpsteplog IS INITIAL.
*      SORT lt_swpsteplog BY wf_id node_id  ASCENDING
*                                 log_date  DESCENDING
*                                 log_time  DESCENDING
*                                 log_count DESCENDING.
      SORT lt_swpsteplog BY wf_id ASCENDING
                            wi_id DESCENDING.
      SELECT * FROM swwwihead INTO TABLE lt_swwwihead
                             FOR ALL ENTRIES IN lt_swpsteplog
                          WHERE wi_id   = lt_swpsteplog-wf_id OR
                                wi_id   = lt_swpsteplog-wi_id.
      SORT lt_swwwihead.
    ENDIF.
  ENDIF.

  SELECT a~bname a~name_textc INTO TABLE lt_user
                     FROM user_addr AS a INNER JOIN usr02 AS b
                     ON a~bname = b~bname
                     FOR ALL ENTRIES IN lt_wbs_header
                     WHERE a~bname = lt_wbs_header-created_by.
  IF NOT lt_swpsteplog IS INITIAL.
    SELECT a~bname a~name_textc APPENDING TABLE lt_user
                     FROM user_addr AS a INNER JOIN usr02 AS
                     b
                     ON a~bname = b~bname
                     FOR ALL ENTRIES IN lt_swpsteplog
                     WHERE a~bname = lt_swpsteplog-wi_agent.
  ENDIF.
  SORT lt_user.

  SELECT * FROM t9m49 INTO TABLE lt_t9m49
                      FOR ALL ENTRIES IN lt_wbs_header
                  WHERE status  = lt_wbs_header-status AND
                        sprache = lc_spras.
  SELECT ddtext domvalue_l FROM dd07t INTO TABLE lt_type_text
                          WHERE domname    = 'ZZWBS_TYPE' AND
                                ddlanguage = lc_spras.

*Project and WBS Details
  LOOP AT lt_wbs_item INTO ls_item.
    READ TABLE lt_wbs_header INTO ls_head
                   WITH KEY request = ls_item-request.

    ls_output-request      = ls_head-request.
    ls_output-pspid        = ls_head-pspid.
    ls_output-post1        = ls_head-post1.
    ls_output-proj_type    = ls_head-proj_type.
    ls_output-type         = ls_head-type.
    ls_output-status       = ls_head-status.
    ls_output-izwek        = ls_head-izwek.
    ls_output-zmaint_sys_h = ls_head-zmaint_sys.

    ls_output-created_by   = ls_head-created_by.
    ls_output-created_on   = ls_head-created_on.

    ls_output-stufe        = ls_item-stufe.
    ls_output-pspid_wbs    = ls_item-pspid_new.
    ls_output-post1_wbs    = ls_item-post1.
    ls_output-pbukr        = ls_item-pbukr.
    ls_output-pgsbr        = ls_item-pgsbr.
    ls_output-prctr        = ls_item-prctr.

*Request Type
    READ TABLE lt_type_text INTO ls_type_text
                   WITH KEY domvalue_l = ls_head-type.
    ls_output-type_text = ls_type_text-ddtext.

    READ TABLE lt_t9m49 INTO ls_t9m49 WITH KEY status = ls_head-status.
    IF sy-subrc = 0.
      ls_output-status_text = ls_t9m49-text.
    ENDIF.

    READ TABLE lt_user INTO ls_user WITH KEY bname = ls_head-created_by.
    IF sy-subrc = 0.
      ls_output-created_name = ls_user-name_textc.
    ENDIF.

*Submitted Date
    CLEAR ls_sww_wi2obj.
    READ TABLE lt_sww_wi2obj INTO ls_sww_wi2obj
                    WITH KEY instid = ls_head-request.
    IF sy-subrc = 0.
      CLEAR ls_swwwihead.
      READ TABLE lt_swwwihead INTO ls_swwwihead
             WITH KEY wi_id = ls_sww_wi2obj-top_wi_id.
      IF sy-subrc = 0.
        lv_sdate = ls_swwwihead-wi_cd.
        lv_stime = ls_swwwihead-wi_ct.
      ENDIF.
*Completion Date
      CLEAR ls_swpsteplog.
      READ TABLE lt_swpsteplog INTO ls_swpsteplog
                               WITH KEY wf_id   =
                              ls_sww_wi2obj-top_wi_id.
      IF sy-subrc = 0 AND NOT ls_swpsteplog-wi_agent IS INITIAL.
        ls_output-complete_by = ls_swpsteplog-wi_agent.
        READ TABLE lt_user INTO ls_user WITH KEY bname =
        ls_swpsteplog-wi_agent.
        IF sy-subrc = 0.
          ls_output-complete_name = ls_user-name_textc.
        ENDIF.
*Convert TimeStamp to Date and time to avoid Time Zone issues
        lv_timestamps = ls_swpsteplog-timestamp.
        lv_timestamp  = lv_timestamps+0(14).
        CALL FUNCTION 'IB_CONVERT_FROM_TIMESTAMP'
          EXPORTING
            i_timestamp = lv_timestamp
            i_tzone     = sy-zonlo
          IMPORTING
            e_datlo     = lv_cdate
            e_timlo     = lv_ctime.
        ls_output-complete_on = lv_cdate." = ls_swpsteplog-log_date.
*        lv_ctime = ls_swpsteplog-log_time.
      ENDIF.
      IF NOT lv_cdate IS INITIAL AND NOT lv_sdate IS INITIAL.
*Turnaround Time
*        CALL FUNCTION 'SWI_DURATION_DETERMINE'
*          EXPORTING
*            start_date = lv_sdate
*            end_date   = lv_cdate
*            start_time = lv_stime
*            end_time   = lv_ctime
*          IMPORTING
*            duration   = lv_seconds.
        lv_seconds         = ls_swwwihead-exec_time.
        ls_output-turntime = lv_seconds / 3600.
      ENDIF.
    ENDIF.
*PlanView Fields
    ls_output-zprj_code_pv   = ls_head-zprj_code_pv.
    ls_output-zstate_code_pv = ls_item-zstate_code_pv.
    ls_output-zmaint_sys     = ls_item-zmaint_sys.

    APPEND ls_output TO lt_output.
    CLEAR:ls_output,ls_item,ls_head,ls_type_text,lv_sdate,lv_cdate,
          lv_stime,lv_ctime,lv_seconds,lv_timestamp,lv_timestamps.
  ENDLOOP.

ENDFORM.                    " GET_REPORT_DATA
*&---------------------------------------------------------------------*
*&      Form  DISPLAY_DATA
*&---------------------------------------------------------------------*
FORM display_data .

  CALL FUNCTION 'REUSE_ALV_FIELDCATALOG_MERGE'
    EXPORTING
      i_program_name         = sy-repid
      i_internal_tabname     = 'LT_OUTPUT'
    CHANGING
      ct_fieldcat            = lt_fieldcat
    EXCEPTIONS
      inconsistent_interface = 1
      program_error          = 2
      OTHERS                 = 3.
  IF sy-subrc <> 0.
    EXIT.
  ENDIF.

  LOOP AT lt_fieldcat ASSIGNING FIELD-SYMBOL(<fs_fieldcat>).
    CASE <fs_fieldcat>-fieldname.
      WHEN 'REQUEST'.
        <fs_fieldcat>-hotspot      = abap_true.
        <fs_fieldcat>-seltext_s    = 'Req. No.'.
        <fs_fieldcat>-seltext_m    = 'Request Number'.
        <fs_fieldcat>-seltext_l    = 'Request Number'.
        <fs_fieldcat>-reptext_ddic = 'Request Number'.
        <fs_fieldcat>-ddictxt      = 'L'.
      WHEN'PSPID'.
        <fs_fieldcat>-hotspot      = abap_true.
        <fs_fieldcat>-ddictxt      = 'L'.
      WHEN 'PSPID_WBS'.
        <fs_fieldcat>-hotspot      = abap_true.
        <fs_fieldcat>-seltext_s    = 'WBS No.'.
        <fs_fieldcat>-seltext_m    = 'WBS Number'.
        <fs_fieldcat>-seltext_l    = 'WBS Number'.
        <fs_fieldcat>-reptext_ddic = 'WBS Number'.
        <fs_fieldcat>-ddictxt      = 'L'.
      WHEN 'POST1_WBS'.
        <fs_fieldcat>-seltext_s    = 'WBS Desc.'.
        <fs_fieldcat>-seltext_m    = 'WBS Description'.
        <fs_fieldcat>-seltext_l    = 'WBS Description'.
        <fs_fieldcat>-reptext_ddic = 'WBS Description'.
        <fs_fieldcat>-ddictxt      = 'L'.
      WHEN 'CREATED_BY' OR 'CREATED_NAME'.
        <fs_fieldcat>-seltext_s    = 'Req.Name'.
        <fs_fieldcat>-seltext_m    = 'Requester Name'.
        <fs_fieldcat>-seltext_l    = 'Requester Name'.
        <fs_fieldcat>-reptext_ddic = 'Requester Name'.
        <fs_fieldcat>-ddictxt      = 'L'.
      WHEN 'TYPE'.
        <fs_fieldcat>-seltext_s    = 'Request Type'.
        <fs_fieldcat>-seltext_m    = 'Request Type'.
        <fs_fieldcat>-seltext_l    = 'Request Type'.
        <fs_fieldcat>-reptext_ddic = 'Request Type'.
        <fs_fieldcat>-ddictxt      = 'L'.
      WHEN 'TYPE_TEXT'.
        <fs_fieldcat>-seltext_s    = 'Request Type'.
        <fs_fieldcat>-seltext_m    = 'Request Type'.
        <fs_fieldcat>-seltext_l    = 'Request Type'.
        <fs_fieldcat>-reptext_ddic = 'Request Type'.
        <fs_fieldcat>-ddictxt      = 'L'.
      WHEN 'TURNTIME'.
        <fs_fieldcat>-seltext_s    = 'Turnaround(Hrs)'.
        <fs_fieldcat>-seltext_m    = 'Turnaround(Hrs)'.
        <fs_fieldcat>-seltext_l    = 'Turnaround(Hrs)'.
        <fs_fieldcat>-reptext_ddic = 'Turnaround(Hrs)'.
        <fs_fieldcat>-ddictxt      = 'L'.
      WHEN 'COMPLETE_BY' OR 'COMPLETE_NAME'.
        <fs_fieldcat>-seltext_s    = 'Completed by'.
        <fs_fieldcat>-seltext_m    = 'Completed by'.
        <fs_fieldcat>-seltext_l    = 'Completed by'.
        <fs_fieldcat>-reptext_ddic = 'Completed by'.
        <fs_fieldcat>-ddictxt      = 'L'.
      WHEN 'STATUS_TEXT'.
        <fs_fieldcat>-seltext_s    = 'Status'.
        <fs_fieldcat>-seltext_m    = 'Status'.
        <fs_fieldcat>-seltext_l    = 'Status'.
        <fs_fieldcat>-reptext_ddic = 'Status'.
        <fs_fieldcat>-ddictxt      = 'L'.
      WHEN OTHERS.
        <fs_fieldcat>-ddictxt      = 'L'.
    ENDCASE.
  ENDLOOP.

  ls_layout-colwidth_optimize = 'X'.
  ls_layout-zebra = 'X'.

*  SET TITLEBAR 'MAIN' WITH lv_title.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
      i_callback_program       = sy-repid
      i_callback_pf_status_set = 'ALV_STATUS'
      i_callback_user_command  = 'USER_COMMAND'
      is_layout                = ls_layout
      it_fieldcat              = lt_fieldcat
      i_default                = 'X'
      i_save                   = 'A'
    TABLES
      t_outtab                 = lt_output[]
    EXCEPTIONS
      program_error            = 1
      OTHERS                   = 2.
  IF sy-subrc <> 0.
* Implement suitable error handling here
  ENDIF.

ENDFORM.                    " DISPLAY_DATA
*&---------------------------------------------------------------------*
*&      Form  SEND_MAIL
*&---------------------------------------------------------------------*
FORM send_mail USING iv_type.

*  CHECK gv_capex IS INITIAL."DO NOT Send eMail for CAPEX Projects

*  CHECK lv_error IS INITIAL.
  IF lv_error IS INITIAL.
    CALL FUNCTION 'ZWBS_SEND_EMAIL'
      EXPORTING
        iv_type    = iv_type
        iv_req_no  = ls_head-request
        iv_express = 'X'
        iv_user    = sy-uname
        iv_capex   = gv_capex
      TABLES
        lt_error   = lt_return.  " LCHENNA for CR 797199
  ELSE.
*Send Error E-mails ONLY in case of PlanView Requests
    IF NOT ls_head-zprj_code_pv IS INITIAL.
      CALL FUNCTION 'ZWBS_SEND_EMAIL'
        EXPORTING
          iv_type    = 'E'
          iv_req_no  = ls_head-request
          iv_express = 'X'
          iv_user    = sy-uname
          iv_capex   = gv_capex
        TABLES
          lt_error   = lt_return.  " LCHENNA for CR 797199
*  Email triggered, set mail flag to let workflow know email triggered.
      gv_err_mail_flag = 'X'.
      EXPORT gv_err_mail_flag = gv_err_mail_flag
             TO MEMORY ID 'ZWBS_ERR_MAIL'.
    ENDIF.
  ENDIF.

  IF gv_capex = 'X' AND gv_error_email = 'X'.
    PERFORM email.
  ENDIF.

ENDFORM.                    " SEND_MAIL
*&---------------------------------------------------------------------*
*&      Form  SCREEN_0100
*&---------------------------------------------------------------------*
FORM screen_0100.
*  IF lv_proj3 IS NOT INITIAL.
  IF lv_proj_type = 'TC'.
    LOOP AT SCREEN.
      CASE abap_true.
        WHEN lv_rb1.
          CASE screen-name.
            WHEN 'LV_LONZACODE' OR 'ZWBS_HEADER-ZPRODCOD' OR
                 'LV_RB3' OR 'LV_RB4'.
              screen-active = 0.
              MODIFY SCREEN.
          ENDCASE.
        WHEN lv_rb2 OR lv_rb5.
          CASE screen-name.
            WHEN 'ZWBS_HEADER-WERKS'    OR
                 'ZWBS_HEADER-VBUKR'    OR
                 'ZWBS_HEADER-ZPRODCOD' OR
                 'LV_VBUKR'             OR
                 'LV_WERKS'             OR
                 'LV_LONZACODE'         OR
                 'LV_RB3'               OR
                 'LV_RB4'.
              screen-active = 0.
              MODIFY SCREEN.
            WHEN 'ZWBS_HEADER-REQUEST'.
              IF lv_rb5 IS INITIAL.
                screen-active = 0.
                MODIFY SCREEN.
              ENDIF.
          ENDCASE.
      ENDCASE.
      CASE screen-name.
        WHEN 'ZWBS_HEADER-REQUEST'.
          IF lv_rb5 IS INITIAL.
            screen-active = 0.
            MODIFY SCREEN.
          ENDIF.
      ENDCASE.
    ENDLOOP.
  ELSE.
    IF lv_rb3 IS NOT INITIAL OR lv_rb4 IS NOT INITIAL.
      LOOP AT SCREEN.
        CASE screen-name.
          WHEN 'ZWBS_HEADER-WERKS'    OR
               'ZWBS_HEADER-VBUKR'    OR
               " Changes by AKOTA for EiCR 787082
               'ZWBS_HEADER-ZPRODCOD' OR
               'LV_VBUKR'             OR
               " Changes by AKOTA for EiCR-766523
               'LV_WERKS'             OR
               'LV_LONZACODE'         OR
               'LV_PROJ3'.
            screen-active = 0.
            MODIFY SCREEN.
        ENDCASE.
      ENDLOOP.
    ELSE.
      LOOP AT SCREEN.
        CASE screen-name.
          WHEN 'ZWBS_HEADER-WERKS'    OR
               'ZWBS_HEADER-VBUKR'    OR
               " Changes by AKOTA for EiCR 787082
               'ZWBS_HEADER-ZPRODCOD' OR
               'LV_VBUKR'             OR
               " Changes by AKOTA for EiCR-766523
               'LV_WERKS'             OR
               'LV_LONZACODE'         OR
               'LV_RB5' .
            IF lv_rb1 IS INITIAL.
              screen-active = 0.
              MODIFY SCREEN.
            ENDIF.
        ENDCASE.
      ENDLOOP.
    ENDIF.
*Hide Submit Saved Request Option for all other Projects except CAPEX
    LOOP AT SCREEN.
      CASE screen-name.
        WHEN 'LV_RB5' OR 'ZWBS_HEADER-REQUEST'.
          screen-active = 0.
          MODIFY SCREEN.
      ENDCASE.
    ENDLOOP.
  ENDIF.

ENDFORM.                    " SCREEN_0100
*&---------------------------------------------------------------------*
*&      Form  SCREEN_0300
*&---------------------------------------------------------------------*
FORM screen_0300.

*  IF lv_proj3 IS NOT INITIAL OR
  IF lv_proj_type = 'TC' OR
     gv_capex IS NOT INITIAL.
    LOOP AT SCREEN.
      CASE abap_true.
        WHEN lv_rb1.
          CASE screen-name.
            WHEN 'ZWBS_PROJ_TEMPL-B_UNIT' OR
                 'LV_PROJECT' OR 'PROJ-PSPID'.
              screen-active = 0.
              MODIFY SCREEN.
          ENDCASE.
        WHEN lv_rb2.
          CASE screen-name.
            WHEN 'ZWBS_PROJ_TEMPL-B_UNIT' OR
                 "'LV_PROJECT' OR 'PROJ-PSPID' or
                 'ZWBS_PROJ_TEM_TC-PROFIDPROJ' OR
                 'LV_TEMPLATE' OR
                 'ZWBS_PROJ_TEMPL-PROJECT' OR
           'ZWBS_PROJ_TEM_TC-IZWEK'.
              screen-active = 0.
              MODIFY SCREEN.
          ENDCASE.
        WHEN lv_rb5.
          CASE screen-name.
            WHEN 'ZWBS_PROJ_TEMPL-B_UNIT' OR
             'LV_PROJECT' OR 'PROJ-PSPID' OR
             'ZWBS_PROJ_TEM_TC-PROFIDPROJ' OR
             'LV_TEMPLATE' OR
             'ZWBS_PROJ_TEMPL-PROJECT' OR
           'ZWBS_PROJ_TEM_TC-IZWEK'..
              screen-active = 0.
              MODIFY SCREEN.
          ENDCASE.
      ENDCASE.
    ENDLOOP.
  ELSE.
    LOOP AT SCREEN.
      IF lv_rb1 IS INITIAL.
        CASE screen-name.
          WHEN 'ZWBS_PROJ_TEMPL-B_UNIT'  OR
               'ZWBS_PROJ_TEMPL-PROJECT' OR
               'LV_TEMPLATE'             OR
               'ZWBS_PROJ_TEM_TC-PROFIDPROJ' OR
           'ZWBS_PROJ_TEM_TC-IZWEK'.
            screen-active = 0.
            MODIFY SCREEN.
        ENDCASE.
      ENDIF.
      IF NOT lv_rb1 IS INITIAL.
        CASE screen-name.
          WHEN 'PROJ-PSPID' OR
           'LV_PROJECT' OR
           'ZWBS_PROJ_TEM_TC-PROFIDPROJ' OR
           'ZWBS_PROJ_TEM_TC-IZWEK'.
            screen-active = 0.
            MODIFY SCREEN.
        ENDCASE.
      ENDIF.

    ENDLOOP.
  ENDIF.


ENDFORM.                    " SCREEN_0300
*&---------------------------------------------------------------------*
*&      Form  WBS_CREATE_DATA
*&---------------------------------------------------------------------*
FORM wbs_create_data .

  DATA:ls_userid    TYPE soudnamei1,
       ls_user_data TYPE soudatai1.

  CLEAR:lt_items,ls_rcwbs,est_proj_mand,est_prps_mand.

*Project - Consider 0 as default
  CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
    EXPORTING
      input  = lv_template
    IMPORTING
      output = lv_project_int.

  FIND FIRST OCCURRENCE OF '.' IN lv_project_int MATCH OFFSET lv_offset.
  CONCATENATE lv_project_int+0(lv_offset) '0' INTO lv_project_new.
  lv_proj3_type = lv_project_int+0(lv_offset).

  CALL FUNCTION 'CONVERSION_EXIT_ABPSN_INPUT'
    EXPORTING
      input  = lv_project_new
    IMPORTING
      output = lv_project_new.

  CALL FUNCTION 'CNPB_H_HIER_GET'
    EXPORTING
      i_objects = ls_objects_in_hierarchy
    IMPORTING
      et_rsthie = lt_items.

  CALL FUNCTION 'CNPB_H_DATA_GET'
    IMPORTING
      est_proj_mand = est_proj_mand
      est_prps_mand = est_prps_mand.

*Assignment
  DATA lv_field TYPE feldname.
  FIELD-SYMBOLS <fs_field> TYPE any.

  lv_field = '(SAPLCJWB)PRPS-POSID'.
  ASSIGN (lv_field) TO <fs_field>.
  <fs_field> = lv_template.
  UNASSIGN <fs_field>.

  lv_field = '(SAPLCJWB)*PRPS-POSID'.
  ASSIGN (lv_field) TO <fs_field>.
  <fs_field> = lv_template.
  UNASSIGN <fs_field>.

  lv_field = '(SAPLCJWB)RCWKP-VORLAGE'.
  ASSIGN (lv_field) TO <fs_field>.
  <fs_field> = lv_template.
  UNASSIGN <fs_field>.

  lv_field = '(SAPLCJWB)PROJ-PSPID'.
  ASSIGN (lv_field) TO <fs_field>.
  <fs_field> = lv_project_new.
  UNASSIGN <fs_field>.

  lv_field = '(SAPLCJWB)*PROJ-PSPID'.
  ASSIGN (lv_field) TO <fs_field>.
  <fs_field> = lv_project_new.
  UNASSIGN <fs_field>.

  lv_field = '(SAPLCJWB)RCWKP-VSPSPID'.
  ASSIGN (lv_field) TO <fs_field>.
  <fs_field> = lv_project_new.
  UNASSIGN <fs_field>.

  lv_field = '(SAPLCJWB)REPID'.
  ASSIGN (lv_field) TO <fs_field>.
  <fs_field> = 'SAPLCJWB'.
  UNASSIGN <fs_field>.

  PERFORM eb_suchen_und_ersetzen_init IN PROGRAM saplcjwb.
  PERFORM extern_call_pspid_input IN PROGRAM saplcjwb.

*Project Details
  CLEAR zwbs_header.
  CLEAR: ls_proj-verna, ls_proj-astna.
  MOVE-CORRESPONDING ls_proj TO zwbs_header.
  CLEAR: zwbs_header-astnr, zwbs_header-vernr.
  READ TABLE est_proj_mand INTO DATA(ls_est_proj_mand) INDEX 1.
  ls_proj-vbukr           = lv_vbukr. " Changes by AKOTA for EiCR-766523
  lv_bukrs                = ls_proj-vbukr.
  zwbs_header-pspid       = lv_project_new.
*  IF lv_proj3 IS NOT INITIAL.
  IF lv_proj_type = 'TC'.
    zwbs_header-post1           = ls_est_proj_mand-ktext.
    zwbs_header-plfaz           = sy-datum.
    CONCATENATE sy-datum(4) '12' '31' INTO lv_end_date.
    zwbs_header-plsez           = lv_end_date.

*Get Requestor Full Name
    ls_userid-sapname = sy-uname.
    CALL FUNCTION 'SO_USER_READ_API1'
      EXPORTING
        user            = ls_userid
      IMPORTING
        user_data       = ls_user_data
      EXCEPTIONS
        user_not_exist  = 1
        parameter_error = 2
        x_error         = 3
        OTHERS          = 4.
    IF sy-subrc <> 0.
    ELSE.
      lv_fullname = ls_user_data-fullname.
    ENDIF.
  ELSE.
    zwbs_header-post1 = lv_lonzacode."ls_est_proj_mand-ktext.
  ENDIF.

  zwbs_header-vbukr       = lv_vbukr. " Changes by AKOTA for EiCR-766523
  zwbs_header-werks       = lv_werks.
  zwbs_header-zprodcod    = lv_lonzacode.
  zwbs_header-pspid_templ = lv_template.
  zwbs_header-proj_type   = lv_proj_type.
  zwbs_header-type        = lv_type.
*  zwbs_header-Astna       =
*  zwbs_header-verna       =

*  CALL FUNCTION 'CONVERSION_EXIT_POSNR_OUTPUT'
*    EXPORTING
*      input  = zwbs_proj_tem_tc-izwek
*    IMPORTING
*      output = gv_posnr.

  SELECT SINGLE izwek, bukrs, gsber, kostl, werks INTO @DATA(ls_impr)
    FROM impr WHERE posnr = @zwbs_proj_tem_tc-izwek.
  IF sy-subrc = 0.
    zwbs_header-izwek = ls_impr-izwek.
    zwbs_header-vgsbr = ls_impr-gsber.
  ELSE.
    SELECT SINGLE izwek, bukrs, gsber, kostl, werks INTO @ls_impr
   FROM impr WHERE posid = @zwbs_proj_tem_tc-izwek.
    IF sy-subrc = 0.
      zwbs_header-izwek = ls_impr-izwek.
      zwbs_header-vgsbr = ls_impr-gsber.
    ENDIF.
  ENDIF.

*WBS Details
  CLEAR lt_prps_mand.
  APPEND LINES OF est_prps_mand TO lt_prps_mand.
  SORT lt_prps_mand BY node_key.
  LOOP AT lt_prps_mand INTO DATA(ls_est_prps_mand).
    PERFORM eb_key_anfang_ersetzen IN PROGRAM saplcjwb
                                   USING    ls_est_prps_mand-posid
                                   CHANGING ls_rcwbs-ident.
    CALL FUNCTION 'CJDW_PRPS_GET'
      EXPORTING
        posid     = ls_est_prps_mand-posid
      IMPORTING
        e_prps    = ls_prps
      EXCEPTIONS
        cancel    = 1
        not_found = 2
        OTHERS    = 3.
    IF sy-subrc <> 0.
* Implement suitable error handling here
    ENDIF.

    MOVE-CORRESPONDING:ls_est_prps_mand TO ls_table,
                       ls_prps          TO ls_table.
    CLEAR: ls_table-posid.
    ls_table-pspid = ls_rcwbs-ident.
*    IF lv_proj3 IS NOT INITIAL.
    IF lv_proj_type = 'TC'.
      ls_table-pgsbr = ls_impr-gsber.
      ls_table-post1 = ls_est_prps_mand-ktext.
      ls_table-pspid_new = ls_rcwbs-ident.
      ls_table-plakz    = abap_true.
      ls_table-plfaz    = zwbs_header-plfaz.
      ls_table-plsez    = zwbs_header-plsez.
      IF ls_table-stufe > 1.
        ls_table-estrt    = zwbs_header-plfaz.
        ls_table-eende    = zwbs_header-plsez.
      ENDIF.
      IF ls_table-stufe = '2'.
        ls_table-akstl = ls_impr-kostl.
        ls_table-posid = zwbs_proj_tem_tc-izwek.
      ENDIF.

      "ls_table-verna    = zwbs_header-verna.
      ls_table-akokr    = 'CA05'.

      SELECT SINGLE * FROM zwbs_proj_tem_tc INTO @DATA(ls_template)
         WHERE project  = @lv_template.
      IF ls_template-unifier = 'X' AND ls_table-stufe EQ 1.
        ls_table-budget = '0.01'.
        ls_table-zproj_template = lv_template.
      ENDIF.
      IF ls_prps-stufe  = 1.
        CLEAR: ls_table-belkz.
      ELSE.
        ls_table-belkz = 'X'.
      ENDIF.
      "CLEAR: zwbs_header-prctr, zwbs_header-vgsbr.
      CLEAR: ls_table-prctr, ls_table-astnr.
    ELSE.
      IF ls_table-stufe EQ 1.
        ls_est_prps_mand-ktext = lv_lonzacode.
      ENDIF.
      ls_table-post1 = ls_est_prps_mand-ktext.

*Default for Levels other than 1 and 2.
* CR 626062-->Initially this code block was commented,the
* result of which we dont have (Flags: Account Assignment LS_TABLE-BELKZ
* and Billing element LS_TABLE-FAKKZ) set beyond for Levels 3 and above.
* As part of CR 626062 business want these two flags to be set and
* hence they are un-commented
      IF ls_table-stufe NE 1 AND ls_table-stufe NE 2.
*        IF lv_proj_type = 'CM' AND ls_table-stufe = 3.

*        ELSE.
        ls_table-belkz = abap_true.
        ls_table-fakkz = abap_true.
*        ENDIF.
      ENDIF.
      CLEAR:ls_table-belkz,ls_table-fakkz.
    ENDIF.

    " Begin of changes by AKOTA for EiCR-766523
*    IF ls_table-pbukr IS INITIAL.
*      ls_table-pbukr = lv_bukrs.
*    ENDIF.
    ls_table-pbukr = lv_vbukr.
    ls_table-werks = lv_werks.
    " End of changes by AKOTA for EiCR-766523
*Clear default Values from Template
*CLEAR:ls_table-prctr,ls_table-abgsl,ls_table-zasset,ls_table-zrevstr,

* CR 626062 ended
*Default Values while adding a new record
    IF ls_default IS INITIAL.
      ls_default       = ls_table.
      ls_default-updkz = 'I'.
      CLEAR:ls_default-pspid,ls_default-post1,ls_default-stufe,
            ls_default-zasset,ls_default-zrevstr,ls_default-zarea,
            ls_default-zscopcha,ls_default-zopportunity_id,
            ls_default-zsynergy_id,
            ls_default-zcustom,ls_default-mtart,ls_default-z_material,
            ls_default-pbukr,ls_default-pgsbr,ls_default-prctr,
            ls_default-werks,ls_default-imprf,
            ls_default-belkz,ls_default-fakkz,ls_default-astnr,
            ls_default-vernr,ls_default-zibpflag,ls_default-zibpflgmc,
            ls_default-zibpaufnr, ls_default-zibpebeln, ls_default-zfcw,
""* Changes by AKOTA for CR 668561,
            ls_default-zmaint_sys,ls_default-zstate_code_pv,
            ls_default-zstage_st_dt,ls_default-zstage_end_dt,
            ls_default-astnr_n,ls_default-astna,ls_default-vernr_n,
            ls_default-verna.
    ENDIF.
*Default Values in the table
    PERFORM assign_table_values USING space.

    APPEND ls_table TO lt_table.
    CLEAR:ls_table,ls_prps.
  ENDLOOP.

ENDFORM.                    " WBS_CREATE_DATA
*&---------------------------------------------------------------------*
*&      Form  WBS_CHANGE_DATA
*&---------------------------------------------------------------------*
FORM wbs_change_data.

  DATA:ls_userid     TYPE soudnamei1,
       ls_user_data  TYPE soudatai1,
       ls_userid2    TYPE soudnamei1,
       ls_user_data2 TYPE soudatai1,
       lv_pspid_new  TYPE anla-posnr.

  CLEAR:ls_proj,lv_oflag.

*Check for Open Request
  SELECT SINGLE COUNT(*) FROM zwbs_header WHERE pspid  EQ lv_project AND
                                                status IN ('0','1').
  IF sy-subrc = 0.
    lv_oflag = abap_true.
    EXIT.
  ENDIF.

*Check if Project Exists
  CALL FUNCTION 'CJDW_PROJ_SELECT_SINGLE'
    EXPORTING
      pspid     = lv_project
    IMPORTING
      e_proj    = ls_proj
    EXCEPTIONS
      not_found = 1.
  IF sy-subrc <> 0.
    MESSAGE ID 'CJ' TYPE 'I' NUMBER '011' WITH lv_project DISPLAY LIKE
    'E'.
    EXIT.
  ENDIF.

*Lock Project for further Editing
  CALL FUNCTION 'CJDW_ENQUEUE'
    EXPORTING
      object_id         = lv_project
    EXCEPTIONS
      foreign_lock      = 1
      invalid_type      = 2
      missing_parameter = 3
      system_failure    = 4
      OTHERS            = 5.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE 'I' NUMBER sy-msgno WITH lv_project DISPLAY
    LIKE 'E'.
    EXIT.
  ENDIF.

  CLEAR:ls_objects_in_hierarchy,gt_treeitm,gt_treev_node,gs_objects_in_tree.

  ls_objects_in_hierarchy-proj = abap_true.
  ls_objects_in_hierarchy-prps = abap_true.
  ls_objects_in_hierarchy-pstx = abap_true.

  CALL FUNCTION 'CNPB_H_PROJ_HIER_REFRESH'.

  CALL FUNCTION 'CNPB_H_PROJ_HIER_SELECT'
    EXPORTING
      i_objects_in_hierarchy         = ls_objects_in_hierarchy
      i_vsnmr                        = ''
      i_pspid                        = lv_project
      i_aufnr                        = ''
      i_flg_enqueue                  = abap_true
      i_expand_levels                = 06
      i_drag_drop_handle             = lv_drag_drop_handle
      i_hier_col_is_key              = lv_hier_col_is_key
*    IMPORTING
*     et_treeitm                     = gt_treeitm
*     et_treev_node                  = gt_treev_node
*     e_flg_enqueue                  = lv_enqueue
*     e_objects_in_hierarchy         = gs_objects_in_tree
    EXCEPTIONS
      no_import_parameters           = 1
      more_than_one_import_parameter = 2
      no_objects_found               = 3
      no_authority                   = 4
      OTHERS                         = 5.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE 'I' NUMBER sy-msgno
                        WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4
                        DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

  CALL FUNCTION 'CNPB_H_HIER_GET'
    EXPORTING
      i_objects = ls_objects_in_hierarchy
    IMPORTING
      et_rsthie = lt_items.

  CALL FUNCTION 'CNPB_H_DATA_GET'
    IMPORTING
      est_proj_mand = est_proj_mand
      est_prps_mand = est_prps_mand.

*Project Details
  CLEAR:zwbs_header,ls_head_db.
  MOVE-CORRESPONDING ls_proj TO zwbs_header.
  READ TABLE est_proj_mand INTO DATA(ls_est_proj_mand) INDEX 1.
*  zwbs_header-pspid       = lv_project_new.
*  zwbs_header-post1       = ls_est_proj_mand-ktext.
*  zwbs_header-vbukr       = lv_bukrs.
*  IF lv_proj3 IS NOT INITIAL.
  IF lv_proj_type = 'TC'.
    CLEAR zwbs_header-vernr.
    SELECT SINGLE s_usrnam INTO zwbs_header-vernr
      FROM tcj04 WHERE vernr = ls_proj-vernr.
    CLEAR zwbs_header-astnr.
    SELECT SINGLE usrid INTO zwbs_header-astnr
      FROM pa0105 WHERE pernr = ls_proj-astnr.

    zwbs_header-post1           = ls_est_proj_mand-ktext.
    "zwbs_header-plfaz           = sy-datum.
    CONCATENATE sy-datum(4) '12' '31' INTO lv_end_date.
    "zwbs_header-plsez           = lv_end_date.
  ENDIF.
  zwbs_header-pspid_templ = lv_template.
  zwbs_header-proj_type   = lv_proj_type.
  zwbs_header-type        = lv_type.
  lv_bukrs                = zwbs_header-vbukr.
*DB Image for Header
  MOVE-CORRESPONDING zwbs_header TO ls_head_db.

  ls_userid2-sapname = sy-uname. "zwbs_header-created_by. "sy-uname.
** get the user FUll name.
  CALL FUNCTION 'SO_USER_READ_API1'
    EXPORTING
      user            = ls_userid2
*     PREPARE_FOR_FOLDER_ACCESS       = ' '
    IMPORTING
      user_data       = ls_user_data2
    EXCEPTIONS
      user_not_exist  = 1
      parameter_error = 2
      x_error         = 3
      OTHERS          = 4.
  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ELSE.
    lv_fullname    = ls_user_data2-fullname.
  ENDIF.
**Custom Fields Control
*  CLEAR ls_cf_control.
*  SELECT SINGLE * FROM zwbs_cf_control INTO ls_cf_control
*                                       WHERE bukrs = lv_bukrs.

*WBS Details
  CLEAR lt_prps_mand.
  APPEND LINES OF est_prps_mand TO lt_prps_mand.
  SORT lt_prps_mand BY node_key.

*WBS Status
  CLEAR:lt_wbs_elements,lt_wbs_status.
  lt_wbs_elements = CORRESPONDING #( lt_prps_mand MAPPING wbs_element = posid ).
  PERFORM get_wbs_status USING lt_wbs_elements.

  LOOP AT lt_prps_mand INTO DATA(ls_est_prps_mand).
    CALL FUNCTION 'CJDW_PRPS_GET'
      EXPORTING
        posid     = ls_est_prps_mand-posid
      IMPORTING
        e_prps    = ls_prps
      EXCEPTIONS
        cancel    = 1
        not_found = 2
        OTHERS    = 3.
    IF sy-subrc <> 0.
* Implement suitable error handling here
    ENDIF.

    MOVE-CORRESPONDING:ls_est_prps_mand TO ls_table,
                       ls_prps          TO ls_table.

    ls_table-pspid = ls_est_prps_mand-posid.
    ls_table-post1 = ls_est_prps_mand-ktext.
    IF ls_prps-stufe = 1.
      ls_head_db-izwek = zwbs_header-izwek = ls_prps-izwek.
    ENDIF.

*Default Header Values
    IF zwbs_header-zprgman IS INITIAL.
      zwbs_header-zprgman = ls_prps-zprgman.
    ENDIF.
    IF zwbs_header-zprodcod IS INITIAL.
      zwbs_header-zprodcod = ls_prps-zprodcod.
    ENDIF.
*    IF lv_proj3 IS NOT INITIAL.
    IF lv_proj_type = 'TC'.
      CLEAR: ls_table-astnr, ls_table-astnr_n, ls_table-astna.
      CLEAR: ls_table-vernr, ls_table-vernr_n, ls_table-verna, ls_table-lstar,lv_pspid_new.
      IF ls_est_prps_mand-stufe = '2'.
*        CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
*          EXPORTING
*            input  = ls_est_prps_mand-posid
*          IMPORTING
*            output = lv_pspid_new.

        lv_pspid_new = ls_est_prps_mand-pspnr.
        SELECT SINGLE anln1 FROM anla INTO @DATA(ls_anla)
          WHERE posnr = @lv_pspid_new.
        IF sy-subrc  = 0.
          SELECT SINGLE lstar FROM anlz INTO ls_table-lstar
            WHERE anln1 = ls_anla.
        ENDIF.
      ENDIF.
      SELECT SINGLE s_usrnam INTO ls_table-vernr
         FROM tcj04 WHERE vernr = ls_prps-vernr.
      ls_table-vernr_n = ls_prps-vernr.

      IF ls_prps-vernr IS NOT INITIAL.
        CLEAR: ls_userid, ls_user_data.
        ls_userid-sapname =  ls_table-vernr.
** get the user FUll name.
        CALL FUNCTION 'SO_USER_READ_API1'
          EXPORTING
            user            = ls_userid
*           PREPARE_FOR_FOLDER_ACCESS       = ' '
          IMPORTING
            user_data       = ls_user_data
          EXCEPTIONS
            user_not_exist  = 1
            parameter_error = 2
            x_error         = 3
            OTHERS          = 4.
        IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
        ENDIF.

        ls_table-verna = ls_user_data-fullname.
      ENDIF.
      SELECT SINGLE usrid INTO ls_table-astnr
        FROM pa0105 WHERE pernr = ls_prps-astnr.
      ls_table-astnr_n = ls_prps-astnr.
      IF ls_table-astnr IS NOT INITIAL.
        CLEAR: ls_userid, ls_user_data.
        ls_userid-sapname =  ls_table-astnr.
** get the user FUll name.
        CALL FUNCTION 'SO_USER_READ_API1'
          EXPORTING
            user            = ls_userid
*           PREPARE_FOR_FOLDER_ACCESS       = ' '
          IMPORTING
            user_data       = ls_user_data
          EXCEPTIONS
            user_not_exist  = 1
            parameter_error = 2
            x_error         = 3
            OTHERS          = 4.
        IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
        ENDIF.
        ls_table-astna = ls_user_data-fullname.
      ENDIF.
      CLEAR: ls_table-posid.
      ls_table-post1 = ls_est_prps_mand-ktext.
      ls_table-pspid_new = ls_est_prps_mand-posid. "ls_rcwbs-ident.
      ls_table-plakz    = abap_true.
*      ls_table-verna    = zwbs_header-verna.
      ls_table-akokr    = 'CA05'.
      ls_table-akstl    = ls_prps-fkstl.
      ls_table-imprf    = ls_prps-imprf.

      " Start and Finish date.
      SELECT SINGLE pstrt pende estrt eende FROM prte INTO
      (ls_table-plfaz, ls_table-plsez, ls_table-estrt, ls_table-eende)
                         WHERE posnr = ls_prps-pspnr.
*      IF sy-subrc = 0 AND ls_table-stufe = 1.
*        CLEAR: ls_table-estrt, ls_table-eende.
**       ls_table-estrt = ls_table-plfaz.
**       ls_table-eende = ls_table-plsez.
*      ENDIF.
      " Investment Program
      SELECT SINGLE posnr
           FROM  imzo
          INTO ls_table-posid
          WHERE objnr = ls_prps-objnr.

      CALL FUNCTION 'CONVERSION_EXIT_POSNR_OUTPUT'
        EXPORTING
          input  = ls_table-posid
        IMPORTING
          output = ls_table-posid.

      " Budget
      SELECT SINGLE waers INTO @DATA(lv_waers) FROM t001
        WHERE bukrs = @ls_prps-pbukr.
      IF sy-subrc = 0.
        SELECT SINGLE lednr INTO @DATA(lv_lednr) FROM tbp0l
          WHERE waers = @lv_waers.
        IF sy-subrc = 0.
          SELECT SINGLE wlp00
              FROM rpsco
              INTO ls_table-budget
              WHERE objnr = ls_prps-objnr
              AND   lednr = lv_lednr
              AND   wrttp = '45'.
        ENDIF.
      ENDIF.

      IF lv_waers = 'JPY' OR lv_waers = 'IDR'.
        ls_table-budget = ls_table-budget * 100.
      ENDIF.
      CLEAR: lv_lednr, lv_waers.
    ELSE.
*  Begin of changes by LCHENNA for CR 797199
      SELECT SINGLE pstrt pende FROM prte INTO
     (ls_table-zstage_st_dt, ls_table-zstage_end_dt)
                        WHERE posnr = ls_prps-pspnr.
*  End of changes by LCHENNA for CR 797199
    ENDIF.

*Default Values while adding a new record
    IF ls_default IS INITIAL.
      ls_default = ls_table.
      ls_default-updkz = 'I'.
      CLEAR:ls_default-pspid,ls_default-post1,ls_default-stufe,
         ls_default-zasset,ls_default-zrevstr,ls_default-zarea,
         ls_default-zscopcha,ls_default-zopportunity_id,ls_default-budget,
         ls_default-zsynergy_id,
         ls_default-zcustom,ls_default-mtart,ls_default-z_material,
         ls_default-pbukr,ls_default-pgsbr,ls_default-prctr,
         ls_default-werks,ls_default-imprf,
         ls_default-belkz,ls_default-fakkz,ls_default-astnr,
         ls_default-vernr,ls_default-zibpflag,ls_default-zibpflgmc,
         ls_default-zibpaufnr, ls_default-zibpebeln, ls_default-zfcw,
         ls_default-zmaint_sys,ls_default-zstate_code_pv,
         ls_default-zstage_st_dt,ls_default-zstage_end_dt,
         ls_default-astnr_n,ls_default-astna,ls_default-vernr_n,
         ls_default-verna.
      ""* Changes by AKOTA for CR 668561
    ENDIF.
*Default Values in the table
    PERFORM assign_table_values USING space.
*Status
    PERFORM assign_wbs_status CHANGING ls_table.
    "* Begin of changes by AKOTA for CR 689451
    IF ls_prps-loevm IS INITIAL.
      "* End of changes by AKOTA for CR 689451
      APPEND ls_table TO lt_table.
      "* Begin of changes by AKOTA for CR 689451
    ENDIF.
    "* End of changes by AKOTA for CR 689451
*Check for if Grouping 2 is SET on WBS
    IF lv_grp_allowed IS INITIAL AND ls_table-grpkz = '2'.
      lv_grp_allowed = abap_true.
    ENDIF.
    CLEAR:ls_table,ls_prps.
  ENDLOOP.

*HOLD Initial Image for further processing
  APPEND LINES OF lt_table TO lt_table_init.

ENDFORM.                    " WBS_CHANGE_DATA
*&---------------------------------------------------------------------*
*&      Form  WBS_CLOSE_DATA
*&---------------------------------------------------------------------*
FORM wbs_close_data .

  CLEAR:ls_proj,lv_oflag.

*Check for Open Request
  SELECT SINGLE COUNT(*) FROM zwbs_header WHERE pspid  EQ lv_project AND
                                                status IN ('0','1').
  IF sy-subrc = 0.
    lv_oflag = abap_true.
    EXIT.
  ENDIF.

*Check if Project Exists
  CALL FUNCTION 'CJDW_PROJ_SELECT_SINGLE'
    EXPORTING
      pspid     = lv_project
    IMPORTING
      e_proj    = ls_proj
    EXCEPTIONS
      not_found = 1.
  IF sy-subrc <> 0.
    MESSAGE ID 'CJ' TYPE 'I' NUMBER '011' WITH lv_project DISPLAY LIKE
    'E'.
    EXIT.
  ENDIF.

*Lock Project for further Editing
  CALL FUNCTION 'CJDW_ENQUEUE'
    EXPORTING
      object_id         = lv_project
    EXCEPTIONS
      foreign_lock      = 1
      invalid_type      = 2
      missing_parameter = 3
      system_failure    = 4
      OTHERS            = 5.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE 'I' NUMBER sy-msgno WITH lv_project DISPLAY
    LIKE 'E'.
    EXIT.
  ENDIF.

  CLEAR:ls_objects_in_hierarchy,gt_treeitm,gt_treev_node,
  gs_objects_in_tree.

  ls_objects_in_hierarchy-proj = abap_true.
  ls_objects_in_hierarchy-prps = abap_true.
  ls_objects_in_hierarchy-pstx = abap_true.

  CALL FUNCTION 'CNPB_H_PROJ_HIER_REFRESH'.

  CALL FUNCTION 'CNPB_H_PROJ_HIER_SELECT'
    EXPORTING
      i_objects_in_hierarchy         = ls_objects_in_hierarchy
      i_vsnmr                        = ''
      i_pspid                        = lv_project
      i_aufnr                        = ''
      i_flg_enqueue                  = abap_true
      i_expand_levels                = 06
      i_drag_drop_handle             = lv_drag_drop_handle
      i_hier_col_is_key              = lv_hier_col_is_key
*    IMPORTING
*     et_treeitm                     = gt_treeitm
*     et_treev_node                  = gt_treev_node
*     e_flg_enqueue                  = lv_enqueue
*     e_objects_in_hierarchy         = gs_objects_in_tree
    EXCEPTIONS
      no_import_parameters           = 1
      more_than_one_import_parameter = 2
      no_objects_found               = 3
      no_authority                   = 4
      OTHERS                         = 5.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE 'I' NUMBER sy-msgno
                        WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4
                        DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

  CALL FUNCTION 'CNPB_H_HIER_GET'
    EXPORTING
      i_objects = ls_objects_in_hierarchy
    IMPORTING
      et_rsthie = lt_items.

  CALL FUNCTION 'CNPB_H_DATA_GET'
    IMPORTING
      est_prps_mand = est_prps_mand.

*Project Details
  CLEAR zwbs_header.
  MOVE-CORRESPONDING ls_proj TO zwbs_header.
  zwbs_header-pspid_templ = lv_template.
  zwbs_header-proj_type   = lv_proj_type.
  zwbs_header-type        = lv_type.
  lv_cflag                = abap_true.

*WBS Details
  CLEAR lt_prps_mand.
  APPEND LINES OF est_prps_mand TO lt_prps_mand.
  SORT lt_prps_mand BY node_key.

*WBS Status
  CLEAR:lt_wbs_elements,lt_wbs_status,lt_zwbs_status.
  lt_wbs_elements = CORRESPONDING #( lt_prps_mand MAPPING wbs_element =
  posid ).
  PERFORM get_wbs_status USING lt_wbs_elements.

  LOOP AT lt_prps_mand INTO DATA(ls_est_prps_mand).
    CALL FUNCTION 'CJDW_PRPS_GET'
      EXPORTING
        posid     = ls_est_prps_mand-posid
      IMPORTING
        e_prps    = ls_prps
      EXCEPTIONS
        cancel    = 1
        not_found = 2
        OTHERS    = 3.
    IF sy-subrc <> 0.
* Implement suitable error handling here
    ENDIF.

    MOVE-CORRESPONDING:ls_est_prps_mand TO ls_table,
                       ls_prps          TO ls_table.
    ls_table-pspid = ls_est_prps_mand-posid.
    ls_table-post1 = ls_est_prps_mand-ktext.

*Default Header Values
    IF zwbs_header-zprgman IS INITIAL.
      zwbs_header-zprgman = ls_prps-zprgman.
    ENDIF.
    IF zwbs_header-zprodcod IS INITIAL.
      zwbs_header-zprodcod = ls_prps-zprodcod.
    ENDIF.
*Default Values in the table
    PERFORM assign_table_values USING space.
*Status
    PERFORM assign_wbs_status CHANGING ls_table.

    APPEND ls_table TO lt_table.
    CLEAR:ls_table,ls_prps.
  ENDLOOP.

ENDFORM.                    " WBS_CLOSE_DATA
*&---------------------------------------------------------------------*
*&      Form  WBS_UNCLOSE_DATA
*&---------------------------------------------------------------------*
FORM wbs_unclose_data .

  CLEAR:ls_proj,lv_oflag.

*Check for Open Request
  SELECT SINGLE COUNT(*) FROM zwbs_header WHERE pspid  EQ lv_project AND
                                                status IN ('0','1').
  IF sy-subrc = 0.
    lv_oflag = abap_true.
    EXIT.
  ENDIF.

*Check if Project Exists
  CALL FUNCTION 'CJDW_PROJ_SELECT_SINGLE'
    EXPORTING
      pspid     = lv_project
    IMPORTING
      e_proj    = ls_proj
    EXCEPTIONS
      not_found = 1.
  IF sy-subrc <> 0.
    MESSAGE ID 'CJ' TYPE 'I' NUMBER '011' WITH lv_project DISPLAY LIKE
    'E'.
    EXIT.
  ENDIF.

*Lock Project for further Editing
  CALL FUNCTION 'CJDW_ENQUEUE'
    EXPORTING
      object_id         = lv_project
    EXCEPTIONS
      foreign_lock      = 1
      invalid_type      = 2
      missing_parameter = 3
      system_failure    = 4
      OTHERS            = 5.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE 'I' NUMBER sy-msgno WITH lv_project DISPLAY
    LIKE 'E'.
    EXIT.
  ENDIF.

  CLEAR:ls_objects_in_hierarchy,gt_treeitm,gt_treev_node,
  gs_objects_in_tree.

  ls_objects_in_hierarchy-proj = abap_true.
  ls_objects_in_hierarchy-prps = abap_true.
  ls_objects_in_hierarchy-pstx = abap_true.

  CALL FUNCTION 'CNPB_H_PROJ_HIER_REFRESH'.

  CALL FUNCTION 'CNPB_H_PROJ_HIER_SELECT'
    EXPORTING
      i_objects_in_hierarchy         = ls_objects_in_hierarchy
      i_vsnmr                        = ''
      i_pspid                        = lv_project
      i_aufnr                        = ''
      i_flg_enqueue                  = abap_true
      i_expand_levels                = 06
      i_drag_drop_handle             = lv_drag_drop_handle
      i_hier_col_is_key              = lv_hier_col_is_key
*    IMPORTING
*     et_treeitm                     = gt_treeitm
*     et_treev_node                  = gt_treev_node
*     e_flg_enqueue                  = lv_enqueue
*     e_objects_in_hierarchy         = gs_objects_in_tree
    EXCEPTIONS
      no_import_parameters           = 1
      more_than_one_import_parameter = 2
      no_objects_found               = 3
      no_authority                   = 4
      OTHERS                         = 5.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE 'I' NUMBER sy-msgno
                        WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4
                        DISPLAY LIKE 'E'.
    EXIT.
  ENDIF.

  CALL FUNCTION 'CNPB_H_HIER_GET'
    EXPORTING
      i_objects = ls_objects_in_hierarchy
    IMPORTING
      et_rsthie = lt_items.

  CALL FUNCTION 'CNPB_H_DATA_GET'
    IMPORTING
      est_prps_mand = est_prps_mand.

*Project Details
  CLEAR zwbs_header.
  MOVE-CORRESPONDING ls_proj TO zwbs_header.
  zwbs_header-pspid_templ = lv_template.
  zwbs_header-proj_type   = lv_proj_type.
  zwbs_header-type        = lv_type.
  lv_ucflag               = abap_true.

*WBS Details
  CLEAR lt_prps_mand.
  APPEND LINES OF est_prps_mand TO lt_prps_mand.
  SORT lt_prps_mand BY node_key.

*WBS Status
  CLEAR:lt_wbs_elements,lt_wbs_status,lt_zwbs_status.
  lt_wbs_elements = CORRESPONDING #( lt_prps_mand MAPPING wbs_element =
  posid ).
  PERFORM get_wbs_status USING lt_wbs_elements.

  LOOP AT lt_prps_mand INTO DATA(ls_est_prps_mand).
    CALL FUNCTION 'CJDW_PRPS_GET'
      EXPORTING
        posid     = ls_est_prps_mand-posid
      IMPORTING
        e_prps    = ls_prps
      EXCEPTIONS
        cancel    = 1
        not_found = 2
        OTHERS    = 3.
    IF sy-subrc <> 0.
* Implement suitable error handling here
    ENDIF.

    MOVE-CORRESPONDING:ls_est_prps_mand TO ls_table,
                       ls_prps          TO ls_table.
    ls_table-pspid = ls_est_prps_mand-posid.
    ls_table-post1 = ls_est_prps_mand-ktext.
*Default Header Values
    IF zwbs_header-zprgman IS INITIAL.
      zwbs_header-zprgman = ls_prps-zprgman.
    ENDIF.
    IF zwbs_header-zprodcod IS INITIAL.
      zwbs_header-zprodcod = ls_prps-zprodcod.
    ENDIF.
*Default Values in the table
    PERFORM assign_table_values USING space.
*Status
    PERFORM assign_wbs_status CHANGING ls_table.

    APPEND ls_table TO lt_table.
    CLEAR:ls_table,ls_prps.
  ENDLOOP.

ENDFORM.                    " WBS_UNCLOSE_DATA
*&---------------------------------------------------------------------*
*&      Form  WBS_REQUEST_CREATE
*&---------------------------------------------------------------------*
FORM wbs_request_create USING iv_simulation TYPE char1.

  CLEAR:lt_return,lt_wbs_celement,lt_extensionin,ls_project_new,
  lv_wbs_app_call.

*Export Identifier to control Template copy during Project creation
  FREE MEMORY ID 'ZWBS_APPL_CALL'.
  lv_wbs_app_call = abap_true.
  EXPORT lv_wbs_app_call = lv_wbs_app_call TO MEMORY ID 'ZWBS_APPL_CALL'.

  PERFORM check_proj_create CHANGING ls_project_new.

  PERFORM check_prps_create CHANGING lt_wbs_celement
                                     lt_extensionin.
  SORT:lt_wbs_celement,lt_extensionin.
  CALL FUNCTION 'BAPI_PS_INITIALIZATION'.

  CALL FUNCTION 'BAPI_BUS2001_CREATE'
    EXPORTING
      i_project_definition = ls_project_new
    TABLES
      et_return            = lt_return.

  LOOP AT lt_return TRANSPORTING NO FIELDS WHERE type CA 'EA'.
    lv_error = 'X'.
    EXIT.
  ENDLOOP.

  IF lv_error IS INITIAL.
    CLEAR lt_return.
*Create New WBS
    IF NOT lt_wbs_celement IS INITIAL OR
       NOT lt_extensionin  IS INITIAL.
      CALL FUNCTION 'BAPI_BUS2054_CREATE_MULTI'
        EXPORTING
          i_project_definition = ls_head-pspid
        TABLES
          it_wbs_element       = lt_wbs_celement
          et_return            = lt_return
          extensionin          = lt_extensionin.
    ENDIF.

*Check lt_return for Success
    CLEAR lv_error.
    LOOP AT lt_return TRANSPORTING NO FIELDS WHERE type CA 'EA'.
      lv_error = 'X'.
      EXIT.
    ENDLOOP.

    IF lv_error IS INITIAL.
      IF iv_simulation IS INITIAL.
        CLEAR:lt_return.
        CALL FUNCTION 'BAPI_PS_PRECOMMIT'
          TABLES
            et_return = lt_return.

        LOOP AT lt_return TRANSPORTING NO FIELDS WHERE type CA 'EA'.
          lv_error = 'X'.
          EXIT.
        ENDLOOP.
        IF lv_error IS INITIAL.
          "Overwrite only if Successful
*      ct_return = lt_return.
        ENDIF.
      ENDIF.
    ENDIF.

    IF lv_error IS INITIAL.
      IF iv_simulation IS INITIAL.
        CLEAR ls_return.
*  Begin of changes by LCHENNA for CR 797199
**  Capture the SAP project number and WBS elements under it
*   to stagging table
        DATA ls_conn_hdr TYPE zvconn_pv_hdr_in.
        DATA lt_conn_itm TYPE STANDARD TABLE OF zvconn_pv_itm_in.
        DATA ls_wbs_item TYPE zwbs_item.
        FIELD-SYMBOLS <fs_conn_itm> TYPE zvconn_pv_itm_in.
        SELECT SINGLE * FROM zvconn_pv_hdr_in INTO ls_conn_hdr
                        WHERE zprj_code_pv <> '0'
                          AND zprj_code_pv = ls_head-zprj_code_pv.
        IF sy-subrc EQ 0.
          CALL FUNCTION 'CONVERSION_EXIT_KONPD_INPUT'
            EXPORTING
              input     = ls_head-pspid
            IMPORTING
              output    = ls_conn_hdr-pspnr
            EXCEPTIONS
              not_found = 1
              OTHERS    = 2.
          IF sy-subrc <> 0.
*         Implement suitable error handling here
          ENDIF.
*Add Timestamp to Staging Header
          ls_conn_hdr-zprj_def_pv = ls_head-pspid.
          ls_conn_hdr-changed_by  = sy-uname.
          ls_conn_hdr-change_date = sy-datum.
          ls_conn_hdr-change_time = sy-uzeit.

          SELECT * FROM zvconn_pv_itm_in INTO TABLE lt_conn_itm
                   WHERE zprj_code_pv <> '0'
                     AND zprj_code_pv = ls_head-zprj_code_pv.

*          SELECT * FROM zvconn_pv_itm_in INTO TABLE lt_conn_itm
*            FOR ALL ENTRIES IN lt_wbs_item
*                   WHERE zprj_code_pv <> '0'
*                     AND zprj_code_pv = ls_head-zprj_code_pv
*                     AND zstage_code_pv = lt_wbs_item-zstate_code_pv.

          IF NOT lt_conn_itm IS INITIAL.
            LOOP AT lt_conn_itm ASSIGNING <fs_conn_itm>.
              READ TABLE lt_wbs_item INTO ls_wbs_item
             WITH KEY zstate_code_pv = <fs_conn_itm>-zstage_code_pv.
              IF sy-subrc = 0.
                CALL FUNCTION 'CONVERSION_EXIT_ABPSP_INPUT'
                  EXPORTING
                    input     = ls_wbs_item-pspid_new
                  IMPORTING
                    output    = <fs_conn_itm>-pspnr
                  EXCEPTIONS
                    not_found = 1
                    OTHERS    = 2.

                IF NOT <fs_conn_itm>-pspnr IS INITIAL.
                  CALL FUNCTION 'CONVERSION_EXIT_ABPSP_OUTPUT'
                    EXPORTING
                      input  = <fs_conn_itm>-pspnr
                    IMPORTING
                      output = <fs_conn_itm>-zwbs_number.
                  <fs_conn_itm>-zstatus     = '04'.
                  <fs_conn_itm>-error_txt   = ' '.
                ENDIF.
              ELSE.
                IF     <fs_conn_itm>-loevm = 'X'
                   AND <fs_conn_itm>-zwbs_number+3(5) = '00000'
                   AND <fs_conn_itm>-pspnr IS INITIAL.
                  <fs_conn_itm>-zstatus     = '81'.
                ELSEIF <fs_conn_itm>-zstatus+0(1)     = '9'.
                ELSE.
                  <fs_conn_itm>-zstatus     = '80'.
                ENDIF.
              ENDIF.
              <fs_conn_itm>-psphi       = ls_conn_hdr-pspnr.
              <fs_conn_itm>-changed_by  = ls_conn_hdr-changed_by.
              <fs_conn_itm>-change_date = ls_conn_hdr-change_date.
              <fs_conn_itm>-change_time = ls_conn_hdr-change_time.
            ENDLOOP.
* update sap project and wbs value to stagging table
* check to add row lock before modifying the entry
            MODIFY zvconn_pv_hdr_in FROM ls_conn_hdr.
            MODIFY zvconn_pv_itm_in FROM TABLE lt_conn_itm.
          ENDIF.
        ENDIF.
*   End of changes by LCHENNA for CR 797199
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait   = 'X'
          IMPORTING
            return = ls_return.
** approval log
        gs_appr_log-text = 'Project and WBS Created Successfully'.
        APPEND gs_appr_log TO gt_appr_log.
        CLEAR: gs_appr_log.
*Project Status
        CLEAR lv_objnr.
        SELECT SINGLE objnr FROM proj INTO lv_objnr
                            WHERE pspid = ls_head-pspid.
        IF NOT lv_objnr IS INITIAL.
          IF gv_capex IS NOT INITIAL.
            PERFORM settlement_rule.

            PERFORM auc_creation.
          ENDIF.
          CALL METHOD zcl_sleep=>seconds
            EXPORTING
              iv_second = 1.
          PERFORM set_release IN PROGRAM saplzwbs_req IF FOUND
                              USING    'P'
                                       ls_head-pspid
                                       lv_objnr
                              CHANGING lt_return.

          IF gv_capex IS NOT INITIAL.
            LOOP AT lt_return TRANSPORTING NO FIELDS WHERE type CA 'EA'.
              gv_error_email = 'X'.
              EXIT.
            ENDLOOP.
            IF sy-subrc NE 0.
              "approval log
              gs_appr_log-text = 'WBS elements have been released Successfully'.
              APPEND gs_appr_log TO gt_appr_log.
              CLEAR: gs_appr_log.
            ELSE.
              " approval log
              gv_error_email = 'X'.
              gs_appr_log-text = 'WBS elements have not released'.
              APPEND gs_appr_log TO gt_appr_log.
              CLEAR: gs_appr_log.
            ENDIF.
            CALL METHOD zcl_sleep=>seconds
              EXPORTING
                iv_second = 1.
            PERFORM budget.
          ENDIF.
        ENDIF.
      ENDIF.
    ELSE.
*   Begin of changes by LCHENNA for CR 797199
* Stagging table wbs to be updated with error status
*   End of changes by LCHENNA for CR 797199
      CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.

** approval log
      gv_error_email = 'X'.
      gs_appr_log-text = 'Project and WBS Created not Successfull'.
      APPEND gs_appr_log TO gt_appr_log.
      CLEAR: gs_appr_log.
    ENDIF.
  ELSE.
*   Begin of changes by LCHENNA for CR 797199
* Stagging table wbs to be updated with error status
*   End of changes by LCHENNA for CR 797199
    CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
** approval log
    gv_error_email = 'X'.
    gs_appr_log-text = 'Project and WBS Created not Successfull'.
    APPEND gs_appr_log TO gt_appr_log.
    CLEAR: gs_appr_log.
  ENDIF.

  LOOP AT lt_return TRANSPORTING NO FIELDS WHERE type CA 'EA'.
    DELETE lt_return WHERE type NA 'EA'. "Delete all other information
    EXIT.
  ENDLOOP.
  IF sy-subrc <> 0.
    CLEAR lt_return.
  ENDIF.

ENDFORM.                    " WBS_REQUEST_CREATE
*&---------------------------------------------------------------------*
*&      Form  WBS_REQUEST_CHANGE
*&---------------------------------------------------------------------*
FORM wbs_request_change USING iv_simulation TYPE char1.

  CLEAR:ls_proj,lt_prps,ls_project_def,ls_project_def_upd,lt_return,
        lt_wbs_celement,lt_wbs_element,lt_wbs_element_upd,
        lt_extensionin,lt_cextensionin.

  SELECT SINGLE * FROM proj INTO ls_proj
                            WHERE pspid = ls_head-pspid.

  IF NOT lt_wbs_item IS INITIAL.
    SELECT * FROM prps INTO TABLE lt_prps
                       FOR ALL ENTRIES IN lt_wbs_item
                       WHERE posid = lt_wbs_item-pspid.
* Begin of changs by LCHENNA for CR 797199
    IF sy-subrc EQ 0.
      SELECT * FROM prte INTO TABLE lt_prte
                         FOR ALL ENTRIES IN lt_prps
                         WHERE posnr = lt_prps-pspnr.
    ENDIF.
* End of changes by LCHENNA for CR 797199
  ENDIF.

*Skip Project Changes in case of Update from PlanView
  CLEAR: lv_maint_sys.
  LOOP AT lt_wbs_item TRANSPORTING NO FIELDS
                      WHERE zmaint_sys EQ 'PV' AND
                            zchange    NE space.
    lv_maint_sys = 'PV'.
    EXIT.
  ENDLOOP.
*  IF sy-subrc = 0 AND NOT ls_proj IS INITIAL.
  "DO NOTHING
*  ELSE.
  PERFORM check_proj_changes CHANGING ls_project_def
                                      ls_project_def_upd.
*  ENDIF.

  PERFORM check_prps_changes CHANGING lt_wbs_element
                                      lt_wbs_element_upd
                                      lt_extensionin
                                      lt_wbs_celement
                                      lt_cextensionin.

*Check for Exceptional Cases sent from PV where we DO NOT have any specific update on Project or WBS
*Please proceed to Update Connection table with the suitable Status
  IF lv_maint_sys = 'PV'        AND
     ls_project_def  IS INITIAL AND
     lt_wbs_element  IS INITIAL AND
     lt_extensionin  IS INITIAL AND
     lt_wbs_celement IS INITIAL AND
     lt_cextensionin IS INITIAL.
    DATA(lv_pv_exception) = abap_true.
  ENDIF.

  CHECK NOT ls_project_def  IS INITIAL OR
        NOT lt_wbs_element  IS INITIAL OR
        NOT lt_extensionin  IS INITIAL OR
        NOT lt_wbs_celement IS INITIAL OR
        NOT lt_cextensionin IS INITIAL OR
        NOT lv_pv_exception IS INITIAL.

  CALL FUNCTION 'BAPI_PS_INITIALIZATION'.

  IF NOT ls_project_def IS INITIAL.
    CALL FUNCTION 'BAPI_BUS2001_CHANGE'
      EXPORTING
        i_project_definition     = ls_project_def
        i_project_definition_upd = ls_project_def_upd
      TABLES
        et_return                = lt_return.
  ENDIF.

*Create New WBS
  CLEAR lt_return.
  IF NOT lt_wbs_celement IS INITIAL OR
     NOT lt_cextensionin IS INITIAL.
    SORT:lt_wbs_celement,lt_cextensionin.
    CALL FUNCTION 'BAPI_BUS2054_CREATE_MULTI'
      EXPORTING
        i_project_definition = ls_head-pspid
      TABLES
        it_wbs_element       = lt_wbs_celement
        et_return            = lt_return
        extensionin          = lt_cextensionin.
  ENDIF.

*Check lt_return for Success
  CLEAR lv_error.
  LOOP AT lt_return TRANSPORTING NO FIELDS WHERE type CA 'EA'.
    lv_error = 'X'.
    EXIT.
  ENDLOOP.

  IF lv_error IS INITIAL.
*Change Existing WBS
    CLEAR lt_return.
    IF NOT lt_wbs_element IS INITIAL OR
       NOT lt_extensionin IS INITIAL.
      CALL FUNCTION 'BAPI_BUS2054_CHANGE_MULTI'
        EXPORTING
          i_project_definition  = ls_head-pspid
        TABLES
          it_wbs_element        = lt_wbs_element
          it_update_wbs_element = lt_wbs_element_upd
          et_return             = lt_return
          extensionin           = lt_extensionin.
    ENDIF.

*Check lt_return for Success
    CLEAR lv_error.
    LOOP AT lt_return TRANSPORTING NO FIELDS WHERE type CA 'EA'.
      lv_error = 'X'.
      EXIT.
    ENDLOOP.
  ENDIF.

  IF lv_error IS INITIAL.
    IF iv_simulation IS INITIAL.
      CLEAR:lt_return.
      IF lv_pv_exception IS INITIAL."DO NOT Process in case of PV Exceptions
        CALL FUNCTION 'BAPI_PS_PRECOMMIT'
          TABLES
            et_return = lt_return.
        LOOP AT lt_return TRANSPORTING NO FIELDS WHERE type CA 'EA'.
          lv_error = 'X'.
          EXIT.
        ENDLOOP.
      ENDIF.
      IF lv_error IS INITIAL.
        "Overwrite only if Successful
*      ct_return = lt_return.
      ENDIF.
    ENDIF.
  ENDIF.

  IF lv_error IS INITIAL.
    IF iv_simulation IS INITIAL.
      CLEAR:ls_return.
      IF lv_pv_exception IS INITIAL."DO NOT Process in case of PV Exceptions
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait   = 'X'
          IMPORTING
            return = ls_return.
** approval log
        gs_appr_log-text = 'Project and WBS Created Successfully'.
        APPEND gs_appr_log TO gt_appr_log.
        CLEAR: gs_appr_log.
      ENDIF.
**WBS Status
      IF lv_pv_exception IS INITIAL."DO NOT Process in case of PV Exceptions
        LOOP AT lt_wbs_item INTO ls_item.
          READ TABLE lt_prps TRANSPORTING NO FIELDS
                             WITH KEY posid = ls_item-pspid.
          IF sy-subrc <> 0.
            CLEAR lv_objnr.
            SELECT SINGLE objnr FROM prps INTO lv_objnr
                                WHERE posid = ls_item-pspid.
            IF NOT lv_objnr IS INITIAL.
              IF gv_capex IS NOT INITIAL.
                PERFORM settlement_rule_change.
                PERFORM investment_program.
                "PERFORM budget_change.
                PERFORM auc_creation.
              ENDIF.
              PERFORM set_release IN PROGRAM saplzwbs_req IF FOUND
                                  USING    'W'
                                           ls_item-pspid
                                           lv_objnr
                                  CHANGING lt_treturn.
              APPEND LINES OF lt_treturn TO lt_return.

            ENDIF.
          ENDIF.
        ENDLOOP.
      ENDIF.

**Budget Update.
      IF gv_capex IS NOT INITIAL.
        LOOP AT lt_return TRANSPORTING NO FIELDS WHERE type CA 'EA'.
          gv_error_email = 'X'.
          EXIT.
        ENDLOOP.
        IF sy-subrc NE 0.
          "approval log
          gs_appr_log-text = 'WBS elements have been released Successfully'.
          APPEND gs_appr_log TO gt_appr_log.
          CLEAR: gs_appr_log.
        ELSE.
          " approval log
          gv_error_email = 'X'.
          gs_appr_log-text = 'WBS elements have not released'.
          APPEND gs_appr_log TO gt_appr_log.
          CLEAR: gs_appr_log.
        ENDIF.
        "LOOP AT lt_wbs_item INTO ls_item WHERE zchange = 'U'.
        PERFORM investment_program.
        PERFORM budget_change.
        "ENDLOOP.
      ENDIF.

*Update Staging PV tables with the Updated Information
      DATA ls_conn_hdr TYPE zvconn_pv_hdr_in.
      DATA lt_conn_itm TYPE STANDARD TABLE OF zvconn_pv_itm_in.
      FIELD-SYMBOLS <fs_conn_itm> TYPE zvconn_pv_itm_in.
      SELECT SINGLE * FROM zvconn_pv_hdr_in INTO ls_conn_hdr
                      WHERE zprj_code_pv <> '0' AND
                            zprj_code_pv = ls_head-zprj_code_pv.
      IF sy-subrc EQ 0.
*Add Timestamp to Staging Header
        ls_conn_hdr-changed_by  = sy-uname.
        ls_conn_hdr-change_date = sy-datum.
        ls_conn_hdr-change_time = sy-uzeit.

        SELECT * FROM zvconn_pv_itm_in INTO TABLE lt_conn_itm
                 WHERE zprj_code_pv <> '0'
                   AND zprj_code_pv = ls_head-zprj_code_pv.

*        SELECT * FROM zvconn_pv_itm_in INTO TABLE lt_conn_itm
*          FOR ALL ENTRIES IN lt_wbs_item
*                   WHERE zprj_code_pv <> '0'
*                     AND zprj_code_pv   = ls_head-zprj_code_pv
*                     AND zstage_code_pv = lt_wbs_item-zstate_code_pv.

        IF lt_conn_itm IS NOT INITIAL.
          LOOP AT lt_conn_itm ASSIGNING <fs_conn_itm>.
            READ TABLE lt_wbs_item INTO ls_item
              WITH KEY zstate_code_pv = <fs_conn_itm>-zstage_code_pv.
            IF sy-subrc = 0.
              CALL FUNCTION 'CONVERSION_EXIT_ABPSP_INPUT'
                EXPORTING
                  input     = ls_item-pspid_new
                IMPORTING
                  output    = <fs_conn_itm>-pspnr
                EXCEPTIONS
                  not_found = 1
                  OTHERS    = 2.

              IF NOT <fs_conn_itm>-pspnr IS INITIAL.
                CALL FUNCTION 'CONVERSION_EXIT_ABPSP_OUTPUT'
                  EXPORTING
                    input  = <fs_conn_itm>-pspnr
                  IMPORTING
                    output = <fs_conn_itm>-zwbs_number.
                <fs_conn_itm>-zstatus   = '04'.
                <fs_conn_itm>-error_txt = ' '.
              ENDIF.
            ELSE.
              IF <fs_conn_itm>-loevm = 'X'                AND
                 <fs_conn_itm>-zwbs_number+3(5) = '00000' AND
                 <fs_conn_itm>-pspnr IS INITIAL.
                <fs_conn_itm>-zstatus = '81'.
              ELSEIF <fs_conn_itm>-zstatus+0(1) = '9'.
              ELSE.
                <fs_conn_itm>-zstatus = '80'.
              ENDIF.
            ENDIF.
            <fs_conn_itm>-psphi       = ls_conn_hdr-pspnr.
            <fs_conn_itm>-changed_by  = ls_conn_hdr-changed_by.
            <fs_conn_itm>-change_date = ls_conn_hdr-change_date.
            <fs_conn_itm>-change_time = ls_conn_hdr-change_time.
          ENDLOOP.
* update sap project and wbs value to stagging table
* check to add row lock before modifying the entry
          MODIFY zvconn_pv_itm_in FROM TABLE lt_conn_itm.
        ENDIF.
      ENDIF.
*--------------------------------------------------------------------*
    ENDIF.
  ELSE.
    CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
** approval log
    gv_error_email = 'X'.
    gs_appr_log-text = 'Project and WBS Created not Successfull'.
    APPEND gs_appr_log TO gt_appr_log.
    CLEAR: gs_appr_log.
  ENDIF.

  LOOP AT lt_return TRANSPORTING NO FIELDS WHERE type CA 'EA'.
    DELETE lt_return WHERE type NA 'EA'. "Delete all other information
    EXIT.
  ENDLOOP.
  IF sy-subrc <> 0.
    CLEAR lt_return.
  ENDIF.
  CLEAR lv_pv_exception.
*  ELSE.
***Budget Update.
*    IF gv_capex IS NOT INITIAL.
*      "LOOP AT lt_wbs_item INTO ls_item WHERE zchange = 'U'.
*      PERFORM investment_program.
*      PERFORM budget_change.
*      "ENDLOOP.
*    ENDIF.
*  ENDIF.
ENDFORM.                    " WBS_REQUEST_CHANGE
*&---------------------------------------------------------------------*
*&      Form  CHECK_PROJ_CREATE
*&---------------------------------------------------------------------*
FORM check_proj_create CHANGING cs_project_new TYPE bapi_bus2001_new.

  cs_project_new-project_definition   = ls_head-pspid.
  cs_project_new-description          = ls_head-post1.
  cs_project_new-wbs_status_profile   = ls_head-stspr.
  cs_project_new-company_code         = ls_head-vbukr.
  cs_project_new-business_area        = ls_head-vgsbr.
  cs_project_new-controlling_area     = ls_head-vkokr.
  cs_project_new-profit_ctr           = ls_head-prctr.
  cs_project_new-project_currency     = ls_head-pwhie.
  cs_project_new-start                = ls_head-plfaz.
  cs_project_new-finish               = ls_head-plsez.
  cs_project_new-plant                = ls_head-werks.
  cs_project_new-calendar             = ls_head-kalid.
  cs_project_new-plan_basic           = ls_head-vgplf.
  cs_project_new-plan_fcst            = ls_head-ewplf.
  cs_project_new-time_unit            = ls_head-zteht.
  cs_project_new-network_profile      = ls_head-vprof.
  cs_project_new-project_profile      = ls_head-profl.
  cs_project_new-budget_profile       = ls_head-bprof.
  cs_project_new-project_stock        = ls_head-besta.
  cs_project_new-wbs_sched_profile    = ls_head-scprf.
  cs_project_new-plan_profile         = ls_head-pprof.
  cs_project_new-planintegrated       = ls_head-plint.
  cs_project_new-valuation_spec_stock = ls_head-kzbws.
  cs_project_new-func_area            = ls_head-func_area.
  cs_project_new-sched_scenario       = ls_head-schtyp.
  cs_project_new-applicant_no         = ls_head-astnr_n.
  cs_project_new-responsible_no       = ls_head-vernr_n.
  cs_project_new-grouping_indicator   = ls_head-grtop.
  "cs_project_new-FCST_START           = ls_head-estrt.
  "cs_project_new-FCST_finish          = ls_head-eende.

ENDFORM.                    " CHECK_PROJ_CREATE
*&---------------------------------------------------------------------*
*&      Form  CHECK_PROJ_CHANGES
*&---------------------------------------------------------------------*
FORM check_proj_changes  CHANGING cs_project_def     TYPE
bapi_bus2001_chg
                                  cs_project_def_upd TYPE
                                  bapi_bus2001_upd.

  IF ls_proj-post1 NE ls_head-post1.
    cs_project_def-description     = ls_head-post1.
    cs_project_def_upd-description = abap_true.
  ENDIF.
  IF lv_maint_sys = 'PV'.
    "Do nothing
  ELSE.
    IF ls_proj-stspr NE ls_head-stspr.
      cs_project_def-wbs_status_profile     = ls_head-stspr.
      cs_project_def_upd-wbs_status_profile = abap_true.
    ENDIF.
    IF ls_proj-vbukr NE ls_head-vbukr.
      cs_project_def-company_code     = ls_head-vbukr.
      cs_project_def_upd-company_code = abap_true.
    ENDIF.
    IF ls_proj-vgsbr NE ls_head-vgsbr.
      cs_project_def-business_area     = ls_head-vgsbr.
      cs_project_def_upd-business_area = abap_true.
    ENDIF.
    IF ls_proj-prctr NE ls_head-prctr.
      cs_project_def-profit_ctr     = ls_head-prctr.
      cs_project_def_upd-profit_ctr = abap_true.
    ENDIF.
    IF ls_proj-pwhie NE ls_head-pwhie.
      cs_project_def-project_currency     = ls_head-pwhie.
      cs_project_def_upd-project_currency = abap_true.
    ENDIF.
    IF ls_proj-plfaz NE ls_head-plfaz.
      cs_project_def-start     = ls_head-plfaz.
      cs_project_def_upd-start = abap_true.
    ENDIF.
    IF ls_proj-plsez NE ls_head-plsez.
      cs_project_def-finish     = ls_head-plsez.
      cs_project_def_upd-finish = abap_true.
    ENDIF.
    IF ls_proj-werks NE ls_head-werks.
      cs_project_def-plant     = ls_head-werks.
      cs_project_def_upd-plant = abap_true.
    ENDIF.
    IF ls_proj-kalid NE ls_head-kalid.
      cs_project_def-calendar     = ls_head-kalid.
      cs_project_def_upd-calendar = abap_true.
    ENDIF.
    IF ls_proj-vgplf NE ls_head-vgplf.
      cs_project_def-plan_basic     = ls_head-vgplf.
      cs_project_def_upd-plan_basic = abap_true.
    ENDIF.
    IF ls_proj-ewplf NE ls_head-ewplf.
      cs_project_def-plan_fcst     = ls_head-ewplf.
      cs_project_def_upd-plan_fcst = abap_true.
    ENDIF.
    IF ls_proj-zteht NE ls_head-zteht.
      cs_project_def-time_unit     = ls_head-zteht.
      cs_project_def_upd-time_unit = abap_true.
    ENDIF.
    IF ls_proj-vprof NE ls_head-vprof.
      cs_project_def-network_profile     = ls_head-vprof.
      cs_project_def_upd-network_profile = abap_true.
    ENDIF.
    IF ls_proj-bprof NE ls_head-bprof.
      cs_project_def-budget_profile     = ls_head-bprof.
      cs_project_def_upd-budget_profile = abap_true.
    ENDIF.
    IF ls_proj-besta NE ls_head-besta.
      cs_project_def-project_stock     = ls_head-besta.
      cs_project_def_upd-project_stock = abap_true.
    ENDIF.
    IF ls_proj-scprf NE ls_head-scprf.
      cs_project_def-wbs_sched_profile     = ls_head-scprf.
      cs_project_def_upd-wbs_sched_profile = abap_true.
    ENDIF.
    IF ls_proj-pprof NE ls_head-pprof.
      cs_project_def-plan_profile     = ls_head-pprof.
      cs_project_def_upd-plan_profile = abap_true.
    ENDIF.
    IF ls_proj-plint NE ls_head-plint.
      cs_project_def-planintegrated     = ls_head-plint.
      cs_project_def_upd-planintegrated = abap_true.
    ENDIF.
    IF ls_proj-kzbws NE ls_head-kzbws.
      cs_project_def-valuation_spec_stock     = ls_head-kzbws.
      cs_project_def_upd-valuation_spec_stock = abap_true.
    ENDIF.
    IF ls_proj-func_area NE ls_head-func_area.
      cs_project_def-func_area     = ls_head-func_area.
      cs_project_def_upd-func_area = abap_true.
    ENDIF.
    IF ls_proj-schtyp NE ls_head-schtyp.
      cs_project_def-sched_scenario     = ls_head-schtyp.
      cs_project_def_upd-sched_scenario = abap_true.
    ENDIF.
    IF ls_proj-astnr NE ls_head-astnr_n.
      cs_project_def-applicant_no     = ls_head-astnr_n.
      cs_project_def_upd-applicant_no = abap_true.
    ENDIF.
    IF ls_proj-vernr NE ls_head-vernr_n.
      cs_project_def-responsible_no     = ls_head-vernr_n.
      cs_project_def_upd-responsible_no = abap_true.
    ENDIF.
  ENDIF.

  IF gv_capex = 'X'.
    cs_project_def-company_code     = ls_head-vbukr.
    cs_project_def_upd-company_code = abap_true.
  ENDIF.

*Check for Atleast One Change
  IF NOT cs_project_def IS INITIAL.
    cs_project_def-project_definition = ls_head-pspid.
  ENDIF.

ENDFORM.                    " CHECK_PROJ_CHANGES
*&---------------------------------------------------------------------*
*&      Form  CHECK_PRPS_CREATE
*&---------------------------------------------------------------------*
FORM check_prps_create CHANGING ct_wbs_element TYPE STANDARD TABLE
                                ct_extensionin TYPE STANDARD TABLE.

  DATA:lt_item      TYPE STANDARD TABLE OF zwbs_item,
       ls_item_temp TYPE zwbs_item,
       ls_te_wbs    TYPE bapi_te_wbs_element.

  DATA:lv_upper_level TYPE ps_posid,
       lv_left_level  TYPE ps_posid,
       lv_up          TYPE ps_stufe,
       lv_left        TYPE ps_stufe,
       lv_index       TYPE i,
       lv_request     TYPE zwbsrequest.
  lv_request = zwbs_header-request.
  EXPORT lv_request = lv_request TO MEMORY ID 'ZCOMPLETION_DATE'.
*Capture New Entries
  CLEAR:lt_item,ls_item_temp.
  APPEND LINES OF lt_wbs_item TO lt_item.

  SORT lt_item BY pspid_new DESCENDING stufe DESCENDING.
  LOOP AT lt_item INTO ls_item.
    CLEAR:ls_wbs_celement,ls_te_wbs,lv_index,lv_left_level,
    lv_upper_level.

    lv_index = sy-tabix + 1.

    ls_wbs_celement-wbs_element      = ls_item-pspid_new.
    ls_wbs_celement-description      = ls_item-post1.
    ls_wbs_celement-company_code     = ls_item-pbukr.
    ls_wbs_celement-business_area    = ls_item-pgsbr.
    ls_wbs_celement-controlling_area = zwbs_header-vkokr.
    ls_wbs_celement-profit_ctr       = ls_item-prctr.
    ls_wbs_celement-plant            = ls_item-werks.

    ls_wbs_celement-res_anal_key     = ls_item-abgsl.
    IF gv_capex IS NOT INITIAL.
      ls_wbs_celement-wbs_planning_element    = ls_item-plakz.
      ls_wbs_celement-inv_reason              = ls_head-izwek.
      ls_wbs_celement-invest_profile          = ls_item-imprf.
      ls_wbs_celement-respsbl_cctr            = ls_item-akstl.
      ls_wbs_celement-wbs_basic_start_date    = ls_item-plfaz.
      ls_wbs_celement-wbs_basic_finish_date   = ls_item-plsez.
      ls_wbs_celement-applicant_no            = ls_item-astnr_n.
      ls_wbs_celement-responsible_no          = ls_item-vernr_n.
      ls_wbs_celement-wbs_forecast_start_date = ls_item-estrt.
      ls_wbs_celement-wbs_forecast_finish_date = ls_item-eende.

      IF ls_item-stufe = 1.
        SELECT SINGLE * FROM zwbs_proj_tem_tc INTO @DATA(ls_proj) WHERE project = @ls_item-zproj_template.
        IF sy-subrc = 0 AND ls_proj-unifier = 'X'.
          ls_te_wbs-zunifier_proj = 'X'.
        ENDIF.
      ENDIF.
    ELSE.
      ls_wbs_celement-wbs_planning_element  = abap_true.
      ls_wbs_celement-wbs_billing_element   = ls_item-fakkz.
      ls_wbs_celement-request_cctr          = ls_item-akstl.
* Begin of changes by LCHENNA for CR 797199
      ls_wbs_celement-wbs_basic_start_date  = ls_item-zstage_st_dt.
      ls_wbs_celement-wbs_basic_finish_date = ls_item-zstage_end_dt.
* End of changes by LCHENNA for CR 797199
      ls_wbs_celement-wbs_mrp_element = ls_item-grpkz.
*Extensions
      ls_te_wbs-zprgman         = ls_head-zprgman.
      ls_te_wbs-zprodcod        = ls_head-zprodcod.
      ls_te_wbs-zasset          = ls_item-zasset.
      ls_te_wbs-zrevstr         = ls_item-zrevstr.
      ls_te_wbs-zarea           = ls_item-zarea.
      ls_te_wbs-zscopcha        = ls_item-zscopcha.
      ls_te_wbs-zopportunity_id = ls_item-zopportunity_id.
      ls_te_wbs-zsynergy_id     = ls_item-zsynergy_id.
      ls_te_wbs-zcustom         = ls_item-zcustom.
      ls_te_wbs-z_material      = ls_item-z_material.
* CR 626062 - Additional fields added
      ls_te_wbs-zipm_pr_code    = ls_item-zipm_pr_code.
      ls_te_wbs-zzfcst_status   = ls_item-zzfcst_status.
      ls_te_wbs-zzserv_bund     = ls_item-zzserv_bund.
      ls_te_wbs-zzfree_text     = ls_item-zzfree_text.
* CR 626062 - Ended
      ""* Begin of changes by AKOTA for CR 668561
      ls_te_wbs-zibpaufnr       = ls_item-zibpaufnr.
      ls_te_wbs-zibpebeln       = ls_item-zibpebeln.
      ls_te_wbs-zfcw            = ls_item-zfcw.
      ls_te_wbs-zibpflag        = ls_item-zibpflag.
      ls_te_wbs-zibpflgmc       = ls_item-zibpflgmc.
      ""* End of changes by AKOTA for CR 668561
* Begin of Change by LCHENNA for CR 797199
      ls_te_wbs-zmaint_sys        = ls_item-zmaint_sys.
      ls_te_wbs-zrev_rec_dt       = ls_item-zrev_rec_dt.
      ls_te_wbs-zprodcat          = ls_item-zprodcat.
      ls_te_wbs-zlifecycle_module = ls_item-zlifecycle_module.
      ls_te_wbs-zbusiness_case    = ls_item-zbusiness_case.
* End of Change by LCHENNA for CR 797199
*    ls_te_wbs-zstage_code_pv    = ls_item-zstate_code_pv.
*Non Resourced Project field sent from Planview
      ls_te_wbs-zibp_res_proj     = ls_item-zibp_res_proj.
*Customer PO and Item
      ls_te_wbs-zbstkd            = ls_item-zbstkd.
      ls_te_wbs-zposex            = ls_item-zposex.
    ENDIF.

    ls_wbs_celement-wbs_account_assignment_element = ls_item-belkz.

*Add Levels to WBS based on Hierarchy
    LOOP AT lt_item INTO ls_item_temp FROM lv_index.
*Left Level
      IF lv_left_level IS INITIAL AND
         ls_item_temp-stufe = ls_item-stufe.
        lv_left_level = ls_item_temp-pspid_new.
      ENDIF.
*Upper Level
      IF ls_item_temp-stufe < ls_item-stufe.
        lv_upper_level = ls_item_temp-pspid_new.
        EXIT.
      ENDIF.
    ENDLOOP.
    ls_wbs_celement-wbs_up   = lv_upper_level.
    ls_wbs_celement-wbs_left = lv_left_level.

    APPEND ls_wbs_celement TO ct_wbs_element.

    IF NOT ls_te_wbs IS INITIAL.
      ls_te_wbs-wbs_element     = ls_item-pspid_new.
      ls_extensionin-structure  = 'BAPI_TE_WBS_ELEMENT'.
      ls_extensionin-valuepart1 = ls_te_wbs.
* CR 626062 - Added
      ls_extensionin-valuepart2 = ls_te_wbs-zzfree_text+37(23).
* CR 626062 - Ended
      ""* Begin of changes by AKOTA for CR 668561
      ls_extensionin-valuepart2+23(2) = ls_te_wbs-zfcw.
      ls_extensionin-valuepart2+25(1) = ls_te_wbs-zibpflag.
      ls_extensionin-valuepart2+26(1) = ls_te_wbs-zibpflgmc.
      ls_extensionin-valuepart2+27(12) = ls_te_wbs-zibpaufnr.
      ls_extensionin-valuepart2+39(10) = ls_te_wbs-zibpebeln.
      ""* End of changes by AKOTA for CR 668561
      ls_extensionin-valuepart2+49(01) = ls_te_wbs-zunifier_proj.

*   Begin of changes by LCHENNA for CR 797199
      ls_extensionin-valuepart2+110(4) = ls_te_wbs-zprodcat."PRDCAT
      ls_extensionin-valuepart2+114(8) = ls_te_wbs-zrev_rec_dt.
      ls_extensionin-valuepart2+122(35) = ls_te_wbs-zbusiness_case.
      ls_extensionin-valuepart2+157(35) = ls_te_wbs-zlifecycle_module.
*      ls_extensionin-valuepart2+212(12) = ls_te_wbs-zstage_code_pv.
*   End of changes by LCHENNA for CR 797199
      ls_extensionin-valuepart2+212(1) = ls_te_wbs-zibp_res_proj.
*Customer PO and Item
      ls_extensionin-valuepart2+213(27) = ls_te_wbs-zbstkd.
      ls_extensionin-valuepart3         = ls_te_wbs-zbstkd+27(8).
      ls_extensionin-valuepart3+8(6)    = ls_te_wbs-zposex.
      APPEND ls_extensionin TO ct_extensionin.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " CHECK_PRPS_CREATE
*&---------------------------------------------------------------------*
*&      Form  CHECK_PRPS_CHANGES
*&---------------------------------------------------------------------*
FORM check_prps_changes CHANGING ct_wbs_element     TYPE STANDARD TABLE
                                 ct_wbs_element_upd TYPE STANDARD TABLE
                                 ct_extensionin     TYPE STANDARD TABLE
                                 ct_wbs_celement    TYPE STANDARD TABLE
                                 ct_cextensionin    TYPE STANDARD TABLE.

  DATA:lt_twbs_element     TYPE STANDARD TABLE OF bapi_bus2054_chg,
       lt_twbs_element_upd TYPE STANDARD TABLE OF bapi_bus2054_upd,
       lt_textensionin     TYPE STANDARD TABLE OF bapiparex,
       lt_item             TYPE STANDARD TABLE OF zwbs_item,
       ls_item_temp        TYPE zwbs_item,
       ls_te_wbs           TYPE bapi_te_wbs_element,
       ls_ext_db           TYPE ci_prps,
       ls_ext_wbs          TYPE ci_prps.

  DATA:lv_upper_level TYPE ps_posid,
       lv_left_level  TYPE ps_posid,
       lv_up          TYPE ps_stufe,
       lv_left        TYPE ps_stufe,
       lv_index       TYPE i,
       lv_wbs_exists  TYPE flag,
       lv_request     TYPE zwbsrequest.

  lv_request = zwbs_header-request.
  EXPORT lv_request = lv_request TO MEMORY ID 'ZCOMPLETION_DATE_CHANGE'.

  SELECT SINGLE * FROM zwbs_auc INTO @DATA(ls_zwbs_auc1)
                  WHERE bukrs = @zwbs_header-vbukr
                  AND  bwkey = @zwbs_header-werks.

*Capture New Entries
  CLEAR:lt_item,ls_item_temp.
  APPEND LINES OF lt_wbs_item TO lt_item.

  SORT lt_item BY pspid_new DESCENDING stufe DESCENDING.
  LOOP AT lt_item INTO ls_item.
    CLEAR:ls_wbs_celement,ls_te_wbs,lv_index,lv_left_level,
    lv_upper_level.
    lv_index = sy-tabix + 1.
    READ TABLE lt_prps INTO ls_prps WITH KEY posid = ls_item-pspid.
    IF sy-subrc <> 0.
      ls_wbs_celement-wbs_element      = ls_item-pspid.
      ls_wbs_celement-description      = ls_item-post1.
      ls_wbs_celement-company_code     = ls_item-pbukr.
      ls_wbs_celement-business_area    = ls_item-pgsbr.
      ls_wbs_celement-controlling_area = zwbs_header-vkokr.
      ls_wbs_celement-profit_ctr       = ls_item-prctr.
      ls_wbs_celement-plant            = ls_item-werks.
      ls_wbs_celement-res_anal_key     = ls_item-abgsl.

      IF gv_capex IS NOT INITIAL.
        ls_wbs_celement-wbs_planning_element    = ls_item-plakz.
        ls_wbs_celement-wbs_account_assignment_element    = ls_item-belkz.
        ls_wbs_celement-inv_reason              = ls_item-izwek.
        IF ls_item-stufe = '2' AND ls_item-zchange = 'I'.
          IF ls_zwbs_auc1 IS INITIAL.
            ls_wbs_celement-invest_profile      = ls_item-imprf.
          ENDIF.
        ELSE.
          ls_wbs_celement-invest_profile        = ls_item-imprf.
        ENDIF.
        ls_wbs_celement-respsbl_cctr            = ls_item-akstl.
        ls_wbs_celement-wbs_basic_start_date    = ls_item-plfaz.
        ls_wbs_celement-wbs_basic_finish_date   = ls_item-plsez.
        ls_wbs_celement-wbs_forecast_start_date = ls_item-estrt.
        ls_wbs_celement-wbs_forecast_finish_date = ls_item-eende.
      ELSE.
        ls_wbs_celement-wbs_planning_element           = abap_true.
        ls_wbs_celement-wbs_billing_element            = ls_item-fakkz.
        ls_wbs_celement-wbs_account_assignment_element = ls_item-belkz.
        ls_wbs_celement-wbs_mrp_element                = ls_item-grpkz.
* Begin of changes by LCHENNA for CR 797199
        ls_wbs_celement-wbs_basic_start_date = ls_item-zstage_st_dt.
        ls_wbs_celement-wbs_basic_finish_date = ls_item-zstage_end_dt.
* End of changes by LCHENNA for CR 797199
      ENDIF.
*Extensions
      ls_te_wbs-zprgman         = ls_head-zprgman.
      ls_te_wbs-zprodcod        = ls_head-zprodcod.
      ls_te_wbs-zasset          = ls_item-zasset.
      ls_te_wbs-zrevstr         = ls_item-zrevstr.
      ls_te_wbs-zarea           = ls_item-zarea.
      ls_te_wbs-zscopcha        = ls_item-zscopcha.
      ls_te_wbs-zopportunity_id = ls_item-zopportunity_id.
      ls_te_wbs-zsynergy_id     = ls_item-zsynergy_id.
      ls_te_wbs-zcustom         = ls_item-zcustom.
      ls_te_wbs-z_material      = ls_item-z_material.
* CR 626062 - Additional fields added
      ls_te_wbs-zipm_pr_code    = ls_item-zipm_pr_code.
      ls_te_wbs-zzfcst_status   = ls_item-zzfcst_status.
      ls_te_wbs-zzserv_bund     = ls_item-zzserv_bund.
      ls_te_wbs-zzfree_text     = ls_item-zzfree_text.
* CR 626062 - Ended
      ""* Begin of changes by AKOTA for CR 668561
      ls_te_wbs-zibpaufnr = ls_item-zibpaufnr.
      ls_te_wbs-zibpebeln = ls_item-zibpebeln.
      ls_te_wbs-zfcw      = ls_item-zfcw.
      ls_te_wbs-zibpflag  = ls_item-zibpflag.
      ls_te_wbs-zibpflgmc = ls_item-zibpflgmc.
      ""* End of changes by AKOTA for CR 668561
*     Begin of changes by LCHENNA for CR 797199
      ls_te_wbs-zmaint_sys = ls_item-zmaint_sys.
      ls_te_wbs-zrev_rec_dt = ls_item-zrev_rec_dt.
      ls_te_wbs-zprodcat = ls_item-zprodcat.
      ls_te_wbs-zbusiness_case = ls_item-zbusiness_case.
      ls_te_wbs-zlifecycle_module = ls_item-zlifecycle_module.
*     End of changes by LCHENNA for CR 797199
*      ls_te_wbs-zstage_code_pv    = ls_item-zstate_code_pv.
*Non Resourced Project field sent from Planview
      ls_te_wbs-zibp_res_proj     = ls_item-zibp_res_proj.
*Customer PO and Item
      ls_te_wbs-zbstkd            = ls_item-zbstkd.
      ls_te_wbs-zposex            = ls_item-zposex.

*Add Levels to WBS based on Hierarchy
      LOOP AT lt_item INTO ls_item_temp FROM lv_index.
*Left Level
        IF lv_left_level IS INITIAL AND
           ls_item_temp-stufe = ls_item-stufe.
          lv_left_level = ls_item_temp-pspid_new.
        ENDIF.
*Upper Level
        IF ls_item_temp-stufe < ls_item-stufe.
          lv_upper_level = ls_item_temp-pspid_new.
          EXIT.
        ENDIF.
      ENDLOOP.
      ls_wbs_celement-wbs_up   = lv_upper_level.
      ls_wbs_celement-wbs_left = lv_left_level.

      APPEND ls_wbs_celement TO ct_wbs_celement.

      IF NOT ls_te_wbs IS INITIAL.
        ls_te_wbs-wbs_element     = ls_item-pspid.
        ls_extensionin-structure  = 'BAPI_TE_WBS_ELEMENT'.
        ls_extensionin-valuepart1 = ls_te_wbs.
* CR 626062 - Added
        ls_extensionin-valuepart2 = ls_te_wbs-zzfree_text+37(23).
* CR 626062 - Ended
        ""* Begin of changes by AKOTA for CR 668561
        ls_extensionin-valuepart2+23(2) = ls_te_wbs-zfcw.
        ls_extensionin-valuepart2+25(1) = ls_te_wbs-zibpflag.
        ls_extensionin-valuepart2+26(1) = ls_te_wbs-zibpflgmc.
        ls_extensionin-valuepart2+27(12) = ls_te_wbs-zibpaufnr.
        ls_extensionin-valuepart2+39(10) = ls_te_wbs-zibpebeln.
        ""* End of changes by AKOTA for CR 668561
*   Begin of changes by LCHENNA for CR 797199
        ls_extensionin-valuepart2+110(4) = ls_te_wbs-zprodcat."PRDCAT
        " Rev Recog date
        ls_extensionin-valuepart2+114(8) = ls_te_wbs-zrev_rec_dt.
        " business case
        ls_extensionin-valuepart2+122(35) = ls_te_wbs-zbusiness_case.
        " life cycle module
        ls_extensionin-valuepart2+157(35) = ls_te_wbs-zlifecycle_module.
*   End of changes by LCHENNA for CR 797199
*        ls_extensionin-valuepart2+212(12) = ls_te_wbs-zstage_code_pv.
        ls_extensionin-valuepart2+212(1) = ls_te_wbs-zibp_res_proj.
*Customer PO and Item
        ls_extensionin-valuepart2+213(27) = ls_te_wbs-zbstkd.
        ls_extensionin-valuepart3         = ls_te_wbs-zbstkd+27(8).
        ls_extensionin-valuepart3+8(6)    = ls_te_wbs-zposex.

        APPEND ls_extensionin TO ct_cextensionin.
      ENDIF.
    ENDIF.
  ENDLOOP.

*Capture Only Changed Records
  LOOP AT lt_wbs_item INTO ls_item WHERE stufe = 1 OR "If Only Header Values are changed
                                         zchange = 'U'.
    CLEAR:ls_wbs_element,ls_wbs_element_upd,ls_extensionin,
          ls_prps,ls_te_wbs,lv_wbs_exists,ls_ext_db,ls_ext_wbs,
          ls_prte.
*Check Record Status - Only Active
    READ TABLE lt_table TRANSPORTING NO FIELDS
                        WITH KEY pspid  = ls_item-pspid
                                 status = space.
    CHECK sy-subrc = 0.
*Check for Changed Data wrt Database
    READ TABLE lt_prps INTO ls_prps WITH KEY posid = ls_item-pspid.
    IF sy-subrc = 0.
      IF ls_prps-post1 NE ls_item-post1.
        ls_wbs_element-description = ls_item-post1.
        ls_wbs_element_upd-description = abap_true.
      ENDIF.
      IF ls_prps-pbukr NE ls_item-pbukr.
        ls_wbs_element-company_code = ls_item-pbukr.
        ls_wbs_element_upd-company_code = abap_true.
      ENDIF.
      IF ls_prps-pgsbr NE ls_item-pgsbr.
        ls_wbs_element-business_area = ls_item-pgsbr.
        ls_wbs_element_upd-business_area = abap_true.
      ENDIF.
      IF ls_prps-prctr NE ls_item-prctr.
        ls_wbs_element-profit_ctr = ls_item-prctr.
        ls_wbs_element_upd-profit_ctr = abap_true.
      ENDIF.
      IF ls_prps-werks NE ls_item-werks.
        ls_wbs_element-plant = ls_item-werks.
        ls_wbs_element_upd-plant = abap_true.
      ENDIF.
      IF ls_prps-abgsl NE ls_item-abgsl.
        ls_wbs_element-res_anal_key = ls_item-abgsl.
        ls_wbs_element_upd-res_anal_key = abap_true.
      ENDIF.
      IF ls_prps-belkz NE ls_item-belkz.
        ls_wbs_element-wbs_account_assignment_element = ls_item-belkz.
        ls_wbs_element_upd-wbs_account_assignment_element = abap_true.
      ENDIF.
      IF ls_prps-plakz NE ls_item-plakz.
        ls_wbs_element-wbs_planning_element = ls_item-plakz.
        ls_wbs_element_upd-wbs_planning_element = abap_true.
      ENDIF.
      IF ls_prps-fakkz NE ls_item-fakkz.
        ls_wbs_element-wbs_billing_element = ls_item-fakkz.
        ls_wbs_element_upd-wbs_billing_element = abap_true.
      ENDIF.
      IF ls_prps-grpkz NE ls_item-grpkz."Indicator: Grouping WBS element
        ls_wbs_element-wbs_mrp_element     = ls_item-grpkz.
        ls_wbs_element_upd-wbs_mrp_element = abap_true.
      ENDIF.
      IF ls_prps-izwek NE ls_item-izwek.
        ls_wbs_element-inv_reason    = ls_item-izwek.
        ls_wbs_element_upd-inv_reason = abap_true.
      ENDIF.
      IF ls_prps-imprf NE ls_item-imprf.
        ls_wbs_element-invest_profile = ls_item-imprf.
        ls_wbs_element_upd-invest_profile = abap_true.
      ENDIF.
      IF ls_prps-fkstl NE ls_item-akstl.
        ls_wbs_element-respsbl_cctr = ls_item-akstl.
        ls_wbs_element_upd-respsbl_cctr = abap_true.
      ENDIF.
      IF ls_prps-vernr NE ls_item-vernr_n.
        ls_wbs_element-responsible_no = ls_item-vernr_n.
        ls_wbs_element_upd-responsible_no = abap_true.
      ENDIF.
      IF ls_prps-astnr NE ls_item-astnr_n.
        ls_wbs_element-applicant_no = ls_item-astnr_n.
        ls_wbs_element_upd-applicant_no = abap_true.
      ENDIF.
      IF gv_capex IS NOT INITIAL.
        READ TABLE lt_prte INTO ls_prte WITH KEY posnr = ls_prps-pspnr.
        IF ls_prte-pstrt NE ls_item-plfaz.
          ls_wbs_element-wbs_basic_start_date    = ls_item-plfaz.
          ls_wbs_element_upd-wbs_basic_start_date = abap_true.
        ENDIF.
        IF ls_prte-pende NE ls_item-plsez.
          ls_wbs_element-wbs_basic_finish_date   = ls_item-plsez.
          ls_wbs_element_upd-wbs_basic_finish_date   = abap_true.
        ENDIF.
        IF ls_prte-estrt NE ls_item-estrt.
          ls_wbs_element-wbs_forecast_start_date = ls_item-estrt.
          ls_wbs_element_upd-wbs_forecast_start_date = abap_true.
        ENDIF.
        IF ls_prte-eende NE ls_item-eende.
          ls_wbs_element-wbs_forecast_finish_date = ls_item-eende.
          ls_wbs_element_upd-wbs_forecast_finish_date = abap_true.
        ENDIF.
      ELSE.
*    Begin of changes by LCHENNA for CR 797199
        READ TABLE lt_prte INTO ls_prte WITH KEY posnr = ls_prps-pspnr.
        IF ls_prte-pstrt NE ls_item-zstage_st_dt.
          ls_wbs_element-wbs_basic_start_date = ls_item-zstage_st_dt.
          ls_wbs_element_upd-wbs_basic_start_date = abap_true.
        ENDIF.

        IF ls_prte-pende NE ls_item-zstage_end_dt.
          ls_wbs_element-wbs_basic_finish_date = ls_item-zstage_end_dt.
          ls_wbs_element_upd-wbs_basic_finish_date = abap_true.
        ENDIF.
*    End of changes by LCHENNA for CR 797199
      ENDIF.

*Extensions
*ONLY Restrict to Limted fields if the Leading System is Plan View
      IF ls_item-zmaint_sys = 'PV'.
        MOVE-CORRESPONDING ls_item TO ls_te_wbs.
        IF ls_prps-zrevstr NE ls_item-zrevstr.
          ls_te_wbs-zrevstr = ls_item-zrevstr.
          lv_wbs_exists     = abap_true.
        ENDIF.
        IF ls_prps-zprgman NE ls_head-zprgman.
          ls_te_wbs-zprgman = ls_head-zprgman.
          lv_wbs_exists     = abap_true.
        ENDIF.
        IF ls_prps-zarea NE ls_item-zarea.
          ls_te_wbs-zarea = ls_item-zarea.
          lv_wbs_exists   = abap_true.
        ENDIF.
        IF ls_prps-zprodcat NE ls_item-zprodcat.
          ls_te_wbs-zprodcat = ls_item-zprodcat.
          lv_wbs_exists      = abap_true.
        ENDIF.
        IF ls_prps-zscopcha NE ls_item-zscopcha.
          ls_te_wbs-zscopcha = ls_item-zscopcha.
          lv_wbs_exists      = abap_true.
        ENDIF.
        IF ls_prps-zprodcod NE ls_head-zprodcod.
          ls_te_wbs-zprodcod = ls_head-zprodcod.
          lv_wbs_exists      = abap_true.
        ENDIF.
        IF ls_prps-zipm_pr_code NE ls_item-zipm_pr_code.
          ls_te_wbs-zipm_pr_code = ls_item-zipm_pr_code.
          lv_wbs_exists          = abap_true.
        ENDIF.
        IF ls_prps-zmaint_sys NE ls_item-zmaint_sys.
          ls_te_wbs-zmaint_sys = ls_item-zmaint_sys.
          lv_wbs_exists        = abap_true.
        ENDIF.
*Project Site Code - Pending
        IF ls_prps-zzfcst_status NE ls_item-zzfcst_status.
          ls_te_wbs-zzfcst_status = ls_item-zzfcst_status.
          lv_wbs_exists           = abap_true.
        ENDIF.
*Non Resourced Project field sent from Planview
        IF ls_prps-zibp_res_proj NE ls_item-zibp_res_proj.
          ls_te_wbs-zibp_res_proj = ls_item-zibp_res_proj.
          lv_wbs_exists           = abap_true.
        ENDIF.
      ENDIF.
      MOVE-CORRESPONDING:ls_prps TO ls_ext_db,
                         ls_prps TO ls_ext_wbs,
                         ls_item TO ls_ext_wbs.
*Check Program Manager and Lonza Code Change Only at Level 1
*      IF ls_item-stufe = 1.
      IF ls_prps-zprgman NE ls_head-zprgman.
        ls_ext_wbs-zprgman = ls_head-zprgman.
      ENDIF.
      IF ls_prps-zprodcod NE ls_head-zprodcod.
        ls_ext_wbs-zprodcod = ls_head-zprodcod.
      ENDIF.
*      ENDIF.
      IF ls_ext_db NE ls_ext_wbs.
        MOVE-CORRESPONDING ls_ext_wbs TO ls_te_wbs.
        lv_wbs_exists = abap_true.
      ENDIF.
*Check for Atleast One changed Value
      IF NOT ls_wbs_element_upd IS INITIAL OR
         NOT lv_wbs_exists      IS INITIAL.
        ls_wbs_element-wbs_element     = ls_item-pspid.
        ls_wbs_element_upd-wbs_element = ls_item-pspid.
        APPEND:ls_wbs_element     TO lt_twbs_element,
               ls_wbs_element_upd TO lt_twbs_element_upd.
        IF NOT lv_wbs_exists IS INITIAL.
          ls_te_wbs-wbs_element     = ls_item-pspid.
          ls_extensionin-structure  = 'BAPI_TE_WBS_ELEMENT'.
*Assign Default Custom Fields from Database
*          PERFORM default_custom_fields CHANGING ls_te_wbs.
          ls_extensionin-valuepart1 = ls_te_wbs.
* CR 626062 - Added
          ls_extensionin-valuepart2 = ls_te_wbs-zzfree_text+37(23).
* CR 626062 - Ended
          ""* Begin of changes by AKOTA for CR 668561
          ls_extensionin-valuepart2+23(2) = ls_te_wbs-zfcw.
          ""* Begin of changes by AKOTA for CR 689451
          ls_extensionin-valuepart2+25(1) = ls_prps-zibpflag.
          ls_extensionin-valuepart2+26(1) = ls_prps-zibpflgmc.
          ""* End of changes by AKOTA for CR 689451
          ls_extensionin-valuepart2+27(12) = ls_te_wbs-zibpaufnr.
          ls_extensionin-valuepart2+39(10) = ls_te_wbs-zibpebeln.
          ""* End of changes by AKOTA for CR 668561
*    Begin of changes by LCHENNA for CR 797199
          ls_extensionin-valuepart2+110(4)  = ls_te_wbs-zprodcat.
          ls_extensionin-valuepart2+114(8)  = ls_te_wbs-zrev_rec_dt.
          ls_extensionin-valuepart2+122(35) = ls_te_wbs-zbusiness_case.
          ls_extensionin-valuepart2+157(35) = ls_te_wbs-zlifecycle_module.
*    End of changes by LCHENNA for CR 797199
*          ls_extensionin-valuepart2+212(12) = ls_te_wbs-zstage_code_pv.
          ls_extensionin-valuepart2+212(1) = ls_te_wbs-zibp_res_proj.
*Customer PO and Item
          ls_extensionin-valuepart2+213(27) = ls_te_wbs-zbstkd.
          ls_extensionin-valuepart3         = ls_te_wbs-zbstkd+27(8).
          ls_extensionin-valuepart3+8(6)    = ls_te_wbs-zposex.
        ENDIF.
        APPEND ls_extensionin TO lt_textensionin.
      ENDIF.
    ENDIF.
  ENDLOOP.

  ct_wbs_element     = lt_twbs_element.
  ct_wbs_element_upd = lt_twbs_element_upd.
  ct_extensionin     = lt_textensionin.
  CLEAR: ls_zwbs_auc1.

ENDFORM.                    " CHECK_PRPS_CHANGES
*&---------------------------------------------------------------------*
*&      Form  SCREEN_DATA
*&---------------------------------------------------------------------*
FORM screen_data.

  IF NOT zwbs_header-werks IS INITIAL.
    SELECT SINGLE COUNT(*) FROM t001k WHERE bwkey = zwbs_header-werks
                                        AND bukrs = zwbs_header-vbukr.
    IF sy-subrc <> 0.
    ENDIF.
    SELECT SINGLE fabkl INTO zwbs_header-kalid FROM t001w
                        WHERE werks = zwbs_header-werks.
  ENDIF.

*  IF zwbs_header-izwek IS NOT INITIAL.
*    READ TABLE lt_table INTO ls_table WITH KEY stufe = '2'.
*    IF sy-subrc = 0.
*
*      CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
*        EXPORTING
*          input  = ls_table-pspid
*        IMPORTING
*          output = lv_pspid_itm.
*
*      SPLIT lv_pspid_itm AT '.' INTO DATA(lv_first) DATA(lv_second) DATA(lv_third).
*      IF zwbs_header-izwek = 'LS' AND lv_third = '51'.
*        MESSAGE 'Project Template and Investment Reason do not match' TYPE 'S' DISPLAY LIKE 'E'.
*      ELSEIF lv_third = '41' AND zwbs_header-izwek NE 'LS'.
*        MESSAGE 'Project Template and Investment Reason do not match' TYPE 'S' DISPLAY LIKE 'E'.
*      ENDIF.
*    ENDIF.
*  ENDIF.

ENDFORM.                    " SCREEN_DATA
*&---------------------------------------------------------------------*
*&      Module  VALIDATE_0400_DATA  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE validate_0400_data INPUT.

  DATA:ls_userid    TYPE soudnamei1,
       ls_user_data TYPE soudatai1.

**Validate Plant
*  IF NOT zwbs_header-werks IS INITIAL.
*SELECT SINGLE COUNT(*) FROM t001k WHERE bwkey = zwbs_header-werks AND
*                                            bukrs = zwbs_header-vbukr.
*    IF sy-subrc <> 0.
*      lv_cursor = 'ZWBS_HEADER-WERKS'.
*      lv_text   = 'Plant'.
*      lv_error  = abap_true.
*      lv_verror = abap_true.
*      lv_herror = abap_true.
*    ENDIF.
*  ENDIF.
*  IF lv_proj3 IS NOT INITIAL OR
  IF lv_proj_type = 'TC' OR
     gv_capex IS NOT INITIAL.
    "    zwbs_header-created_by = sy-uname.
    PERFORM responsible_person.
    IF zwbs_header-astnr IS NOT INITIAL.
      PERFORM applicant_number.
    ENDIF.
  ELSE.
*Check for mismatch between Business Area and Profit Center
    CLEAR lv_prctr.
    IF strlen( zwbs_header-prctr ) > 2 AND zwbs_header-prctr+0(2) = '00'.
      lv_prctr = zwbs_header-prctr+8(2).
    ELSE.
      lv_prctr = zwbs_header-prctr.
    ENDIF.

    IF zwbs_header-vgsbr+0(2) = '00'.
      IF zwbs_header-vgsbr+2(2) <> lv_prctr."zwbs_header-prctr+8(2).
        lv_cursor = 'ZWBS_HEADER-VGSBR'.
        lv_error  = abap_true.
        lv_verror = abap_true.
        lv_herror = abap_true.
      ENDIF.
    ELSE.
      IF zwbs_header-vgsbr <> lv_prctr."zwbs_header-prctr+8(2).
        lv_cursor = 'ZWBS_HEADER-VGSBR'.
        lv_error  = abap_true.
        lv_verror = abap_true.
        lv_herror = abap_true.
      ENDIF.
    ENDIF.
  ENDIF.

ENDMODULE.                 " VALIDATE_0400_DATA  INPUT
*&---------------------------------------------------------------------*
*&      Form  GET_WBS_TEXT
*&---------------------------------------------------------------------*
FORM get_wbs_text USING pv_tdname TYPE tdobname
                        pv_id     TYPE tdid.

  SELECT SINGLE * FROM stxh INTO ls_stxh
                  WHERE tdobject = lc_object AND
                        tdname   = pv_tdname AND
                        tdid     = pv_id     AND
                        tdspras  = lc_spras.

  CHECK sy-subrc = 0.

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      client                  = sy-mandt
      id                      = ls_stxh-tdid
      language                = ls_stxh-tdspras
      name                    = ls_stxh-tdname
      object                  = ls_stxh-tdobject
    IMPORTING
      header                  = ls_header
    TABLES
      lines                   = lt_lines
    EXCEPTIONS
      id                      = 1
      language                = 2
      name                    = 3
      not_found               = 4
      object                  = 5
      reference_check         = 6
      wrong_access_to_archive = 7
      OTHERS                  = 8.
  IF sy-subrc <> 0.
  ENDIF.

ENDFORM.                    " GET_WBS_TEXT
*&--------------------------------------------------------------------*
*&      Form  USER_COMMAND
*&--------------------------------------------------------------------*
FORM user_command USING r_ucomm     LIKE sy-ucomm
                        rs_selfield TYPE slis_selfield.

  DATA:lv_pspnr_proj TYPE ps_intnr,
       lv_pspnr_prps TYPE ps_posnr.

  CASE r_ucomm.
    WHEN '&WF_LIST'.

      CLEAR lt_rspar.
      IF rs_selfield-tabindex > 0.
        READ TABLE lt_output INTO ls_output INDEX rs_selfield-tabindex.
        IF sy-subrc EQ 0.
*         fill selection criteria
          CLEAR ls_rspar.
          ls_rspar-selname = 'R_ANTR_W'.
          ls_rspar-kind = 'S'.
          ls_rspar-sign = 'I'.
          ls_rspar-option = 'IN'.
          ls_rspar-low = ls_output-request.
          APPEND ls_rspar TO lt_rspar.
        ENDIF.
        IF lt_rspar IS NOT INITIAL.
*         export selection for selection r_antr_w in transaction ZCJ04
          EXPORT lt_rspar FROM lt_rspar TO MEMORY ID lc_memory_id_5.

          SET PARAMETER ID 'PSP' FIELD ' '.
          SET PARAMETER ID 'ZWBSREQUEST' FIELD ' '.
          CALL TRANSACTION 'Z_WF_LIST' AND SKIP FIRST SCREEN.
        ENDIF.
      ENDIF.

    WHEN OTHERS.

      CHECK NOT rs_selfield-value IS INITIAL.

      CASE rs_selfield-fieldname.
        WHEN 'REQUEST'.
          SET PARAMETER ID 'ZWBSREQUEST' FIELD rs_selfield-value.
          CALL TRANSACTION 'ZCJ03' AND SKIP FIRST SCREEN.
        WHEN 'PSPID'.
          CALL FUNCTION 'CONVERSION_EXIT_KONPD_INPUT'
            EXPORTING
              input     = rs_selfield-value
            IMPORTING
              output    = lv_pspnr_proj
            EXCEPTIONS
              not_found = 1
              OTHERS    = 2.
          IF sy-subrc = 0.
* Implement suitable error handling here
            SET PARAMETER ID 'PSP' FIELD lv_pspnr_proj.
            SET PARAMETER ID 'PRO' FIELD space.
            CALL TRANSACTION 'CJ20N' AND SKIP FIRST SCREEN.
          ENDIF.
        WHEN 'PSPID_WBS'.
          CALL FUNCTION 'CONVERSION_EXIT_ABPSP_INPUT'
            EXPORTING
              input     = rs_selfield-value
            IMPORTING
              output    = lv_pspnr_prps
            EXCEPTIONS
              not_found = 1
              OTHERS    = 2.
          IF sy-subrc = 0.
* Implement suitable error handling here
            SET PARAMETER ID 'PSP' FIELD space.
            SET PARAMETER ID 'PRO' FIELD lv_pspnr_prps.
            CALL TRANSACTION 'CJ20N' AND SKIP FIRST SCREEN.
          ENDIF.
      ENDCASE.

  ENDCASE.


ENDFORM.                    "user_command
*&---------------------------------------------------------------------*
*&      Form  USER_DETAILS
*&---------------------------------------------------------------------*
FORM user_details USING pv_user TYPE syuname.

  CLEAR:lv_fname,lv_lname,lv_fullname,lv_department,lv_location.

  SELECT SINGLE name_first name_last department city1
         INTO (lv_fname,lv_lname,lv_department,lv_location)
         FROM user_addr WHERE bname = pv_user.

  CONCATENATE lv_lname lv_fname INTO lv_fullname SEPARATED BY space.

ENDFORM.                    " USER_DETAILS
*&---------------------------------------------------------------------*
*&      Form  DEFAULT_CUSTOM_FIELDS
*&---------------------------------------------------------------------*
FORM default_custom_fields CHANGING cs_te_wbs TYPE bapi_te_wbs_element.

  IF ls_prps-zprgman NE ls_head-zprgman.
    cs_te_wbs-zprgman = ls_head-zprgman.
  ELSE.
    cs_te_wbs-zprgman = ls_prps-zprgman.
  ENDIF.
  IF ls_prps-zprodcod NE ls_head-zprodcod.
    cs_te_wbs-zprodcod = ls_head-zprodcod.
  ELSE.
    cs_te_wbs-zprodcod = ls_prps-zprodcod.
  ENDIF.
  IF ls_prps-zasset NE ls_item-zasset.
    cs_te_wbs-zasset = ls_item-zasset.
  ELSE.
    cs_te_wbs-zasset = ls_prps-zasset.
  ENDIF.
  IF ls_prps-zrevstr NE ls_item-zrevstr.
    cs_te_wbs-zrevstr = ls_item-zrevstr.
  ELSE.
    cs_te_wbs-zrevstr = ls_prps-zrevstr.
  ENDIF.
  IF ls_prps-zarea NE ls_item-zarea.
    cs_te_wbs-zarea = ls_item-zarea.
  ELSE.
    cs_te_wbs-zarea = ls_prps-zarea.
  ENDIF.
  IF ls_prps-zscopcha NE ls_item-zscopcha.
    cs_te_wbs-zscopcha = ls_item-zscopcha.
  ELSE.
    cs_te_wbs-zscopcha = ls_prps-zscopcha.
  ENDIF.
  IF ls_prps-zopportunity_id NE ls_item-zopportunity_id.
    cs_te_wbs-zopportunity_id = ls_item-zopportunity_id.
  ELSE.
    cs_te_wbs-zopportunity_id = ls_prps-zopportunity_id.
  ENDIF.
  ""* Begin of changes by AKOTA for CR 668561
  IF ls_prps-zfcw NE ls_item-zfcw.
    cs_te_wbs-zfcw = ls_item-zfcw.
  ELSE.
    cs_te_wbs-zfcw = ls_prps-zfcw.
  ENDIF.
  IF ls_prps-zibpflag NE ls_item-zibpflag.
    cs_te_wbs-zibpflag = ls_item-zibpflag.
  ELSE.
    cs_te_wbs-zibpflag = ls_prps-zibpflag.
  ENDIF.
  IF ls_prps-zibpflgmc NE ls_item-zibpflgmc.
    cs_te_wbs-zibpflgmc = ls_item-zibpflgmc.
  ELSE.
    cs_te_wbs-zibpflgmc = ls_prps-zibpflgmc.
  ENDIF.
  IF ls_prps-zibpaufnr NE ls_item-zibpaufnr.
    cs_te_wbs-zibpaufnr = ls_item-zibpaufnr.
  ELSE.
    cs_te_wbs-zibpaufnr = ls_prps-zibpaufnr.
  ENDIF.
  IF ls_prps-zibpebeln NE ls_item-zibpebeln.
    cs_te_wbs-zibpebeln = ls_item-zibpebeln.
  ELSE.
    cs_te_wbs-zibpebeln = ls_prps-zibpebeln.
  ENDIF.
  ""* End of changes by AKOTA for CR 668561
  IF ls_prps-zsynergy_id NE ls_item-zsynergy_id.
    cs_te_wbs-zsynergy_id = ls_item-zsynergy_id.
  ELSE.
    cs_te_wbs-zsynergy_id = ls_prps-zsynergy_id.
  ENDIF.
  IF ls_prps-zcustom NE ls_item-zcustom.
    cs_te_wbs-zcustom = ls_item-zcustom.
  ELSE.
    cs_te_wbs-zcustom = ls_prps-zcustom.
  ENDIF.
  IF ls_prps-z_material NE ls_item-z_material.
    cs_te_wbs-z_material = ls_item-z_material.
  ELSE.
    cs_te_wbs-z_material = ls_prps-z_material.
  ENDIF.

ENDFORM.                    " DEFAULT_CUSTOM_FIELDS
*&---------------------------------------------------------------------*
*&      Form  GET_WBS_STATUS
*&---------------------------------------------------------------------*
FORM get_wbs_status USING it_wbs_elements TYPE STANDARD TABLE.

  CALL FUNCTION 'BAPI_BUS2054_GET_STATUS'
    TABLES
      i_wbs_elements  = it_wbs_elements
      e_system_status = lt_wbs_status.

  SELECT * FROM zwbs_status INTO TABLE lt_zwbs_status
                            WHERE type = lv_type.

ENDFORM.                    " GET_WBS_STATUS
*&---------------------------------------------------------------------*
*&      Form  ASSIGN_WBS_STATUS
*&---------------------------------------------------------------------*
FORM assign_wbs_status  CHANGING cs_table TYPE ts_table.

*Cases - Create or Change
  IF lv_type = 1 OR lv_type = 2.
    LOOP AT lt_wbs_status TRANSPORTING NO FIELDS
                          WHERE wbs_element   = cs_table-pspid AND
                              ( system_status = 'DLFL' OR
                                system_status = 'LKD'  OR
                                system_status = 'CLSD' ).
      EXIT.
    ENDLOOP.
    IF sy-subrc = 0.
      cs_table-status = abap_true.
    ENDIF.
*Cases - Close or Unclose
  ELSEIF lv_type = 3 OR lv_type = 4.
    IF NOT ls_prps IS INITIAL.
      CALL FUNCTION 'PS_BAPI_GET_STATUS'
        EXPORTING
          i_objnr    = ls_prps-objnr
          i_language = 'E'
        IMPORTING
          e_status   = cs_table-stat_curr.
    ENDIF.
*    READ TABLE lt_wbs_status INTO DATA(ls_wbs_status)
*                             WITH KEY wbs_element = cs_table-pspid.
*      IF sy-subrc = 0.
*        cs_table-stat_curr = ls_wbs_status-system_status.
*      ENDIF.
  ENDIF.

ENDFORM.                    " ASSIGN_WBS_STATUS
*&---------------------------------------------------------------------*
*&      Form  GET_POSITIONS
*&---------------------------------------------------------------------*
FORM get_positions CHANGING "cv_capex_approver      TYPE char10
                            cv_pm_approver      TYPE char10
                            cv_co_approver      TYPE char14
                            cv_r2r_acc_approver TYPE char10
                            cv_auto_approver    TYPE flag
                            cv_md_approver      TYPE char10
                            cv_r2r_sr_approver  TYPE char10.

  DATA:lt_users_co  TYPE STANDARD TABLE OF hrp1001-uname,
       lv_error     TYPE flag,
       lv_pbukr_pos TYPE ps_pbukr,
       lv_prctr_pos TYPE prctr,
       lv_indicator TYPE flag.

  CLEAR:ls_wf_control,cv_pm_approver,lv_prctr_pos,lv_error,
  "cv_capex_approver
        cv_pm_approver,cv_co_approver,cv_r2r_acc_approver,
        cv_auto_approver,cv_md_approver,cv_r2r_sr_approver,
        lt_users_co,lv_indicator.

*Create Case - Profit Center and Comp.Code from Header
  IF ls_head-type = 1. " Create
    lv_prctr_pos = ls_head-prctr.
    lv_pbukr_pos = ls_head-vbukr.
  ELSE.
*Others - Profit Center and Comp.Code from First Changed Line
    CASE ls_head-type.
      WHEN '2'.  " Change
        LOOP AT lt_wbs_item INTO ls_item WHERE zchange NE space.
          lv_prctr_pos = ls_item-prctr.
          lv_pbukr_pos = ls_item-pbukr.
          EXIT.
        ENDLOOP.
        IF sy-subrc <> 0.
          lv_indicator = abap_true.
        ENDIF.
      WHEN '3'. " Close
        LOOP AT lt_wbs_item INTO ls_item WHERE zclose NE space.
          lv_prctr_pos = ls_item-prctr.
          lv_pbukr_pos = ls_item-pbukr.
          EXIT.
        ENDLOOP.
        IF sy-subrc <> 0.
          lv_indicator = abap_true.
        ENDIF.
      WHEN '4'.  " UnClose
        LOOP AT lt_wbs_item INTO ls_item WHERE zunclose NE space.
          lv_prctr_pos = ls_item-prctr.
          lv_pbukr_pos = ls_item-pbukr.
          EXIT.
        ENDLOOP.
        IF sy-subrc <> 0.
          lv_indicator = abap_true.
        ENDIF.
    ENDCASE.


    IF lv_indicator = abap_true.
      lv_prctr_pos = ls_head-prctr.
      lv_pbukr_pos = ls_head-vbukr.
    ENDIF.
  ENDIF.

  PERFORM get_wf_control USING    lv_pbukr_pos
                                  lv_prctr_pos
                                  lv_maint_sys
                         CHANGING ls_wf_control.

  CHECK NOT ls_wf_control IS INITIAL.

* capex Approver
*  IF  ls_wf_control-capex_agent_type IS NOT INITIAL
*  AND ls_wf_control-capex_approver   IS NOT INITIAL.
*    CONCATENATE ls_wf_control-capex_agent_type
*                ls_wf_control-capex_approver
*                 INTO cv_capex_approver RESPECTING BLANKS.
*  ENDIF.

* PM Approver
  IF  ls_wf_control-pm_agent_type IS NOT INITIAL
  AND ls_wf_control-pm_approver   IS NOT INITIAL.
    CONCATENATE ls_wf_control-pm_agent_type
                ls_wf_control-pm_approver
                 INTO cv_pm_approver RESPECTING BLANKS.
  ENDIF.

* Controlling Approver
  IF  ls_wf_control-co_agent_type IS NOT INITIAL
  AND ls_wf_control-co_approver   IS NOT INITIAL.
    zcl_cmd_customer=>get_user_details(
         EXPORTING iv_agent_type  = ls_wf_control-co_agent_type
                   iv_approver    = ls_wf_control-co_approver
                   iv_single_user = ls_wf_control-co_single_user
                   iv_title       =
                   'Please choose a Controlling Approver'
         IMPORTING ev_approver    = cv_co_approver
                   ev_error       = lv_error
                   et_users       = lt_users_co ).
  ENDIF.

* R2R Accounting Approver
  IF  ls_wf_control-r2r_acc_agent_type IS NOT INITIAL
  AND ls_wf_control-r2r_acc_approver   IS NOT INITIAL.
    CONCATENATE ls_wf_control-r2r_acc_agent_type
                ls_wf_control-r2r_acc_approver
                 INTO cv_r2r_acc_approver
                    RESPECTING BLANKS.
  ENDIF.

* Auto Approver
  cv_auto_approver = ls_wf_control-auto_approver.

* MD Approver
  IF  ls_wf_control-md_agent_type IS NOT INITIAL
  AND ls_wf_control-md_approver   IS NOT INITIAL.
    CONCATENATE ls_wf_control-md_agent_type
                ls_wf_control-md_approver INTO cv_md_approver
                   RESPECTING BLANKS.
  ENDIF.

* R2R SR Approver
  IF  ls_wf_control-r2r_sr_agent_type IS NOT INITIAL
  AND ls_wf_control-r2r_sr_agent_type   IS NOT INITIAL.
    CONCATENATE ls_wf_control-r2r_sr_agent_type
                ls_wf_control-r2r_sr_approver INTO cv_r2r_sr_approver
                 RESPECTING BLANKS.
  ENDIF.

ENDFORM.                    " GET_POSITIONS
*&---------------------------------------------------------------------*
*&      Form  FILL_CONTAINER_ELEMENTS
*&---------------------------------------------------------------------*
FORM fill_container_elements  USING
"pv_capex_approver      TYPE char10
                                       pv_pm_approver      TYPE char10
                                       pv_co_approver      TYPE char14
                                       pv_r2r_acc_approver TYPE char10
                                       pv_auto_approver    TYPE flag
                                       pv_md_approver      TYPE char10
                                       pv_r2r_sr_approver  TYPE char10
                              CHANGING ct_input_container TYPE STANDARD
                              TABLE.

  DATA:ls_input_container TYPE swr_cont.

*  ls_input_container-element = 'IVCAPEXAPPROVER' .
*  ls_input_container-value   =  pv_capex_approver.
*  APPEND ls_input_container TO ct_input_container.

  ls_input_container-element = 'IVPMAPPROVER' .
  ls_input_container-value   =  pv_pm_approver.
  APPEND ls_input_container TO ct_input_container.

  ls_input_container-element = 'IVCOAPPROVER' .
  ls_input_container-value   =  pv_co_approver.
  APPEND ls_input_container TO ct_input_container.

  ls_input_container-element = 'IVR2RACCAPPROVER' .
  ls_input_container-value   =  pv_r2r_acc_approver.
  APPEND ls_input_container TO ct_input_container.

  ls_input_container-element = 'IVAUTOAPPROVER'.
  ls_input_container-value   =  pv_auto_approver.
  APPEND ls_input_container TO ct_input_container.

  ls_input_container-element = 'IVMDAPPROVER'.
  ls_input_container-value   =  pv_md_approver.
  APPEND ls_input_container TO ct_input_container.

  ls_input_container-element = 'IVR2RSRAPPROVER'.
  ls_input_container-value   =  pv_r2r_sr_approver.
  APPEND ls_input_container TO ct_input_container.

*  IF lv_proj3 IS NOT INITIAL.
  IF lv_proj_type = 'TC'.
    ls_input_container-element = 'IV_CAPEX'.
    ls_input_container-value   = 'X'.
    APPEND ls_input_container TO ct_input_container.
  ENDIF.

ENDFORM.                    " FILL_CONTAINER_ELEMENTS
*&---------------------------------------------------------------------*
*&      Form  GET_WF_CONTROL
*&---------------------------------------------------------------------*
FORM get_wf_control USING    iv_bukrs      TYPE ps_pbukr
                             iv_prctr      TYPE prctr
                             iv_maint_sys  TYPE zmaint_sys
                    CHANGING cs_wf_control TYPE zwbs_wf_control.

  SELECT SINGLE * FROM zwbs_wf_control INTO cs_wf_control
                  WHERE proj_type  EQ zwbs_header-proj_type AND
                        vbukr      EQ iv_bukrs              AND
                        prctr      EQ iv_prctr              AND
                        zmaint_sys EQ iv_maint_sys          AND
                        type       EQ lv_type.
  CHECK sy-subrc <> 0.
  SELECT SINGLE * FROM zwbs_wf_control INTO cs_wf_control
                  WHERE proj_type  EQ zwbs_header-proj_type AND
                        vbukr      EQ iv_bukrs              AND
                        prctr      EQ '*'                   AND
                        zmaint_sys EQ iv_maint_sys          AND
                        type       EQ lv_type.
  CHECK sy-subrc <> 0.
  SELECT SINGLE * FROM zwbs_wf_control INTO cs_wf_control
                  WHERE proj_type  EQ zwbs_header-proj_type AND
                        vbukr      EQ iv_bukrs              AND
                        prctr      EQ iv_prctr              AND
                        type       EQ lv_type.
  CHECK sy-subrc <> 0.
  SELECT SINGLE * FROM zwbs_wf_control INTO cs_wf_control
                  WHERE proj_type  EQ zwbs_header-proj_type AND
                        vbukr      EQ iv_bukrs              AND
                        prctr      EQ '*'                   AND
                        type       EQ lv_type.

ENDFORM.                    " GET_WF_CONTROL
*&---------------------------------------------------------------------*
*&      Form  WBS_REQUEST_STATUS_CHANGE
*&---------------------------------------------------------------------*
FORM wbs_request_status_change.

  CLEAR lt_return.
  CLEAR:lt_wbs_stat,ls_wbs_stat,lt_ret,ls_ret,ls_table.

**WBS Status
  LOOP AT lt_wbs_item INTO ls_item WHERE ( zclose   EQ abap_true   OR
                                           zunclose EQ abap_true ) AND
                                           accept   EQ 'X'         AND
                                           zstatus  NE space.
*    PERFORM set_status USING    ls_item-pspid
*                                ls_item-zstatus
*                       CHANGING lt_treturn.
*    APPEND LINES OF lt_treturn TO lt_return.
    ls_wbs_stat-wbs_element       = ls_item-pspid.
    ls_wbs_stat-set_system_status = ls_item-zstatus.
    IF lv_type = 4.
      READ TABLE lt_table INTO ls_table WITH KEY pspid = ls_item-pspid.
      ls_wbs_stat-undo_system_status = ls_table-stat_curr.
    ENDIF.
    APPEND ls_wbs_stat TO lt_wbs_stat.
    CLEAR ls_wbs_stat.
  ENDLOOP.
*--------------------------------------------------------------------*
  CHECK NOT lt_wbs_stat IS INITIAL.

  CALL FUNCTION 'BAPI_PS_INITIALIZATION'.

*  ls_wbs_stat-wbs_element       = iv_pspid.
*  ls_wbs_stat-set_system_status = iv_status.
*  IF lv_type = 4.
*    READ TABLE lt_table INTO ls_table WITH KEY pspid = iv_pspid.
*    ls_wbs_stat-undo_system_status = ls_table-stat_curr.
*  ENDIF.
*  APPEND ls_wbs_stat TO lt_wbs_stat.
*  CLEAR ls_wbs_stat.
  CLEAR:ls_return,ls_ret.
  CALL FUNCTION 'BAPI_BUS2054_SET_STATUS'
    IMPORTING
      return              = ls_ret
    TABLES
      i_wbs_system_status = lt_wbs_stat.
  IF NOT ls_ret IS INITIAL.
    MOVE-CORRESPONDING ls_ret TO ls_return.
    APPEND ls_return TO lt_return.
  ENDIF.

*  CHECK ct_return IS INITIAL.

  CLEAR lt_ret.
  CALL FUNCTION 'BAPI_PS_PRECOMMIT'
    TABLES
      et_return = lt_ret.

  LOOP AT lt_ret TRANSPORTING NO FIELDS WHERE type CA 'EA'.
    EXIT.
  ENDLOOP.
  IF sy-subrc <> 0.
    CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
      EXPORTING
        wait = 'X'.
  ELSE.
    CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'
      IMPORTING
        return = ls_return.
    lt_return = lt_ret.
  ENDIF.
*--------------------------------------------------------------------*

  LOOP AT lt_return TRANSPORTING NO FIELDS WHERE type CA 'EA'.
* Auto Approver Step specific
    IF gv_auto_approver_step = abap_true.
      gv_auto_approver_step_error = abap_true.
      EXPORT gv_auto_approver_step_error = gv_auto_approver_step_error
           TO MEMORY ID 'ZWBS_AUTO_APPROVER_STEP_ERROR'.
    ENDIF.

    lv_error = 'X'.
    DELETE lt_return WHERE type NA 'EA'. "Delete all other information
    EXIT.
  ENDLOOP.
  IF sy-subrc <> 0.
    CLEAR lt_return.
  ENDIF.

* Message Pop-up need not be shown in Auto approver Step as it is
* background step
  IF NOT lt_return IS INITIAL AND gv_auto_approver_step = abap_false.
    CALL FUNCTION 'FINB_BAPIRET2_DISPLAY'
      EXPORTING
        it_message = lt_return.
  ENDIF.

ENDFORM.                    " WBS_REQUEST_STATUS_CHANGE
*&---------------------------------------------------------------------*
*&      Form  SET_STATUS
*&---------------------------------------------------------------------*
FORM set_status USING     iv_pspid  TYPE ps_pspid
                          iv_status TYPE bapi_set_system_status
                 CHANGING ct_return TYPE STANDARD TABLE.

  CLEAR:ct_return,lt_wbs_stat,ls_wbs_stat,lt_ret,ls_ret,ls_table.

  CALL FUNCTION 'BAPI_PS_INITIALIZATION'.

  ls_wbs_stat-wbs_element       = iv_pspid.
  ls_wbs_stat-set_system_status = iv_status.
  IF lv_type = 4.
    READ TABLE lt_table INTO ls_table WITH KEY pspid = iv_pspid.
    ls_wbs_stat-undo_system_status = ls_table-stat_curr.
  ENDIF.
  APPEND ls_wbs_stat TO lt_wbs_stat.
  CLEAR ls_wbs_stat.
  CLEAR:ls_return,ls_ret.
  CALL FUNCTION 'BAPI_BUS2054_SET_STATUS'
    IMPORTING
      return              = ls_ret
    TABLES
      i_wbs_system_status = lt_wbs_stat.
  IF NOT ls_ret IS INITIAL.
    MOVE-CORRESPONDING ls_ret TO ls_return.
    APPEND ls_return TO ct_return.
  ENDIF.

*  CHECK ct_return IS INITIAL.

  CLEAR lt_ret.
  CALL FUNCTION 'BAPI_PS_PRECOMMIT'
    TABLES
      et_return = lt_ret.

  LOOP AT lt_ret TRANSPORTING NO FIELDS WHERE type CA 'EA'.
    EXIT.
  ENDLOOP.
  IF sy-subrc <> 0.
    CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
      EXPORTING
        wait = 'X'.
  ELSE.
    CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'
      IMPORTING
        return = ls_return.
    ct_return = lt_ret.
  ENDIF.

ENDFORM.                    " SET_STATUS
*&---------------------------------------------------------------------*
*&      Form  BUILD_VALID_WF_PARAMS
*&---------------------------------------------------------------------*
FORM build_valid_wf_params  CHANGING cv_bukrs_valid
                                     cv_prctr_valid.

  DATA:ls_table_valid  TYPE ts_table,
       lv_header_param TYPE flag.
*Others - Profit Center and Comp.Code from First Changed Line
  CLEAR:ls_table_valid, cv_prctr_valid, cv_bukrs_valid,
        lv_header_param.

  CASE lv_type.
    WHEN '2'. " Modify
      LOOP AT lt_table INTO ls_table_valid WHERE zchange NE space.
        cv_prctr_valid = ls_table_valid-prctr.
        cv_bukrs_valid = ls_table_valid-pbukr.
        EXIT.
      ENDLOOP.
      IF sy-subrc <> 0.
        lv_header_param = abap_true.
      ENDIF.
    WHEN '3'. " Close
      LOOP AT lt_table INTO ls_table_valid WHERE zclose NE space.
        cv_prctr_valid = ls_table_valid-prctr.
        cv_bukrs_valid = ls_table_valid-pbukr.
        EXIT.
      ENDLOOP.
      IF sy-subrc <> 0.
        lv_header_param = abap_true.
      ENDIF.
    WHEN '4'.  " UnClose
      LOOP AT lt_table INTO ls_table_valid WHERE zunclose NE space.
        cv_prctr_valid = ls_table_valid-prctr.
        cv_bukrs_valid = ls_table_valid-pbukr.
        EXIT.
      ENDLOOP.
      IF sy-subrc <> 0.
        lv_header_param = abap_true.
      ENDIF.
  ENDCASE.

  IF lv_header_param = abap_true.
*If no item lines are changed (likes changes only on the header area and
* techincally CV_HEADER_PARAM = 'X' means no item lines are changed )
* then pick up the very first line to define the WF Path
    READ TABLE lt_table INTO ls_table_valid INDEX 1.
    IF sy-subrc = 0.
      cv_prctr_valid = ls_table_valid-prctr.
      cv_bukrs_valid = ls_table_valid-pbukr.
    ENDIF.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  ALV_STATUS
*&---------------------------------------------------------------------*
*       use own status for the ALV to include the "REFRESH" button
*----------------------------------------------------------------------*
*      --> RT_EXTAB   Excluded functions
*----------------------------------------------------------------------*
FORM alv_status USING rt_extab TYPE slis_t_extab.           "#EC CALLED

  DELETE rt_extab WHERE fcode = '&REFRESH'.
  SET PF-STATUS 'ALV_STATUS_ENH' OF PROGRAM 'SAPMZWBS' EXCLUDING
  rt_extab.
ENDFORM.                    "alv_status
*&--------------------------------------------------------------------*
*&      Form  SHOW_LOG
*&--------------------------------------------------------------------*
FORM show_log.

  IF NOT gt_log IS INITIAL.
    CALL SCREEN '0800' STARTING AT 5 3.
    CLEAR ok_code.
  ELSE.
    MESSAGE s324(00).
  ENDIF.

ENDFORM.                    " SHOW_LOG
*&--------------------------------------------------------------------*
*&      Form  CREATE_LOG_EDITOR
*&--------------------------------------------------------------------*
FORM create_log_editor .

  IF lo_clog IS INITIAL.
    CREATE OBJECT lo_clog
      EXPORTING
        repid                      = sy-repid
        dynnr                      = sy-dynnr
        dynpro_container           = 'CLOG'
        wordwrap_mode              = 2
        wordwrap_position          = 72
        wordwrap_to_linebreak_mode = 1.
  ENDIF.

  CALL METHOD lo_clog->set_text_as_r3table
    EXPORTING
      table = gt_log.

*--- statusbar in text-control
  CALL METHOD lo_clog->set_statusbar_mode
    EXPORTING
      statusbar_mode = lc_true.

*--- Toolbar in text-control
  CALL METHOD lo_clog->set_toolbar_mode
    EXPORTING
      toolbar_mode = lc_true.

*Set Visibility for Log
  CALL METHOD lo_clog->set_readonly_mode
    EXPORTING
      readonly_mode          = lc_true
    EXCEPTIONS
      error_cntl_call_method = 1
      invalid_parameter      = 2
      OTHERS                 = 3.
  IF sy-subrc <> 0.
  ENDIF.

  CALL METHOD lo_clog->flush.

ENDFORM.                    " CREATE_LOG_EDITOR
*&---------------------------------------------------------------------*
*&      Form  CUSTOM_FIELDS_MANDATORY_CHECK
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_ZWBS_HEADER_PROJ_TYPE  text
*      -->P_LS_TABLE_PBUKR  text
*      -->P_LS_TABLE_PRCTR  text
*      -->P_4219   text
*      <--P_LV_CF_CONTROL  text
*----------------------------------------------------------------------*
FORM custom_fields_mandatory_check  USING pv_proj_type
                                          pv_pbukr
                                          pv_prctr
                                          pv_fname
                                CHANGING cv_cf_control TYPE flag.

  CLEAR:ls_cf_control, cv_cf_control.
  SELECT SINGLE * FROM zwbs_cf_control INTO ls_cf_control
                                       WHERE proj_type = pv_proj_type
                                       AND   bukrs     = pv_pbukr
                                       AND   prctr     = pv_prctr
                                       AND   fieldname = pv_fname.
  IF sy-subrc <> 0.
    SELECT SINGLE * FROM zwbs_cf_control INTO ls_cf_control
                                      WHERE proj_type = pv_proj_type
                                      AND   bukrs     = '*'
                                      AND   prctr     = pv_prctr
                                      AND   fieldname = pv_fname.
    IF sy-subrc <> 0.
      SELECT SINGLE * FROM zwbs_cf_control INTO ls_cf_control
                                      WHERE proj_type = pv_proj_type
                                      AND   bukrs     = pv_pbukr
                                      AND   prctr     = '*'
                                      AND   fieldname = pv_fname.
      IF sy-subrc <> 0.
        SELECT SINGLE * FROM zwbs_cf_control INTO ls_cf_control
                                             WHERE proj_type =
                                             pv_proj_type
                                             AND   bukrs     = '*'
                                             AND   prctr     = '*'
                                       AND   fieldname = pv_fname.
      ENDIF.
    ENDIF.
  ENDIF.

  IF NOT ls_cf_control IS INITIAL.
    CASE ls_table-stufe.
      WHEN 2.
        IF NOT ls_cf_control-level2 IS INITIAL.
          cv_cf_control = abap_true.
        ENDIF.
      WHEN 3.
        IF NOT ls_cf_control-level3 IS INITIAL.
          cv_cf_control = abap_true.
        ENDIF.
      WHEN 4.
        IF NOT ls_cf_control-level4 IS INITIAL.
          cv_cf_control = abap_true.
        ENDIF.
      WHEN 5.
        IF NOT ls_cf_control-level5 IS INITIAL.
          cv_cf_control = abap_true.
        ENDIF.
      WHEN 6.
        IF NOT ls_cf_control-level6 IS INITIAL.
          cv_cf_control = abap_true.
        ENDIF.
    ENDCASE.
  ENDIF.
ENDFORM.
*&--------------------------------------------------------------------*
*&      Form  GET_LOG_TEXT
*&--------------------------------------------------------------------*
FORM get_log_text USING pv_tdname TYPE tdobname.

  SELECT SINGLE * FROM stxh INTO ls_stxh
                  WHERE tdobject = lc_object AND
                        tdname   = pv_tdname AND
                        tdid     = lc_log_id AND
                        tdspras  = lc_spras.

  CHECK sy-subrc = 0.

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      client                  = sy-mandt
      id                      = ls_stxh-tdid
      language                = ls_stxh-tdspras
      name                    = ls_stxh-tdname
      object                  = ls_stxh-tdobject
    IMPORTING
      header                  = ls_header
    TABLES
      lines                   = lt_lines
    EXCEPTIONS
      id                      = 1
      language                = 2
      name                    = 3
      not_found               = 4
      object                  = 5
      reference_check         = 6
      wrong_access_to_archive = 7
      OTHERS                  = 8.
  IF sy-subrc <> 0.
  ENDIF.

ENDFORM.                    " GET_LOG_TEXT
*&--------------------------------------------------------------------*
*&      Form  REGISTER_LOG
*&--------------------------------------------------------------------*
FORM register_log.

  CHECK ls_head-type = 2. "ONLY for Change Project/WBS

  DATA:lt_d021t TYPE STANDARD TABLE OF d021t,
       lt_dd03l TYPE STANDARD TABLE OF dd03l,
       lv_field TYPE feldname,
       lv_pspid TYPE ps_pspid.

  DATA: lv_char_fs1 TYPE char40,
        lv_char_fs2 TYPE char40.

  FIELD-SYMBOLS:<fs1> TYPE any,
                <fs2> TYPE any.

*Header Changes
  CLEAR:lt_d021t,lt_dd03l,lt_log,lt_tlog.
*Field Names for Change Log
  SELECT * FROM d021t INTO TABLE lt_d021t WHERE prog = sy-repid AND
                                                dynr = '0400'   AND
                                                lang = lc_spras.
  SELECT * FROM dd03l INTO TABLE lt_dd03l
                      WHERE tabname = 'ZWBS_HEADER'
                      ORDER BY position.

  DO.
    ASSIGN COMPONENT sy-index OF STRUCTURE ls_head TO <fs1>.
    IF sy-subrc NE 0. "No more component
      EXIT.
    ENDIF.

    READ TABLE lt_dd03l INTO DATA(ls_dd03l) WITH KEY position = sy-index
    .
    CHECK ls_dd03l-fieldname = 'WERKS'   OR
          ls_dd03l-fieldname = 'POST1'   OR
          ls_dd03l-fieldname = 'VGSBR'   OR
*          ls_dd03l-fieldname = 'ZPRGMAN' OR
          ls_dd03l-fieldname = 'PLSEZ'   OR
          ls_dd03l-fieldname = 'PRCTR'   OR
          ls_dd03l-fieldname = 'IZWEK'   OR
          ls_dd03l-fieldname = 'VERNR'.

    ASSIGN COMPONENT sy-index OF STRUCTURE ls_head_db TO <fs2>.
    IF ls_dd03l-fieldname EQ 'PRCTR'.
      SHIFT <fs1> LEFT DELETING LEADING '0'.
      SHIFT <fs2> LEFT DELETING LEADING '0'.
    ENDIF.
    IF <fs1> NE <fs2>.
      CONCATENATE 'ZWBS_HEADER-' ls_dd03l-fieldname INTO lv_field.
      READ TABLE lt_d021t INTO DATA(ls_d021t) WITH KEY fldn = lv_field.
      IF sy-subrc = 0 OR lv_field = 'ZWBS_HEADER-IZWEK' OR
                         lv_field = 'ZWBS_HEADER-VERNR'.
*OLD Value
        CASE lv_field.
          WHEN 'ZWBS_HEADER-IZWEK'.
            ls_d021t-dtxt = 'Investment Reason'.
          WHEN 'ZWBS_HEADER-VERNR'.
            ls_d021t-dtxt = 'Person Responsible'.
          WHEN OTHERS.
        ENDCASE.
        CONCATENATE ls_d021t-dtxt '-' 'Old value:' <fs2>
                             INTO ls_log-text
                             SEPARATED BY space.
        APPEND ls_log TO lt_tlog.
        CLEAR ls_log.
*OLD Value
        CONCATENATE ls_d021t-dtxt '-' 'New value:' <fs1>
                             INTO ls_log-text
                             SEPARATED BY space.
        APPEND ls_log TO lt_tlog.
        CLEAR ls_log.
      ENDIF.
    ENDIF.
  ENDDO.
  IF NOT lt_tlog IS INITIAL.
*Convert to External Format for User Readability
    CLEAR lv_pspid.
    CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
      EXPORTING
        input  = ls_head-pspid
      IMPORTING
        output = lv_pspid.
    CONCATENATE 'Project:' lv_pspid INTO ls_log-text
                                     SEPARATED BY space.
    INSERT ls_log INTO lt_tlog INDEX 1.
    APPEND LINES OF lt_tlog TO lt_log.
    APPEND INITIAL LINE TO lt_log.
    CLEAR ls_log.
  ENDIF.
  UNASSIGN:<fs1>,<fs2>.

*Item Changes
  CLEAR:lt_d021t,lt_dd03l,lt_tlog.
  DATA: lv_dynr TYPE d021t-dynr.
*Field Names for Change Log
*  IF lv_proj3 IS NOT INITIAL OR
  IF lv_proj_type = 'TC' OR
     gv_capex IS NOT INITIAL.
    lv_dynr = '0900'.
  ELSE.
    lv_dynr = '0500'.
  ENDIF.

  IF lv_dynr = '0500'.
    SELECT * FROM d021t INTO TABLE lt_d021t WHERE prog = sy-repid AND
                                                 dynr = lv_dynr   AND
                                                 lang = lc_spras.
    SELECT * FROM dd03l INTO TABLE lt_dd03l
                        WHERE tabname = 'ZWBS_ITEM'
                        ORDER BY position.

    LOOP AT lt_wbs_item INTO ls_item WHERE zchange EQ 'U'.
      CLEAR:ls_item_db,ls_table_init,lt_tlog.
      READ TABLE lt_table_init INTO ls_table_init
                               WITH KEY pspid   = ls_item-pspid.
      CHECK sy-subrc = 0.
      MOVE-CORRESPONDING ls_table_init TO ls_item_db.
      DO.
        ASSIGN COMPONENT sy-index OF STRUCTURE ls_item TO <fs1>.
        IF sy-subrc NE 0. " no more component
          EXIT.
        ENDIF.

        READ TABLE lt_dd03l INTO ls_dd03l WITH KEY position = sy-index.
        CHECK ls_dd03l-fieldname NE 'MANDT'         AND
              ls_dd03l-fieldname NE 'PSPID_NEW'     AND
              ls_dd03l-fieldname NE 'REQUEST'       AND
              ls_dd03l-fieldname NE 'ZCHANGE'       AND
              ls_dd03l-fieldname NE 'CREATED_BY'    AND
              ls_dd03l-fieldname NE 'CREATED_ON'    AND
              ls_dd03l-fieldname NE 'CREATION_TIME' AND
              ls_dd03l-fieldname NE 'CHANGED_BY'    AND
              ls_dd03l-fieldname NE 'CHANGED_ON'    AND
              ls_dd03l-fieldname NE 'CHANGE_TIME'.

        ASSIGN COMPONENT sy-index OF STRUCTURE ls_item_db TO <fs2>.
        IF <fs1> NE <fs2>.
          CONCATENATE 'LS_TABLE-' ls_dd03l-fieldname INTO lv_field.
          READ TABLE lt_d021t INTO ls_d021t WITH KEY fldn = lv_field.
          IF sy-subrc = 0.
*OLD Value
            CONCATENATE ls_d021t-dtxt '-' 'Old value:' <fs2>
                                 INTO ls_log-text
                                 SEPARATED BY space.
            APPEND ls_log TO lt_tlog.
            CLEAR ls_log.
*OLD Value
            CONCATENATE ls_d021t-dtxt '-' 'New value:' <fs1>
                                 INTO ls_log-text
                                 SEPARATED BY space.
            APPEND ls_log TO lt_tlog.
            CLEAR ls_log.
          ENDIF.
        ENDIF.
      ENDDO.

      IF NOT lt_tlog IS INITIAL.
*Convert to External Format for User Readability
        CLEAR lv_pspid.
        CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
          EXPORTING
            input  = ls_item-pspid
          IMPORTING
            output = lv_pspid.
        CONCATENATE 'WBS:' lv_pspid INTO ls_log-text
                                         SEPARATED BY space.
        INSERT ls_log INTO lt_tlog INDEX 1.
        APPEND LINES OF lt_tlog TO lt_log.
        APPEND INITIAL LINE TO lt_log.
        CLEAR ls_log.
      ENDIF.
      UNASSIGN:<fs1>,<fs2>.
    ENDLOOP.

  ELSE.
    DATA: gt_field_container TYPE dyfatc_tab.
    CALL FUNCTION 'RPY_DYNPRO_READ'
      EXPORTING
        progname             = sy-repid
        dynnr                = '0900'
      TABLES
        fields_to_containers = gt_field_container.
    IF sy-subrc <> 0.
* Implement suitable error handling here
    ENDIF.

*    SELECT * FROM d021t INTO TABLE lt_d021t WHERE prog = sy-repid AND
*dynr = lv_dynr   AND
*                                                      lang = lc_spras.
    SELECT * FROM dd03l INTO TABLE lt_dd03l
                        WHERE tabname = 'ZWBS_ITEM'
                        ORDER BY position.

    LOOP AT lt_wbs_item INTO ls_item WHERE zchange EQ 'U'.
      CLEAR:ls_item_db,ls_table_init,lt_tlog.
      READ TABLE lt_table_init INTO ls_table_init
                             WITH KEY pspid   = ls_item-pspid.
      CHECK sy-subrc = 0.
      MOVE-CORRESPONDING ls_table_init TO ls_item_db.
      DO.
        ASSIGN COMPONENT sy-index OF STRUCTURE ls_item TO <fs1>.
        IF sy-subrc NE 0. " no more component
          EXIT.
        ENDIF.

        READ TABLE lt_dd03l INTO ls_dd03l WITH KEY position = sy-index.
        CHECK ls_dd03l-fieldname NE 'MANDT'         AND
              ls_dd03l-fieldname NE 'PSPID_NEW'     AND
              ls_dd03l-fieldname NE 'REQUEST'       AND
              ls_dd03l-fieldname NE 'ZCHANGE'       AND
              ls_dd03l-fieldname NE 'CREATED_BY'    AND
              ls_dd03l-fieldname NE 'CREATED_ON'    AND
              ls_dd03l-fieldname NE 'CREATION_TIME' AND
              ls_dd03l-fieldname NE 'CHANGED_BY'    AND
              ls_dd03l-fieldname NE 'CHANGED_ON'    AND
              ls_dd03l-fieldname NE 'CHANGE_TIME'   AND
              ls_dd03l-fieldname NE 'ASTNR_N'       AND
              ls_dd03l-fieldname NE 'VERNR_N'.
        IF ls_dd03l-fieldname = 'BUDGET'.
          IF ls_item_db-budget IS INITIAL.
            SELECT SINGLE waers INTO @DATA(lv_waers) FROM t001
              WHERE bukrs = @ls_item-pbukr.
            IF sy-subrc = 0.
              SELECT SINGLE lednr INTO @DATA(lv_lednr) FROM tbp0l
                WHERE waers = @lv_waers.
              IF sy-subrc = 0.
                SELECT SINGLE objnr INTO @DATA(lv_objnr) FROM prps
                  WHERE posid = @ls_item-pspid_new.
                IF sy-subrc = 0.
                  SELECT SINGLE wlp00
                      FROM rpsco
                      INTO @DATA(lv_budget)
                      WHERE objnr = @lv_objnr
                      AND   lednr = @lv_lednr
                      AND   wrttp = '45'.
                ENDIF.
              ENDIF.
              CLEAR: lv_lednr,lv_waers,lv_objnr.
            ENDIF.

          ELSE.
            lv_budget = ls_item_db-budget.
          ENDIF.
          ASSIGN lv_budget TO <fs2>.
*          CLEAR: lv_budget.
        ELSE.
          ASSIGN COMPONENT sy-index OF STRUCTURE ls_item_db TO <fs2>.
        ENDIF.
        IF ls_dd03l-fieldname EQ 'PRCTR' OR
          ls_dd03l-fieldname EQ 'POSID'.
          SHIFT <fs1> LEFT DELETING LEADING '0'.
        ENDIF.
        IF ls_dd03l-fieldname EQ 'PRCTR' OR
          ls_dd03l-fieldname EQ 'POSID'.
          SHIFT <fs2> LEFT DELETING LEADING '0'.
*        ELSEIF ls_dd03l-fieldname EQ 'ASTNR'.
*          SELECT SINGLE * FROM pa0105 INTO @DATA(ls_pa0105)
*             WHERE usrid = @<fs2>.
*          IF sy-subrc = 0.
*            CLEAR: <fs2>.
*            MOVE ls_pa0105-usrid TO <fs2>.
*          ENDIF.
*        ELSEIF ls_dd03l-fieldname EQ 'VERNR'.
*          SELECT SINGLE * FROM tcj04 INTO @DATA(ls_tcj04)
*                   WHERE s_usrnam = @<fs2>.
*          IF sy-subrc = 0.
*            CLEAR: <fs2>.
*            MOVE ls_tcj04-s_usrnam TO <fs2>.
*          ENDIF.
        ENDIF.
        IF <fs1> NE <fs2>.
          CONCATENATE 'ZWBS_ITEM-' ls_dd03l-fieldname INTO lv_field.
          READ TABLE gt_field_container INTO DATA(ls_fld_cont)
          WITH KEY cont_type = 'TABLE_CTRL'
                   cont_name = 'TC_CAPEX'
                   type      = 'TEXT'
                   name      = lv_field.
*          READ TABLE lt_d021t INTO ls_d021t WITH KEY fldn = lv_field.
          IF sy-subrc = 0.
*OLD Value
            MOVE <fs2> TO lv_char_fs2.
            CONCATENATE ls_fld_cont-text '-' 'Old value:' lv_char_fs2
            "<fs2>
                                 INTO ls_log-text
                                 SEPARATED BY space.
            APPEND ls_log TO lt_tlog.
            CLEAR ls_log.
*New Value
            MOVE <fs1> TO lv_char_fs1.
            CONCATENATE ls_fld_cont-text '-' 'New value:' lv_char_fs1
            "<fs1>
                                 INTO ls_log-text
                                 SEPARATED BY space.
            APPEND ls_log TO lt_tlog.
            CLEAR ls_log.
          ENDIF.
        ENDIF.
      ENDDO.

      IF NOT lt_tlog IS INITIAL.
*Convert to External Format for User Readability
        CLEAR lv_pspid.
        CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
          EXPORTING
            input  = ls_item-pspid
          IMPORTING
            output = lv_pspid.
        CONCATENATE 'WBS:' lv_pspid INTO ls_log-text
                                         SEPARATED BY space.
        INSERT ls_log INTO lt_tlog INDEX 1.
        APPEND LINES OF lt_tlog TO lt_log.
        APPEND INITIAL LINE TO lt_log.
        CLEAR ls_log.
      ENDIF.
      UNASSIGN:<fs1>,<fs2>.
    ENDLOOP.
  ENDIF.

*Add timestamp to Log Table
  IF NOT lt_log IS INITIAL.
    CALL FUNCTION 'TEXT_CREATE_HISTORY_LINE'
      IMPORTING
        history_line = ls_log-text.
    IF ls_log-text+0(1) = '*'.
      CLEAR ls_log-text+0(1).
      CONDENSE ls_log-text.
    ENDIF.
    INSERT ls_log INTO lt_log INDEX 1.
    APPEND INITIAL LINE TO gt_log.
    APPEND LINES OF lt_log TO gt_log.

    CLEAR:lv_tdname,ls_header,lt_lines.
*Log
    lv_tdname = zwbs_header-request.
    CALL FUNCTION 'INIT_TEXT'
      EXPORTING
        id       = lc_log_id
        language = lc_spras
        name     = lv_tdname
        object   = lc_object
      IMPORTING
        header   = ls_header
      TABLES
        lines    = lt_lines
      EXCEPTIONS
        id       = 1
        language = 2
        name     = 3
        object   = 4
        OTHERS   = 5.
    IF sy-subrc <> 0.
      EXIT.
    ENDIF.

    IF NOT gt_log IS INITIAL.
      lt_lines = CORRESPONDING #( gt_log MAPPING tdline = text ).
      CALL FUNCTION 'SAVE_TEXT'
        EXPORTING
          client   = sy-mandt
          header   = ls_header
        TABLES
          lines    = lt_lines
        EXCEPTIONS
          id       = 1
          language = 2
          name     = 3
          object   = 4
          OTHERS   = 5.
      IF sy-subrc <> 0.
      ENDIF.
    ENDIF.
  ENDIF.

ENDFORM.                    " REGISTER_LOG
*&---------------------------------------------------------------------*
*&      Form  SETTLEMENT_RULE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM settlement_rule .

  DATA: ls_option   TYPE ctu_params,
        lt_bdcdata  TYPE STANDARD TABLE OF bdcdata,
        ls_messages TYPE bdcmsgcoll,
        lt_messages TYPE STANDARD TABLE OF bdcmsgcoll.


  DATA: lv_perbz TYPE perbz.
  DATA: ls_cobrb     TYPE cobrb,
        lt_cobrb     TYPE TABLE OF cobrb,
        lv_pspid     TYPE ps_pspid,
        lv_pspnr     TYPE ps_posnr,
        lt_table1    TYPE TABLE OF string,
        lv_wbs       TYPE dkobr-empge,
        lv_tabix_sr  TYPE char2,
        lv_tabix_sr2 TYPE char2,
        lv_tabix_sr1 TYPE char2,
        lv_name_sr   TYPE char40,
        lv_pre       TYPE perbz_ld.

  CLEAR: ls_option.
  ls_option-dismode = 'N'.
  ls_option-updmode = 'A'.
  ls_option-defsize = 'X'.

  CLEAR: ls_item.
  READ TABLE lt_wbs_item INTO ls_item INDEX 1.

  PERFORM bdc_dynpro      USING 'SAPLCJWB' '0100' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_CURSOR'
                                '*PROJ-PSPID' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_OKCODE'
                                '=LETB' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING '*PROJ-PSPID'
                                ls_item-pspid_new CHANGING lt_bdcdata.
  PERFORM bdc_field       USING '*PRPS-POSID'
                              ' ' CHANGING lt_bdcdata.

  CLEAR: ls_item.
*LOOP AT lt_table ASSIGNING FIELD-SYMBOL(<fs_table_sr>)." WHERE stufe >
*'2'.
  LOOP AT lt_wbs_item ASSIGNING FIELD-SYMBOL(<fs_table_sr>).
    " WHERE stufe > '2'.


*    CLEAR lv_tabix_sr.
    IF sy-tabix > 13.
      lv_tabix_sr = sy-tabix - lv_tabix_sr2.
    ELSE.
      lv_tabix_sr = sy-tabix.
    ENDIF.

    IF <fs_table_sr>-stufe LE '2'.
      CONTINUE.
    ENDIF.

    CLEAR: lv_pspid.
    CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
      EXPORTING
        input  = <fs_table_sr>-pspid_new
      IMPORTING
        output = lv_pspid.

    SPLIT lv_pspid AT '.' INTO TABLE lt_table1.
    DESCRIBE TABLE lt_table1 LINES DATA(lv_lines).
    DELETE lt_table1  INDEX lv_lines.
    lv_lines = lv_lines - 1.
    "SORT lt_table1 DESCENDING.
    CLEAR: lv_wbs.
    LOOP AT lt_table1 INTO DATA(ls_table1).
      CONCATENATE  lv_wbs ls_table1 INTO lv_wbs SEPARATED BY '.' .
    ENDLOOP.

    CLEAR:lv_wbs+0(1).
    CONDENSE lv_wbs.


    PERFORM bdc_dynpro      USING 'SAPLCJWB' '0901' CHANGING lt_bdcdata.

    IF lv_tabix_sr > 13.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '/00' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=P+' CHANGING lt_bdcdata.
*PERFORM bdc_dynpro      USING 'SAPLCJWB' '0901' CHANGING lt_bdcdata.
*      PERFORM bdc_field       USING 'BDC_OKCODE'
*                              '=MRKL' CHANGING lt_bdcdata.

      lv_tabix_sr = 1.
      lv_tabix_sr2 = 13.
      PERFORM bdc_dynpro      USING 'SAPLCJWB' '0901' CHANGING
      lt_bdcdata.
    ENDIF.

    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=ABRV' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'PROJ-POST1'
                                  zwbs_header-post1 CHANGING lt_bdcdata.
    CLEAR: lv_name_sr.
    CONCATENATE 'RCWBT-UNTRG(' lv_tabix_sr ')' INTO lv_name_sr.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                              lv_name_sr CHANGING lt_bdcdata.

    CLEAR: lv_name_sr.
    CONCATENATE 'RCJ_MARKL-MARK(' lv_tabix_sr ')' INTO lv_name_sr.
    PERFORM bdc_field       USING lv_name_sr 'X'
                                   CHANGING lt_bdcdata.

    PERFORM bdc_dynpro      USING 'SAPLKOBS' '0130' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'DKOBR-EMPGE(01)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '/00' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'COBRB-KONTY(01)'
                                  'WBS' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'DKOBR-EMPGE(01)'
                                  lv_wbs CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLKOBS' '0130' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'COBRB-KONTY(02)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '/00' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'COBRB-KONTY(02)'
                                  'WBS' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'DKOBR-EMPGE(02)'
                                  lv_wbs CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLKOBS' '0130' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'COBRB-PERBZ(01)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '/00' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'COBRB-PERBZ(01)'
                                  'FUL' CHANGING lt_bdcdata.  "lv_pre
    PERFORM bdc_dynpro      USING 'SAPLKOBS' '0130' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'COBRB-PERBZ(02)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '/00' CHANGING lt_bdcdata.
    IF <fs_table_sr>-imprf IS INITIAL.
      lv_pre = 'PER'.
    ELSE.
      lv_pre = 'PRE'.
    ENDIF.
    PERFORM bdc_field       USING 'COBRB-PERBZ(02)'
                                  lv_pre CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLKOBS' '0130' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'COBRB-KONTY(01)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=BACK' CHANGING lt_bdcdata.

    PERFORM bdc_dynpro      USING 'SAPLCJWB' '0901' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                              '=MRKL' CHANGING lt_bdcdata.
  ENDLOOP.

  PERFORM bdc_dynpro      USING 'SAPLCJWB' '0901' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_OKCODE'
                                '=BU' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'PROJ-POST1'
                                zwbs_header-post1 CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_CURSOR'
                                'RCWBT-UNTRG(02)' CHANGING lt_bdcdata.

  CALL TRANSACTION 'CJ02' USING       lt_bdcdata
                                       OPTIONS FROM ls_option
                                       MESSAGES INTO lt_messages.
  CALL METHOD zcl_sleep=>seconds
    EXPORTING
      iv_second = 1.
*  READ TABLE lt_messages INTO ls_messages WITH KEY msgtyp = 'E'.
  LOOP AT lt_messages TRANSPORTING NO FIELDS WHERE msgtyp CA 'EA'.
    lv_error = 'X'.
    EXIT.
  ENDLOOP.

  IF lv_error = 'X'.
** approval log
    gv_error_email = 'X'.
    gs_appr_log-text = 'Settlement Rule Creation not Successfull'.
    APPEND gs_appr_log TO gt_appr_log.
    CLEAR: gs_appr_log.
  ELSE.
** approval log
    gs_appr_log-text = 'Settlement Rule Created Successfully'.
    APPEND gs_appr_log TO gt_appr_log.
    CLEAR: gs_appr_log.
  ENDIF.
  CLEAR: lv_error.

  IF sy-subrc = 0.
*    gv_error_sr = 'X'.
    PERFORM investment_program.
    "PERFORM budget.
  ELSE.
    PERFORM investment_program.
    "PERFORM budget.
  ENDIF.

***BDC For Settlement RUle.

*    CLEAR: lv_pspid.
*    CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
*      EXPORTING
*        input  = <fs_table_sr>-pspid_new
*      IMPORTING
*        output = lv_pspid.
*    CLEAR: lv_pspnr.
*    CALL FUNCTION 'CONVERSION_EXIT_ABPSP_OUTPUT'
*      EXPORTING
*        input  = <fs_table_sr>-pspid_new
*      IMPORTING
*        output = lv_pspnr.

*    SELECT SINGLE *
*    FROM prps
*    INTO @DATA(ls_prps)
*    WHERE posid EQ @<fs_table_sr>-pspid_new. " @lv_pspnr.
*    IF sy-subrc = 0.
*      CLEAR:ls_cobrb.
*      DO 2 TIMES.
*        CLEAR: lv_perbz.
*        IF sy-index = 1.
*          lv_perbz = 'PER'.
*        ELSEIF sy-index = 2.
*          lv_perbz = 'FUL'.
*        ENDIF.
*
*        ls_cobrb-objnr      = ls_prps-objnr.
*        ADD 1 TO ls_cobrb-lfdnr.
*
****    USE THE CONVERSION EXITS !!!
*        CALL FUNCTION 'CONVERSION_EXIT_PERBZ_INPUT'
*          EXPORTING
*            input  = lv_perbz
*          IMPORTING
*            output = ls_cobrb-perbz.
*
*        CALL FUNCTION 'CONVERSION_EXIT_OBART_INPUT'
*          EXPORTING
*            input     = 'WBS'
*          IMPORTING
*            output    = ls_cobrb-konty
*          EXCEPTIONS
*            not_found = 1
*            OTHERS    = 2.
*
*        IF sy-subrc NE 0.
*
*        ENDIF.
*
*        ls_cobrb-prozs      = '100.00'.
*        ls_cobrb-kokrs      = ls_prps-pkokr.
*        ls_cobrb-bukrs      = ls_prps-pbukr.
*        ls_cobrb-ps_psp_pnr = ls_prps-pspnr.
*        ls_cobrb-rec_objnr1 = ls_prps-objnr.
*
*        APPEND ls_cobrb TO lt_cobrb.
*      ENDDO.
*      CLEAR:ls_prps.
*    ENDIF.


***Create Settlement Rule.
*  CALL FUNCTION 'K_SRULE_SAVE_UTASK'
*    TABLES
*      t_cobrb_insert    = lt_cobrb
*    EXCEPTIONS
*      srule_utask_error = 1
*      OTHERS            = 2.
*
*  IF sy-subrc NE 0.
*    "Implement suitable error handling here
*    ELSE.
*      COMMIT WORK.
*  ENDIF.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  BUDGET
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM budget.

  DATA: lt_bapiret    TYPE TABLE OF bapiret2,
        lt_bpak       TYPE TABLE OF bpak,
        lt_bpak_cj40  TYPE TABLE OF bpak,
        ls_bpak_cj40  TYPE  bpak,
        ls_bpak       TYPE bpak,
        ls_bapiret    TYPE bapiret2,
        lv_flag_error TYPE oax.

  DATA: ls_option   TYPE ctu_params,
        lt_bdcdata  TYPE STANDARD TABLE OF bdcdata,
        ls_messages TYPE bdcmsgcoll,
        lt_messages TYPE STANDARD TABLE OF bdcmsgcoll.
  DATA: lv_budget TYPE char20.

  DATA: lv_name TYPE char40.
  DATA: ls_bp       TYPE zwbs_item,
        lv_tabix    TYPE char2,
        lv_tabix_bp TYPE char2.

  lt_table_bp = lt_wbs_item.
  SORT lt_table_bp BY stufe DESCENDING.
  READ TABLE lt_table_bp INTO ls_bp INDEX 1.

  SELECT * FROM prps INTO TABLE @DATA(lt_prps_bp)
     FOR ALL ENTRIES IN @lt_wbs_item
     WHERE posid = @lt_wbs_item-pspid_new.
  IF lt_prps_bp IS NOT INITIAL.
    SELECT * FROM prhi INTO TABLE @DATA(lt_prhi)
     FOR ALL ENTRIES IN @lt_prps_bp
     WHERE psphi = @lt_prps_bp-psphi
       AND down  = @space.
  ENDIF.

  IF zwbs_header-pwhie = 'JPY' OR
     zwbs_header-pwhie = 'IDR'.

    REFRESH: lt_bdcdata, lt_messages.
    CLEAR: ls_option.
    ls_option-dismode = 'N'.
    ls_option-updmode = 'A'.
    ls_option-defsize = 'X'.
*    IF sy-uname = 'ELIATSOPOU'.
*      ls_option-dismode = 'A'.
*    ENDIF.


    LOOP AT lt_wbs_item INTO ls_table_bp." WHERE stufe = ls_bp-stufe.
      READ TABLE lt_prps_bp INTO DATA(ls_prps_bp) WITH KEY posid = ls_table_bp-pspid_new.
      IF sy-subrc = 0.
        READ TABLE lt_prhi INTO DATA(ls_prhi) WITH KEY posnr = ls_prps_bp-pspnr.
        IF sy-subrc NE 0.
          CONTINUE.
        ENDIF.
      ENDIF.

      REFRESH lt_bdcdata.

      PERFORM bdc_dynpro      USING 'SAPMKBUD' '0200' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'PRPS-POSID' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=EINK' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'PROJ-PSPID'
                                    ' ' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'PRPS-POSID'
                                    ls_table_bp-pspid_new CHANGING
                                    lt_bdcdata.
      PERFORM bdc_field       USING 'BPDY-VERSN'
                                    '0' CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLKBPP' '0320' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'BPDY-WERT1(01)' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '/00' CHANGING lt_bdcdata.
      lv_budget = ls_table_bp-budget.
      SPLIT lv_budget AT '.' INTO DATA(lv_value) DATA(lv_dec).
      PERFORM bdc_field       USING 'BPDY-WERT1(01)'
                                     lv_value CHANGING
                                     lt_bdcdata.
      CLEAR: lv_value, lv_dec.
      PERFORM bdc_dynpro      USING 'SAPLKBPP' '0320' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'BPDY-WERT1(01)' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=SAVE' CHANGING lt_bdcdata.
      CALL TRANSACTION 'CJ40' USING       lt_bdcdata
                                         OPTIONS FROM ls_option
                                         MESSAGES INTO lt_messages.
    ENDLOOP.

    CLEAR: ls_item.
    READ TABLE lt_wbs_item INTO ls_item INDEX 1.

    REFRESH: lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPMKBUD' '0200' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'PROJ-PSPID' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '/00' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'PROJ-PSPID'
                                  ls_item-pspid_new CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'PRPS-POSID'
                                ' ' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BPDY-VERSN'
                                  '0' CHANGING lt_bdcdata.

    PERFORM bdc_dynpro      USING 'SAPLKBPP' '0320' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'BPDY-WERT1(01)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                '=MRKA' CHANGING lt_bdcdata.

    PERFORM bdc_dynpro      USING 'SAPLKBPP' '0320' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                               'BPDY-WERT1(01)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=SYNC' CHANGING lt_bdcdata.

    PERFORM bdc_dynpro      USING 'SAPLKBPP' '0705' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'BPDY-JAHR_VON' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=ENTE' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BPDY-JAHR_VON'
                                  '2019' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BPDY-JAHR_BIS'
                                  '2027' CHANGING lt_bdcdata.
*  PERFORM bdc_field       USING 'BPDY-TI_GES_1'
*                                'X' CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLKBPP' '0320' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'BPDY-WERT1(01)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=SAVE' CHANGING lt_bdcdata.
    CALL TRANSACTION 'CJ40' USING       lt_bdcdata
                                         OPTIONS FROM ls_option
                                         MESSAGES INTO lt_messages.
    CALL METHOD zcl_sleep=>seconds
      EXPORTING
        iv_second = 1.
    LOOP AT lt_messages INTO DATA(ls_mes_cj40) WHERE msgtyp CA 'EA'.
      gv_error_email = 'X'.
      gs_appr_log-text = ls_mes_cj40-msgv1.  "'Budget in CJ40 Creation not Successfull'.
      APPEND gs_appr_log TO gt_appr_log.
      CLEAR: gs_appr_log.
      EXIT.
    ENDLOOP.

    IF sy-subrc NE 0.
      "approval log
      gs_appr_log-text = 'Budget in CJ40 Created Successfully'.
      APPEND gs_appr_log TO gt_appr_log.
      CLEAR: gs_appr_log.
      PERFORM original_budget.
*    ELSE.
*      " approval log
**      gv_error_email = 'X'.
*      gs_appr_log-text = 'Budget in CJ40 Creation not Successfull'.
*      APPEND gs_appr_log TO gt_appr_log.
*      CLEAR: gs_appr_log.
    ENDIF.
  ELSE.
    CLEAR:ls_table_bp.
    LOOP AT lt_wbs_item INTO ls_table_bp WHERE stufe = ls_bp-stufe.
      CLEAR: ls_prps_bp.
      READ TABLE lt_prps_bp INTO ls_prps_bp WITH KEY posid = ls_table_bp-pspid_new.
      IF sy-subrc = 0.
        CLEAR: ls_prhi.
        READ TABLE lt_prhi INTO ls_prhi WITH KEY posnr = ls_prps_bp-pspnr.
        IF sy-subrc NE 0.
          CONTINUE.
        ENDIF.
        ls_bpak-e_objnr = ls_prps_bp-objnr.
        ls_bpak-e_ges   = 'X'.
        ls_bpak-wert    = ls_table_bp-budget.
        ls_bpak-twaer   = ls_prps_bp-pwpos.
*      ls_bpak-e_versn = 0.
        APPEND ls_bpak TO lt_bpak.
        CLEAR: ls_bpak.
      ENDIF.
    ENDLOOP.
    IF lt_bpak IS NOT INITIAL.
      DATA(lt_bpak_cj30) = lt_bpak.
      DATA(lt_bpak_cj32) = lt_bpak.

      LOOP AT lt_bpak INTO ls_bpak.
        MOVE-CORRESPONDING ls_bpak TO ls_bpak_cj40.
        ls_bpak_cj40-e_versn = '000'.
        APPEND ls_bpak_cj40 TO lt_bpak_cj40.
        CLEAR: ls_bpak_cj40.
      ENDLOOP.

      CALL FUNCTION 'KBPP_EXTERN_UPDATE_CO'
        EXPORTING
          i_budget_activity = 'KSTP'
*         I_BUDGET_ACTIV_SUP_RET              = ' '
*         I_BUDGET_DISTRIBUTION_ALLOWED       = ' '
*         I_COMMIT_DATA     = ' '
          i_delta_amounts   = 'X'
          i_rollup_data     = 'X'
          i_check_plan_data = 'X'
          i_application     = 'P'
          i_commit_all      = 'X'
        IMPORTING
          e_errors_found    = lv_flag_error
        TABLES
          it_bpak           = lt_bpak_cj40
          it_return         = lt_bapiret
        EXCEPTIONS
          no_update         = 1
          OTHERS            = 2.
      IF lt_bapiret IS INITIAL AND lv_flag_error IS INITIAL.
** approval log
        gs_appr_log-text = 'Budget in CJ40 Created Successfully'.
        APPEND gs_appr_log TO gt_appr_log.
        CLEAR: gs_appr_log.
        CALL FUNCTION 'KBPP_EXTERN_UPDATE_CO'
          EXPORTING
            i_budget_activity = 'KBUD'
*           I_BUDGET_ACTIV_SUP_RET              = ' '
*           I_BUDGET_DISTRIBUTION_ALLOWED       = ' '
*           I_COMMIT_DATA     = ' '
            i_delta_amounts   = 'X'
            i_rollup_data     = 'X'
            i_check_plan_data = 'X'
            i_application     = 'P'
            i_commit_all      = 'X'
          IMPORTING
            e_errors_found    = lv_flag_error
          TABLES
            it_bpak           = lt_bpak_cj30
            it_return         = lt_bapiret
          EXCEPTIONS
            no_update         = 1
            OTHERS            = 2.

        IF lt_bapiret IS INITIAL AND lv_flag_error IS INITIAL.
          " approval log
          gs_appr_log-text = 'Budget in CJ30 Created Successfully'.
          APPEND gs_appr_log TO gt_appr_log.
          CLEAR: gs_appr_log.
          CALL FUNCTION 'KBPP_EXTERN_UPDATE_CO'
            EXPORTING
              i_budget_activity = 'KBFR'
*             I_BUDGET_ACTIV_SUP_RET              = ' '
*             I_BUDGET_DISTRIBUTION_ALLOWED       = ' '
*             I_COMMIT_DATA     = ' '
              i_delta_amounts   = 'X'
              i_rollup_data     = 'X'
              i_check_plan_data = 'X'
              i_application     = 'P'
              i_commit_all      = 'X'
            IMPORTING
              e_errors_found    = lv_flag_error
            TABLES
              it_bpak           = lt_bpak_cj32
              it_return         = lt_bapiret
            EXCEPTIONS
              no_update         = 1
              OTHERS            = 2.
          IF lt_bapiret IS INITIAL AND lv_flag_error IS INITIAL.
            "approval log
            gs_appr_log-text = 'Budget in CJ32 Created Successfully'.
            APPEND gs_appr_log TO gt_appr_log.
            CLEAR: gs_appr_log.
          ELSE.
** approval log
            CLEAR: ls_bapiret.
            LOOP AT lt_bapiret INTO ls_bapiret.
              gv_error_email = 'X'.
              gs_appr_log-text = ls_bapiret-message. "'Budget in CJ32 Creation not Successfull'.
              APPEND gs_appr_log TO gt_appr_log.
              CLEAR: gs_appr_log.
            ENDLOOP.
          ENDIF.
        ELSE.
** approval log
          CLEAR: ls_bapiret.
          LOOP AT lt_bapiret INTO ls_bapiret.
            gv_error_email = 'X'.
            gs_appr_log-text = ls_bapiret-message. "'Budget in CJ30 Creation not Successfull'.
            APPEND gs_appr_log TO gt_appr_log.
            CLEAR: gs_appr_log.
          ENDLOOP.
        ENDIF.
      ELSE.
** approval log
        CLEAR: ls_bapiret.
        LOOP AT lt_bapiret INTO ls_bapiret.
          gv_error_email = 'X'.
          gs_appr_log-text = ls_bapiret-message. "'Budget in CJ40 Creation not Successfull'.
          APPEND gs_appr_log TO gt_appr_log.
          CLEAR: gs_appr_log.
        ENDLOOP.

      ENDIF.
    ENDIF.
  ENDIF.


ENDFORM.


*&---------------------------------------------------------------------*
*&      Form  ORIGINAL_BUDGET
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM original_budget .
  DATA: ls_option   TYPE ctu_params,
        lt_bdcdata  TYPE STANDARD TABLE OF bdcdata,
        ls_messages TYPE bdcmsgcoll,
        lt_messages TYPE STANDARD TABLE OF bdcmsgcoll.
  REFRESH: lt_bdcdata, lt_messages.
  CLEAR: ls_option.
  ls_option-dismode = 'N'.
  ls_option-updmode = 'A'.
  ls_option-defsize = 'X'.
*  IF sy-uname = 'ELIATSOPOU'.
*    ls_option-dismode = 'A'.
*  ENDIF.
  CLEAR: ls_item.
  READ TABLE lt_wbs_item INTO ls_item INDEX 1.


  PERFORM bdc_dynpro      USING 'SAPMKBUD' '0200' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_CURSOR'
                                'PROJ-PSPID' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_OKCODE'
                                '/00' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'PROJ-PSPID'
                                ls_item-pspid_new CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'PRPS-POSID'
                                 ' ' CHANGING lt_bdcdata.
  PERFORM bdc_dynpro      USING 'SAPLKBPP' '0320' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_CURSOR'
                                'BPDY-WERT1(01)' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_OKCODE'
                                '=MRKA' CHANGING lt_bdcdata.
  PERFORM bdc_dynpro      USING 'SAPLKBPP' '0320' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_CURSOR'
                                'BPDY-WERT1(01)' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_OKCODE'
                                '=KOPS' CHANGING lt_bdcdata.
  PERFORM bdc_dynpro      USING 'SAPLSPO5' '0130' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_OKCODE'
                                '=OK' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_CURSOR'
                                'SPOPLI-SELFLAG(05)' CHANGING lt_bdcdata
                                .
*perform bdc_field       using 'SPOPLI-SELFLAG(01)'
*                              record-SELFLAG_01_002.
  PERFORM bdc_field       USING 'SPOPLI-SELFLAG(05)'
                                 'X' CHANGING lt_bdcdata.
  PERFORM bdc_dynpro      USING 'SAPLKBPP' '0706' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_CURSOR'
                                'BPDY-COPY_PERC' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_OKCODE'
                                '=ENTE' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BPDY-COPY_PERC'
                                '100' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BPDY-COPY_REPL'
                                'X' CHANGING lt_bdcdata.
  PERFORM bdc_dynpro      USING 'SAPLKBPP' '0320' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_CURSOR'
                                'BPDY-WERT1(01)' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_OKCODE'
                                '=POST' CHANGING lt_bdcdata.
  CALL TRANSACTION 'CJ30' USING       lt_bdcdata
                                         OPTIONS FROM ls_option
                                         MESSAGES INTO lt_messages .

*  READ TABLE lt_messages INTO ls_messages WITH KEY msgtyp = 'S'.
*  CALL METHOD zcl_sleep=>seconds
*    EXPORTING
*      iv_second = 1.
  LOOP AT lt_messages TRANSPORTING NO FIELDS WHERE msgtyp CA 'EA'.
    gv_error_email = 'X'.
    EXIT.
  ENDLOOP.

  IF sy-subrc NE 0.
    "approval log
    gs_appr_log-text = 'Budget in CJ30 Created Successfully'.
    APPEND gs_appr_log TO gt_appr_log.
    CLEAR: gs_appr_log.
    PERFORM budget_release.

  ELSE.
    gv_error_email = 'X'.
    "approval log
    gs_appr_log-text = 'Budget in CJ30 Created not Successfull'.
    APPEND gs_appr_log TO gt_appr_log.
    CLEAR: gs_appr_log.
  ENDIF.
ENDFORM.


*&---------------------------------------------------------------------*
*&      Form  BUDGET_RELEASE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM budget_release .
  DATA: ls_option   TYPE ctu_params,
        lt_bdcdata  TYPE STANDARD TABLE OF bdcdata,
        ls_messages TYPE bdcmsgcoll,
        lt_messages TYPE STANDARD TABLE OF bdcmsgcoll.
  REFRESH: lt_bdcdata, lt_messages.
  CLEAR: ls_option.
  ls_option-dismode = 'N'.
  ls_option-updmode = 'A'.
  ls_option-defsize = 'X'.
*  IF sy-uname = 'ELIATSOPOU'.
*    ls_option-dismode = 'A'.
*  ENDIF.
  CLEAR: ls_item.
  READ TABLE lt_wbs_item INTO ls_item INDEX 1.


  PERFORM bdc_dynpro      USING 'SAPMKBUD' '0200' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_CURSOR'
                                'PROJ-PSPID' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_OKCODE'
                                '/00' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'PROJ-PSPID'
                                ls_item-pspid_new  CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'PRPS-POSID'
                                 ' ' CHANGING lt_bdcdata.
  PERFORM bdc_dynpro      USING 'SAPLKBPP' '0320' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_CURSOR'
                                'BPDY-WERT1(01)' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_OKCODE'
                                '=MRKA' CHANGING lt_bdcdata.
  PERFORM bdc_dynpro      USING 'SAPLKBPP' '0320' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_CURSOR'
                                'BPDY-WERT1(01)' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_OKCODE'
                                '=KOPS' CHANGING lt_bdcdata.
  PERFORM bdc_dynpro      USING 'SAPLSPO5' '0130' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_OKCODE'
                                '=OK' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_CURSOR'
                                'SPOPLI-SELFLAG(08)' CHANGING lt_bdcdata
                                .
*perform bdc_field       using 'SPOPLI-SELFLAG(01)'
*                              record-SELFLAG_01_002.
  PERFORM bdc_field       USING 'SPOPLI-SELFLAG(08)'
                                'X' CHANGING lt_bdcdata.
  PERFORM bdc_dynpro      USING 'SAPLKBPP' '0706' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_CURSOR'
                                'BPDY-COPY_PERC' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_OKCODE'
                                '=ENTE' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BPDY-COPY_PERC'
                                '100' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BPDY-COPY_REPL'
                                'X' CHANGING lt_bdcdata.
  PERFORM bdc_dynpro      USING 'SAPLKBPP' '0320' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_CURSOR'
                                'BPDY-WERT1(01)' CHANGING lt_bdcdata.
  PERFORM bdc_field       USING 'BDC_OKCODE'
                                '=POST' CHANGING lt_bdcdata.

  CALL TRANSACTION 'CJ32' USING       lt_bdcdata
                                         OPTIONS FROM ls_option
                                         MESSAGES INTO lt_messages.

*  READ TABLE lt_messages INTO ls_messages WITH KEY msgtyp = 'S'.
  LOOP AT lt_messages TRANSPORTING NO FIELDS WHERE msgtyp CA 'EA'.
    gv_error_email = 'X'.
    EXIT.
  ENDLOOP.

  IF sy-subrc NE 0.
    "approval log
    gs_appr_log-text = 'Budget in CJ32 Created Successfully'.
    APPEND gs_appr_log TO gt_appr_log.
    CLEAR: gs_appr_log.
  ELSE.
    gv_error_email = 'X'.
    "approval log
    gs_appr_log-text = 'Budget in CJ32 Creation Not Successfull'.
    APPEND gs_appr_log TO gt_appr_log.
    CLEAR: gs_appr_log.
  ENDIF.
ENDFORM.


*&---------------------------------------------------------------------*
*&      Form  INVESTMENT_PROGRAM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM investment_program .
  DATA: ls_option   TYPE ctu_params,
        lt_bdcdata  TYPE STANDARD TABLE OF bdcdata,
        ls_messages TYPE bdcmsgcoll,
        lt_messages TYPE STANDARD TABLE OF bdcmsgcoll.
  REFRESH: lt_bdcdata, lt_messages.
  CLEAR: ls_option.
  ls_option-dismode = 'N'.
  ls_option-updmode = 'A'.
  ls_option-defsize = 'X'.

  READ TABLE lt_wbs_item INTO DATA(ls_aau) INDEX 1.
  IF sy-subrc = 0.
    PERFORM bdc_dynpro      USING 'SAPLCJWB' '0100' CHANGING lt_bdcdata
    ..
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  '*PRPS-POSID' CHANGING lt_bdcdata..
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=LETB' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING '*PROJ-PSPID'
                                  ' ' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING '*PRPS-POSID'
                                  ls_aau-pspid_new CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLCJWB' '0901' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=BU' CHANGING lt_bdcdata..
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'PRPS-BELKZ(01)' CHANGING lt_bdcdata..
    PERFORM bdc_field       USING 'PRPS-BELKZ(01)'
                                  ' ' CHANGING lt_bdcdata.
    CALL TRANSACTION 'CJ02' USING   lt_bdcdata
                                        OPTIONS FROM ls_option
                                        MESSAGES INTO lt_messages.
    CALL METHOD zcl_sleep=>seconds
      EXPORTING
        iv_second = 1.
    LOOP AT lt_messages TRANSPORTING NO FIELDS WHERE msgtyp CA 'EA'.
*          lv_error = 'X'.
      EXIT.
    ENDLOOP.


  ENDIF.

  REFRESH: lt_bdcdata, lt_messages.
  CLEAR: ls_option.
  ls_option-dismode = 'N'.
  ls_option-updmode = 'A'.
  ls_option-defsize = 'X'.
  LOOP AT lt_wbs_item ASSIGNING FIELD-SYMBOL(<fs_table_ip>) WHERE posid
  IS NOT INITIAL.
    REFRESH: lt_bdcdata, lt_messages.
    PERFORM bdc_dynpro      USING 'SAPLCJWB' '0100' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  '*PRPS-POSID' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=LETB' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING '*PRPS-POSID'
                                  <fs_table_ip>-pspid_new CHANGING
                                  lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLCJWB' '0901' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=TBST' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'RCWBT-UNTRG(01)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'RCJ_MARKL-MARK(01)'
                                  'X' CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLCJWB' '0999' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=AIPP' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'PRPS-POSID' CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLAIPP' '0050' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'RAIP1-POSID' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=TAKE' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'RAIP1-PRNAM'
                                  'CA05' CHANGING lt_bdcdata.
    "    SHIFT <fs_table_ip>-posid LEFT DELETING LEADING '0'.
    PERFORM bdc_field       USING 'RAIP1-POSID'
                                  <fs_table_ip>-posid CHANGING
                                  lt_bdcdata.
    PERFORM bdc_field       USING 'RAIP1-GJAHR'
                                  '2007' CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLCJWB' '0999' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '/EBCK'CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'PRPS-POSID' CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLCJWB' '0901' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=BU' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'RCWBT-UNTRG(01)' CHANGING lt_bdcdata.
    CALL TRANSACTION 'CJ02' USING   lt_bdcdata
                                    OPTIONS FROM ls_option
                                    MESSAGES INTO lt_messages.

  ENDLOOP.
  CALL METHOD zcl_sleep=>seconds
    EXPORTING
      iv_second = 1.
  LOOP AT lt_messages TRANSPORTING NO FIELDS WHERE msgtyp CA 'EA'.
    lv_error = 'X'.
    EXIT.
  ENDLOOP.

  IF lv_error = 'X'.

** approval log
    gv_error_email = 'X'.
    gs_appr_log-text = 'Investment Program Creation not Successfull'.
    APPEND gs_appr_log TO gt_appr_log.
    CLEAR: gs_appr_log.
  ELSE.

** approval log
    gs_appr_log-text = 'Investement Program Created Successfully'.
    APPEND gs_appr_log TO gt_appr_log.
    CLEAR: gs_appr_log.
  ENDIF.
  CLEAR: lv_error.

ENDFORM.


*&---------------------------------------------------------------------*
*&      Form  BDC_DYNPRO
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_7625   text
*      -->P_7626   text
*      <--P_LT_BDCDATA  text
*----------------------------------------------------------------------*
FORM bdc_dynpro  USING    iv_program iv_dynpro
                 CHANGING ct_bdcdata TYPE bdcdata_tab.

  DATA: ls_bdcdata  TYPE bdcdata.

  CLEAR ls_bdcdata.
  ls_bdcdata-program  = iv_program.
  ls_bdcdata-dynpro   = iv_dynpro.
  ls_bdcdata-dynbegin = 'X'.
  APPEND ls_bdcdata TO ct_bdcdata.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  BDC_FIELD
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_7637   text
*      -->P_7638   text
*----------------------------------------------------------------------*
FORM bdc_field  USING   iv_fnam iv_fval
      CHANGING ct_bdcdata TYPE bdcdata_tab.
  DATA: ls_bdcdata  TYPE bdcdata.

  CLEAR ls_bdcdata.
  ls_bdcdata-fnam = iv_fnam.
  WRITE iv_fval TO ls_bdcdata-fval LEFT-JUSTIFIED.
  APPEND ls_bdcdata TO ct_bdcdata.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  APPLICANT_NUM_TO_ITEMS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM pers_resp_num_to_items .

  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = 'Person Responsible'
      text_question         = 'Do you want to update the Person Responsible for all the WBS elements?'
      text_button_1         = 'Yes'
      text_button_2         = 'No'
      default_button        = '2'
      display_cancel_button = space
    IMPORTING
      answer                = lv_ans_appl
      " to hold the FM's return value
    EXCEPTIONS
      text_not_found        = 1
      OTHERS                = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
          WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.
  IF lv_ans_appl EQ '1'.
    LOOP AT lt_table ASSIGNING FIELD-SYMBOL(<fs_table1>).
      CHECK <fs_table1>-status IS INITIAL."DO NOT Update for Inactive Lines
      zwbs_item-vernr   = <fs_table1>-vernr   = zwbs_header-vernr.
      zwbs_item-vernr_n = <fs_table1>-vernr_n = zwbs_header-vernr_n.
      IF lv_type = 2.
        <fs_table1>-zchange = 'U'.
      ENDIF.
      CALL FUNCTION 'SUSR_USER_ADDRESS_READ'
        EXPORTING
          user_name              = zwbs_header-vernr
*         READ_DB_DIRECTLY       = ' '
*         CACHE_RESULTS          = 'X'
        IMPORTING
          user_usr03             = ls_usr03  "lv_name
        EXCEPTIONS
          user_address_not_found = 1
          OTHERS                 = 2.
      IF sy-subrc = 0.
        CONCATENATE ls_usr03-name1 ls_usr03-name2
              INTO <fs_table1>-verna SEPARATED BY space.
        zwbs_item-verna = <fs_table1>-verna.
      ENDIF.
      CLEAR: ls_usr03.
    ENDLOOP.
    UNASSIGN <fs_table1>.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  PERS_RESP_NUM_TO_ITEMS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM applicant_num_to_items .

  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = 'Applicant number'
      text_question         = 'Do you want to update the Applicant number for all the WBS elements?'
      text_button_1         = 'Yes'
      text_button_2         = 'No'
      default_button        = '2'
      display_cancel_button = space
    IMPORTING
      answer                = lv_ans_pers
      " to hold the FM's return value
    EXCEPTIONS
      text_not_found        = 1
      OTHERS                = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
          WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.
  IF lv_ans_pers = 1.
    LOOP AT lt_table ASSIGNING FIELD-SYMBOL(<fs_table1>).
      CHECK <fs_table1>-status IS INITIAL."DO NOT Update for Inactive Lines
      <fs_table1>-astnr   = zwbs_header-astnr.
      <fs_table1>-astnr_n = zwbs_header-astnr_n.
      IF lv_type = 2.
        <fs_table1>-zchange = 'U'.
      ENDIF.
      CALL FUNCTION 'SUSR_USER_ADDRESS_READ'
        EXPORTING
          user_name              = zwbs_header-astnr
*         READ_DB_DIRECTLY       = ' '
*         CACHE_RESULTS          = 'X'
        IMPORTING
          user_usr03             = ls_usr03  "lv_name
        EXCEPTIONS
          user_address_not_found = 1
          OTHERS                 = 2.
      IF sy-subrc = 0.
        CONCATENATE ls_usr03-name1 ls_usr03-name2
               INTO <fs_table1>-astna SEPARATED BY space.
        zwbs_item-astna = <fs_table1>-astna.
      ENDIF.
      CLEAR: ls_usr03.
*    <fs_table1>-pgsbr = ZWBS_ITEM-pgsbr.
*    <fs_table1>-prctr = ZWBS_ITEM-prctr.
    ENDLOOP.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  BUSINESS_AREA_LINES
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM business_area_lines .
  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = 'Business Area'
      text_question         =
                              'Do you want to update the Business Area for all the WBS elements?'
      text_button_1         = 'Yes'
      text_button_2         = 'No'
      default_button        = '2'
      display_cancel_button = space
    IMPORTING
      answer                = lv_ans_buss
      " to hold the FM's return value
    EXCEPTIONS
      text_not_found        = 1
      OTHERS                = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
    WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.
  IF lv_ans_buss = 1.
    LOOP AT lt_table ASSIGNING <fs_table1>.
      <fs_table1>-pgsbr =  zwbs_item-pgsbr = zwbs_header-vgsbr.
    ENDLOOP.
  ELSE.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  FINISH_DATE_LINES
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM finish_date_lines .

  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = 'Finish Date'
      text_question         = 'Do you want to update the Finish Forecast & Actual Date for all the WBS elements?'
      text_button_1         = 'Yes'
      text_button_2         = 'No'
      default_button        = '2'
      display_cancel_button = space
    IMPORTING
      answer                = lv_ans_fini
      " to hold the FM's return value
    EXCEPTIONS
      text_not_found        = 1
      OTHERS                = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
    WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.
  IF lv_ans_fini = 1.
    LOOP AT lt_table ASSIGNING <fs_table1>.
      CHECK <fs_table1>-status IS INITIAL."DO NOT Update for Inactive Lines
      <fs_table1>-plsez = zwbs_item-plsez = zwbs_header-plsez.
      IF lv_type = 1.
        zwbs_item-eende = <fs_table1>-eende = <fs_table1>-plsez.
      ENDIF.

    ENDLOOP.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  RESPONSIBLE_PERSON
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM responsible_person .
** Validate Responsible Person.
  SELECT SINGLE * FROM tcj04 INTO @DATA(ls_tcj04)
    WHERE s_usrnam = @zwbs_header-vernr.
  IF sy-subrc = 0.
    zwbs_header-vernr_n = ls_tcj04-vernr.
    zwbs_header-vernr   = ls_tcj04-s_usrnam.
  ELSE.
    SELECT * FROM tcj04 INTO ls_tcj04 UP TO 1 ROWS
      ORDER BY vernr DESCENDING .
    ENDSELECT.
    IF sy-subrc = 0.
      ls_userid-sapname =  zwbs_header-vernr.
** get the user FUll name.
      CALL FUNCTION 'SO_USER_READ_API1'
        EXPORTING
          user            = ls_userid
*         PREPARE_FOR_FOLDER_ACCESS       = ' '
        IMPORTING
          user_data       = ls_user_data
        EXCEPTIONS
          user_not_exist  = 1
          parameter_error = 2
          x_error         = 3
          OTHERS          = 4.
      IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
      ENDIF.
      ls_tcj04-vernr    = ls_tcj04-vernr + 1.
      ls_tcj04-verna    = ls_user_data-fullname.
      ls_tcj04-s_usrnam = zwbs_header-vernr.
      MODIFY tcj04 FROM ls_tcj04.
      IF sy-subrc = 0.
        zwbs_header-vernr_n = ls_tcj04-vernr.
      ENDIF.
    ENDIF.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  APPLICANT_NUMBER
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM applicant_number .
*** Validate Applicant number.
** get the user FUll name.
  CLEAR: ls_userid, ls_user_data.
  ls_userid-sapname = zwbs_header-astnr.

  CALL FUNCTION 'SO_USER_READ_API1'
    EXPORTING
      user            = ls_userid
    IMPORTING
      user_data       = ls_user_data
    EXCEPTIONS
      user_not_exist  = 1
      parameter_error = 2
      x_error         = 3
      OTHERS          = 4.
  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  SELECT SINGLE * FROM pa0105 INTO @DATA(ls_pa0105)
    WHERE usrty = '0001'
    AND usrid = @zwbs_header-astnr.
  IF sy-subrc = 0.
    SELECT SINGLE * FROM tcj05 INTO @DATA(ls_tcj05)
     WHERE astnr = @ls_pa0105-pernr.
    IF sy-subrc = 0.
      zwbs_header-astnr_n = ls_tcj05-astnr.
      zwbs_header-astna = ls_user_data-fullname.
    ELSE.
      SELECT SINGLE * FROM pa0105 INTO ls_pa0105
          WHERE usrty = '0001'
            AND usrid = zwbs_header-astnr.
      IF sy-subrc = 0.
        "TRANSLATE ls_user_data-fullname TO UPPER CASE.
        ls_tcj05-astnr     = ls_pa0105-pernr.
        ls_tcj05-astna     = ls_user_data-fullname.
        MODIFY tcj05 FROM ls_tcj05.
        IF sy-subrc = 0.
          zwbs_header-astnr_n = ls_tcj05-astnr.
          zwbs_header-astna   = ls_tcj05-astna.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  RESPONSIBLE_PERSON_LINE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM responsible_person_line .

  CLEAR: ls_userid, ls_user_data.
  ls_userid-sapname =  zwbs_item-vernr.
** get the user FUll name.
  CALL FUNCTION 'SO_USER_READ_API1'
    EXPORTING
      user            = ls_userid
*     PREPARE_FOR_FOLDER_ACCESS       = ' '
    IMPORTING
      user_data       = ls_user_data
    EXCEPTIONS
      user_not_exist  = 1
      parameter_error = 2
      x_error         = 3
      OTHERS          = 4.
  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  SELECT SINGLE * FROM tcj04 INTO @DATA(ls_tcj04)
      WHERE s_usrnam = @zwbs_item-vernr.
  IF sy-subrc = 0.
    ls_table-vernr_n = zwbs_item-vernr_n = ls_tcj04-vernr.
    ls_table-vernr = zwbs_item-vernr   = ls_tcj04-s_usrnam.
    ls_table-verna = zwbs_item-verna   = ls_user_data-fullname.
  ELSE.
    SELECT * FROM tcj04 INTO ls_tcj04 UP TO 1 ROWS
      ORDER BY vernr DESCENDING .
    ENDSELECT.
    IF sy-subrc = 0.
      ls_tcj04-vernr    = ls_tcj04-vernr + 1.
      ls_tcj04-verna    = ls_user_data-fullname.
      ls_tcj04-s_usrnam = zwbs_item-vernr.
      MODIFY tcj04 FROM ls_tcj04.
      IF sy-subrc = 0.
        ls_table-vernr_n = zwbs_item-vernr_n = ls_tcj04-vernr.
        ls_table-verna   = zwbs_item-verna   = ls_tcj04-verna.
        ls_table-vernr   = zwbs_item-vernr.
      ENDIF.
    ENDIF.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  APPLICANT_NUMBER_LINE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM applicant_number_line .
*** Validate Applicant number.
** get the user FUll name.
  CLEAR: ls_userid, ls_user_data.
  ls_userid-sapname = zwbs_item-astnr.

  CALL FUNCTION 'SO_USER_READ_API1'
    EXPORTING
      user            = ls_userid
    IMPORTING
      user_data       = ls_user_data
    EXCEPTIONS
      user_not_exist  = 1
      parameter_error = 2
      x_error         = 3
      OTHERS          = 4.
  IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  SELECT SINGLE * FROM pa0105 INTO @DATA(ls_pa0105)
    WHERE usrty = '0001'
    AND usrid = @zwbs_item-astnr.
  IF sy-subrc = 0.
    SELECT SINGLE * FROM tcj05 INTO @DATA(ls_tcj05)
     WHERE astnr = @ls_pa0105-pernr.
    IF sy-subrc = 0.
      ls_table-astnr = zwbs_item-astnr.
      ls_table-astnr_n = zwbs_item-astnr_n = ls_tcj05-astnr.
      ls_table-astna   = zwbs_item-astna = ls_user_data-fullname.
    ELSE.
      SELECT SINGLE * FROM pa0105 INTO ls_pa0105
          WHERE usrty = '0001'
            AND usrid = zwbs_item-astnr.
      IF sy-subrc = 0.
        "TRANSLATE ls_user_data-fullname TO UPPER CASE.
        ls_tcj05-astnr     = ls_pa0105-pernr.
        ls_tcj05-astna     = ls_user_data-fullname.
        MODIFY tcj05 FROM ls_tcj05.
        IF sy-subrc = 0.
          ls_table-astnr_n  = zwbs_item-astnr_n = ls_tcj05-astnr.
          ls_table-astna    = zwbs_item-astna   = ls_tcj05-astna.
          ls_table-astnr    = zwbs_item-astnr.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CUSTOM_FIELDS_MAND_CHECK_CAPEX
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_5027   text
*      <--P_LV_CF_CONTROL_CAPEX  text
*----------------------------------------------------------------------*
FORM custom_fields_mand_check_capex  USING    VALUE(p_5027)
                                     CHANGING p_lv_cf_control_capex.

  DATA: lv_change TYPE char10.
  IF lv_type = 1.
    lv_change = 'CREATE'.
  ELSE.
    lv_change = 'CHANGE'.
  ENDIF.

  SELECT SINGLE * FROM zwbs_cf_ctrl_tc
                  INTO @DATA(ls_cf_ctrl_tc)
                  WHERE fieldname = @p_5027
                  AND   levels    = @ls_table-stufe
                  AND   izwek     = @ls_table-izwek
                  AND   bukrs     = @ls_table-pbukr
                  AND   crt_chg   = @lv_change.
  IF sy-subrc NE 0.
*    IF ls_cf_ctrl_tc-mandatory_flag IS NOT INITIAL.
*      ls_screen-required = 1.
*    ENDIF.
*
*    IF ls_cf_ctrl_tc-editable_flag IS NOT INITIAL.
*      ls_screen-input = 1.
*    ENDIF.
*  ELSE.
    SELECT SINGLE * FROM zwbs_cf_ctrl_tc
              INTO @ls_cf_ctrl_tc
              WHERE fieldname = @p_5027
              AND   levels    = '*' "@space
              AND   izwek     = @ls_table-izwek
              AND   bukrs     = @ls_table-pbukr
              AND   crt_chg   = @lv_change.
    IF sy-subrc NE 0.
      SELECT SINGLE * FROM zwbs_cf_ctrl_tc
                    INTO @ls_cf_ctrl_tc
                    WHERE fieldname = @p_5027
                    AND   levels    = @ls_table-stufe
                    AND   izwek     = '*' "@space
                    AND   bukrs     = @ls_table-pbukr
                    AND   crt_chg   = @lv_change.
      IF sy-subrc NE 0.
        SELECT SINGLE * FROM zwbs_cf_ctrl_tc
                   INTO @ls_cf_ctrl_tc
                   WHERE fieldname = @p_5027
                   AND   levels    = @ls_table-stufe
                   AND   izwek     = @ls_table-izwek
                   AND   bukrs     = '*' "@space
                   AND   crt_chg   = @lv_change.
        IF sy-subrc NE 0.
          SELECT SINGLE * FROM zwbs_cf_ctrl_tc
                    INTO @ls_cf_ctrl_tc
                     WHERE fieldname = @p_5027
                     AND   levels    = '*' "@space
                     AND   izwek     = '*' "@space
                     AND   bukrs     = '*' "@space
                     AND   crt_chg   = @lv_change.
          IF sy-subrc NE 0.
            SELECT SINGLE * FROM zwbs_cf_ctrl_tc
                      INTO @ls_cf_ctrl_tc
                       WHERE fieldname = @p_5027
                       AND   levels    = '*' "@space
                       AND   izwek     = '*' "@space
                       AND   bukrs     = @ls_table-pbukr
                       AND   crt_chg   = @lv_change.
            IF sy-subrc NE 0.
              SELECT SINGLE * FROM zwbs_cf_ctrl_tc
                        INTO @ls_cf_ctrl_tc
                         WHERE fieldname = @p_5027
                         AND   levels    = @ls_table-stufe
                         AND   izwek     = '*' "@space
                         AND   bukrs     = '*' "@space
                         AND   crt_chg   = @lv_change.

              IF sy-subrc NE 0.
                SELECT SINGLE * FROM zwbs_cf_ctrl_tc
                          INTO @ls_cf_ctrl_tc
                           WHERE fieldname = @p_5027
                         AND   levels    = @ls_table-stufe
                         AND   izwek     = '*' "@space
                         AND   bukrs     = @ls_table-pbukr
                         AND   crt_chg   = @lv_change.
                IF sy-subrc NE 0.
                  SELECT SINGLE * FROM zwbs_cf_ctrl_tc
                          INTO @ls_cf_ctrl_tc
                           WHERE fieldname = @p_5027
                  AND   levels    = '*' "@ls_table-stufe
                  AND   izwek     =  @ls_table-izwek
                  AND   bukrs     = '*' "@ls_table-pbukr
                  AND   crt_chg   = @lv_change.
                ENDIF.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.
  IF ls_cf_ctrl_tc IS NOT INITIAL.
    IF ls_cf_ctrl_tc-mandatory_flag IS NOT INITIAL.
      lv_cf_control_capex = 'X'.
    ENDIF.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SETTLEMENT_RULE_CHANGE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM settlement_rule_change .
  DATA: ls_option   TYPE ctu_params,
        lt_bdcdata  TYPE STANDARD TABLE OF bdcdata,
        ls_messages TYPE bdcmsgcoll,
        lt_messages TYPE STANDARD TABLE OF bdcmsgcoll.


  DATA: lv_perbz TYPE perbz.
  DATA: ls_cobrb     TYPE cobrb,
        lt_cobrb     TYPE TABLE OF cobrb,
        lv_pspid     TYPE ps_pspid,
        lv_pspnr     TYPE ps_posnr,
        lt_table1    TYPE TABLE OF string,
        lv_wbs       TYPE dkobr-empge,
        lv_tabix_sr  TYPE char2,
        lv_tabix_sr2 TYPE char2,
        lv_tabix_sr1 TYPE char2,
        lv_name_sr   TYPE char40,
        lv_pre       TYPE perbz_ld.

  CLEAR: ls_option.
  ls_option-dismode = 'N'.
  ls_option-updmode = 'A'.
  ls_option-defsize = 'X'.


  LOOP AT lt_wbs_item ASSIGNING FIELD-SYMBOL(<fs_table_sr>)
    WHERE stufe > '2' AND zchange = 'I'.

    CLEAR: lv_pspid.
    CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
      EXPORTING
        input  = <fs_table_sr>-pspid_new
      IMPORTING
        output = lv_pspid.

    SPLIT lv_pspid AT '.' INTO TABLE lt_table1.
    DESCRIBE TABLE lt_table1 LINES DATA(lv_lines).
    DELETE lt_table1  INDEX lv_lines.
    lv_lines = lv_lines - 1.
    "SORT lt_table1 DESCENDING.
    CLEAR: lv_wbs.
    LOOP AT lt_table1 INTO DATA(ls_table1).
      CONCATENATE  lv_wbs ls_table1 INTO lv_wbs SEPARATED BY '.' .
    ENDLOOP.

    CLEAR:lv_wbs+0(1).
    CONDENSE lv_wbs.

    REFRESH: lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLCJWB' '0100'  CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  '*PRPS-POSID' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=LETB' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING '*PROJ-PSPID'
                                  ' ' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING '*PRPS-POSID'
                                  <fs_table_sr>-pspid_new CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLCJWB' '0901' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=ABRV' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'PRPS-STUFE(01)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'RCJ_MARKL-MARK(01)'
                                  'X' CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLKOBS' '0130' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'DKOBR-EMPGE(01)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '/00' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'COBRB-KONTY(01)'
                                  'WBS' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'DKOBR-EMPGE(01)'
                                  lv_wbs CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLKOBS' '0130' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'COBRB-PERBZ(01)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '/00' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'COBRB-PERBZ(01)'
                                  'FUL' CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLKOBS' '0130' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'DKOBR-EMPGE(02)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '/00' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'COBRB-KONTY(02)'
                                  'WBS' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'DKOBR-EMPGE(02)'
                                  lv_wbs CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLKOBS' '0130' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'COBRB-PERBZ(02)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '/00' CHANGING lt_bdcdata.
    IF <fs_table_sr>-imprf IS INITIAL.
      lv_pre = 'PER'.
    ELSE.
      lv_pre = 'PRE'.
    ENDIF.
    PERFORM bdc_field       USING 'COBRB-PERBZ(02)'
                                  lv_pre CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLKOBS' '0130' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'COBRB-KONTY(01)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '/00' CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLKOBS' '0130' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'COBRB-KONTY(01)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=BACK' CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLCJWB' '0901' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=BU' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'PRPS-STUFE(01)' CHANGING lt_bdcdata.
    CALL TRANSACTION 'CJ02' USING       lt_bdcdata
                                         OPTIONS FROM ls_option
                                         MESSAGES INTO lt_messages.
  ENDLOOP.
  CALL METHOD zcl_sleep=>seconds
    EXPORTING
      iv_second = 1.

  LOOP AT lt_messages TRANSPORTING NO FIELDS WHERE msgtyp CA 'EA'.
    lv_error = 'X'.
    EXIT.
  ENDLOOP.
  IF lv_error = 'X'.
** approval log
    gv_error_email = 'X'.
    gs_appr_log-text = 'Settlement Rule updation not Successfull'.
    APPEND gs_appr_log TO gt_appr_log.
    CLEAR: gs_appr_log.
  ELSE.
** approval log
    gs_appr_log-text = 'Settlement Rule updated Successfully'.
    APPEND gs_appr_log TO gt_appr_log.
    CLEAR: gs_appr_log.
  ENDIF.
  CLEAR: lv_error.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  FCODE_TOTAL_UP
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_TC_NAME  text
*      -->P_P_TABLE_NAME  text
*      -->P_P_MARK_NAME  text
*----------------------------------------------------------------------*
FORM fcode_total_up."  USING    p_tc_name TYPE dynfnam
  "p_table_name
  "p_mark_name.

  DATA: lt_table5 TYPE STANDARD TABLE OF ts_table,
        lt_table4 TYPE STANDARD TABLE OF ts_table,
        lt_table3 TYPE STANDARD TABLE OF ts_table,
        lt_table2 TYPE STANDARD TABLE OF ts_table,
        lt_table1 TYPE STANDARD TABLE OF ts_table,
        lv_sum4   TYPE zwbs_item-budget,
        lv_sum3   TYPE zwbs_item-budget,
        lv_sum2   TYPE zwbs_item-budget,
        lv_sum1   TYPE zwbs_item-budget,
        lv_index4 TYPE sy-index,
        lv_index3 TYPE sy-index,
        lv_index2 TYPE sy-index,
        lv_index1 TYPE sy-index.
  DATA: lv_pspid_len5 TYPE numc2.
  DATA: lv_pspid_len4 TYPE numc2.
  DATA: lv_pspid_len3 TYPE numc2.
  DATA: lv_pspid_len2 TYPE numc2.
  DATA: lv_pspid_len1 TYPE numc2.


  LOOP AT lt_table ASSIGNING FIELD-SYMBOL(<wa>).
    IF <wa>-stufe = '5'.
*      lv_pspid_len5 = strlen( <wa>-pspid_new ).
      APPEND <wa> TO lt_table5.
    ELSEIF <wa>-stufe = '4'.
      APPEND <wa> TO lt_table4.
      DATA(lv_pspid_new4) = <wa>-pspid.
      CALL FUNCTION 'FTR_CORR_SWIFT_DELETE_ENDZERO'
        CHANGING
          c_value = lv_pspid_new4.
      lv_pspid_len4 = strlen( lv_pspid_new4 ).
    ELSEIF <wa>-stufe = '3'.
      APPEND <wa> TO lt_table3.
      DATA(lv_pspid_new3) = <wa>-pspid.
      CALL FUNCTION 'FTR_CORR_SWIFT_DELETE_ENDZERO'
        CHANGING
          c_value = lv_pspid_new3.
      lv_pspid_len3 = strlen( lv_pspid_new3 ).
    ELSEIF <wa>-stufe = '2'.
      APPEND <wa> TO lt_table2.
      DATA(lv_pspid_new2) = <wa>-pspid.
      CALL FUNCTION 'FTR_CORR_SWIFT_DELETE_ENDZERO'
        CHANGING
          c_value = lv_pspid_new2.
      lv_pspid_len2 = strlen( lv_pspid_new2 ).
    ELSEIF <wa>-stufe = '1'.
      APPEND <wa> TO lt_table1.
      DATA(lv_pspid_new1) = <wa>-pspid.
      CALL FUNCTION 'FTR_CORR_SWIFT_DELETE_ENDZERO'
        CHANGING
          c_value = lv_pspid_new1.
      lv_pspid_len1 = strlen( lv_pspid_new1 ).
    ENDIF.
  ENDLOOP.

* Build the Total for Level4.
  LOOP AT lt_table ASSIGNING FIELD-SYMBOL(<wa4>) WHERE stufe = '4'.
    LOOP AT lt_table5 ASSIGNING FIELD-SYMBOL(<wa5>).
      IF <wa5>-pspid+0(lv_pspid_len4) = <wa4>-pspid+0(lv_pspid_len4).
        lv_sum4 = lv_sum4 + <wa5>-budget.
      ENDIF.
    ENDLOOP.
    IF lv_sum4 IS NOT INITIAL.
      <wa4>-budget = lv_sum4.
    ENDIF.
    lv_index4 = lv_index4 + 1.
    MODIFY lt_table FROM <wa4> TRANSPORTING budget.
    MODIFY lt_table4 FROM <wa4> INDEX lv_index4.
    CLEAR: lv_sum4.
  ENDLOOP.

* Build the Total for Level3.
  LOOP AT lt_table ASSIGNING FIELD-SYMBOL(<wa3>) WHERE stufe = '3'.
    LOOP AT lt_table4 ASSIGNING <wa4>.
      IF <wa4>-pspid+0(lv_pspid_len3) = <wa3>-pspid+0(lv_pspid_len3).
        lv_sum3 = lv_sum3 + <wa4>-budget.
      ENDIF.
    ENDLOOP.
    IF lv_sum3 IS NOT INITIAL.
      <wa3>-budget = lv_sum3.
    ENDIF.
    lv_index3 = lv_index3 + 1.
    MODIFY lt_table FROM <wa3> TRANSPORTING budget.
    MODIFY lt_table3 FROM <wa3> INDEX lv_index3.
    CLEAR: lv_sum3.
  ENDLOOP.

* Build the Total for Level2.
  LOOP AT lt_table ASSIGNING FIELD-SYMBOL(<wa2>) WHERE stufe = '2'.
    LOOP AT lt_table3 ASSIGNING <wa3>.
      IF <wa3>-pspid+0(lv_pspid_len2) = <wa2>-pspid+0(lv_pspid_len2).
        lv_sum2 = lv_sum2 + <wa3>-budget.
      ENDIF.
    ENDLOOP.

    IF lv_sum2 IS NOT INITIAL.
      <wa2>-budget = lv_sum2.
    ENDIF.
    lv_index2 = lv_index2 + 1.
    MODIFY lt_table FROM <wa2> TRANSPORTING budget.
    MODIFY lt_table2 FROM <wa2> INDEX lv_index2.
    CLEAR: lv_sum2.
  ENDLOOP.

* Build the Total for Level1.
  LOOP AT lt_table ASSIGNING FIELD-SYMBOL(<wa1>) WHERE stufe = '1'.
    LOOP AT lt_table2 ASSIGNING <wa2>.
      IF <wa2>-pspid+0(lv_pspid_len1) = <wa1>-pspid+0(lv_pspid_len1).
        lv_sum1 = lv_sum1 + <wa2>-budget.
      ENDIF.
    ENDLOOP.
    IF lv_sum1 IS NOT INITIAL.
      <wa1>-budget = lv_sum1.
    ENDIF.
    MODIFY lt_table FROM <wa1> TRANSPORTING budget.
    CLEAR: lv_sum1.
  ENDLOOP.

ENDFORM.                              " FCODE_Total_up
*&---------------------------------------------------------------------*
*&      Module  GET_LSTAR  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE get_lstar INPUT.
  TYPES:BEGIN OF ts_cssl,
          lstar TYPE lstar,
          "post1 TYPE im_post1, "invtxt TYPE im_invtxt,
        END OF ts_cssl.

  DATA:lt_cssl TYPE STANDARD TABLE OF ts_cssl.
  "ls_cssl1 TYPE ts_cssl.
*  DATA: lv_prctr_impr TYPE impr-prct.
  DATA: lv_counterl TYPE numc3,
        lv_year     TYPE gjahr.

  CLEAR:ls_temp,lv_sline.
  GET CURSOR LINE lv_sline.
  IF tc_capex-top_line + lv_sline - 1 > tc_capex-lines.
    lv_sline = tc_capex-lines.
  ELSE.
    lv_sline = tc_capex-top_line + lv_sline - 1.
  ENDIF.
  lv_year = sy-datum+0(4).
  READ TABLE lt_table INTO DATA(ls_table_lstar) INDEX lv_sline.
  SELECT lstar FROM cssl
    INTO TABLE @lt_cssl
    WHERE kostl = @ls_table_lstar-akstl
    AND   gjahr = @lv_year.

  IF NOT lt_cssl IS INITIAL.
    CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
      EXPORTING
        retfield    = 'LSTAR'
        dynpprog    = sy-repid
        dynpnr      = sy-dynnr
        dynprofield = 'ZWBS_ITEM-LSTAR'
        value_org   = 'S'
      TABLES
        value_tab   = lt_cssl.
    IF sy-subrc <> 0.
    ENDIF.
  ENDIF.
ENDMODULE.
*&---------------------------------------------------------------------*
*&      Form  AUC_CREATION
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM auc_creation .

  DATA: ls_option    TYPE ctu_params,
        lt_bdcdata   TYPE STANDARD TABLE OF bdcdata,
        ls_messages  TYPE bdcmsgcoll,
        lt_messages  TYPE STANDARD TABLE OF bdcmsgcoll,
        lv_pspid_new TYPE ps_pspid,
        lv_len       TYPE numc2.
  CLEAR: ls_option.
  ls_option-dismode = 'N'.
  ls_option-updmode = 'A'.
  ls_option-defsize = 'X'.

  CALL METHOD zcl_sleep=>seconds
    EXPORTING
      iv_second = 1.

  IF lv_type = 1.
    LOOP AT lt_wbs_item INTO DATA(ls_auc) WHERE  stufe = '02'
                                           AND   imprf IS NOT INITIAL. "WHERE lstar IS NOT INITIAL.
      SELECT SINGLE * FROM zwbs_auc INTO @DATA(ls_zwbs_auc)
        WHERE bukrs = @zwbs_header-vbukr
        AND  bwkey = @ls_auc-werks.
      IF sy-subrc NE 0.
        CONTINUE.
      ENDIF.

      REFRESH: lt_bdcdata, lt_messages.
      CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
        EXPORTING
          input  = ls_auc-pspid_new
        IMPORTING
          output = lv_pspid_new.

      SPLIT lv_pspid_new AT '.' INTO DATA(lv_first) DATA(lv_second).
      REPLACE ALL OCCURRENCES OF '.' IN lv_second WITH space.
      SHIFT lv_second LEFT DELETING LEADING '0'.
      CONDENSE lv_second.
      lv_len = strlen( lv_second ).
      IF lv_len < '8'.
        DATA(lv_val) = 8 - lv_len.
      ENDIF.
      DO lv_val TIMES.
        CONCATENATE lv_second '0' INTO lv_second.
      ENDDO.
      lv_second = lv_second + 1.
      WRITE: lv_second.



      PERFORM bdc_dynpro      USING 'SAPLCJWB' '0100' CHANGING lt_bdcdata..
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    '*PRPS-POSID' CHANGING lt_bdcdata..
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=LETB' CHANGING lt_bdcdata..
      PERFORM bdc_field       USING '*PRPS-POSID'
                                    ls_auc-pspid_new CHANGING lt_bdcdata..
      PERFORM bdc_dynpro      USING 'SAPLCJWB' '0901' CHANGING lt_bdcdata..
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=TBST' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'RCWBT-UNTRG(01)' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'RCJ_MARKL-MARK(01)'
                                    'X' CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLCJWB' '0999' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=CONT' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'PRPS-POSID' CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLCJWB' '0999' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '/00' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'PRPS-IMPRF'
                                    ls_auc-imprf CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLCJWB' '0999' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=AIB' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'PRPS-POSID' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'PRPS-IMPRF'
                                    ls_auc-imprf CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLAIST' '0105' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'ANLA-ANLKL' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '/00' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'ANLA-ANLKL'
                                    '9990' CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLAIST' '1000' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '/00' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'ANLA-ANLN1' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'ANLA-ANLN1'
                                     lv_second CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLAIST' '1000' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '/00' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'ANLA-INVNR' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'ANLA-INVNR'
                                    lv_second CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'ANLA-INKEN'
                                    'X' CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLAIST' '1000' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=TAB02' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'ANLA-TXA50' CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLAIST' '1000' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '/00' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'ANLZ-LSTAR' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'ANLZ-LSTAR'
                                    ls_auc-lstar CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLAIST' '1000' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=TAB03' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'ANLZ-LSTAR' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'ANLZ-LSTAR'
                                    ls_auc-lstar CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLAIST' '1000' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '/00' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'ANLA-ORD41' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'ANLA-ORD41'
                                     ls_zwbs_auc-ord4x CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLAIST' '1000' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=RW' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'ANLA-ORD41' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'ANLA-ORD41'
                                    ls_zwbs_auc-ord4x CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLCJWB' '0999' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '/EBCK' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'PRPS-POSID' CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLCJWB' '0901' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=BU' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'RCWBT-UNTRG(01)' CHANGING lt_bdcdata.
      CALL TRANSACTION 'CJ02' USING       lt_bdcdata
                                               OPTIONS FROM ls_option
                                               MESSAGES INTO lt_messages.
      CLEAR: lv_second.
      LOOP AT lt_messages TRANSPORTING NO FIELDS WHERE msgtyp CA 'EA'.
        lv_error = 'X'.
        EXIT.
      ENDLOOP.

      IF lv_error = 'X'.
** approval log
        gs_appr_log-text = 'AUC Creation not Successfull'.
        APPEND gs_appr_log TO gt_appr_log.
        CLEAR: gs_appr_log.
      ELSE.
** approval log
        gs_appr_log-text = 'AUC Created Successfully'.
        APPEND gs_appr_log TO gt_appr_log.
        CLEAR: gs_appr_log.
      ENDIF.
      CLEAR: lv_error.
    ENDLOOP.
  ELSEIF lv_type = 2.
    CLEAR: ls_auc, lv_first, lv_second..
    LOOP AT lt_wbs_item INTO ls_auc WHERE  stufe = '2'
                                     AND   imprf IS NOT INITIAL
                                     AND   zchange = 'I'.
      SELECT SINGLE * FROM zwbs_auc INTO @ls_zwbs_auc
        WHERE bukrs = @zwbs_header-vbukr
        AND  bwkey = @ls_auc-werks.
      IF sy-subrc NE 0.
        CONTINUE.
      ENDIF.
      REFRESH: lt_bdcdata, lt_messages.
      CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
        EXPORTING
          input  = ls_auc-pspid_new
        IMPORTING
          output = lv_pspid_new.

      SPLIT lv_pspid_new AT '.' INTO lv_first lv_second.
      REPLACE ALL OCCURRENCES OF '.' IN lv_second WITH space.
      SHIFT lv_second LEFT DELETING LEADING '0'.
      CONDENSE lv_second.
      lv_len = strlen( lv_second ).
      IF lv_len < '8'.
        lv_val = 8 - lv_len.
      ENDIF.
      DO lv_val TIMES.
        CONCATENATE lv_second '0' INTO lv_second.
      ENDDO.
      lv_second = lv_second + 1.
      PERFORM bdc_dynpro      USING 'SAPLCJWB' '0100' CHANGING lt_bdcdata..
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    '*PRPS-POSID' CHANGING lt_bdcdata..
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=LETB' CHANGING lt_bdcdata..
      PERFORM bdc_field       USING '*PRPS-POSID'
                                    ls_auc-pspid_new CHANGING lt_bdcdata..
      PERFORM bdc_dynpro      USING 'SAPLCJWB' '0901' CHANGING lt_bdcdata..
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=TBST' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'RCWBT-UNTRG(01)' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'RCJ_MARKL-MARK(01)'
                                    'X' CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLCJWB' '0999' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=CONT' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'PRPS-POSID' CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLCJWB' '0999' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '/00' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'PRPS-IMPRF'
                                    ls_auc-imprf CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLSPO1' '0300' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                            '=YES' CHANGING lt_bdcdata.
*        PERFORM bdc_dynpro      USING 'SAPLCJWB' '0999' CHANGING lt_bdcdata.
*        PERFORM bdc_field       USING 'BDC_OKCODE'
*                                      '=AIB' CHANGING lt_bdcdata.
*        PERFORM bdc_field       USING 'BDC_CURSOR'
*                                      'PRPS-POSID' CHANGING lt_bdcdata.
*        PERFORM bdc_field       USING 'PRPS-IMPRF'
*                                      ls_auc-imprf CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLAIST' '0105' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'ANLA-ANLKL' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '/00' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'ANLA-ANLKL'
                                    '9990' CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLAIST' '1000' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '/00' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'ANLA-ANLN1' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'ANLA-ANLN1'
                                     lv_second CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLAIST' '1000' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '/00' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'ANLA-INVNR' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'ANLA-INVNR'
                                    lv_second CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'ANLA-INKEN'
                                    'X' CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLAIST' '1000' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=TAB02' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'ANLA-TXA50' CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLAIST' '1000' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '/00' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'ANLZ-LSTAR' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'ANLZ-LSTAR'
                                    ls_auc-lstar CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLAIST' '1000' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=TAB03' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'ANLZ-LSTAR' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'ANLZ-LSTAR'
                                    ls_auc-lstar CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLAIST' '1000' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '/00' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'ANLA-ORD41' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'ANLA-ORD41'
                                     ls_zwbs_auc-ord4x CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLAIST' '1000' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=RW' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'ANLA-ORD41' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'ANLA-ORD41'
                                    ls_zwbs_auc-ord4x CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLCJWB' '0999' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '/EBCK' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'PRPS-POSID' CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLCJWB' '0901' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=BU' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'RCWBT-UNTRG(01)' CHANGING lt_bdcdata.
      CALL TRANSACTION 'CJ02' USING       lt_bdcdata
                                               OPTIONS FROM ls_option
                                               MESSAGES INTO lt_messages.
      CLEAR: lv_second.
      LOOP AT lt_messages TRANSPORTING NO FIELDS WHERE msgtyp CA 'EA'.
        lv_error = 'X'.
        EXIT.
      ENDLOOP.

      IF lv_error = 'X'.
** approval log
        gs_appr_log-text = 'AUC Creation not Successfull'.
        APPEND gs_appr_log TO gt_appr_log.
        CLEAR: gs_appr_log.
      ELSE.
** approval log
        gs_appr_log-text = 'AUC Created Successfully'.
        APPEND gs_appr_log TO gt_appr_log.
        CLEAR: gs_appr_log.
      ENDIF.
      CLEAR: lv_error.
    ENDLOOP.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  ATTACH_DOCUMENT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM attach_document .
*Request Number
  "PERFORM get_request CHANGING ls_head.
  PERFORM get_request_attach.

  PERFORM attach_files.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_REQUEST_ATTACH
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_request_attach .
  IF zwbs_header-request IS INITIAL.
    CALL FUNCTION 'NUMBER_GET_NEXT'
      EXPORTING
        nr_range_nr             = '01'
        object                  = 'ZPSR_REQNO'
        quantity                = '1'
        toyear                  = '0000'
      IMPORTING
        number                  = zwbs_header-request
      EXCEPTIONS
        interval_not_found      = 1
        number_range_not_intern = 2
        object_not_found        = 3
        quantity_is_0           = 4
        quantity_is_not_1       = 5
        interval_overflow       = 6
        buffer_overflow         = 7
        OTHERS                  = 8.
    IF sy-subrc <> 0.
    ENDIF.

    zwbs_header-created_by    = sy-uname.
    zwbs_header-created_on    = sy-datum.
    zwbs_header-creation_time = sy-uzeit.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  ATTACH_FILES
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM attach_files .
  DATA: lt_file_table TYPE filetable,
        lv_rc         TYPE i,
        lt_attach     TYPE STANDARD TABLE OF zemc_ts_email_attach,
        lt_doc_attach TYPE STANDARD TABLE OF ts_doc_attach,
        ls_doc_attach TYPE ts_doc_attach,
        ls_attach     TYPE zemc_ts_email_attach,
        lv_string     TYPE string,
        lv_doc_len    TYPE so_obj_len,
        lv_length     TYPE i,
        lt_mailhex    TYPE STANDARD TABLE OF soli,
        lv_object_key TYPE swo_typeid,
        lv_pathname   TYPE dsvasdocid,
        lv_filename   TYPE dsvasdocid,
        lv_ext        TYPE dsvasdocid,
        lv_ext_t      TYPE so_obj_tp,
        lv_filename_t TYPE so_obj_des,
        lv_xstring    TYPE xstring,
        lv_doc_type   TYPE saedoktyp,
        lv_object     TYPE saeobjart VALUE 'ZMSCIDOCU',
        lv_sap_object TYPE saeanwdid,
        lv_object_id  TYPE sapb-sapobjid,
*       lv_filename   TYPE toaat-filename,
        lv_filedesc   TYPE toaat-descr,
        lt_return     TYPE bapirettab.

  .

  PERFORM start_gos USING    zwbs_header-request
                                 'E'
                        CHANGING lo_gos.

*  CLEAR lt_file_table.
*  CALL METHOD cl_gui_frontend_services=>file_open_dialog
*    EXPORTING
*      multiselection          = abap_true
*    CHANGING
*      file_table              = lt_file_table
*      rc                      = lv_rc
*    EXCEPTIONS
*      file_open_dialog_failed = 1
*      cntl_error              = 2
*      error_no_gui            = 3
*      not_supported_by_gui    = 4
*      OTHERS                  = 5.
*
*  " update list of attached files
*  LOOP AT lt_file_table INTO DATA(ls_file_table).
*    CLEAR ls_attach.
*    ls_attach-file_name = ls_file_table-filename.
*    APPEND ls_attach TO lt_attach.
*  ENDLOOP.
*  SORT lt_attach.
*  DELETE ADJACENT DUPLICATES FROM lt_attach.
*
*  LOOP AT lt_attach INTO ls_attach.
*    CLEAR:lv_string,lv_doc_len,lv_length,lt_mailhex,lv_object_key.
*    lv_string = ls_attach-file_name.
*
*    CALL FUNCTION 'GUI_UPLOAD'
*      EXPORTING
*        filename                = lv_string
*        filetype                = 'BIN'
*      IMPORTING
*        filelength              = lv_length
*      TABLES
*        data_tab                = lt_mailhex
*      EXCEPTIONS
*        file_open_error         = 1
*        file_read_error         = 2
*        no_batch                = 3
*        gui_refuse_filetransfer = 4
*        invalid_type            = 5
*        no_authority            = 6
*        unknown_error           = 7
*        bad_data_format         = 8
*        header_not_allowed      = 9
*        separator_not_allowed   = 10
*        header_too_long         = 11
*        unknown_dp_error        = 12
*        access_denied           = 13
*        dp_out_of_memory        = 14
*        disk_full               = 15
*        dp_timeout              = 16
*        OTHERS                  = 17.
*
*    IF sy-subrc IS NOT INITIAL.
*      MESSAGE 'Error in reading file for upload'(002) TYPE 'I'.
*    ENDIF.
*
*    lv_pathname = lv_string.
*
*    CALL FUNCTION 'Z_DSVAS_DOC_FILENAME_SPLIT'
*      EXPORTING
*        pf_docid     = lv_pathname
*      IMPORTING
*        pf_filename  = lv_filename
*        pf_extension = lv_ext.
*
*    lv_ext_t      = lv_ext.
*    lv_filename_t = lv_filename.
*
**Collect Attachment data for Notification
*    ls_doc_attach-file_desc = lv_filename_t.
*    ls_doc_attach-file_ext  = lv_ext_t.
*    ls_doc_attach-file_len  = lv_length.
*    ls_doc_attach-file_cont = lt_mailhex.
*    APPEND ls_doc_attach TO lt_doc_attach.
*    CLEAR:ls_doc_attach.
*  ENDLOOP.
*
*  lv_object_key = zwbs_header-request.
*  LOOP AT lt_doc_attach INTO ls_doc_attach.
*    TRANSLATE ls_doc_attach-file_ext TO UPPER CASE.
**Use Business Document option
**--------------------------------------------------------------------*
*    CLEAR:lt_return,lv_xstring,lv_filename,lv_filedesc,lv_doc_type.
*    lv_filename = ls_doc_attach-file_desc.
*    lv_filedesc = ls_doc_attach-file_desc.
**Convert Data to Hex
*    CALL FUNCTION 'SCMS_BINARY_TO_XSTRING'
*      EXPORTING
*        input_length = ls_doc_attach-file_len
*      IMPORTING
*        buffer       = lv_xstring
*      TABLES
*        binary_tab   = ls_doc_attach-file_cont
*      EXCEPTIONS
*        failed       = 1
*        OTHERS       = 2.
*    IF sy-subrc <> 0.
** Implement suitable error handling here
*    ENDIF.
**Attach Document
*    lv_object_id = lv_object_key.
*    lv_doc_type  = ls_doc_attach-file_ext.
*    CALL FUNCTION 'ZATTACH_ARCHIV_OBJECT'
*      EXPORTING
*        iv_ar_object     = lv_object
*        iv_sap_object    = 'ZWBS'
*        iv_object_id     = lv_object_id
*        iv_document_type = lv_doc_type
**       IV_ARCHIV_ID     =
**       IV_FILELENGTH    = lv_doc_size
**       IT_BINARCOBJ     =
*        iv_hex_string    = lv_xstring
*        iv_filename      = lv_filename
*        iv_file_descr    = lv_filedesc
*      IMPORTING
*        et_bapiret       = lt_return
*      EXCEPTIONS
*        not_possible     = 1
*        OTHERS           = 2.
*    IF sy-subrc <> 0.
** Implement suitable error handling here
*    ENDIF.
**--------------------------------------------------------------------*
*  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  BUDGET_CHANGE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM budget_change .

  DATA: lt_bapiret      TYPE TABLE OF bapiret2,
        lt_bpak         TYPE TABLE OF bpak,
        ls_bpak         TYPE bpak,
        ls_bapiret      TYPE bapiret2,
        lt_bpak_cj40    TYPE TABLE OF bpak,
        ls_bpak_cj40    TYPE  bpak,
        lv_flag_error_c TYPE oax.

  DATA: ls_option   TYPE ctu_params,
        lt_bdcdata  TYPE STANDARD TABLE OF bdcdata,
        ls_messages TYPE bdcmsgcoll,
        lt_messages TYPE STANDARD TABLE OF bdcmsgcoll.


  DATA: lv_name TYPE char40.
  DATA: ls_bp       TYPE zwbs_item,
        lv_tabix    TYPE char2,
        lv_tabix_bp TYPE char2.

  lt_table_bp = lt_wbs_item.
  SORT lt_table_bp BY stufe DESCENDING.
  READ TABLE lt_table_bp INTO ls_bp INDEX 1.

  SELECT * FROM prps INTO TABLE @DATA(lt_prps_bp)
     FOR ALL ENTRIES IN @lt_wbs_item
     WHERE posid = @lt_wbs_item-pspid_new.
  IF lt_prps_bp IS NOT INITIAL.
    SELECT * FROM prhi INTO TABLE @DATA(lt_prhi)
     FOR ALL ENTRIES IN @lt_prps_bp
     WHERE psphi = @lt_prps_bp-psphi
       AND down  = @space.
  ENDIF.


*
*
  LOOP AT lt_wbs_item INTO ls_table_bp WHERE zchange = 'I' OR zchange = 'U'." WHERE stufe = ls_bp-stufe.
    READ TABLE lt_prps_bp INTO DATA(ls_prps_bp) WITH KEY posid = ls_table_bp-pspid_new.
    IF sy-subrc = 0.
      READ TABLE lt_prhi INTO DATA(ls_prhi) WITH KEY posnr = ls_prps_bp-pspnr.
      IF sy-subrc NE 0.
        CONTINUE.
      ENDIF.
    ENDIF.
    APPEND ls_table_bp TO lt_wbs_budget.
  ENDLOOP.

  IF zwbs_header-pwhie = 'JPY' OR
     zwbs_header-pwhie = 'IDR'.

    REFRESH: lt_bdcdata, lt_messages.
    CLEAR: ls_option.
    ls_option-dismode = 'N'.
    ls_option-updmode = 'A'.
    ls_option-defsize = 'X'.
    CLEAR: ls_table_bp.
    LOOP AT lt_wbs_budget INTO ls_table_bp.

      REFRESH lt_bdcdata.

      PERFORM bdc_dynpro      USING 'SAPMKBUD' '0200' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'PRPS-POSID' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=EINK' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'PROJ-PSPID'
                                    ' ' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'PRPS-POSID'
                                    ls_table_bp-pspid_new CHANGING
                                    lt_bdcdata.
      PERFORM bdc_field       USING 'BPDY-VERSN'
                                    '0' CHANGING lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLKBPP' '0320' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'BPDY-WERT1(01)' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '/00' CHANGING lt_bdcdata.
      lv_budget_c = ls_table_bp-budget.
      SPLIT lv_budget_c AT '.' INTO DATA(lv_value_c) DATA(lv_dec).
      PERFORM bdc_field       USING 'BPDY-WERT1(01)'
                                     lv_value_c CHANGING
                                     lt_bdcdata.
      PERFORM bdc_dynpro      USING 'SAPLKBPP' '0320' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_CURSOR'
                                    'BPDY-WERT1(01)' CHANGING lt_bdcdata.
      PERFORM bdc_field       USING 'BDC_OKCODE'
                                    '=SAVE' CHANGING lt_bdcdata.
      CALL TRANSACTION 'CJ40' USING       lt_bdcdata
                                         OPTIONS FROM ls_option
                                         MESSAGES INTO lt_messages.
      CLEAR: ls_table_bp.
    ENDLOOP.

    CLEAR: ls_item.
    READ TABLE lt_wbs_item INTO ls_item INDEX 1.

    REFRESH: lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPMKBUD' '0200' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'PROJ-PSPID' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '/00' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'PROJ-PSPID'
                                  ls_item-pspid_new CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'PRPS-POSID'
                                ' ' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BPDY-VERSN'
                                  '0' CHANGING lt_bdcdata.

    PERFORM bdc_dynpro      USING 'SAPLKBPP' '0320' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'BPDY-WERT1(01)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                '=MRKA' CHANGING lt_bdcdata.

    PERFORM bdc_dynpro      USING 'SAPLKBPP' '0320' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                               'BPDY-WERT1(01)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=SYNC' CHANGING lt_bdcdata.

    PERFORM bdc_dynpro      USING 'SAPLKBPP' '0705' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'BPDY-JAHR_VON' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=ENTE' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BPDY-JAHR_VON'
                                  '2019' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BPDY-JAHR_BIS'
                                  '2027' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BPDY-TI_GES_1'
                                  'X' CHANGING lt_bdcdata.
    PERFORM bdc_dynpro      USING 'SAPLKBPP' '0320' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_CURSOR'
                                  'BPDY-WERT1(01)' CHANGING lt_bdcdata.
    PERFORM bdc_field       USING 'BDC_OKCODE'
                                  '=SAVE' CHANGING lt_bdcdata.
    CALL TRANSACTION 'CJ40' USING       lt_bdcdata
                                         OPTIONS FROM ls_option
                                         MESSAGES INTO lt_messages.
    CALL METHOD zcl_sleep=>seconds
      EXPORTING
        iv_second = 1.
    LOOP AT lt_messages TRANSPORTING NO FIELDS WHERE msgtyp CA 'EA'.
      gv_error_email = 'X'.
      EXIT.
    ENDLOOP.

    IF sy-subrc NE 0.
      "approval log
      gs_appr_log-text = 'Budget in CJ40 Updated Successfully'.
      APPEND gs_appr_log TO gt_appr_log.
      CLEAR: gs_appr_log.
      PERFORM original_budget.
    ELSE.
      " approval log
      gv_error_email = 'X'.
      gs_appr_log-text = 'Budget in CJ40 updation not Successfull'.
      APPEND gs_appr_log TO gt_appr_log.
      CLEAR: gs_appr_log.
    ENDIF.
  ELSE.
    CLEAR:ls_table_bp.
    LOOP AT lt_wbs_budget INTO ls_table_bp." WHERE stufe = ls_bp-stufe.
      CLEAR: ls_prps_bp.
      READ TABLE lt_prps_bp INTO ls_prps_bp WITH KEY posid = ls_table_bp-pspid_new.
      IF sy-subrc = 0.
        ls_bpak-e_objnr = ls_prps_bp-objnr.
        ls_bpak-e_ges = 'X'.
        IF ls_table_bp-zchange = 'I'.  " inserted new line for budget in Change case.
          ls_bpak-wert  = ls_table_bp-budget.
        ELSEIF ls_table_bp-zchange = 'U'.  " modified budget for Existing line item.

          SELECT SINGLE waers INTO @DATA(lv_waers) FROM t001
            WHERE bukrs = @ls_prps_bp-pbukr.
          IF sy-subrc = 0.
            SELECT SINGLE lednr INTO @DATA(lv_lednr) FROM tbp0l
              WHERE waers = @lv_waers.
            IF sy-subrc = 0.
              SELECT SINGLE wlp00
                  FROM rpsco
                  INTO @DATA(lv_wlp00)
                  WHERE objnr = @ls_prps_bp-objnr
                  AND   lednr = @lv_lednr
                  AND   wrttp = '45'.

              IF lv_wlp00 GE ls_table_bp-budget.
                ls_bpak-wert  =   lv_wlp00 - ls_table_bp-budget. " Budget decreased in Change case for Existing line item.
                ls_bpak-wert = ls_bpak-wert * -1.
              ELSEIF lv_wlp00 LE ls_table_bp-budget. "budget increased in change case for Existing line item.
                ls_bpak-wert  = ls_table_bp-budget - lv_wlp00.
              ENDIF.
            ENDIF.
          ENDIF.
          CLEAR: lv_lednr, lv_waers.
        ENDIF.
        ls_bpak-twaer = ls_prps_bp-pwpos.
        "ls_bpak-e_versn = 0.
        APPEND ls_bpak TO lt_bpak.
        CLEAR: ls_bpak.
      ENDIF.
    ENDLOOP.

    IF lt_bpak IS NOT INITIAL.
      DATA(lt_bpak_cj30) = lt_bpak.
      DATA(lt_bpak_cj32) = lt_bpak.

      LOOP AT lt_bpak INTO ls_bpak.
        MOVE-CORRESPONDING ls_bpak TO ls_bpak_cj40.
        ls_bpak_cj40-e_versn = '000'.
        APPEND ls_bpak_cj40 TO lt_bpak_cj40.
        CLEAR: ls_bpak_cj40.
      ENDLOOP.

      CALL FUNCTION 'KBPP_EXTERN_UPDATE_CO'
        EXPORTING
          i_budget_activity = 'KSTP'
*         I_BUDGET_ACTIV_SUP_RET              = ' '
*         I_BUDGET_DISTRIBUTION_ALLOWED       = ' '
*         I_COMMIT_DATA     = ' '
          i_delta_amounts   = 'X'
          i_rollup_data     = 'X'
          i_check_plan_data = 'X'
          i_application     = 'P'
          i_commit_all      = 'X'
        IMPORTING
          e_errors_found    = lv_flag_error_c
        TABLES
          it_bpak           = lt_bpak_cj40
          it_return         = lt_bapiret
        EXCEPTIONS
          no_update         = 1
          OTHERS            = 2.
      IF lt_bapiret IS INITIAL AND lv_flag_error_c IS INITIAL.
        " approval log
        gs_appr_log-text = 'Budget in CJ40 Created Successfully'.
        APPEND gs_appr_log TO gt_appr_log.
        CLEAR: gs_appr_log.
        CALL FUNCTION 'KBPP_EXTERN_UPDATE_CO'
          EXPORTING
            i_budget_activity = 'KBUD'
*           I_BUDGET_ACTIV_SUP_RET              = ' '
*           I_BUDGET_DISTRIBUTION_ALLOWED       = ' '
*           I_COMMIT_DATA     = ' '
            i_delta_amounts   = 'X'
            i_rollup_data     = 'X'
            i_check_plan_data = 'X'
            i_application     = 'P'
            i_commit_all      = 'X'
          IMPORTING
            e_errors_found    = lv_flag_error_c
          TABLES
            it_bpak           = lt_bpak_cj30
            it_return         = lt_bapiret
          EXCEPTIONS
            no_update         = 1
            OTHERS            = 2.

        IF lt_bapiret IS INITIAL AND lv_flag_error_c IS INITIAL.
          " approval log
          gs_appr_log-text = 'Budget in CJ30 Created Successfully'.
          APPEND gs_appr_log TO gt_appr_log.
          CLEAR: gs_appr_log.
          CALL FUNCTION 'KBPP_EXTERN_UPDATE_CO'
            EXPORTING
              i_budget_activity = 'KBFR'
*             I_BUDGET_ACTIV_SUP_RET              = ' '
*             I_BUDGET_DISTRIBUTION_ALLOWED       = ' '
*             I_COMMIT_DATA     = ' '
              i_delta_amounts   = 'X'
              i_rollup_data     = 'X'
              i_check_plan_data = 'X'
              i_application     = 'P'
              i_commit_all      = 'X'
            IMPORTING
              e_errors_found    = lv_flag_error_c
            TABLES
              it_bpak           = lt_bpak_cj32
              it_return         = lt_bapiret
            EXCEPTIONS
              no_update         = 1
              OTHERS            = 2.
          IF lt_bapiret IS INITIAL AND lv_flag_error_c IS INITIAL.
            "approval log
            gs_appr_log-text = 'Budget in CJ32 Created Successfully'.
            APPEND gs_appr_log TO gt_appr_log.
            CLEAR: gs_appr_log.
          ELSE.
            " approval log
            gv_error_email = 'X'.
            gs_appr_log-text = 'Budget in CJ32 Creation not Successfull'.
            APPEND gs_appr_log TO gt_appr_log.
            CLEAR: gs_appr_log.
          ENDIF.
        ELSE.
          " approval log
          gv_error_email = 'X'.
          gs_appr_log-text = 'Budget in CJ30 Creation not Successfull'.
          APPEND gs_appr_log TO gt_appr_log.
          CLEAR: gs_appr_log.
        ENDIF.

      ELSE.
        "approval log
        gv_error_email = 'X'.
        gs_appr_log-text = 'Budget in CJ40 Creation not Successfull'.
        APPEND gs_appr_log TO gt_appr_log.
        CLEAR: gs_appr_log.
      ENDIF.
    ENDIF.
  ENDIF.



ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  DOWNLOAD
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM download .
  TYPES: BEGIN OF ty_download,
           stufe  TYPE zwbs_item-stufe,
           pspid  TYPE zwbs_item-pspid,
           post1  TYPE zwbs_item-post1,
           budget TYPE zwbs_item-budget,
         END OF ty_download,
         BEGIN OF ts_fieldnames,
           fieldname TYPE char50,
         END OF ts_fieldnames.

  DATA: ls_download   TYPE ty_download,
        lt_download   TYPE TABLE OF ty_download,
        lt_fieldnames TYPE STANDARD TABLE OF ts_fieldnames,
        ls_fieldnames TYPE ts_fieldnames.

  DATA: lv_action   TYPE i,
        lv_filename TYPE string,
        lv_fullpath TYPE string,
        lv_path     TYPE string.
*--Appending header to the Excel file.
  ls_fieldnames-fieldname = 'Level'.APPEND ls_fieldnames TO lt_fieldnames.CLEAR ls_fieldnames.
  ls_fieldnames-fieldname = 'WBS Element'.APPEND ls_fieldnames TO lt_fieldnames.CLEAR ls_fieldnames.
  ls_fieldnames-fieldname = 'Description'.APPEND ls_fieldnames TO lt_fieldnames.CLEAR ls_fieldnames.
  ls_fieldnames-fieldname = 'Budget'.APPEND ls_fieldnames TO lt_fieldnames.CLEAR ls_fieldnames.

  LOOP AT lt_table INTO ls_table.
    ls_download-stufe = ls_table-stufe.
    ls_download-pspid = ls_table-pspid.
    ls_download-post1 = ls_table-post1.
    ls_download-budget = ls_table-budget.
    APPEND ls_download TO lt_download.
    CLEAR: ls_download.
  ENDLOOP.

  CALL METHOD cl_gui_frontend_services=>file_save_dialog
    EXPORTING
      window_title      = 'Please Select the location'
      default_extension = 'XLSX'
      default_file_name = 'Capex_template.xls'
      file_filter       = '*.xls'
    CHANGING
      filename          = lv_filename
      path              = lv_path
      fullpath          = lv_fullpath
      user_action       = lv_action.
  IF NOT lv_action IS INITIAL.
    EXIT.
  ENDIF.

  CALL METHOD cl_gui_frontend_services=>gui_download
    EXPORTING
      filename              = lv_filename
      filetype              = 'ASC'
      write_field_separator = 'X'
      fieldnames            = lt_fieldnames
    CHANGING
      data_tab              = lt_download.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  UPLOAD
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM upload .
*  DATA: lv_action   TYPE i,
*        lv_filename TYPE string,
*        lv_fullpath TYPE string,
*        lv_path     TYPE string.
  TYPES: BEGIN OF ty_upload,
           stufe  TYPE zwbs_item-stufe,
           pspid  TYPE zwbs_item-pspid,
           post1  TYPE zwbs_item-post1,
           budget TYPE zwbs_item-budget,
         END OF ty_upload.
  DATA: lt_file_data TYPE STANDARD TABLE OF ty_upload,
        "lt_alv_data  TYPE STANDARD TABLE OF ts_result,
        lt_raw_data  TYPE truxs_t_text_data,
        lv_subrc     LIKE sy-subrc,
        lt_file      TYPE filetable,
        l_file       TYPE rlgrap-filename.
  " Display File Open Dialog control/screen
  CALL METHOD cl_gui_frontend_services=>file_open_dialog
    EXPORTING
      window_title     = 'Select File'
      default_filename = '*.XLS'
      "file_filter      =
      "                  'Microsoft Excel Files (*.XLS;*.XLSX)|*.XLS;*.XLSX|'
      multiselection   = ' '
    CHANGING
      file_table       = lt_file
      rc               = lv_subrc.

  " Write path on input area
  READ TABLE lt_file INTO DATA(ls_file) INDEX 1.
  IF sy-subrc EQ 0.
    l_file = ls_file-filename.

**  Get Excel file data in internal table.
    CALL FUNCTION 'TEXT_CONVERT_XLS_TO_SAP'
      EXPORTING
*       I_FIELD_SEPERATOR    =
        i_line_header        = 'X'
        i_tab_raw_data       = lt_raw_data
        i_filename           = l_file
      TABLES
        i_tab_converted_data = lt_file_data
*   EXCEPTIONS
*       CONVERSION_FAILED    = 1
*       OTHERS               = 2
      .
    IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.
  ENDIF.

  IF lt_file_data IS NOT INITIAL.
    LOOP AT lt_table ASSIGNING FIELD-SYMBOL(<fs_fdata>).
      READ TABLE lt_file_data INTO DATA(ls_file_data) WITH KEY pspid = <fs_fdata>-pspid.
      IF sy-subrc = 0.
        IF lv_type = 2.
          IF <fs_fdata>-post1 NE ls_file_data-post1 OR
             <fs_fdata>-budget NE ls_file_data-budget.
            <fs_fdata>-zchange = 'U'.
          ENDIF.
        ENDIF.
        <fs_fdata>-stufe = ls_file_data-stufe.
        <fs_fdata>-pspid = ls_file_data-pspid.
        <fs_fdata>-post1 = ls_file_data-post1.
        <fs_fdata>-budget = ls_file_data-budget.

      ENDIF.
    ENDLOOP.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SHOW_APPROVAL_LOG
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM show_approval_log .
  DATA: lv_name TYPE thead-tdname.

  lv_name = zwbs_header-request.
  CALL FUNCTION 'READ_TEXT'
    EXPORTING
*     CLIENT   = SY-MANDT
      id       = 'ZALG'
      language = 'E'
      name     = lv_name
      object   = 'Z_WBS_REQ'
*     ARCHIVE_HANDLE                = 0
*     LOCAL_CAT                     = ' '
*   IMPORTING
*     HEADER   =
*     OLD_LINE_COUNTER              =
    TABLES
      lines    = lt_lines
*   EXCEPTIONS
*     ID       = 1
*     LANGUAGE = 2
*     NAME     = 3
*     NOT_FOUND                     = 4
*     OBJECT   = 5
*     REFERENCE_CHECK               = 6
*     WRONG_ACCESS_TO_ARCHIVE       = 7
*     OTHERS   = 8
    .
  IF sy-subrc <> 0.
* Implement suitable error handling here
  ENDIF.

  IF NOT lt_lines IS INITIAL.
    CALL SCREEN '0810' STARTING AT 5 3.
    CLEAR ok_code.
  ELSE.
    MESSAGE s324(00).
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CREATE_APPR_LOG_EDITOR
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM create_appr_log_editor .

  IF lo_alog IS INITIAL.
    CREATE OBJECT lo_alog
      EXPORTING
        repid                      = sy-repid
        dynnr                      = sy-dynnr
        dynpro_container           = 'ALOG'
        wordwrap_mode              = 2
        wordwrap_position          = 72
        wordwrap_to_linebreak_mode = 1.
  ENDIF.
  gt_appr_log = CORRESPONDING #( lt_lines MAPPING text = tdline ).
  CALL METHOD lo_alog->set_text_as_r3table
    EXPORTING
      table = gt_appr_log.

*--- statusbar in text-control
  CALL METHOD lo_alog->set_statusbar_mode
    EXPORTING
      statusbar_mode = lc_true.

*--- Toolbar in text-control
  CALL METHOD lo_alog->set_toolbar_mode
    EXPORTING
      toolbar_mode = lc_true.

*Set Visibility for Log
  CALL METHOD lo_alog->set_readonly_mode
    EXPORTING
      readonly_mode          = lc_true
    EXCEPTIONS
      error_cntl_call_method = 1
      invalid_parameter      = 2
      OTHERS                 = 3.
  IF sy-subrc <> 0.
  ENDIF.

  CALL METHOD lo_alog->flush.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  EMAIL
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM email .
  DATA: lo_bcs           TYPE REF TO cl_bcs,
        lx_send_req_bcs  TYPE REF TO cx_send_req_bcs,
        lo_doc_bcs       TYPE REF TO cl_document_bcs,
        lv_raw           TYPE char03 VALUE 'RAW',
        lt_body          TYPE STANDARD TABLE OF soli,
        ls_body          TYPE soli,
        lv_doc_len       TYPE so_obj_len,
        lv_subject       TYPE so_obj_des,
        lv_language      TYPE so_obj_la,
        lv_importance    TYPE bcs_docimp,
        lx_document_bcs  TYPE REF TO cx_document_bcs,
        lv_email_address TYPE ad_smtpadr,
        lo_sender        TYPE REF TO cl_cam_address_bcs,
        lx_address_bcs   TYPE REF TO cx_address_bcs,
        lo_recipient     TYPE REF TO cl_cam_address_bcs,
        lv_string        TYPE string.
  DATA:lt_line TYPE STANDARD TABLE OF tline,
       ls_line TYPE tline.

  TRY .
      lo_bcs = cl_bcs=>create_persistent( ).
    CATCH cx_send_req_bcs INTO lx_send_req_bcs.
  ENDTRY.


  IF gt_appr_log IS NOT INITIAL.
    lt_line = CORRESPONDING #( gt_appr_log MAPPING tdline = text ).
    CLEAR lv_string.
    LOOP AT lt_line INTO ls_line.
      CONCATENATE lv_string ls_line-tdline INTO ls_line-tdline
                  SEPARATED BY cl_abap_char_utilities=>cr_lf.
      ls_body-line = ls_line-tdline.
      APPEND ls_body TO lt_body.
      CLEAR ls_body.
    ENDLOOP.
    CLEAR lv_doc_len.
    lv_doc_len = strlen( lv_string ).
    CONCATENATE zwbs_header-request 'Approval log for Capex Projects' INTO lv_subject
            SEPARATED BY space.
    "lv_subject  = 'Approval log for Capex Projects'.
  ENDIF.
  TRY.
      lo_doc_bcs = cl_document_bcs=>create_document(
          EXPORTING  i_type         = lv_raw
                     i_text         = lt_body
                     i_length       = lv_doc_len
                     i_subject      = lv_subject
                     i_language     = lv_language
                     i_importance   = lv_importance ).
    CATCH cx_document_bcs INTO lx_document_bcs.
  ENDTRY.

  TRY .
      lo_bcs->set_document( i_document =  lo_doc_bcs ).
    CATCH cx_send_req_bcs INTO lx_send_req_bcs.
  ENDTRY.

  TRY.
      lv_email_address = 'wbselementmasterdata@lonza.com'.
      lo_recipient = cl_cam_address_bcs=>create_internet_address( lv_email_address ).
      lo_bcs->add_recipient( EXPORTING i_recipient = lo_recipient ).

    CATCH cx_send_req_bcs INTO lx_send_req_bcs.
    CATCH cx_address_bcs  INTO lx_address_bcs.
  ENDTRY.

  TRY .
      lo_sender = cl_cam_address_bcs=>create_internet_address( lv_email_address ).
    CATCH cx_address_bcs INTO lx_address_bcs.
  ENDTRY.
  TRY.
      lo_bcs->set_sender( EXPORTING i_sender = lo_sender ).
    CATCH cx_send_req_bcs INTO lx_send_req_bcs.
  ENDTRY.
  TRY.
      lo_bcs->set_send_immediately( 'X' ).  "Send email directly
    CATCH cx_send_req_bcs INTO lx_send_req_bcs.
  ENDTRY.
  TRY.
      lo_bcs->send( ).
      COMMIT WORK AND WAIT.
    CATCH cx_send_req_bcs INTO lx_send_req_bcs.
  ENDTRY.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_PROJECT_TYPE_LIST
*&---------------------------------------------------------------------*
FORM get_project_type_list .

  CHECK ok_code IS INITIAL.

  CLEAR:lt_proj_list,lv_id.

  zwbs_header-proj_type = lv_proj_type.

  SELECT proj_type,proj_desc FROM zwbs_proj_type
                             INTO TABLE @lt_proj_list.

  SORT lt_proj_list BY key.
  lv_id = 'ZWBS_HEADER-PROJ_TYPE'.

  CALL FUNCTION 'VRM_SET_VALUES'
    EXPORTING
      id              = lv_id
      values          = lt_proj_list[]
    EXCEPTIONS
      id_illegal_name = 1
      OTHERS          = 2.
  IF sy-subrc <> 0.
* Implement suitable error handling here
  ENDIF.

ENDFORM.
*&--------------------------------------------------------------------*
*&      Form  SAVE_DATA
*&--------------------------------------------------------------------*
FORM save_data.

  CHECK lv_error IS INITIAL.

  CLEAR:ls_head,lt_wbs_item.

  MOVE-CORRESPONDING zwbs_header TO ls_head.
*Request Number
  PERFORM get_request CHANGING ls_head.

  PERFORM collect_data USING ' ' ' '.

  PERFORM update_data.
*Clear Buffers to avoid Lock Issues on Project/WBS
  PERFORM clear_proj_buffer.

  PERFORM status_message.

ENDFORM.                    " SAVE_DATA
*&---------------------------------------------------------------------*
*&      Form  PROCESS_ACTION
*&---------------------------------------------------------------------*
FORM process_action .

  CASE lv_proj_type.
    WHEN 'TC'.
      CASE abap_true.
        WHEN lv_rb3 OR lv_rb4.
          CLEAR:lv_rb3,lv_rb4.
          lv_rb2 = abap_true.
        WHEN OTHERS.
      ENDCASE.
    WHEN OTHERS.
  ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CANCEL_REQUEST
*&---------------------------------------------------------------------*
FORM cancel_request .

  CHECK lv_error IS INITIAL.

  CLEAR:ls_head,lt_wbs_item.

  MOVE-CORRESPONDING zwbs_header TO ls_head.
*Request Number
  PERFORM get_request CHANGING ls_head.

  PERFORM collect_data USING 'C' ' '.

  PERFORM update_data.
*Clear Buffers to avoid Lock Issues on Project/WBS
  PERFORM clear_proj_buffer.

  PERFORM status_message.

ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  GET_INVESTMENT_REASON
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_investment_reason .
*  DATA: lv_key TYPE char40.

  CHECK ok_code IS INITIAL OR ok_code = 'PRJTY'.
  CHECK  lv_proj_type = 'TC'.

  SELECT posid, izwek
          INTO TABLE @DATA(lt_ir) FROM impr
         WHERE usr09 = '00000000'
           AND usr11 = ' '.
  SORT lt_ir ASCENDING BY izwek.
  DELETE lt_ir WHERE izwek IS INITIAL.
  "SORT lt_ir ASCENDING BY izwek.
  "DELETE ADJACENT DUPLICATES FROM lt_ir COMPARING posid izwek.
*
*  SELECT * FROM t087j INTO TABLE @DATA(lt_t087j)
*    FOR ALL ENTRIES IN @lt_ir
*      WHERE spras = @sy-langu
*       AND  izwek = @lt_ir-izwek.

  LOOP AT lt_ir INTO DATA(ls_ir).
*    READ TABLE lt_t087j INTO DATA(ls_t087j) WITH KEY izwek = ls_ir-izwek.
    ls_ip-key = ls_ir-posid.
    ls_ip-text = ls_ir-izwek.
    APPEND ls_ip TO lt_ip.
*    ENDIF.
    CLEAR: ls_ir, ls_ip.
  ENDLOOP.

  SORT lt_ip ASCENDING BY text.
  DELETE ADJACENT DUPLICATES FROM lt_ip.

  lv_id = 'ZWBS_PROJ_TEM_TC-IZWEK'.
*Set Default Values
  CALL FUNCTION 'VRM_SET_VALUES'
    EXPORTING
      id              = lv_id
      values          = lt_ip[]
    EXCEPTIONS
      id_illegal_name = 1
      OTHERS          = 2.
  IF sy-subrc <> 0.
* Implement suitable error handling here
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CHECK_WBS_RAKEY
*&---------------------------------------------------------------------*
FORM check_wbs_rakey CHANGING cv_wbs_rakey_flag.

  DATA:lv_lower_level TYPE ps_posid,
       lv_child_grpkz TYPE grpspkz,
       lv_valid_child TYPE flag.

  DATA(lt_table_rakey) = lt_table.

  SORT lt_table_rakey BY pspid ASCENDING stufe ASCENDING.

  READ TABLE lt_table_rakey INTO DATA(ls_table_rakey)
                            WITH KEY pspid = ls_table-pspid.
  CHECK sy-subrc = 0.
  DATA(lv_tabix_wbs) = sy-tabix + 1.
  DATA(lv_len_pspid) = strlen( ls_table-pspid ).

  LOOP AT lt_table_rakey INTO DATA(ls_table_child)
                         FROM lv_tabix_wbs.
    IF ls_table_child-pspid+0(lv_len_pspid) = ls_table-pspid.
*Lower Level
      IF ls_table_child-stufe > ls_table_rakey-stufe.
        lv_lower_level = ls_table_child-pspid.
        lv_child_grpkz = ls_table_child-grpkz.
        lv_valid_child = abap_true.
        IF NOT lv_lower_level IS INITIAL AND NOT lv_child_grpkz IS INITIAL.
          CLEAR ls_table_rakey.
          READ TABLE lt_table_rakey INTO ls_table_rakey
                                    WITH KEY pspid = lv_lower_level.
          IF sy-subrc = 0 AND ls_table_rakey-pbukr = ls_table-pbukr.
            cv_wbs_rakey_flag = abap_true.
            EXIT.
          ENDIF.
        ENDIF.
      ENDIF.
    ELSE.
      IF lv_valid_child IS INITIAL.
        cv_wbs_rakey_flag = abap_true.
        EXIT.
      ENDIF.
    ENDIF.
  ENDLOOP.
  IF cv_wbs_rakey_flag  IS INITIAL AND
   ( sy-subrc <> 0 OR
   ( NOT lv_lower_level IS INITIAL AND lv_child_grpkz IS INITIAL ) ).
    cv_wbs_rakey_flag = abap_true.
  ENDIF.
  CLEAR:lv_lower_level,lv_child_grpkz,lv_valid_child.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CHECK_WBS_RAKEY_PARENT
*&---------------------------------------------------------------------*
FORM check_wbs_rakey_parent CHANGING cv_wbs_rakey_flag.

  DATA lv_upper_level TYPE ps_posid.

  DATA(lt_table_rakey) = lt_table.

  SORT lt_table_rakey BY pspid DESCENDING stufe DESCENDING.

  READ TABLE lt_table_rakey INTO DATA(ls_table_rakey)
                            WITH KEY pspid = ls_table-pspid.
  CHECK sy-subrc = 0.
  DATA(lv_tabix_wbs) = sy-tabix + 1.

  LOOP AT lt_table_rakey INTO DATA(ls_table_parent) FROM lv_tabix_wbs.
*Upper Level
    IF ls_table_parent-stufe < ls_table_rakey-stufe.
      lv_upper_level = ls_table_parent-pspid.
      EXIT.
    ENDIF.
  ENDLOOP.
  IF NOT lv_upper_level IS INITIAL.
    CLEAR ls_table_rakey.
    READ TABLE lt_table_rakey INTO ls_table_rakey
                              WITH KEY pspid = lv_upper_level.
    IF sy-subrc = 0 AND ls_table_rakey-pbukr <> ls_table-pbukr.
      CLEAR lv_abgsl.
      CONCATENATE '%' ls_table_rakey-abgsl '%' INTO lv_abgsl.
      SELECT SINGLE COUNT(*) FROM zvv_param
                    WHERE lookup_name EQ   'ZK_CGT_RA_KKA2_EXIT' AND
                          free_key    EQ   'ABGSL'               AND
                          indicator1  EQ   abap_true             AND
                        ( value1      LIKE lv_abgsl              OR
                          value2      LIKE lv_abgsl              OR
                          value3      LIKE lv_abgsl ).
      IF sy-subrc <> 0.
        cv_wbs_rakey_flag = abap_true.
      ENDIF.
    ENDIF.
  ELSE.
    cv_wbs_rakey_flag = abap_true.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CHECK_WBS_RAKEY_IC
*&---------------------------------------------------------------------*
FORM check_wbs_rakey_ic CHANGING cv_group_rakey_ic.

  DATA lv_lower_level TYPE ps_posid.

  DATA(lt_table_rakey) = lt_table.

  SORT lt_table_rakey BY pspid ASCENDING stufe ASCENDING.

  READ TABLE lt_table_rakey INTO DATA(ls_table_rakey)
                            WITH KEY pspid = ls_table-pspid.
  CHECK sy-subrc = 0.
  DATA(lv_tabix_wbs) = sy-tabix + 1.

  LOOP AT lt_table_rakey INTO DATA(ls_table_child) FROM lv_tabix_wbs.
*Lower Level
    IF ls_table_child-stufe > ls_table_rakey-stufe.
      lv_lower_level = ls_table_child-pspid.
      EXIT.
    ENDIF.
  ENDLOOP.
  IF NOT lv_lower_level IS INITIAL.
    CLEAR ls_table_rakey.
    READ TABLE lt_table_rakey INTO ls_table_rakey
                              WITH KEY pspid = lv_lower_level.
    IF sy-subrc = 0 AND ls_table_rakey-pbukr <> ls_table-pbukr.
      cv_group_rakey_ic = abap_true.
    ENDIF.
  ENDIF.

ENDFORM.


*&---------------------------------------------------------------------*
*&  Include           MZWBSI01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0100  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
 MODULE user_command_0100 INPUT.

*Project Type
*   CASE abap_true.
*     WHEN lv_proj1.
*       lv_proj_type = 'CZ'.
*     WHEN lv_proj2.
*       lv_proj_type = 'CI'.
*     WHEN lv_proj3.
*       lv_proj_type = 'TC'.
*     WHEN OTHERS.
*   ENDCASE.
   lv_proj_type = zwbs_header-proj_type.

   IF lv_rb2 IS NOT INITIAL OR
      lv_rb3 IS NOT INITIAL OR
      lv_rb4 IS NOT INITIAL.
*     IF lv_proj3 IS INITIAL.
     IF lv_proj_type NE 'TC' AND NOT lv_project IS INITIAL.
       SELECT SINGLE COUNT(*) FROM zwbs_proj_type
                              WHERE proj_type = lv_project+0(2).
       IF sy-subrc = 0.
         lv_proj_type = lv_project+0(2).
       ELSE.
         lv_proj_type = 'TC'.
       ENDIF.
     ENDIF.
   ENDIF.

   CASE ok_code.
     WHEN 'SOP'.
       CLEAR lv_url.
*      CONCATENATE text-s01 text-s02 text-s03 INTO lv_url.
       lv_url = text-s04.
       PERFORM show_dms_link USING lv_url.
     WHEN 'NEXT'.
       PERFORM process_data.
     WHEN 'PRJTY'.
       PERFORM process_action.
     WHEN OTHERS.
   ENDCASE.

 ENDMODULE.                 " USER_COMMAND_0100  INPUT
*&--------------------------------------------------------------------*
*&      Module  EXIT_COMMAND  INPUT
*&--------------------------------------------------------------------*
*       text
*---------------------------------------------------------------------*
 MODULE exit_command INPUT.

   CASE ok_code.
     WHEN 'BACK'.
       PERFORM clear_proj_buffer.
       IF lv_wf_flag IS INITIAL AND
          sy-tcode   EQ 'ZCJ01'.
         LEAVE TO SCREEN 0.
       ELSE.
         LEAVE PROGRAM.
       ENDIF.
     WHEN 'EXIT' OR 'CANCEL'.
       CLEAR lv_answer.
       CALL FUNCTION 'POPUP_TO_CONFIRM'
         EXPORTING
           titlebar              = 'Information'
           text_question         =
                                   'Changes will be lost. Do you want to Continue?'
           text_button_1         = 'Yes'
           icon_button_1         = 'ICON_OKAY'
           text_button_2         = 'No'
           icon_button_2         = 'ICON_CANCEL'
           display_cancel_button = space
         IMPORTING
           answer                = lv_answer
         EXCEPTIONS
           text_not_found        = 1
           OTHERS                = 2.
       IF sy-subrc <> 0.
* Implement suitable error handling here
       ENDIF.
       CHECK lv_answer = 1.
       PERFORM clear_proj_buffer.
       LEAVE PROGRAM.
   ENDCASE.

 ENDMODULE.                 " EXIT_COMMAND  INPUT
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0300  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
 MODULE user_command_0300 INPUT.

   CLEAR:lv_bunit,lv_profid.

   lv_bunit  = zwbs_proj_templ-b_unit.
   lv_profid = zwbs_proj_tem_tc-profidproj.
   " lv_ir     = zwbs_proj_tem_tc-izwek.

 ENDMODULE.                 " USER_COMMAND_0300  INPUT
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0400  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
 MODULE user_command_0400 INPUT.

   CASE ok_code.
     WHEN 'ENTER'.
       PERFORM screen_data.
       IF lv_no_budget = 'X'.
         CALL TRANSACTION 'ZCJ00'.
       ENDIF.
     WHEN 'ATTACH'.
       PERFORM attach_document.
     WHEN 'SAVE'.
       PERFORM save_data.
     WHEN 'CANCEL_REQ'.
       PERFORM cancel_request.
     WHEN 'SUBMIT'.
*       IF lv_proj3 IS NOT INITIAL.
       IF lv_proj_type = 'TC'.
         IF lv_message IS NOT INITIAL.
           MESSAGE lv_message TYPE 'E'.
         ELSEIF lv_message1 IS NOT INITIAL.
           MESSAGE lv_message1 TYPE 'E'.
         ELSEIF lv_message2 IS NOT INITIAL.
           MESSAGE lv_message2 TYPE 'E'.
         ELSEIF lv_msg_clsd_wbs IS NOT INITIAL.
           MESSAGE lv_msg_clsd_wbs TYPE 'E'.
         ELSEIF lv_msg_diff_wbs IS NOT INITIAL.
           MESSAGE lv_msg_diff_wbs TYPE 'E'.
         ELSEIF lv_msg_miss_wbs IS NOT INITIAL.
           MESSAGE lv_msg_miss_wbs TYPE 'E'.
         ELSEIF lv_msg_curr IS NOT INITIAL.
           MESSAGE lv_msg_curr TYPE 'E'.
         ENDIF.
         IF zwbs_header-request IS INITIAL.
           MESSAGE 'Attachment is Mandatory' TYPE 'E'.
         ELSE.
           DATA : wa_object       TYPE sibflporb,
                  int_rel_options TYPE obl_t_relt,
                  wa_rel_options  TYPE obl_s_relt,
                  int_links       TYPE obl_t_link,
                  wa_links        TYPE obl_s_link.

           wa_rel_options-low = 'ATTA'. "" Attachemnts
           wa_rel_options-sign = 'I'.
           wa_rel_options-option = 'EQ'.
           APPEND wa_rel_options TO int_rel_options.

           wa_object-instid = zwbs_header-request.
           wa_object-typeid = 'Z_WBS'. "" PR
           wa_object-catid  = 'BO'. "" Business Object
           REFRESH int_links[].

           TRY.
               CALL METHOD cl_binary_relation=>read_links_of_binrels
                 EXPORTING
                   is_object           = wa_object          " Start object
                   it_relation_options = int_rel_options    " Link Types
                   ip_role             = 'GOSAPPLOBJ'       " Role type
                 IMPORTING
                   et_links            = int_links.         " Table with Relationship Records

             CATCH cx_obl_parameter_error. " Incorrect Calling of Interface
             CATCH cx_obl_internal_error.  " Internal Error of Relationship Service
             CATCH cx_obl_model_error.     " Error with Model Roles
           ENDTRY.
           IF int_links IS INITIAL.
             MESSAGE 'Attachment is Mandatory' TYPE 'E'.
           ENDIF.
         ENDIF.
       ENDIF.
*       IF lv_proj3 IS NOT INITIAL.
       IF lv_proj_type = 'TC'.
         DATA(lt_table_tmp) = lt_table.
         SORT lt_table_tmp BY stufe DESCENDING.
       ENDIF.
       IF lt_table IS INITIAL.
         ""* Changes by AKOTA for CR 668561
         CALL FUNCTION 'POPUP_TO_INFORM'
           EXPORTING
             titel = 'Project/WBS Request'
             txt1  = 'Request cannot be submitted with no WBS elements'
             txt2  = ''.
       ELSE.
         CLEAR: lv_flag.
         LOOP AT lt_table INTO ls_table.
           IF ls_table-pspid IS INITIAL.
             lv_flag = 'X'.
             CALL FUNCTION 'POPUP_TO_INFORM'
               EXPORTING
                 titel = 'Project/WBS Request'
                 txt1  = 'Request cannot be submitted with blank WBS elements'
                 txt2  = ''.
             EXIT.
           ENDIF.
         ENDLOOP.
         IF lv_flag IS INITIAL.
*          PERFORM validate_data. " Changes by AKOTA for EiCR 729491
           PERFORM submit_data.
         ENDIF.
         ""* Changes by AKOTA for CR 668561
       ENDIF.
     WHEN 'DELETE'.
       CLEAR:lv_text,lv_answer.
       CONCATENATE text-005
                   zwbs_header-request INTO lv_text SEPARATED BY space.
       CALL FUNCTION 'POPUP_TO_CONFIRM'
         EXPORTING
           titlebar              = 'Project/WBS Request'
           text_question         = lv_text
           text_button_1         = 'Yes'
           icon_button_1         = 'ICON_OKAY'
           text_button_2         = 'No'
           icon_button_2         = 'ICON_CANCEL'
           display_cancel_button = ' '
         IMPORTING
           answer                = lv_answer
         EXCEPTIONS
           text_not_found        = 1
           OTHERS                = 2.
       IF sy-subrc <> 0.
* Implement suitable error handling here
       ENDIF.
       CHECK lv_answer = 1.
       PERFORM delete_data.
     WHEN 'APPROVE'.
*       IF lv_proj3 = 'X' OR gv_capex = 'X'.
       IF lv_proj_type = 'TC' OR gv_capex = 'X'.
         IF lv_message IS NOT INITIAL.
           MESSAGE lv_message TYPE 'E'.
         ELSEIF lv_message1 IS NOT INITIAL.
           MESSAGE lv_message1 TYPE 'E'.
         ELSEIF lv_message2 IS NOT INITIAL.
           MESSAGE lv_message2 TYPE 'E'.
         ENDIF.
       ENDIF.
       PERFORM approve_data.
     WHEN 'REJECT'.
       DATA: lt_text1 TYPE catsxt_longtext_itab.
       CALL FUNCTION 'CATSXT_SIMPLE_TEXT_EDITOR'
         EXPORTING
           im_title = 'Rejection Remarks'
*          IM_DISPLAY_MODE       = ' '
*          IM_START_COLUMN       = 10
*          IM_START_ROW          = 10
         CHANGING
           ch_text  = lt_text1.

       IF lt_text1 IS INITIAL.
         MESSAGE 'Please type rejection reason in the Remark area below' TYPE 'E'.
       ELSE.
         EXPORT lt_text1 = lt_text1 TO MEMORY ID 'REJECT'.
       ENDIF.

*      IF lt_text IS INITIAL.
*        MESSAGE 'Please type rejection reason in the Remark area below' TYPE 'E'.
*      ELSE.
*        EXPORT lt_text = lt_text TO MEMORY ID 'REJECT'.
*      ENDIF.
       PERFORM reject_data.
     WHEN 'SOP'.
       CLEAR lv_url.
*      CONCATENATE text-s01 text-s02 text-s03 INTO lv_url.
       lv_url = text-s04.
       PERFORM show_dms_link USING lv_url.
     WHEN 'LOG'.
       PERFORM show_log.
     WHEN 'DOWNLOAD'.
       PERFORM download.
     WHEN 'UPLOAD'.
       PERFORM upload.
     WHEN 'APPR_LOG'.
       PERFORM show_approval_log.
   ENDCASE.

 ENDMODULE.                 " USER_COMMAND_0400  INPUT

*&SPWIZARD: INPUT MODULE FOR TC 'TC_WBS'. DO NOT CHANGE THIS LINE!
*&SPWIZARD: MODIFY TABLE
 MODULE tc_wbs_modify INPUT.

   CLEAR ls_temp.
   ls_temp = ls_table.

   CLEAR:lv_error,ls_table.
   MOVE-CORRESPONDING zwbs_item TO ls_table.
   ls_table-pspid_new = ls_temp-pspid_new.
   ls_table-long_text = ls_temp-long_text.
   ls_table-updkz     = ls_temp-updkz.
   ls_table-status    = ls_temp-status.
   ls_table-stat_curr = ls_temp-stat_curr.
*Handle IBP Flags
   ls_table-zibpflag  = ls_temp-zibpflag.
   ls_table-zibpflgmc = ls_temp-zibpflgmc.

*Register Changed Records
   IF zwbs_header-type EQ 2 AND ls_temp <> ls_table.
     IF ls_table-updkz = 'I'.
       ls_table-zchange = 'I'.
     ELSE.
       IF ls_table-zchange = 'I'.
* Do Nothing..!
       ELSE.
         ls_table-zchange = 'U'.
       ENDIF.
     ENDIF.
   ENDIF.

*Default Values in the table
   PERFORM assign_table_values USING space.

   MODIFY lt_table FROM ls_table
                   INDEX tc_wbs-current_line.
   IF sy-subrc <> 0." AND NOT ls_table-stufe IS INITIAL.
     APPEND ls_table TO lt_table.
   ENDIF.

*Validate and Update Data
*  PERFORM validate_data.

 ENDMODULE.

*&SPWIZARD: INPUT MODUL FOR TC 'TC_WBS'. DO NOT CHANGE THIS LINE!
*&SPWIZARD: MARK TABLE
 MODULE tc_wbs_mark INPUT.
   DATA: g_tc_wbs_wa2 LIKE LINE OF lt_table.
   IF tc_wbs-line_sel_mode = 1 AND ls_table-select = 'X'.
     LOOP AT lt_table INTO g_tc_wbs_wa2
                      WHERE select = 'X'.
       g_tc_wbs_wa2-select = ''.
       MODIFY lt_table FROM g_tc_wbs_wa2
                       TRANSPORTING select.
     ENDLOOP.
   ENDIF.
   MODIFY lt_table FROM ls_table
                   INDEX tc_wbs-current_line
                   TRANSPORTING select.
 ENDMODULE.

*&SPWIZARD: INPUT MODULE FOR TC 'TC_WBS'. DO NOT CHANGE THIS LINE!
*&SPWIZARD: PROCESS USER COMMAND
 MODULE tc_wbs_user_command INPUT.

   PERFORM clear_fcode.

   ok_code = sy-ucomm.

   CHECK lv_error IS INITIAL.
*Validate and Update Data
   PERFORM validate_data.
   PERFORM clear_fcode.

   CHECK lv_error IS INITIAL.
*Table Operations
   PERFORM user_ok_tc USING    'TC_WBS'
                               'LT_TABLE'
                               'SELECT'
                      CHANGING ok_code.
   sy-ucomm = ok_code.

 ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0500  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
 MODULE user_command_0500 INPUT.

 ENDMODULE.                 " USER_COMMAND_0500  INPUT
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0600  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
 MODULE user_command_0600 INPUT.

   PERFORM get_text.

 ENDMODULE.                 " USER_COMMAND_0600  INPUT
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0700  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
 MODULE user_command_0700 INPUT.

   PERFORM get_request_data.

 ENDMODULE.                 " USER_COMMAND_0700  INPUT
*&---------------------------------------------------------------------*
*&      Module  GET_ABGSL  INPUT
*&---------------------------------------------------------------------*
 MODULE get_abgsl INPUT.

   TYPES:BEGIN OF ts_abgsl,
           abgsl TYPE abgr_schl,
           texta TYPE kkatext,
         END OF ts_abgsl.

   DATA:lt_abgsl TYPE STANDARD TABLE OF ts_abgsl.

   CLEAR:ls_temp,lv_sline.

   GET CURSOR LINE lv_sline.
   IF tc_wbs-top_line + lv_sline - 1 > tc_wbs-lines.
     lv_sline = tc_wbs-lines.
   ELSE.
     lv_sline = tc_wbs-top_line + lv_sline - 1.
   ENDIF.

   SELECT a~abgsl a~texta INTO TABLE lt_abgsl
                          FROM tkkad AS a INNER JOIN zwbs_proj_rakey AS b
                          ON a~abgsl = b~abgsl
                          WHERE a~spras     = lc_spras AND
                                b~proj_type = lv_proj_type .
   IF NOT lt_abgsl IS INITIAL.
     CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
       EXPORTING
         retfield    = 'ABGSL'
         dynpprog    = sy-repid
         dynpnr      = sy-dynnr
         dynprofield = 'ZWBS_ITEM-ABGSL'
         value_org   = 'S'
       TABLES
         value_tab   = lt_abgsl.
     IF sy-subrc <> 0.
     ENDIF.
   ENDIF.

 ENDMODULE.                 " GET_ABGSL  INPUT
*&---------------------------------------------------------------------*
*&      Module  GET_STATUS  INPUT
*&---------------------------------------------------------------------*
 MODULE get_status INPUT.

   TYPES:BEGIN OF ts_status,
           status TYPE j_txt04,
         END OF ts_status.

   DATA lt_status TYPE STANDARD TABLE OF ts_status.

   CLEAR:ls_temp,lv_sline.

   GET CURSOR LINE lv_sline.
   IF tc_wbs-top_line + lv_sline - 1 > tc_wbs-lines.
     lv_sline = tc_wbs-lines.
   ELSE.
     lv_sline = tc_wbs-top_line + lv_sline - 1.
   ENDIF.
   READ TABLE lt_table INTO ls_temp INDEX lv_sline.
   SELECT stat_new FROM zwbs_status INTO TABLE lt_status
                                    WHERE type      = lv_type AND
                                          stat_curr = ls_temp-stat_curr.
   IF NOT lt_status IS INITIAL.
     CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
       EXPORTING
         retfield    = 'STATUS'
         dynpprog    = sy-repid
         dynpnr      = sy-dynnr
         dynprofield = 'ZWBS_ITEM-STAT_NEW'
         value_org   = 'S'
       TABLES
         value_tab   = lt_status.
     IF sy-subrc <> 0.
     ENDIF.
   ENDIF.

 ENDMODULE.                 " GET_STATUS  INPUT
*&--------------------------------------------------------------------*
*&      Module  USER_COMMAND_0800  INPUT
*&--------------------------------------------------------------------*
 MODULE user_command_0800 INPUT.
   CLEAR: sy-ucomm.
   LEAVE TO SCREEN 0.

 ENDMODULE.                 " USER_COMMAND_0800  INPUT

*&SPWIZARD: INPUT MODULE FOR TC 'TC_CAPEX'. DO NOT CHANGE THIS LINE!
*&SPWIZARD: MODIFY TABLE
 MODULE tc_capex_modify INPUT.
   DATA:
     ls_useridv    TYPE soudnamei1,
     ls_userida    TYPE soudnamei1,
     ls_user_datav TYPE soudatai1,
     ls_user_dataa TYPE soudatai1,
     lv_budget     TYPE char20,
     lv_budget_c   TYPE char20.
*   DATA: lt_table5 TYPE STANDARD TABLE OF ts_table,
*         lt_table4 TYPE STANDARD TABLE OF ts_table,
*         lt_table3 TYPE STANDARD TABLE OF ts_table,
*         lt_table2 TYPE STANDARD TABLE OF ts_table,
*         lt_table1 TYPE STANDARD TABLE OF ts_table.

*   DATA: lv_pspid_len5 TYPE numc2.
*   DATA: lv_pspid_len4 TYPE numc2.
*   DATA: lv_pspid_len3 TYPE numc2.
*   DATA: lv_pspid_len2 TYPE numc2.
*   DATA: lv_pspid_len1 TYPE numc2.
*   DATA: lv_pspid_len_eende TYPE numc2.

   zwbs_item-pspid_new = ls_table-pspid_new = ls_table-pspid.
   IF ls_table-status IS INITIAL.
     zwbs_item-werks = ls_table-werks = zwbs_header-werks.
   ENDIF.
   CLEAR ls_temp.
   ls_temp = ls_table.

   zwbs_item-prctr = ls_table-prctr.
   zwbs_item-posid = ls_table-posid.
   zwbs_item-pgsbr = zwbs_header-vgsbr.
   IF ls_table-status IS INITIAL.
     zwbs_item-izwek = zwbs_header-izwek.
   ENDIF.
   MOVE-CORRESPONDING zwbs_item TO ls_table. "g_tc_capex_wa.
   IF ls_table-vernr IS NOT INITIAL.
     PERFORM responsible_person_line.
   ENDIF.

   IF ls_table-astnr IS NOT INITIAL.
     PERFORM applicant_number_line.
   ENDIF.

*   READ TABLE lt_table INTO DATA(ls_tab_eende) WITH KEY stufe = '2'.
*   IF sy-subrc = 0 AND ls_tab_eende-eende IS NOT INITIAL.
*     IF ls_table-stufe > 2.
*       zwbs_item-eende = ls_table-eende = ls_tab_eende-eende.
*     ENDIF.
*   ENDIF.

*   CLEAR:lv_pspid_len_eende , lv_pspid_new2.
*   LOOP AT lt_table ASSIGNING FIELD-SYMBOL(<wa1>).
*     IF <wa1>-stufe = '5'.
*     ELSEIF <wa1>-stufe = '2'.
*       lv_pspid_new2 = <wa1>-pspid.
*       CALL FUNCTION 'FTR_CORR_SWIFT_DELETE_ENDZERO'
*         CHANGING
*           c_value = lv_pspid_new2.
*       lv_pspid_len_eende = strlen( lv_pspid_new2 ).
*     ENDIF.
*   ENDLOOP.
*
*   CLEAR: ls_frct_2, ls_frct_3.
*   LOOP AT lt_table INTO ls_frct_2 WHERE stufe = '2'.
*     LOOP AT lt_table INTO ls_frct_3 WHERE stufe > '2'.
*       IF ls_frct_3-pspid+0(lv_pspid_len_eende) = ls_frct_2-pspid+0(lv_pspid_len_eende).
*         ls_frct_3-eende = ls_frct_2-eende.
*
*         IF ls_frct_3-eende IS NOT INITIAL.
*           MODIFY lt_table FROM ls_frct_3 TRANSPORTING eende.
*         ENDIF.
*       ENDIF.
*     ENDLOOP.
*   ENDLOOP.
   IF zwbs_header-type EQ 1.
     IF ls_table-stufe NE 1.
       ls_table-estrt = ls_table-plfaz.
     ENDIF.

     IF ls_table-stufe  = '2'.
       ls_table-eende = ls_table-plsez.
       IF ls_table-eende NE zwbs_item-eende.
         ls_table-eende = zwbs_item-eende.
       ENDIF.
     ENDIF.
   ENDIF.

   IF zwbs_header-type EQ 2.
     ls_table-estrt = ls_table-plfaz.
   ENDIF.
   IF ls_table-updkz = 'I'.
     ls_table-zinsert = zwbs_item-zinsert = 'X'.
   ENDIF.

*Register Changed Records
   IF zwbs_header-type EQ 2 AND ls_temp <> ls_table.
     IF ls_table-updkz = 'I'.
       ls_table-zchange = 'I'.
     ELSE.
       IF ls_table-zchange = 'I'.
* Do Nothing..!
       ELSE.
         ls_table-zchange = 'U'.
       ENDIF.
     ENDIF.
   ENDIF.


   MODIFY lt_table
     FROM ls_table
     INDEX tc_capex-current_line.

 ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  TC_CAPEX_USER_COMMAND  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
 MODULE tc_capex_user_command INPUT.

*  PERFORM business_area.

   PERFORM clear_fcode.

   ok_code = sy-ucomm.

   CHECK lv_error IS INITIAL.
*Validate and Update Data
   PERFORM validate_data.
   PERFORM clear_fcode.

   CHECK lv_error IS INITIAL.
*Table Operations
   PERFORM user_ok_tc USING    'TC_CAPEX'
                               'LT_TABLE'
                               'SELECT'
                      CHANGING ok_code.
   sy-ucomm = ok_code.

 ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0900  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
 MODULE user_command_0900 INPUT.

 ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  GET_AKSTL  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
 MODULE get_akstl INPUT.


   DATA: lv_datum_1 TYPE char8.
   CLEAR:ls_temp,lv_sline.
   DATA: lv_counter TYPE numc3.

   GET CURSOR LINE lv_sline.
   IF tc_capex-top_line + lv_sline - 1 > tc_capex-lines.
     lv_sline = tc_capex-lines.
   ELSE.
     lv_sline = tc_capex-top_line + lv_sline - 1.
   ENDIF.

*  SELECT DISTINCT a~kostl b~ktext INTO TABLE lt_kostl
*                         FROM csks AS a INNER JOIN cskt AS b
*                         ON a~kostl = b~kostl
*WHERE a~datbi     > sy-datum AND " zwbs_header-plsez AND
*                               a~bukrs     = zwbs_header-vbukr AND
*                               a~gsber     = zwbs_header-vgsbr AND
*                               b~spras     = lc_spras.



   CONCATENATE sy-datum+0(4) '12' '31' INTO lv_datum_1.
   lv_datum1 = sy-datum.
   lv_datum1 = lv_datum_1.

   IF lv_counter IS INITIAL.
     SELECT kostl
        FROM csks
        INTO TABLE @DATA(lt_csks)
        WHERE datbi GE @lv_datum1
            AND bukrs = @zwbs_header-vbukr
            AND gsber = @zwbs_header-vgsbr.
     lv_counter = 1.
   ELSE.
     READ TABLE lt_table INTO DATA(ls_table_akstl) INDEX lv_sline.

     SELECT kostl
         FROM csks
         INTO TABLE @lt_csks
         WHERE datbi GE @lv_datum1
             AND bukrs = @ls_table_akstl-pbukr "@zwbs_header-vbukr
             AND gsber = @ls_table_akstl-pgsbr. "@zwbs_item-pgsbr.
   ENDIF.
   IF lt_csks IS NOT INITIAL.
     SELECT kostl, ktext INTO TABLE @DATA(lt_cskt) FROM cskt
        FOR ALL ENTRIES IN @lt_csks
       WHERE kostl = @lt_csks-kostl
        AND  spras = @lc_spras.
   ENDIF.
   REFRESH: lt_kostl.

   LOOP AT lt_csks INTO DATA(ls_csks1).
     READ TABLE lt_cskt INTO DATA(ls_cskt) WITH KEY kostl =
     ls_csks1-kostl.
     IF sy-subrc = 0.
       MOVE ls_csks1-kostl TO ls_kostl-kostl.
       MOVE ls_cskt-ktext TO ls_kostl-ktext.
       APPEND ls_kostl TO lt_kostl.
       CLEAR: ls_kostl.
     ENDIF.

   ENDLOOP.
*  DELETE ADJACENT DUPLICATES FROM lt_kostl.
   IF NOT lt_kostl IS INITIAL.
     CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
       EXPORTING
         retfield    = 'KOSTL'
         dynpprog    = sy-repid
         dynpnr      = sy-dynnr
         dynprofield = 'ZWBS_ITEM-AKSTL'
         value_org   = 'S'
       TABLES
         value_tab   = lt_kostl.
     IF sy-subrc <> 0.
     ENDIF.
   ENDIF.

 ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  GET_VGSBR  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
 MODULE get_vgsbr INPUT.

   TYPES:BEGIN OF ts_vgsbr,
           gsber TYPE gsber,
*          ktext TYPE ktext,
         END OF ts_vgsbr.

   DATA:lt_vgsbr TYPE STANDARD TABLE OF ts_vgsbr,
        lt_gjahr TYPE rseloption,
        ls_gjahr TYPE rsdsselopt.

*   IF lv_proj3 IS NOT INITIAL.
   IF lv_proj_type = 'TC'.
     ls_gjahr-sign  = 'I'.
     ls_gjahr-option = 'EQ'.
     ls_gjahr-low = sy-datum+0(4).
     ls_gjahr-high = sy-datum+0(4) + 1.

     APPEND ls_gjahr TO lt_gjahr.
     CLEAR: ls_gjahr.

     SELECT gsber FROM t9f09
        INTO TABLE lt_vgsbr
       WHERE gjahr IN lt_gjahr
        AND  bukrs = zwbs_header-vbukr.

     IF NOT lt_vgsbr IS INITIAL.
       CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
         EXPORTING
           retfield    = 'VGSBR'
           dynpprog    = sy-repid
           dynpnr      = sy-dynnr
           dynprofield = 'ZWBS_header-VGSBR'
           value_org   = 'S'
         TABLES
           value_tab   = lt_vgsbr.
       IF sy-subrc <> 0.
       ENDIF.
     ENDIF.
     REFRESH: lt_gjahr.
   ELSE.
     SELECT gsber FROM tgsb
        INTO TABLE lt_vgsbr.


     IF NOT lt_vgsbr IS INITIAL.
       CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
         EXPORTING
           retfield    = 'VGSBR'
           dynpprog    = sy-repid
           dynpnr      = sy-dynnr
           dynprofield = 'ZWBS_ITEM-VGSBR'
           value_org   = 'S'
         TABLES
           value_tab   = lt_vgsbr.
       IF sy-subrc <> 0.
       ENDIF.
     ENDIF.

   ENDIF.
 ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  ASSIGN_BA  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
 MODULE assign_ba INPUT.

   DATA:ls_userid1    TYPE soudnamei1,
        ls_user_data1 TYPE soudatai1.

   DATA:lv_prctr_cpx1      TYPE char4,
        lv_prctr_cpx1_conv TYPE prctr.
*   IF lv_proj3 IS NOT INITIAL OR gv_capex IS NOT INITIAL.
   IF lv_proj_type = 'TC' OR gv_capex IS NOT INITIAL.
     lv_prctr_cpx1 = zwbs_header-vgsbr.
     SHIFT lv_prctr_cpx1 LEFT DELETING LEADING '0'.
     CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
       EXPORTING
         input  = lv_prctr_cpx1
       IMPORTING
         output = lv_prctr_cpx1_conv.
     zwbs_item-prctr    = lv_prctr_cpx1_conv.
     zwbs_header-prctr  = lv_prctr_cpx1_conv.
     zwbs_item-pgsbr    = zwbs_header-vgsbr.
     ls_userid1-sapname =  sy-uname.
** get the user FUll name.
     CALL FUNCTION 'SO_USER_READ_API1'
       EXPORTING
         user            = ls_userid1
*        PREPARE_FOR_FOLDER_ACCESS       = ' '
       IMPORTING
         user_data       = ls_user_data1
       EXCEPTIONS
         user_not_exist  = 1
         parameter_error = 2
         x_error         = 3
         OTHERS          = 4.
     IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
     ELSE.
       lv_fullname    = ls_user_data1-fullname.
     ENDIF.
   ENDIF.

 ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  GET_IMPRF  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
 MODULE get_imprf INPUT.
   TYPES:BEGIN OF ts_imprf,
           ivpro  TYPE im_profil,
           invtxt TYPE im_invtxt,
         END OF ts_imprf.

   DATA:lt_imprf TYPE STANDARD TABLE OF ts_imprf.

   CLEAR:ls_temp,lv_sline.

   GET CURSOR LINE lv_sline.
   IF tc_capex-top_line + lv_sline - 1 > tc_capex-lines.
     lv_sline = tc_capex-lines.
   ELSE.
     lv_sline = tc_capex-top_line + lv_sline - 1.
   ENDIF.

   SELECT ivpro
          invtxt FROM taprft INTO TABLE lt_imprf WHERE
                                       spras  = lc_spras.
   IF NOT lt_imprf IS INITIAL.
     CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
       EXPORTING
         retfield    = 'IVPRO'
         dynpprog    = sy-repid
         dynpnr      = sy-dynnr
         dynprofield = 'ZWBS_ITEM-IMPRF'
         value_org   = 'S'
       TABLES
         value_tab   = lt_imprf.
     IF sy-subrc <> 0.
     ENDIF.
   ENDIF.

 ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  TC_CAPEX_MARK  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
 MODULE tc_capex_mark INPUT.
   DATA: g_tc_capex_wa2 LIKE LINE OF lt_table.
   IF tc_capex-line_sel_mode = 1
   AND ls_table-select = 'X'.
     LOOP AT lt_table INTO g_tc_capex_wa2
       WHERE select = 'X'.
       g_tc_capex_wa2-select = ''.
       MODIFY lt_table
         FROM g_tc_capex_wa2
         TRANSPORTING select.
     ENDLOOP.
   ENDIF.
   MODIFY lt_table
     FROM ls_table
     INDEX tc_capex-current_line
     TRANSPORTING select.
 ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  GET_POSID  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
 MODULE get_posid INPUT.
   TYPES:BEGIN OF ts_impr,
           posid TYPE im_posid,
           "          posnr TYPE im_posnr,
           post1 TYPE im_post1, "invtxt TYPE im_invtxt,
         END OF ts_impr.

   DATA:lt_impr1 TYPE STANDARD TABLE OF ts_impr,
        ls_impr2 TYPE ts_impr.
   DATA: lv_prctr_impr TYPE impr-prctr.
   DATA: lv_counterc TYPE numc3.
   CLEAR:ls_temp,lv_sline.

   GET CURSOR LINE lv_sline.
   IF tc_capex-top_line + lv_sline - 1 > tc_capex-lines.
     lv_sline = tc_capex-lines.
   ELSE.
     lv_sline = tc_capex-top_line + lv_sline - 1.
   ENDIF.

*  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
*    EXPORTING
*      input  = zwbs_header-prctr
*    IMPORTING
*      output = lv_prctr_impr.

   IF zwbs_header-izwek = 'LS'.
     IF lv_counterc IS INITIAL.
       SELECT posnr, posid FROM impr
           INTO TABLE @DATA(lt_impr)
           WHERE izwek  = @zwbs_header-izwek
             AND bukrs  = @zwbs_header-vbukr
             "AND gsber  = @zwbs_header-vgsbr
             AND usr11  = @space.

       lv_counterc = 1.
     ELSE.

       READ TABLE lt_table INTO DATA(ls_table_posid) INDEX lv_sline.
       SELECT posnr, posid FROM impr
         INTO TABLE @lt_impr
         WHERE izwek  = @zwbs_header-izwek
           AND bukrs  = @ls_table_posid-pbukr
         "AND gsber  = @ls_table_posid-pgsbr
         AND usr11  = @space.

     ENDIF.
   ELSE.
     IF lv_counterc IS INITIAL.
       SELECT posnr, posid FROM impr
           INTO TABLE @lt_impr
           WHERE izwek  = @zwbs_header-izwek
             AND bukrs  = @zwbs_header-vbukr
             AND gsber  = @zwbs_header-vgsbr
             AND usr11  = @space.

       lv_counterc = 1.
     ELSE.

       READ TABLE lt_table INTO ls_table_posid INDEX lv_sline.
       SELECT posnr, posid FROM impr
         INTO TABLE @lt_impr
         WHERE izwek  = @zwbs_header-izwek
           AND bukrs  = @ls_table_posid-pbukr
         AND gsber  = @ls_table_posid-pgsbr
         AND usr11  = @space.

     ENDIF.
   ENDIF.

   IF lt_impr IS NOT INITIAL.
     SELECT posnr,  post1 FROM impu
       INTO TABLE @DATA(lt_impu)
       FOR ALL ENTRIES IN @lt_impr
       WHERE spras = 'E'
        AND  posnr = @lt_impr-posnr.
   ENDIF.

   REFRESH: lt_impr1.
   LOOP AT lt_impr INTO DATA(ls_impr).
     READ TABLE lt_impu INTO DATA(ls_impu) WITH KEY posnr = ls_impr-posnr
     .
     IF sy-subrc = 0.
       ls_impr2-posid = ls_impr-posid.
*      ls_impr2-posid = ls_impu-posnr.
       ls_impr2-post1 = ls_impu-post1.
       APPEND ls_impr2 TO lt_impr1.
       CLEAR: ls_impr2.
     ENDIF.
   ENDLOOP.

   IF NOT lt_impr IS INITIAL.
     CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
       EXPORTING
         retfield    = 'POSID'
         dynpprog    = sy-repid
         dynpnr      = sy-dynnr
         dynprofield = 'LS_TABLE-POSID'
         value_org   = 'S'
       TABLES
         value_tab   = lt_impr1.
     IF sy-subrc <> 0.
     ENDIF.
   ENDIF.
 ENDMODULE.
*&---------------------------------------------------------------------*
*&      Form  BUSINESS_AREA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
 FORM business_area .
   LOOP AT lt_table ASSIGNING FIELD-SYMBOL(<fs_table1>).
     <fs_table1>-pgsbr = zwbs_item-pgsbr.
     CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
       EXPORTING
         input  = zwbs_header-prctr
       IMPORTING
         output = zwbs_header-prctr.
     <fs_table1>-prctr = zwbs_item-prctr.
   ENDLOOP.
 ENDFORM.
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0810  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
 MODULE user_command_0810 INPUT.
   CLEAR: sy-ucomm.
   LEAVE TO SCREEN 0.
 ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  GET_IZWEK  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*


*&---------------------------------------------------------------------*
*&  Include           MZWBSO01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Module  STATUS_0100  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE status_0100 OUTPUT.

  PERFORM exlcude_fcode.

  SET PF-STATUS '100' EXCLUDING lt_fcode.
  SET TITLEBAR '100' WITH text-001.

  PERFORM screen_0100.

  PERFORM get_project_type_list.

ENDMODULE.                 " STATUS_0100  OUTPUT
*&---------------------------------------------------------------------*
*&      Module  STATUS_0200  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE status_0200 OUTPUT.

  DATA: l_html              TYPE STANDARD TABLE OF w3html
                            WITH DEFAULT KEY INITIAL SIZE 0
                            WITH HEADER LINE,
        html_line           LIKE LINE OF l_html,
        lt_html_lines       TYPE STANDARD TABLE OF tline,
        ls_html_lines       TYPE tline,
        g_current_url(1024),
        g_url(1024).

  IF lo_html_control IS INITIAL.
    CREATE OBJECT lo_cont_html
      EXPORTING
        container_name = 'HTML_CONTROL'.

    CREATE OBJECT lo_html_control
      EXPORTING
        parent = lo_cont_html.
    IF sy-subrc NE 0.
*
    ENDIF.

    FREE l_html.
    CLEAR html_line.

    CALL FUNCTION 'READ_TEXT'
      EXPORTING
        client                  = sy-mandt
        id                      = 'ST'
        language                = sy-langu
        name                    = 'ZWBS_ADD_INFO'
        object                  = 'TEXT'
*      IMPORTING
*       header                  = ls_header
      TABLES
        lines                   = lt_html_lines
      EXCEPTIONS
        id                      = 1
        language                = 2
        name                    = 3
        not_found               = 4
        object                  = 5
        reference_check         = 6
        wrong_access_to_archive = 7
        OTHERS                  = 8.
    IF sy-subrc <> 0.
    ENDIF.

    LOOP AT lt_html_lines INTO ls_html_lines.
      l_html = ls_html_lines-tdline.
      APPEND l_html.
    ENDLOOP.
*url leihen
    CALL METHOD lo_html_control->load_html_document
      EXPORTING
        document_id  = 'PMC_EXAMPLE1.HTML'
      IMPORTING
        assigned_url = g_current_url.
    IF sy-subrc <> 0.
** MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.

    g_url = g_current_url.

*daten_an_url_laden
*unsere programmlokale interne tabelle vom typ w3html
*enthaelt nun den html code der nun an die geliehene url aus dem
*web repository geladen wird ( merge )
    CALL METHOD lo_html_control->load_data
      EXPORTING
        url          = g_url
        type         = 'text'
        subtype      = 'html'
*       SIZE         = 0
      IMPORTING
        assigned_url = g_current_url
      CHANGING
        data_table   = l_html[].
    IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.
*am ende werden die daten auf dem screen prasentiert und stehen zur
*eingabe bereit
    g_url = g_current_url.
*daten_auf-screen_zeigen
    CALL METHOD lo_html_control->show_url
      EXPORTING
        url = g_url.
    IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
    ENDIF.
  ENDIF.

ENDMODULE.                 " STATUS_0200  OUTPUT
*&---------------------------------------------------------------------*
*&      Module  STATUS_0300  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE status_0300 OUTPUT.
*  SET PF-STATUS 'xxxxxxxx'.
*  SET TITLEBAR 'xxx'.

  PERFORM screen_0300.

  PERFORM get_investment_reason.

  PERFORM get_bunit_list.

  PERFORM get_tree_list.

  PERFORM show_tree_structure.

ENDMODULE.                 " STATUS_0300  OUTPUT
*&---------------------------------------------------------------------*
*&      Module  STATUS_0400  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE status_0400 OUTPUT.
  IMPORT gv_capex = gv_capex FROM MEMORY ID 'ZWBS_CAPEX'.
  IF ls_head-proj_type = 'TC'.
    gv_capex = 'X'.
  ENDIF.
  PERFORM exlcude_fcode.
  PERFORM screen_0400.
  SET PF-STATUS '400' EXCLUDING lt_fcode.

*Check for any errors on Header
  IF NOT lv_herror IS INITIAL.
    SET CURSOR FIELD lv_cursor.
    IF lv_cursor = 'ZWBS_HEADER-VGSBR'.
      MESSAGE s368(00) WITH 'Mismatch in Business Area &'
      'Profit Center'
                       DISPLAY LIKE 'W'.
    ELSEIF NOT lv_text IS INITIAL.
      MESSAGE s368(00) WITH lv_text 'is a required field'
                       DISPLAY LIKE 'E'.
    ENDIF.
  ENDIF.
*Clear User Commands
  DATA(zucomm) = sy-ucomm.
  CLEAR:ok_code,sy-ucomm.

ENDMODULE.                 " STATUS_0400  OUTPUT
*&---------------------------------------------------------------------*
*&      Module  START_GOS  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE start_gos OUTPUT.

* -- start GOS
  IF lo_gos IS NOT BOUND.
    IF NOT lv_dflag IS INITIAL OR
       NOT lv_sflag IS INITIAL OR
       sy-tcode = 'ZCJ03'.
      lv_rw_mode = 'D'.
    ELSE.
      lv_rw_mode = 'E'.
    ENDIF.
*    IF lv_proj3 IS NOT INITIAL.
*
*    ENDIF.
    PERFORM start_gos USING    zwbs_header-request
                               lv_rw_mode
                      CHANGING lo_gos.
  ENDIF.

ENDMODULE.                 " START_GOS  OUTPUT

*&SPWIZARD: OUTPUT MODULE FOR TC 'TC_WBS'. DO NOT CHANGE THIS LINE!
*&SPWIZARD: UPDATE LINES FOR EQUIVALENT SCROLLBAR
MODULE tc_wbs_change_tc_attr OUTPUT.

  FIELD-SYMBOLS <fs_cols> TYPE scxtab_column.

  DESCRIBE TABLE lt_table LINES tc_wbs-lines.

*Check for any errors
  IF NOT lv_error IS INITIAL AND lv_herror IS INITIAL.
    lv_tline = lv_tline - tc_wbs-top_line + 1.
    ""**Changes by AKOTA for CR 668561
    SET CURSOR FIELD lv_cursor LINE lv_tline.
    IF NOT lv_verror IS INITIAL.
      CASE lv_cursor.
        WHEN 'ZWBS_ITEM-PSPID'.
          MESSAGE s368(00) WITH 'The project number is wrong, '
                                'please add the correct project no'
                           DISPLAY LIKE 'E'.
        WHEN 'ZWBS_ITEM-PGSBR'.
          MESSAGE s368(00) WITH 'Mismatch in Business Area &'
                                'Profit Center'
                           DISPLAY LIKE 'E'.
        WHEN 'ZWBS_ITEM-POST1'.
          MESSAGE s368(00) WITH 'Mismatch in Project Description &'
                                'WBS Description'
                           DISPLAY LIKE 'E'.
        WHEN 'ZWBS_ITEM-ABGSL'.
          IF lv_raerror IS INITIAL.
            MESSAGE s022(zk) DISPLAY LIKE 'E'.
          ELSE.
            MESSAGE s368(00) WITH 'For IC Case Please maintain ZRA-24 '
                                  'in the Upper level'
                             DISPLAY LIKE 'E'.
          ENDIF.
        WHEN 'ZWBS_ITEM-ZASSET'.
          MESSAGE s368(00) WITH 'Asset Box is Deleted'
                           DISPLAY LIKE 'E'.
        WHEN 'ZWBS_ITEM-PRCTR'.
          IF NOT lv_pcasset_flag IS INITIAL.
            MESSAGE s368(00) WITH 'Asset Box Profit Center not coherent'
                                  'with WBS Profit Center'
                             DISPLAY LIKE 'E'.
          ELSE.
            MESSAGE s368(00) WITH 'Profit Center of WBS is not valid'
                                  'for the assigned Company Code'
                             DISPLAY LIKE 'E'.
          ENDIF.
        WHEN 'ZWBS_ITEM-GRPKZ'.
          CASE lv_grp_flag.
            WHEN 1.
              MESSAGE s368(00) WITH 'Maintain Grouping indicator'
                                    'on atleast one WBS element'
                               DISPLAY LIKE 'E'.
            WHEN 2 OR 3.
              MESSAGE s368(00) WITH 'Maintain Grouping indicator 1'
                                    'on only one WBS element'
                               DISPLAY LIKE 'E'.
            WHEN 4.
              MESSAGE s021(zk) DISPLAY LIKE 'E'.
            WHEN 5.
              MESSAGE s368(00) WITH 'For IC Case the grouping flag is expected'
                                    'only on below level'
                               DISPLAY LIKE 'E'.
            WHEN OTHERS.
          ENDCASE.
          CASE lv_agrp_flag.
            WHEN 1.
              MESSAGE s368(00) WITH 'Please select Template which has Automatic'
                                    'grouping flagged in order to use grouping 1'
                               DISPLAY LIKE 'E'.
            WHEN 2 OR 3.
              MESSAGE s368(00) WITH 'Maintain Grouping indicator 1 Only'
                               DISPLAY LIKE 'E'.
            WHEN OTHERS.
          ENDCASE.
        WHEN OTHERS.
          MESSAGE s368(00) WITH text-007 lv_text
                           DISPLAY LIKE 'E'.
      ENDCASE.
    ELSEIF NOT lv_wf_pos_flag IS INITIAL.
      MESSAGE s398(00) WITH 'Workflow not maintained for this Company Code'
                            'and Business Area,'
                            'please get in contact with Master Data Team'
                       DISPLAY LIKE 'E'.
    ELSEIF NOT lv_pcba_flag IS INITIAL.
      CASE lv_cursor.
*        WHEN 'ZWBS_ITEM-PGSBR'.
*          MESSAGE s368(00) WITH 'Business Area entered not coherent' 'with your Plant'
*                           DISPLAY LIKE 'E'.
        WHEN 'ZWBS_ITEM-PRCTR'.
          MESSAGE s368(00) WITH "'Profit Center not allowed' 'for the Company Code'
                                'Profit Center of WBS is not valid' 'for the assigned Company Code'
                           DISPLAY LIKE 'E'.
      ENDCASE.
    ELSEIF NOT lv_level_flag IS INITIAL.
      MESSAGE s368(00) WITH 'Missing Parent element for WBS' ls_table-pspid
                       DISPLAY LIKE 'E'.
    ELSEIF NOT lv_ag_flag IS INITIAL AND NOT lv_cerror IS INITIAL.
    ELSEIF NOT lv_text IS INITIAL.
      MESSAGE s368(00) WITH lv_text 'is a required field'
                       DISPLAY LIKE 'E'.
    ENDIF.
  ENDIF.
  CLEAR:lv_error,lv_verror,lv_herror,lv_grp_flag,lv_wf_pos_flag,
        lv_pcba_flag,lv_cerror,lv_raerror.

*Hide Columns for Regular Process
  ASSIGN tc_wbs-cols TO FIELD-SYMBOL(<lt_cols>).
  CASE zwbs_header-type.
    WHEN 1.
*Create Case
      LOOP AT <lt_cols> ASSIGNING <fs_cols>
                        WHERE screen-name = 'ZWBS_ITEM-ZCHANGE'  OR
                              screen-name = 'ZWBS_ITEM-ZCLOSE'   OR
                              screen-name = 'ZWBS_ITEM-ZUNCLOSE' OR
                              screen-name = 'LS_TABLE-STAT_CURR' OR
                              screen-name = 'ZWBS_ITEM-ZSTATUS'  OR
                              screen-name = 'ZWBS_ITEM-ACCEPT'   OR
                              screen-name = 'LS_TABLE-LONG_TEXT' OR
                              screen-name = 'COMMENTS_TEXT'.
        <fs_cols>-invisible = 1.
      ENDLOOP.
    WHEN 2.
*Change Case
      LOOP AT <lt_cols> ASSIGNING <fs_cols>
                        WHERE screen-name = 'ZWBS_ITEM-ZCLOSE'   OR
                              screen-name = 'ZWBS_ITEM-ZUNCLOSE' OR
                              screen-name = 'LS_TABLE-STAT_CURR' OR
                              screen-name = 'ZWBS_ITEM-ZSTATUS'  OR
                              screen-name = 'ZWBS_ITEM-ACCEPT'   OR
                              screen-name = 'LS_TABLE-LONG_TEXT' OR
                              screen-name = 'COMMENTS_TEXT' OR
*    Begin of Changes by LCHENNA for CR 797199
                              screen-name = 'ZWBS_ITEM-ZMAINT_SYS'.
        IF <fs_cols>-screen-name = 'ZWBS_ITEM-ZMAINT_SYS'.
          <fs_cols>-screen-input = 0.
* End of changes by LCHENNA for CR 797199
        ELSE.
          <fs_cols>-invisible = 1.
        ENDIF.
      ENDLOOP.
    WHEN 3.
*Close Case
      LOOP AT <lt_cols> ASSIGNING <fs_cols>
                        WHERE screen-name = 'ZWBS_ITEM-ZCHANGE'  OR
                              screen-name = 'ZWBS_ITEM-ZUNCLOSE' OR
                              screen-name = 'ZWBS_ITEM-ACCEPT'   OR
                              screen-name = 'LS_TABLE-LONG_TEXT' OR
                              screen-name = 'COMMENTS_TEXT' OR
*        Begin of changes by LCHENNA for CR 797199.
                              screen-name = 'ZWBS_ITEM-ZMAINT_SYS'.
*        End of changes by LCHENNA for CR 797199.
        IF <fs_cols>-screen-name = 'ZWBS_ITEM-ACCEPT'.
          IF zwbs_header-request IS INITIAL.
            <fs_cols>-invisible = 1.
          ENDIF.
* Begin of changes by LCHENNA for CR 797199
        ELSEIF <fs_cols>-screen-name = 'ZWBS_ITEM-ZMAINT_SYS'.
          <fs_cols>-screen-input = 0.
* End of changes by LCHENNA for CR 797199
        ELSE.
          <fs_cols>-invisible = 1.
        ENDIF.
      ENDLOOP.
    WHEN 4.
*Unclose Case
      LOOP AT <lt_cols> ASSIGNING <fs_cols>
                        WHERE screen-name = 'ZWBS_ITEM-ZCHANGE'  OR
                              screen-name = 'ZWBS_ITEM-ZCLOSE'   OR
                              screen-name = 'ZWBS_ITEM-ACCEPT'   OR
                              screen-name = 'LS_TABLE-LONG_TEXT' OR
                              screen-name = 'COMMENTS_TEXT' OR
                              screen-name = 'ZWBS_ITEM-ZMAINT_SYS'.
        IF <fs_cols>-screen-name = 'ZWBS_ITEM-ACCEPT'.
          IF zwbs_header-request IS INITIAL.
            <fs_cols>-invisible = 1.
          ENDIF.
* Begin of changes by LCHENNA for CR 797199
        ELSEIF <fs_cols>-screen-name = 'ZWBS_ITEM-ZMAINT_SYS'.
          <fs_cols>-screen-input = 0.
* End of changes by LCHENNA for CR 797199
        ELSE.
          <fs_cols>-invisible = 1.
        ENDIF.
      ENDLOOP.
  ENDCASE.

*DO NOT Display PlanView fields for SAP Requests
  IF zwbs_header-zprj_code_pv IS INITIAL.
    LOOP AT <lt_cols> ASSIGNING <fs_cols>
                      WHERE screen-name = 'ZWBS_ITEM-ZSTATE_CODE_PV' OR
                            screen-name = 'ZWBS_ITEM-ZMAINT_SYS'."     OR
*                            screen-name = 'ZWBS_ITEM-ZIBP_RES_PROJ'.
      <fs_cols>-invisible = 1.
    ENDLOOP.
  ENDIF.

*DO NOT Display GROUPING field based on Template for SAP Requests
  IF ls_proj_templ-grouping IS INITIAL AND lv_grp_allowed IS INITIAL.
    LOOP AT <lt_cols> ASSIGNING <fs_cols>
                      WHERE screen-name = 'ZWBS_ITEM-GRPKZ'.
      <fs_cols>-invisible = 1.
    ENDLOOP.
  ENDIF.
  UNASSIGN <lt_cols>.

ENDMODULE.

*&SPWIZARD: OUTPUT MODULE FOR TC 'TC_WBS'. DO NOT CHANGE THIS LINE!
*&SPWIZARD: GET LINES OF TABLECONTROL
MODULE tc_wbs_get_lines OUTPUT.
  g_tc_wbs_lines = sy-loopc.
ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  STATUS_0500  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE status_0500 OUTPUT.
*  SET PF-STATUS 'xxxxxxxx'.
*  SET TITLEBAR 'xxx'.

  CASE sy-tcode.
    WHEN 'ZCJ01'.
      IF zwbs_header-type = 3 OR
         zwbs_header-type = 4.
        LOOP AT SCREEN.
          CASE screen-name.
            WHEN 'TC_WBS_INSERT'   OR
                 'TC_WBS_DELETE'   OR
                 'TC_WBS_MARK'     OR
                 'TC_WBS_DEMARK'.
              screen-active = 0.
              MODIFY SCREEN.
          ENDCASE.
        ENDLOOP.
      ENDIF.
    WHEN 'ZCJ03'.
      LOOP AT SCREEN.
        CASE screen-name.
          WHEN 'TC_WBS_INSERT'   OR
               'TC_WBS_DELETE'   OR
*               'TC_WBS_TOP'      OR
*               'TC_WBS_PREVIOUS' OR
*               'TC_WBS_NEXT'     OR
*               'TC_WBS_BOTTOM'   OR
               'TC_WBS_MARK'     OR
               'TC_WBS_DEMARK'.
            screen-active = 0.
            MODIFY SCREEN.
        ENDCASE.
      ENDLOOP.
  ENDCASE.

ENDMODULE.                 " STATUS_0500  OUTPUT
*&---------------------------------------------------------------------*
*&      Module  STATUS_0600  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE status_0600 OUTPUT.
*  SET PF-STATUS 'xxxxxxxx'.
*  SET TITLEBAR 'xxx'.

  PERFORM create_text_editor.

ENDMODULE.                 " STATUS_0600  OUTPUT
*&---------------------------------------------------------------------*
*&      Module  TC_WBS_CHANGE_FIELD_ATTR  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE tc_wbs_change_field_attr OUTPUT.

  DATA:ls_screen TYPE screen,
       lv_field  TYPE feldname.

  MOVE-CORRESPONDING ls_table TO zwbs_item.

  LOOP AT SCREEN INTO ls_screen.
    IF NOT ls_table-status IS INITIAL.
      CASE ls_screen-name.
        WHEN 'LS_TABLE-SELECT'.
        WHEN OTHERS.
          ls_screen-input = 0.
      ENDCASE.
    ELSE.
      CASE ls_screen-name.
        WHEN 'ZWBS_ITEM-ZCLOSE'.
          IF NOT lv_wf_flag IS INITIAL AND
                 sy-tcode = 'ZCJ02N'.
            ls_screen-input = 0.
          ELSEIF NOT lv_dflag IS INITIAL.
            ls_screen-input = 0.
          ELSE.
            READ TABLE lt_zwbs_status TRANSPORTING NO FIELDS
                                      WITH KEY type      = lv_type
                                               stat_curr = ls_table-stat_curr.
            IF sy-subrc <> 0.
              ls_screen-input = 0.
            ENDIF.
          ENDIF.
        WHEN 'ZWBS_ITEM-ZUNCLOSE'.
          IF NOT lv_wf_flag IS INITIAL AND
                 sy-tcode = 'ZCJ02N'.
            ls_screen-input = 0.
          ELSEIF NOT lv_dflag IS INITIAL.
            ls_screen-input = 0.
          ELSE.
            READ TABLE lt_zwbs_status TRANSPORTING NO FIELDS
                                      WITH KEY type      = lv_type
                                               stat_curr = ls_table-stat_curr.
            IF sy-subrc <> 0.
              ls_screen-input = 0.
            ENDIF.
          ENDIF.
        WHEN 'ZWBS_ITEM-ACCEPT'.
          IF NOT lv_dflag IS INITIAL OR
             NOT lv_rflag IS INITIAL.
            ls_screen-input = 0.
          ELSEIF NOT lv_wf_flag         IS INITIAL   AND
               ( NOT zwbs_item-zclose   IS INITIAL   OR
                 NOT zwbs_item-zunclose IS INITIAL ) AND
                 sy-tcode = 'ZCJ02N'.
*            ls_screen-input = 1.
          ELSE.
            ls_screen-input = 0.
          ENDIF.
        WHEN 'ZWBS_ITEM-ZSTATUS'.
          IF NOT lv_wf_flag IS INITIAL.
            ls_screen-input = 0.
          ELSEIF NOT lv_dflag IS INITIAL OR
                 NOT lv_rflag IS INITIAL.
            ls_screen-input = 0.
          ELSEIF NOT ls_table-zclose   IS INITIAL OR
                 NOT ls_table-zunclose IS INITIAL.
            ls_screen-input    = 1.
          ELSE.
            ls_screen-input = 0.
          ENDIF.
        WHEN 'ZWBS_ITEM-STUFE'.
          IF ls_table-updkz = 'I'.
            ls_screen-input = 1.
          ENDIF.
        WHEN 'ZWBS_ITEM-POST1'.
          IF NOT lv_cflag  IS INITIAL OR
             NOT lv_ucflag IS INITIAL OR
             NOT lv_dflag  IS INITIAL OR
             NOT lv_rflag  IS INITIAL.
            ls_screen-input = 0.
          ENDIF.
        WHEN 'ZWBS_ITEM-BELKZ' OR 'ZWBS_ITEM-FAKKZ'.
          IF ls_table-stufe = '1' OR ls_table-stufe = '2'.
            ls_screen-input = 0.
          ENDIF.
          IF NOT lv_cflag  IS INITIAL OR
             NOT lv_ucflag IS INITIAL OR
             NOT lv_dflag  IS INITIAL OR
             NOT lv_rflag  IS INITIAL.
            ls_screen-input = 0.
          ENDIF.
*          IF NOT ls_cf_control IS INITIAL.
*            CASE ls_table-stufe.
**              WHEN 2.
**                IF NOT ls_cf_control-level2 IS INITIAL.
**                  ls_screen-required = 1.
**                ENDIF.
*              WHEN 3.
*                IF NOT ls_cf_control-level3 IS INITIAL.
*                  ls_screen-required = 1.
*                ENDIF.
*              WHEN 4.
*                IF NOT ls_cf_control-level4 IS INITIAL.
*                  ls_screen-required = 1.
*                ENDIF.
*              WHEN 5.
*                IF NOT ls_cf_control-level5 IS INITIAL.
*                  ls_screen-required = 1.
*                ENDIF.
*              WHEN 6.
*                IF NOT ls_cf_control-level6 IS INITIAL.
*                  ls_screen-required = 1.
*                ENDIF.
*            ENDCASE.
*          ENDIF.
        WHEN 'ZWBS_ITEM-MTART' OR 'ZWBS_ITEM-Z_MATERIAL'.
          IF NOT lv_cflag  IS INITIAL OR
             NOT lv_ucflag IS INITIAL OR
             NOT lv_dflag  IS INITIAL OR
             NOT lv_rflag  IS INITIAL.
            ls_screen-input = 0.
          ENDIF.
        WHEN 'ZWBS_ITEM-ZCUSTOM' OR 'ZWBS_ITEM-ZASSET' OR
             'ZWBS_ITEM-ZREVSTR' OR 'ZWBS_ITEM-ZSCOPCHA'.
*If Customer already exists for a line make it Non-editable
          IF ls_screen-name EQ 'ZWBS_ITEM-ZCUSTOM'.
            IF  ls_table-zcustom IS INITIAL AND
            NOT ls_table-zchange IS INITIAL.
            ELSEIF ls_table-updkz IS INITIAL AND
              lv_type = 2.
              ls_screen-input = 0.
            ENDIF.
          ENDIF.
          IF NOT lv_cflag  IS INITIAL OR
             NOT lv_ucflag IS INITIAL OR
             NOT lv_dflag  IS INITIAL OR
             NOT lv_rflag  IS INITIAL.
            ls_screen-input = 0.
          ENDIF.
*          IF NOT ls_cf_control IS INITIAL.
*            CASE ls_table-stufe.
*              WHEN 2.
*                IF NOT ls_cf_control-level2 IS INITIAL.
*                  ls_screen-required = 1.
*                ENDIF.
*              WHEN 3.
*                IF NOT ls_cf_control-level3 IS INITIAL.
*                  ls_screen-required = 1.
*                ENDIF.
*              WHEN 4.
*                IF NOT ls_cf_control-level4 IS INITIAL.
*                  ls_screen-required = 1.
*                ENDIF.
*              WHEN 5.
*                IF NOT ls_cf_control-level5 IS INITIAL.
*                  ls_screen-required = 1.
*                ENDIF.
*              WHEN 6.
*                IF NOT ls_cf_control-level6 IS INITIAL.
*                  ls_screen-required = 1.
*                ENDIF.
*            ENDCASE.
*          ENDIF.
        WHEN 'COMMENTS_TEXT'.
        WHEN 'ZWBS_ITEM-GRPKZ'.
          IF NOT lv_grp_allowed IS INITIAL AND NOT ls_table-grpkz IS INITIAL.
            READ TABLE lt_table_init TRANSPORTING NO FIELDS
                                     WITH KEY pspid = ls_table-pspid.
            IF sy-subrc = 0.
              ls_screen-input = 0.
            ENDIF.
          ENDIF.
        WHEN OTHERS.
          IF NOT lv_cflag  IS INITIAL OR
             NOT lv_ucflag IS INITIAL OR
             NOT lv_dflag  IS INITIAL OR
             NOT lv_rflag  IS INITIAL.
            ls_screen-input = 0.
          ENDIF.
      ENDCASE.
    ENDIF.
    MODIFY SCREEN FROM ls_screen.
  ENDLOOP.

*Highlight Changed Values for Change Project/WBS
  IF lv_type = '2' AND ls_table-zchange = 'U' AND
                 ( NOT lt_table_init IS INITIAL OR
                   NOT lt_prps       IS INITIAL ).
    CLEAR:ls_table_init,ls_prps.
    IF sy-tcode = 'ZCJ01'.
      READ TABLE lt_table_init INTO ls_table_init
                               WITH KEY pspid = zwbs_item-pspid.
    ELSE.
      READ TABLE lt_prps INTO ls_prps WITH KEY posid = zwbs_item-pspid.
    ENDIF.
    LOOP AT SCREEN INTO ls_screen.
      CASE ls_screen-name.
        WHEN 'ZWBS_ITEM-POST1'             OR
             'ZWBS_ITEM-PBUKR'             OR
             'ZWBS_ITEM-PGSBR'             OR
             'ZWBS_ITEM-PRCTR'             OR
             'ZWBS_ITEM-WERKS'             OR
             'ZWBS_ITEM-ABGSL'             OR
             'ZWBS_ITEM-ZASSET'            OR
             'ZWBS_ITEM-ZREVSTR'           OR
             'ZWBS_ITEM-ZAREA'             OR
             'ZWBS_ITEM-ZSCOPCHA'          OR
             'ZWBS_ITEM-ZOPPORTUNITY_ID'   OR
             'ZWBS_ITEM-ZSYNERGY_ID'       OR
             'ZWBS_ITEM-ZCUSTOM'           OR
             'ZWBS_ITEM-MTART'             OR
             'ZWBS_ITEM-Z_MATERIAL'        OR
             'ZWBS_ITEM-ZIBPEBELN'         OR
             'ZWBS_ITEM-ZFCW'              OR
             'ZWBS_ITEM-ZIPM_PR_CODE'      OR
             'ZWBS_ITEM-ZZFCST_STATUS'     OR
             'ZWBS_ITEM-ZZSERV_BUND'       OR
             'ZWBS_ITEM-ZZFREE_TEXT'       OR
             'ZWBS_ITEM-BELKZ'             OR
             'ZWBS_ITEM-FAKKZ'             OR
* Begin of changes by LCHENNA for CR 797199
             'ZWBS_ITEM-ZSTAGE_ST_DT'      OR
             'ZWBS_ITEM-ZSTAGE_END_DT'     OR
             'ZWBS_ITEM-ZREV_REC_DT'       OR
             'ZWBS_ITEM-ZPRODCAT'          OR
             'ZWBS_ITEM-ZBUSINESS_CASE'    OR
             'ZWBS_ITEM-ZLIFECYCLE_MODULE' OR
* End of changes by LCHENNA for CR 797199
             'ZWBS_ITEM-ZBSTKD'            OR
             'ZWBS_ITEM-ZPOSEX'.
          CLEAR lv_field.
          lv_field = ls_screen-name+10.
          ASSIGN COMPONENT lv_field OF STRUCTURE ls_table TO
          FIELD-SYMBOL(<fs1>).
          IF sy-tcode = 'ZCJ01'.
            ASSIGN COMPONENT lv_field OF STRUCTURE ls_table_init TO
            FIELD-SYMBOL(<fs2>).
          ELSE.
            ASSIGN COMPONENT lv_field OF STRUCTURE ls_prps TO <fs2>.
          ENDIF.
          IF <fs1> IS ASSIGNED AND
             <fs2> IS ASSIGNED AND
             <fs1> NE <fs2>.
            ls_screen-intensified = 1.
          ENDIF.
          UNASSIGN:<fs1>,<fs2>.
      ENDCASE.
      MODIFY SCREEN FROM ls_screen.
    ENDLOOP.
  ENDIF.

ENDMODULE.                 " TC_WBS_CHANGE_FIELD_ATTR  OUTPUT
*&---------------------------------------------------------------------*
*&      Module  STATUS_0700  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE status_0700 OUTPUT.

  PERFORM exlcude_fcode.

  SET PF-STATUS '700' EXCLUDING lt_fcode.
  IF sy-tcode = 'ZCJ02N'.
    SET TITLEBAR '100' WITH text-002.
  ELSEIF sy-tcode = 'ZCJ03'.
    lv_dflag = abap_true.
    SET TITLEBAR '100' WITH text-003.
  ENDIF.

ENDMODULE.                 " STATUS_0700  OUTPUT
*&--------------------------------------------------------------------*
*&      Module  STATUS_0800  OUTPUT
*&--------------------------------------------------------------------*
MODULE status_0800 OUTPUT.
  SET PF-STATUS '800'.
  SET TITLEBAR '800'.

  PERFORM create_log_editor.

ENDMODULE.                 " STATUS_0800  OUTPUT

*&SPWIZARD: OUTPUT MODULE FOR TC 'TC_CAPEX'. DO NOT CHANGE THIS LINE!
*&SPWIZARD: COPY DDIC-TABLE TO ITAB
MODULE tc_capex_init OUTPUT.

  DATA: "lv_vernr     TYPE xubname,
*        lv_astnr     TYPE xubname,
*        lv_vgsbr     TYPE zwbs_header-vgsbr,
*        lv_plsez     TYPE zwbs_header-plsez,
    ls_usr03          TYPE usr03,
    lv_ans_appl       TYPE c,
    lv_ans_pers       TYPE c,
    lv_ans_buss       TYPE c,
    lv_ans_fini       TYPE c,
    lv_countera       TYPE numc3,
    lv_counterv       TYPE numc3,
    lv_counterb       TYPE numc3,
    lv_counterf       TYPE numc3,
    lv_prctr_cpx      TYPE char4,
    lv_prctr_cpx_conv TYPE prctr,
    lv_datum          TYPE char8,
    lv_message        TYPE char80,
    lv_message1       TYPE char80,
    lv_message2       TYPE char80,
    lv_pspid_hdr      TYPE zwbs_header-pspid.
  DATA: lv_pspid_len  TYPE numc2.
  DATA: lv_pspid_len1 TYPE numc2.
  DATA: result_tab TYPE match_result_tab.
  DATA: lv_pspid_len_eende TYPE numc2.
  "DATA: lv_pspid_len2 TYPE numc2.

  IF zucomm = 'ENTER' OR zucomm = 'ATTACH'.
    IF ( lv_type = 1 AND gv_capex IS INITIAL ) OR
       ( lv_type = 2 AND gv_capex IS INITIAL ) .
      IF zwbs_header-vernr IS NOT INITIAL.
        IF ( lv_vernr IS INITIAL AND zwbs_header-vernr NE ls_head_db-vernr ) OR
       ( NOT lv_vernr IS INITIAL AND zwbs_header-vernr NE lv_vernr ).
*          IF lv_vernr IS INITIAL.
*            lv_vernr = zwbs_header-vernr.
*            lv_countera = lv_countera + 1.
*            IF lv_countera = 1.
*              LOOP AT lt_table ASSIGNING FIELD-SYMBOL(<fs_table1>).
*                CHECK <fs_table1>-status IS INITIAL."DO NOT Update for Inactive Lines
*                zwbs_item-vernr   = <fs_table1>-vernr   = zwbs_header-vernr.
*                zwbs_item-vernr_n = <fs_table1>-vernr_n = zwbs_header-vernr_n.
*                IF lv_type = 2.
*                  <fs_table1>-zchange = 'U'.
*                ENDIF.
*                CALL FUNCTION 'SUSR_USER_ADDRESS_READ'
*                  EXPORTING
*                    user_name              = zwbs_header-vernr
**                   READ_DB_DIRECTLY       = ' '
**                   CACHE_RESULTS          = 'X'
*                  IMPORTING
*                    user_usr03             = ls_usr03  "lv_name
*                  EXCEPTIONS
*                    user_address_not_found = 1
*                    OTHERS                 = 2.
*                IF sy-subrc = 0.
*                  CONCATENATE ls_usr03-name1 ls_usr03-name2 INTO
*                              <fs_table1>-verna SEPARATED BY space.
*                  zwbs_item-verna = <fs_table1>-verna.
*                ENDIF.
*                CLEAR: ls_usr03.
*              ENDLOOP.
*              UNASSIGN <fs_table1>.
**          PERFORM pers_resp_num_to_items.
*            ENDIF.
*          ENDIF.
          IF lv_type = 1 AND lv_vernr IS INITIAL.
            LOOP AT lt_table ASSIGNING FIELD-SYMBOL(<fs_table1>).
              CHECK <fs_table1>-status IS INITIAL."DO NOT Update for Inactive Lines
              zwbs_item-vernr   = <fs_table1>-vernr   = zwbs_header-vernr.
              zwbs_item-vernr_n = <fs_table1>-vernr_n = zwbs_header-vernr_n.
              IF lv_type = 2.
                <fs_table1>-zchange = 'U'.
              ENDIF.
              CALL FUNCTION 'SUSR_USER_ADDRESS_READ'
                EXPORTING
                  user_name              = zwbs_header-vernr
*                 READ_DB_DIRECTLY       = ' '
*                 CACHE_RESULTS          = 'X'
                IMPORTING
                  user_usr03             = ls_usr03  "lv_name
                EXCEPTIONS
                  user_address_not_found = 1
                  OTHERS                 = 2.
              IF sy-subrc = 0.
                CONCATENATE ls_usr03-name1 ls_usr03-name2 INTO
                            <fs_table1>-verna SEPARATED BY space.
                zwbs_item-verna = <fs_table1>-verna.
              ENDIF.
              CLEAR: ls_usr03.
            ENDLOOP.
            UNASSIGN <fs_table1>.
          ELSE.
            PERFORM pers_resp_num_to_items.
          ENDIF.
        ENDIF.
*        IF zwbs_header-vernr NE lv_vernr AND lv_vernr IS NOT INITIAL.
*          PERFORM pers_resp_num_to_items.
*        ENDIF.
        lv_vernr = zwbs_header-vernr.
      ENDIF.

      IF zwbs_header-astnr IS NOT INITIAL.
        IF ( lv_astnr IS INITIAL AND zwbs_header-astnr NE ls_head_db-astnr ) OR
       ( NOT lv_astnr IS INITIAL AND zwbs_header-astnr NE lv_astnr ).
*        IF lv_astnr IS INITIAL.
*          lv_astnr = zwbs_header-astnr.
*          lv_counterv = lv_counterv + 1.
*          IF lv_counterv = 1.
*            LOOP AT lt_table ASSIGNING <fs_table1>.
*              CHECK <fs_table1>-status IS INITIAL."DO NOT Update for Inactive Lines
*              <fs_table1>-astnr   = zwbs_header-astnr.
*              <fs_table1>-astnr_n = zwbs_header-astnr_n.
*              IF lv_type = 2.
*                <fs_table1>-zchange = 'U'.
*              ENDIF.
*              CALL FUNCTION 'SUSR_USER_ADDRESS_READ'
*                EXPORTING
*                  user_name              = zwbs_header-astnr
**                 READ_DB_DIRECTLY       = ' '
**                 CACHE_RESULTS          = 'X'
*                IMPORTING
*                  user_usr03             = ls_usr03  "lv_name
*                EXCEPTIONS
*                  user_address_not_found = 1
*                  OTHERS                 = 2.
*              IF sy-subrc = 0.
*                CONCATENATE ls_usr03-name1 ls_usr03-name2 INTO
*                <fs_table1>-astna SEPARATED BY space.
*                zwbs_item-astna = <fs_table1>-astna.
*              ENDIF.
*              CLEAR: ls_usr03.
**    <fs_table1>-pgsbr = ZWBS_ITEM-pgsbr.
**    <fs_table1>-prctr = ZWBS_ITEM-prctr.
*            ENDLOOP.
*          PERFORM applicant_num_to_items.
*          ENDIF.
*        ENDIF.
*        IF zwbs_header-astnr NE lv_astnr AND lv_astnr IS NOT INITIAL.
          IF lv_type = 1 AND lv_astnr IS INITIAL.
            LOOP AT lt_table ASSIGNING <fs_table1>.
              CHECK <fs_table1>-status IS INITIAL."DO NOT Update for Inactive Lines
              <fs_table1>-astnr   = zwbs_header-astnr.
              <fs_table1>-astnr_n = zwbs_header-astnr_n.
              IF lv_type = 2.
                <fs_table1>-zchange = 'U'.
              ENDIF.
              CALL FUNCTION 'SUSR_USER_ADDRESS_READ'
                EXPORTING
                  user_name              = zwbs_header-astnr
                IMPORTING
                  user_usr03             = ls_usr03
                EXCEPTIONS
                  user_address_not_found = 1
                  OTHERS                 = 2.
              IF sy-subrc = 0.
                CONCATENATE ls_usr03-name1 ls_usr03-name2 INTO
                <fs_table1>-astna SEPARATED BY space.
                zwbs_item-astna = <fs_table1>-astna.
              ENDIF.
              CLEAR: ls_usr03.
            ENDLOOP.
          ELSE.
            PERFORM applicant_num_to_items.
          ENDIF.
        ENDIF.
        lv_astnr = zwbs_header-astnr.
      ENDIF.

      IF zwbs_header-vgsbr IS NOT INITIAL.
        IF lv_vgsbr IS INITIAL.
          lv_vgsbr = zwbs_header-vgsbr.
          lv_counterb = lv_counterb + 1.
          IF lv_counterb = 1.
            IF lv_type = 1.
              LOOP AT lt_table ASSIGNING <fs_table1>.
                zwbs_item-pgsbr = <fs_table1>-pgsbr = zwbs_header-vgsbr.
              ENDLOOP.
            ELSE.
              LOOP AT lt_table ASSIGNING <fs_table1> WHERE pgsbr IS INITIAL.
                zwbs_item-pgsbr = <fs_table1>-pgsbr = zwbs_header-vgsbr.
              ENDLOOP.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.

      IF zwbs_header-vgsbr NE lv_vgsbr AND lv_vgsbr IS NOT INITIAL.
        PERFORM business_area_lines.
        lv_vgsbr = zwbs_header-vgsbr.
      ENDIF.

*** Begin of change to correct Basic Finish Date Update
***      IF zwbs_header-plsez IS NOT INITIAL.
***        IF lv_plsez IS INITIAL.
***          lv_plsez = zwbs_header-plsez.
***          lv_counterf = lv_counterf + 1.
***          IF lv_counterf = 1.
***            LOOP AT lt_table ASSIGNING <fs_table1>.
***              CHECK <fs_table1>-status IS INITIAL."DO NOT Update for Inactive Lines
***              IF <fs_table1>-zchange = 'I'.
***              ELSE.
***                zwbs_item-plsez = <fs_table1>-plsez = zwbs_header-plsez.
***                IF lv_type = 1.
***                  zwbs_item-eende = <fs_table1>-eende = <fs_table1>-plsez.
***                ENDIF.
***              ENDIF.
***            ENDLOOP.
***          ENDIF.
***        ENDIF.
***      ENDIF.

*** Update Basic FInish Date based on Header Finish Date
      IF lv_plsez IS INITIAL.
        IF lv_type = 1.
          lv_plsez = zwbs_header-plsez.
        ELSE.
          IF zwbs_header-plsez NE ls_head_db-plsez.
            PERFORM finish_date_lines.
            lv_plsez = zwbs_header-plsez.
          ENDIF.
        ENDIF.
      ELSEIF lv_plsez NE zwbs_header-plsez.
        PERFORM finish_date_lines.
        lv_plsez = zwbs_header-plsez.
      ENDIF.
*** End of change to correct Basic Finish Date Update
*    ELSEIF lv_type = 2.
*      " Applicant Number
*      IF zwbs_header-astnr_n IS NOT INITIAL.
*        IF zwbs_header-astnr_n NE zwbs_item-astnr_n. "ls_proj-astnr.
*          lv_astnr = zwbs_header-astnr.
*          PERFORM applicant_num_to_items.
*
*        ENDIF.
*
*        IF zwbs_header-astnr NE lv_astnr AND lv_astnr IS NOT INITIAL..
*          PERFORM applicant_num_to_items.
*          lv_astnr = zwbs_header-astnr.
*        ENDIF.
*      ENDIF.
*
*      " User Responsible Number.
*      IF zwbs_header-vernr_n IS NOT INITIAL.
*        IF zwbs_header-vernr_n NE zwbs_item-vernr_n. "ls_proj-vernr.
*          lv_vernr = zwbs_header-vernr.
*          PERFORM pers_resp_num_to_items.
*        ENDIF.
*
*        IF zwbs_header-vernr NE lv_vernr AND lv_vernr IS NOT INITIAL.
*          PERFORM pers_resp_num_to_items.
*          lv_vernr = zwbs_header-vernr.
*        ENDIF.
*      ENDIF.
*
*      " Business Area.
*      IF zwbs_header-vgsbr IS NOT INITIAL.
*        IF zwbs_header-vgsbr NE zwbs_item-pgsbr. "ls_proj-vgsbr.
*          lv_vgsbr = zwbs_header-vgsbr.
*          PERFORM business_area_lines.
*        ENDIF.
*
*        IF zwbs_header-vgsbr NE lv_vgsbr AND lv_vgsbr IS NOT INITIAL.
*          PERFORM business_area_lines.
*          lv_vgsbr = zwbs_header-vgsbr.
*        ENDIF.
*      ENDIF.
*
*      " Finish Date.
*      IF zwbs_header-plsez NE zwbs_item-plsez. "ls_proj-plsez.
*        lv_plsez = zwbs_header-plsez.
*        PERFORM finish_date_lines.
*      ENDIF.
*
*      IF zwbs_header-plsez NE lv_plsez AND lv_plsez IS NOT INITIAL.
*        PERFORM finish_date_lines.
*        lv_plsez = zwbs_header-plsez.
*      ENDIF.

    ELSEIF gv_capex IS NOT INITIAL.
      " Applicant Number
      IF zwbs_header-astnr IS NOT INITIAL.
        IF zwbs_header-astnr NE ls_head-astnr.
          lv_astnr = zwbs_header-astnr.
          PERFORM applicant_num_to_items.
        ENDIF.

        IF zwbs_header-astnr NE lv_astnr AND lv_astnr IS NOT INITIAL..
          PERFORM applicant_num_to_items.
          lv_astnr = zwbs_header-astnr.
        ENDIF.
      ENDIF.

      " User Responsible Number.
      IF zwbs_header-vernr IS NOT INITIAL.
        IF zwbs_header-vernr NE ls_head-vernr.
          lv_vernr = zwbs_header-vernr.
          PERFORM pers_resp_num_to_items.
        ENDIF.

        IF zwbs_header-vernr NE lv_vernr AND lv_vernr IS NOT INITIAL.
          PERFORM pers_resp_num_to_items.
          lv_vernr = zwbs_header-vernr.
        ENDIF.
      ENDIF.

      " Business Area
      IF zwbs_header-vgsbr IS NOT INITIAL.
        IF zwbs_header-vgsbr NE ls_head-vgsbr.
          lv_vgsbr = zwbs_header-vgsbr.
          PERFORM business_area_lines.
        ENDIF.

        IF zwbs_header-vgsbr NE lv_vgsbr AND lv_vgsbr IS NOT INITIAL.
          PERFORM business_area_lines.
          lv_vgsbr = zwbs_header-vgsbr.
        ENDIF.
      ENDIF.

      " Finish Date
      IF zwbs_header-plsez IS NOT INITIAL.
        IF zwbs_header-plsez NE ls_head-plsez.
          lv_plsez = zwbs_header-plsez.
          PERFORM finish_date_lines.
        ENDIF.

        IF zwbs_header-plsez NE lv_plsez AND lv_plsez IS NOT INITIAL.
          PERFORM finish_date_lines.
          lv_plsez = zwbs_header-plsez.
        ENDIF.
      ENDIF.

    ENDIF.

    CLEAR:lv_pspid_len_eende .
    LOOP AT lt_table ASSIGNING FIELD-SYMBOL(<wa1>).
      IF <wa1>-stufe = '5'.
      ELSEIF <wa1>-stufe = '2'.
        DATA(lv_pspid_new2) = <wa1>-pspid.
        CALL FUNCTION 'FTR_CORR_SWIFT_DELETE_ENDZERO'
          CHANGING
            c_value = lv_pspid_new2.
        lv_pspid_len_eende = strlen( lv_pspid_new2 ).
      ENDIF.
    ENDLOOP.

    "CLEAR: ls_frct_2, ls_frct_3.
    LOOP AT lt_table INTO DATA(ls_frct_2) WHERE stufe = '2'.
      LOOP AT lt_table INTO DATA(ls_frct_3) WHERE stufe > '2'.
        IF ls_frct_3-pspid+0(lv_pspid_len_eende) = ls_frct_2-pspid+0(lv_pspid_len_eende).
          IF lv_type = 2.
            "CLEAR: lv_objnr1.
            SELECT SINGLE objnr FROM prps INTO @DATA(lv_objnr1)
              WHERE posid =  @ls_frct_3-pspid.
            IF sy-subrc = 0.
              "CLEAR: ls_jest.
              SELECT SINGLE * FROM jest INTO @DATA(ls_jest)
                WHERE objnr = @lv_objnr1
                AND  stat  = 'I0046'
                AND  inact = @space.
              IF sy-subrc = 0.
              ELSE.
                ls_frct_3-eende = ls_frct_2-eende.
                IF lv_type = 2.
                  ls_frct_3-zchange = 'U'.
                ENDIF.
                IF ls_frct_3-eende IS NOT INITIAL.
                  MODIFY lt_table FROM ls_frct_3 TRANSPORTING eende zchange.
                ENDIF.
              ENDIF.
            ELSE.
              ls_frct_3-eende = ls_frct_2-eende.
              IF ls_frct_3-eende IS NOT INITIAL.
                MODIFY lt_table FROM ls_frct_3 TRANSPORTING eende.
              ENDIF.
            ENDIF.
          ELSE.
            ls_frct_3-eende = ls_frct_2-eende.
            IF ls_frct_3-eende IS NOT INITIAL.
              MODIFY lt_table FROM ls_frct_3 TRANSPORTING eende.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDLOOP.
    ENDLOOP.
  ENDIF.
  FIELD-SYMBOLS <fs_cols1> TYPE scxtab_column.
  DESCRIBE TABLE lt_table LINES tc_capex-lines.

  DATA: lv_pspid_itm  TYPE zwbs_header-pspid.
*Check for any errors
  IF zwbs_header-izwek IS NOT INITIAL.
    READ TABLE lt_table INTO DATA(ls_table1) WITH KEY stufe = '2'.
    IF sy-subrc = 0.

      CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
        EXPORTING
          input  = ls_table1-pspid
        IMPORTING
          output = lv_pspid_itm.

      SPLIT lv_pspid_itm AT '.' INTO DATA(lv_first) DATA(lv_second) DATA(lv_third).
      IF zwbs_header-izwek = 'LS' AND lv_third = '51'.
        MESSAGE s368(00) WITH 'Project Template and Investment Reason' 'do not match'
                       DISPLAY LIKE 'E'.
        "MESSAGE 'Project Template and Investment Reason do not match' TYPE 'S' DISPLAY LIKE 'E'.
      ELSEIF lv_third = '41' AND zwbs_header-izwek NE 'LS'.
        MESSAGE s368(00) WITH 'Project Template and Investment Reason' 'do not match'
                        DISPLAY LIKE 'E'.
        " MESSAGE 'Project Template and Investment Reason do not match' TYPE 'S' DISPLAY LIKE 'E'.
      ENDIF.
    ENDIF.
  ENDIF.


  IF NOT lv_error IS INITIAL AND lv_herror IS INITIAL.
    lv_tline = lv_tline - tc_wbs-top_line + 1.
    SET CURSOR FIELD lv_cursor LINE lv_tline.
    IF NOT lv_verror IS INITIAL.
      IF lv_cursor = 'ZWBS_ITEM-PGSBR'.
        MESSAGE s368(00) WITH 'Mismatch in Business Area &'
        'Profit Center'
                         DISPLAY LIKE 'W'.
      ELSEIF lv_cursor = 'ZWBS_ITEM-POST1'.
*        IF lv_proj3 = space.
        IF lv_proj_type NE 'TC'.
          MESSAGE s368(00) WITH 'Mismatch in Project Description &'
                                'WBS Description'
                           DISPLAY LIKE 'E'.
        ENDIF.
      ELSE.
        MESSAGE s368(00) WITH text-007 lv_text
                         DISPLAY LIKE 'E'.
      ENDIF.
    ELSEIF NOT lv_wf_pos_flag IS INITIAL.
      MESSAGE s398(00) WITH
      'Workflow not maintained for this Company Code'
      'and Business Area,'
    'please get in contact with Master Data Team'
                       DISPLAY LIKE 'E'.
    ELSEIF NOT lv_ag_flag IS INITIAL AND NOT lv_cerror IS INITIAL.
    ELSEIF NOT lv_text IS INITIAL.
      MESSAGE s368(00) WITH lv_text 'is a required field'
                       DISPLAY LIKE 'E'.
    ENDIF.
  ENDIF.
  CLEAR:lv_error,lv_verror,lv_herror,lv_raerror.

*Hide Columns for Regular Process
  ASSIGN tc_capex-cols TO <lt_cols>.
  CASE zwbs_header-type.
    WHEN 1.
*Create Case
      LOOP AT <lt_cols> ASSIGNING <fs_cols1>
                        WHERE screen-name = 'ZWBS_ITEM-ZCHANGE'
                        .
        <fs_cols1>-invisible = 1.
      ENDLOOP.
    WHEN 2.
*Change Case
      IF gv_capex IS INITIAL.
        LOOP AT <lt_cols> ASSIGNING <fs_cols>
                          WHERE screen-name = 'ZWBS_ITEM-ZCHANGE'.
          <fs_cols>-invisible = 1.
        ENDLOOP.
      ENDIF.
  ENDCASE.

* DO NOT Display PlanView fields for SAP Requests
  IF zwbs_header-zprj_code_pv IS INITIAL.
    LOOP AT <lt_cols> ASSIGNING <fs_cols1>
                     WHERE screen-name = 'ZWBS_ITEM-ZSTATE_CODE_PV' OR
                           screen-name = 'ZWBS_ITEM-ZMAINT_SYS'.
      <fs_cols1>-invisible = 1.
    ENDLOOP.
  ENDIF.
  UNASSIGN <lt_cols>.
  CLEAR: lv_message, lv_message1, lv_message2,lv_msg_clsd_wbs,lv_msg_miss_wbs,lv_msg_diff_wbs.
  LOOP AT lt_table ASSIGNING FIELD-SYMBOL(<fs_table2>).

    IF <fs_table2>-pspid IS INITIAL.
      <fs_table2>-zinsert = zwbs_item-zinsert = 'X'.
    ENDIF.
*Consider Change flag ONLY in case of Change Project/WBS
    IF zwbs_header-type EQ 2.
      CHECK <fs_table2>-zchange IS NOT INITIAL.
    ENDIF.


*Maintain PC in accordance to BA at the Line Item Level
    lv_prctr_cpx = <fs_table2>-pgsbr.
    SHIFT lv_prctr_cpx LEFT DELETING LEADING '0'.
    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
      EXPORTING
        input  = lv_prctr_cpx
      IMPORTING
        output = lv_prctr_cpx_conv.
    <fs_table2>-prctr = zwbs_item-prctr = lv_prctr_cpx_conv.
*In the change request if a requestor update the data in the header,
*the system should updated the data of all the lines except the closed WBS
*(now it is updating the data of all lines, also closed WBS).
    IF <fs_table2>-status IS INITIAL.
      zwbs_item-izwek = <fs_table2>-izwek = zwbs_header-izwek.
      zwbs_item-pbukr = <fs_table2>-pbukr = zwbs_header-vbukr.
    ENDIF.
    "<fs_table2>-plsez = zwbs_header-plsez.
*    <fs_table2>-pgsbr = zwbs_item-pgsbr = zwbs_header-vgsbr.
*    <fs_table1>-prctr = ZWBS_ITEM-prctr.
    IF <fs_table2>-posid IS NOT INITIAL.
      IF <fs_table2>-izwek = 'LS'.
        SELECT SINGLE posid FROM impr
        INTO @DATA(ls_impr1)
        WHERE posid  =  @<fs_table2>-posid
         AND  izwek  = @<fs_table2>-izwek
        AND   bukrs  = @<fs_table2>-pbukr
       " AND   gsber  = @<fs_table2>-pgsbr
        AND   usr11  = @space.
        IF ls_impr1 NE <fs_table2>-posid." and ls_impr1 is not INITIAL.
*          CLEAR: lv_message.
*          CONCATENATE 'Please enter valid Position ID' lv_message INTO
*          lv_message.
*          MESSAGE lv_message TYPE 'E'. "DISPLAY LIKE 'E'.
          MESSAGE s368(00) WITH 'Position ID is a not valid,'
                                'please choose from drop down list'
                      DISPLAY LIKE 'E'.
          CONCATENATE 'Position ID is a not valid,'
                  'please choose from drop down list' lv_message1 INTO
                                                       lv_message1.
*          MESSAGE lv_message TYPE 'E'. " DISPLAY LIKE 'E'.
*      ELSE.
*        CLEAR: lv_message1.
        ENDIF.
        CLEAR: ls_impr1.
      ELSE.
        "SHIFT <fs_table2>-posid  LEFT DELETING LEADING '0'.
        SELECT SINGLE posid FROM impr
          INTO @ls_impr1
          WHERE posid  =  @<fs_table2>-posid
           AND  izwek  = @<fs_table2>-izwek
          AND   bukrs  = @<fs_table2>-pbukr
          AND   gsber  = @<fs_table2>-pgsbr
          AND   usr11  = @space.
        IF ls_impr1 NE <fs_table2>-posid." and ls_impr1 is not INITIAL.
*          CLEAR: lv_message.
*          CONCATENATE 'Please enter valid Position ID' lv_message INTO
*          lv_message.
*          MESSAGE lv_message TYPE 'E'. "DISPLAY LIKE 'E'.
          IF lv_message IS INITIAL.
            MESSAGE s368(00) WITH 'Position ID is a not valid,'
                                  'please choose from drop down list'
                        DISPLAY LIKE 'E'.
            CONCATENATE 'Position ID is a not valid,'
                    'please choose from drop down list' lv_message1 INTO
                                                         lv_message1.
*          MESSAGE lv_message TYPE 'E'. " DISPLAY LIKE 'E'.
*      ELSE.
*        CLEAR: lv_message1.
          ENDIF.
        ENDIF.
        CLEAR: ls_impr1.
      ENDIF.
    ENDIF.
*    IF zwbs_header-type EQ 1.
*      READ TABLE lt_table INTO ls_table WITH KEY pspid = lv_pspid_itm.
*      IF sy-subrc = 0.
*        CLEAR: lv_msg_miss_wbs.
*      ELSE.
*        IF lv_msg_miss_wbs IS INITIAL.
*          MESSAGE s368(00) WITH 'The Parent WBS is missing, please add it'
*                         DISPLAY LIKE 'E'.
*          CONCATENATE 'The Parent WBS is missing, please add it' lv_msg_miss_wbs INTO
*           lv_msg_miss_wbs.
*          EXIT.
*        ENDIF.
*      ENDIF.
*    ENDIF.
    IF <fs_table2>-stufe NE '1' AND zwbs_header-type EQ 2.
*      DATA(lv_pspid) = <fs_table2>-pspid.
*      CALL FUNCTION 'FTR_CORR_SWIFT_DELETE_ENDZERO'
*        CHANGING
*          c_value = lv_pspid.
*      lv_pspid_len = strlen( lv_pspid ).
*      lv_pspid_len1 = lv_pspid_len - 1.
*      IF zwbs_item-stufe = '5'.
*        CONCATENATE lv_pspid+0(lv_pspid_len1) '0' INTO lv_pspid.
*      ELSEIF zwbs_item-stufe = '4'.
*        CONCATENATE lv_pspid+0(lv_pspid_len1) '0' '0' INTO lv_pspid.
*      ELSEIF zwbs_item-stufe = '3'.
*        CONCATENATE lv_pspid+0(lv_pspid_len1) '0' '0' '0' INTO lv_pspid.
*      ELSEIF zwbs_item-stufe = '2'.
*        CONCATENATE lv_pspid+0(lv_pspid_len1) '0' '0' '0' '0' INTO lv_pspid.
*      ENDIF.

      CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
        EXPORTING
          input  = <fs_table2>-pspid
        IMPORTING
          output = lv_pspid_itm.

      FIND ALL OCCURRENCES OF '.'
      IN lv_pspid_itm
      RESULTS result_tab.

      SORT result_tab BY offset DESCENDING.
      READ TABLE result_tab INTO DATA(ls_res_tab) INDEX 1.
      IF sy-subrc = 0.
        CALL FUNCTION 'CONVERSION_EXIT_ABPSN_INPUT'
          EXPORTING
            input  = lv_pspid_itm+0(ls_res_tab-offset)
          IMPORTING
            output = lv_pspid_itm.
        CLEAR: lv_objnr1.
        SELECT SINGLE objnr FROM prps INTO @lv_objnr1
       WHERE posid =  @lv_pspid_itm. "@lv_pspid+0(lv_pspid_len).
        IF sy-subrc = 0.
          CLEAR: ls_jest.
          SELECT SINGLE * FROM jest INTO @ls_jest
             WHERE objnr = @lv_objnr1
              AND  stat  = 'I0046'
              AND  inact = @space.
          IF sy-subrc = 0.
            IF lv_msg_clsd_wbs IS INITIAL.
              MESSAGE s368(00) WITH 'Not possible to create new WBS,' 'parent WBS is closed'
                            DISPLAY LIKE 'E'.
              CONCATENATE 'Not possible to create new WBS,' 'parent WBS is closed' lv_msg_clsd_wbs INTO
               lv_msg_clsd_wbs.
              EXIT.
            ENDIF.
          ELSE.
            CLEAR: lv_msg_clsd_wbs.
          ENDIF.
          CLEAR: lv_objnr1, ls_jest.
        ENDIF.
      ENDIF.

*      READ TABLE lt_table INTO ls_table WITH KEY pspid = lv_pspid_itm.
*      IF sy-subrc = 0.
*        CLEAR: lv_msg_miss_wbs.
*      ELSE.
*        IF lv_msg_miss_wbs IS INITIAL.
*          MESSAGE s368(00) WITH 'The Parent WBS is missing, please add it'
*                         DISPLAY LIKE 'E'.
*          CONCATENATE 'The Parent WBS is missing, please add it' lv_msg_miss_wbs INTO
*           lv_msg_miss_wbs.
*          EXIT.
*        ENDIF.
*      ENDIF.
      IF sy-tcode = 'ZCJ01'.
        CLEAR: lv_pspid_len.
        CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
          EXPORTING
            input  = zwbs_header-pspid
          IMPORTING
            output = lv_pspid_hdr.

        CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
          EXPORTING
            input  = <fs_table2>-pspid
          IMPORTING
            output = lv_pspid_itm.

        lv_pspid_len = strlen( lv_pspid_hdr ).
        IF lv_pspid_itm+0(lv_pspid_len) NE lv_pspid_hdr.
          IF lv_msg_diff_wbs IS INITIAL.
            MESSAGE s368(00)
            WITH 'The project number is wrong, please remove the' 'line and provide correct project no'
               DISPLAY LIKE 'E'.
            "MESSAGE 'The Parent WBS is different, Please delete the WBS and give correct Wbs' TYPE 'S' DISPLAY LIKE 'E'.
            CONCATENATE 'The project number is wrong, please remove the' 'line and provide correct project no'
            lv_msg_diff_wbs INTO lv_msg_diff_wbs SEPARATED BY space.
            EXIT.
          ELSE.

          ENDIF.
        ELSE.
          CLEAR: lv_msg_diff_wbs.
        ENDIF.
      ENDIF.
    ENDIF.
    zwbs_item-werks = <fs_table2>-werks = zwbs_header-werks.
*    IF lv_proj3 IS NOT INITIAL OR gv_capex IS NOT INITIAL.
    IF lv_proj_type = 'TC' OR gv_capex IS NOT INITIAL.
      IF <fs_table2>-akstl IS NOT INITIAL.
        CONCATENATE sy-datum+0(4) '12' '31' INTO lv_datum.
        DATA(lv_datum1) = sy-datum.
        lv_datum1 = lv_datum.

        SELECT SINGLE kostl
           FROM csks
           INTO @DATA(ls_csks)
           WHERE kostl = @<fs_table2>-akstl
               AND datbi GE @lv_datum1
               AND bukrs = @<fs_table2>-pbukr "@zwbs_header-vbukr
               AND gsber = @<fs_table2>-pgsbr. "@zwbs_item-pgsbr.
        IF ls_csks NE <fs_table2>-akstl.
*          CLEAR: lv_message.
          IF lv_message IS INITIAL.
            MESSAGE s368(00) WITH 'Cost center is a not valid,'
                                   'please choose from drop down list'
                                   DISPLAY LIKE 'E'.
            CONCATENATE 'Cost center is a not valid,'
                     'please choose from drop down list' lv_message INTO
            lv_message.
*          MESSAGE lv_message TYPE 'E'. " DISPLAY LIKE 'E'.
*        ELSE.
*          CLEAR: lv_message.
          ENDIF.
        ENDIF.
        CLEAR: ls_csks.
      ENDIF.

      IF <fs_table2>-lstar IS NOT INITIAL.
*        SHIFT <fs_table2>-posid  LEFT DELETING LEADING '0'.
        SELECT SINGLE lstar FROM cssl
          INTO @DATA(ls_cssl)
          WHERE lstar = @<fs_table2>-lstar
            AND gjahr = @sy-datum+0(4).
        IF ls_cssl NE <fs_table2>-lstar." and ls_impr1 is not INITIAL.
          IF lv_message2 IS INITIAL.
            MESSAGE s368(00) WITH 'Activity type is a not valid'
                                    'please choose from drop down list'
                        DISPLAY LIKE 'E'.
            CONCATENATE 'Activity type is a not valid,'
                     'please choose from drop down list' lv_message2 INTO
                                                              lv_message2.
*          MESSAGE lv_message TYPE 'E'. " DISPLAY LIKE 'E'.
*        ELSE.
*          CLEAR: lv_message2.
          ENDIF.
        ENDIF.
        CLEAR: ls_cssl.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDMODULE.

*&SPWIZARD: OUTPUT MODULE FOR TC 'TC_CAPEX'. DO NOT CHANGE THIS LINE!
*&SPWIZARD: MOVE ITAB TO DYNPRO
MODULE tc_capex_move OUTPUT.
  MOVE-CORRESPONDING g_tc_capex_wa TO zwbs_item.
ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  SUBSCREENS  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Module  SCREEN_SELECTION  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE screen_selection OUTPUT.

*  IF sy-tcode = 'ZCJ03' OR sy-tcode = 'ZCJ02N'.
*    LOOP AT lt_table INTO ls_table WHERE pspid+0(2) NE 'TC'." OR
**                                         pspid+0(2) = 'CI' OR
**                                         pspid+0(2) = 'CM'.
*      gv_screen = '0500'.
*      EXIT.
*    ENDLOOP.
*    IF sy-subrc <> 0.
*      gv_screen = '0900'.
*    ENDIF.
*  ELSE.
*    IF lv_proj3 IS NOT INITIAL OR
  IF lv_proj_type = 'TC' OR
     gv_capex IS NOT INITIAL.
    gv_screen = '0900'.
  ELSE.
    gv_screen = '0500'.
  ENDIF.
*  ENDIF.

ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  TC_CAPEX_GET_LINES  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE tc_capex_get_lines OUTPUT.

  g_tc_capex_lines = sy-loopc.
ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  TC_CAPEX_CHANGE_FIELD_ATTR  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE tc_capex_change_field_attr OUTPUT.
*  DATA:ls_screen TYPE screen,

  DATA:lv_field_tc  TYPE fieldname.
  DATA: lv_change TYPE char10.
  DATA: lv_prctr_cpx2 TYPE char4.
  DATA: lv_prctr_conv TYPE prctr.
*  IF ls_table-akstl IS INITIAL.
*    ls_table-akstl = lv_akstl.
*  ENDIF.
  "CLEAR: ls_table-pgsbr, ls_table-prctr.

  MOVE-CORRESPONDING ls_table TO zwbs_item.
  IF ls_table-status IS INITIAL.
    MOVE zwbs_header-izwek TO zwbs_item-izwek.
    MOVE zwbs_header-izwek TO ls_table-izwek.
  ENDIF.
  lv_prctr_cpx2 = zwbs_item-pgsbr.
  SHIFT lv_prctr_cpx2 LEFT DELETING LEADING '0'.
  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
    EXPORTING
      input  = lv_prctr_cpx2
    IMPORTING
      output = lv_prctr_conv.
  ls_table-prctr = zwbs_item-prctr = lv_prctr_conv.  "lv_prctr_cpx2.
  IF lv_type = 1.
    lv_change = 'CREATE'.
  ELSE.
    lv_change = 'CHANGE'.
  ENDIF.

  LOOP AT SCREEN.
    CASE screen-name.
      WHEN 'TC_CAPEX_SUM'.
        screen-input = 1.
        MODIFY SCREEN.
    ENDCASE.
  ENDLOOP.
  IF sy-tcode = 'ZCJ03'.
    LOOP AT SCREEN.
      screen-input = 0.
      MODIFY SCREEN.
    ENDLOOP.
*  ELSEIF lv_insr_flag = 'X'.
*
  ELSE.
*    IF lv_insr_flag = 'X'.
*      IF ls_table-pspid IS INITIAL.
*        READ TABLE lt_table ASSIGNING <fs_ins> WITH KEY pspid = ls_table-pspid.
*        IF sy-subrc = 0.
*          <fs_ins>-zinsert = 'X'.
*          CLEAR: lv_insr_flag.
*          Modify table lt_table from <FS_INS> TRANSPORTING zinsert.
*          READ TABLE lt_table INTO ls_table WITH KEY pspid = <fs_ins>-pspid.
*        ENDIF.
*      ENDIF.
*    ENDIF.


    IF ls_table-zinsert = 'X' AND ls_table-pspid IS INITIAL.
      LOOP AT SCREEN.
        CASE screen-name.
          WHEN  'ZWBS_ITEM-STUFE'     OR
               'ZWBS_ITEM-PSPID'     OR
               'ZWBS_ITEM-POST1'     OR
               'ZWBS_ITEM-VERNR'     OR
               'ZWBS_ITEM-PLSEZ'     OR
               'ZWBS_ITEM-PLFAZ'.
            screen-input = 1.
          WHEN OTHERS.
            screen-input = 0.
        ENDCASE.
        MODIFY SCREEN.
      ENDLOOP.
    ELSEIF ls_table-zinsert = 'X' AND ls_table-pspid IS NOT INITIAL..
      LOOP AT SCREEN.
        CASE screen-name.
          WHEN 'ZWBS_ITEM-POST1' OR
               'LS_TABLE-SELECT'.
            screen-input = 1.
            MODIFY SCREEN.
          WHEN OTHERS.
            screen-input = 0.
            MODIFY SCREEN.
        ENDCASE.
      ENDLOOP.

      LOOP AT SCREEN INTO ls_screen.
        SPLIT ls_screen-name AT '-' INTO DATA(lv_table) lv_field_tc.
        CASE ls_screen-name.
          WHEN 'ZWBS_ITEM-AKSTL'   OR
               'ZWBS_ITEM-BUDGET'  OR
               'ZWBS_ITEM-AKOKR'   OR
               'ZWBS_ITEM-PGSBR'   OR
               'ZWBS_ITEM-WERKS'   OR
               'ZWBS_ITEM-PLAKZ'   OR
               'ZWBS_ITEM-PLFAZ'   OR
               "'ZWBS_ITEM-PLSEZ'   OR
               'ZWBS_ITEM-ESTRT'   OR
               'ZWBS_ITEM-EENDE'   OR
               'ZWBS_ITEM-ASTNR'   OR
               'ZWBS_ITEM-VERNR'   OR
               'ZWBS_ITEM-IMPRF'   OR
               'LS_TABLE-POSID'    OR"'ZWBS_ITEM-POSID'   OR
               'ZWBS_ITEM-LSTAR'.
            PERFORM item_table_fc USING lv_field_tc
                                        lv_change.
          WHEN 'ZWBS_ITEM-PLSEZ'.
            ls_screen-input = 1.
            MODIFY SCREEN.
          WHEN OTHERS.
        ENDCASE.
        MODIFY SCREEN FROM ls_screen.
      ENDLOOP.
    ELSE.
      LOOP AT SCREEN.
        CASE screen-name.
          WHEN 'ZWBS_ITEM-POST1' OR
               'LS_TABLE-SELECT'.
            screen-input = 1.
            MODIFY SCREEN.
          WHEN OTHERS.
            screen-input = 0.
            MODIFY SCREEN.
        ENDCASE.
      ENDLOOP.

      LOOP AT SCREEN INTO ls_screen.
        SPLIT ls_screen-name AT '-' INTO lv_table lv_field_tc.
        CASE ls_screen-name.
          WHEN 'ZWBS_ITEM-AKSTL'   OR
               'ZWBS_ITEM-BUDGET'  OR
               'ZWBS_ITEM-AKOKR'   OR
               'ZWBS_ITEM-PGSBR'   OR
               'ZWBS_ITEM-WERKS'   OR
               'ZWBS_ITEM-PLAKZ'   OR
               'ZWBS_ITEM-PLFAZ'   OR
               'ZWBS_ITEM-PLSEZ'   OR
               'ZWBS_ITEM-ESTRT'   OR
               'ZWBS_ITEM-EENDE'   OR
               'ZWBS_ITEM-ASTNR'   OR
               'ZWBS_ITEM-VERNR'   OR
               'ZWBS_ITEM-IMPRF'   OR
               'LS_TABLE-POSID'    OR"'ZWBS_ITEM-POSID'   OR
               'ZWBS_ITEM-LSTAR'.
            PERFORM item_table_fc USING lv_field_tc
                                        lv_change.
          WHEN OTHERS.
        ENDCASE.
        MODIFY SCREEN FROM ls_screen.
      ENDLOOP.
    ENDIF.
  ENDIF.
  IF lv_change = 'CHANGE'.
    LOOP AT SCREEN.
      CASE screen-name.
        WHEN 'ZWBS_ITEM-PGSBR'.
          SELECT SINGLE objnr FROM prps INTO @DATA(lv_objnr_pgsbr)
            WHERE posid = @ls_table-pspid.
          IF sy-subrc = 0.
            SELECT SINGLE wrttp FROM rpsco INTO @DATA(lv_wrttp)
              WHERE objnr = @lv_objnr_pgsbr
               AND  wrttp = '04'.
            IF sy-subrc = 0.
              screen-input = 0.
              MODIFY SCREEN.
            ENDIF.
          ENDIF.

      ENDCASE.
    ENDLOOP.
  ENDIF.
*Highlight Changed Values for Change Project/WBS
  IF lv_type = '2' AND ls_table-zchange = 'U' AND
                 ( NOT lt_table_init IS INITIAL OR
                   NOT lt_prps       IS INITIAL ).
    CLEAR:ls_table_init,ls_prps.
    IF sy-tcode = 'ZCJ01'.
      READ TABLE lt_table_init INTO ls_table_init WITH KEY pspid =
      zwbs_item-pspid.
    ELSE.
      READ TABLE lt_prps INTO ls_prps WITH KEY posid = zwbs_item-pspid.
    ENDIF.
    LOOP AT SCREEN INTO ls_screen.
      CASE ls_screen-name.
        WHEN 'ZWBS_ITEM-POST1'           OR
             'ZWBS_ITEM-PBUKR'           OR
             'ZWBS_ITEM-PGSBR'           OR
             'ZWBS_ITEM-PRCTR'           OR
             'ZWBS_ITEM-WERKS'           OR
             'ZWBS_ITEM-ABGSL'           OR
             'ZWBS_ITEM-ZASSET'          OR
             'ZWBS_ITEM-ZREVSTR'         OR
             'ZWBS_ITEM-ZAREA'           OR
             'ZWBS_ITEM-ZSCOPCHA'        OR
             'ZWBS_ITEM-ZOPPORTUNITY_ID' OR
             'ZWBS_ITEM-ZSYNERGY_ID'     OR
             'ZWBS_ITEM-ZCUSTOM'         OR
             'ZWBS_ITEM-MTART'           OR
             'ZWBS_ITEM-Z_MATERIAL'      OR
             'ZWBS_ITEM-ZIBPEBELN'       OR
             'ZWBS_ITEM-ZFCW'            OR
             'ZWBS_ITEM-ZIPM_PR_CODE'    OR
             'ZWBS_ITEM-ZZFCST_STATUS'   OR
             'ZWBS_ITEM-ZZSERV_BUND'     OR
             'ZWBS_ITEM-ZZFREE_TEXT'     OR
             'ZWBS_ITEM-BELKZ'           OR
             'ZWBS_ITEM-FAKKZ'           OR
* Begin of changes by LCHENNA for CR 797199
             'ZWBS_ITEM-ZSTAGE_ST_DT'    OR
             'ZWBS_ITEM-ZSTAGE_END_DT'   OR
             'ZWBS_ITEM-ZREV_REC_DT'     OR
             'ZWBS_ITEM-ZPRODCAT'        OR
             'ZWBS_ITEM-ZBUSINESS_CASE'  OR
             'ZWBS_ITEM-ZLIFECYCLE_MODULE'.
* End of changes by LCHENNA for CR 797199
          CLEAR lv_field.
          lv_field = ls_screen-name+10.
          ASSIGN COMPONENT lv_field OF STRUCTURE ls_table TO <fs1>.
          IF sy-tcode = 'ZCJ01'.
            ASSIGN COMPONENT lv_field OF STRUCTURE ls_table_init TO <fs2>.
          ELSE.
            ASSIGN COMPONENT lv_field OF STRUCTURE ls_prps TO <fs2>.
          ENDIF.
          IF <fs1> IS ASSIGNED AND
             <fs2> IS ASSIGNED AND
             <fs1> NE <fs2>.
            ls_screen-intensified = 1.
          ENDIF.
          UNASSIGN:<fs1>,<fs2>.
      ENDCASE.
      MODIFY SCREEN FROM ls_screen.
    ENDLOOP.
  ENDIF.

  IF lv_type = 2.
*    CALL FUNCTION 'CONVERSION_EXIT_ABPSN_OUTPUT'
*      EXPORTING
*        input  = ls_table-pspid
*      IMPORTING
*        output = lv_pspid_itm.
*
*    CLEAR: result_tab.
*    FIND ALL OCCURRENCES OF '.'
*    IN lv_pspid_itm
*    RESULTS result_tab.
*
*    SORT result_tab BY offset DESCENDING.
*    CLEAR: ls_res_tab.
*    READ TABLE result_tab INTO ls_res_tab INDEX 1.
*    IF sy-subrc = 0.
*      CALL FUNCTION 'CONVERSION_EXIT_ABPSN_INPUT'
*        EXPORTING
*          input  = lv_pspid_itm+0(ls_res_tab-offset)
*        IMPORTING
*          output = lv_pspid_itm.

    CLEAR: lv_objnr1.
    SELECT SINGLE objnr FROM prps INTO @lv_objnr1
   WHERE posid =  @ls_table-pspid. "lv_pspid_itm. "@lv_pspid+0(lv_pspid_len).
    IF sy-subrc = 0.
      CLEAR: ls_jest.
      SELECT SINGLE * FROM jest INTO @ls_jest
         WHERE objnr = @lv_objnr1
          AND  stat  = 'I0046'
          AND  inact = @space.
      IF sy-subrc = 0.
        LOOP AT SCREEN.
          screen-input = 0.
          MODIFY SCREEN.
        ENDLOOP.
        LOOP AT SCREEN.
          CASE screen-name.
            WHEN 'LS_TABLE-SELECT'.
              screen-input = 1.
              MODIFY SCREEN.
          ENDCASE.
        ENDLOOP.
      ENDIF.
    ENDIF.
  ENDIF.
*  ENDIF.

ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  STATUS_0900  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE status_0900 OUTPUT.

  DATA: lt_table5 TYPE STANDARD TABLE OF ts_table,
        lt_table4 TYPE STANDARD TABLE OF ts_table,
        lt_table3 TYPE STANDARD TABLE OF ts_table,
        lt_table2 TYPE STANDARD TABLE OF ts_table,
        lt_table1 TYPE STANDARD TABLE OF ts_table.

*   DATA: lv_pspid_len5 TYPE numc2.
*   DATA: lv_pspid_len4 TYPE numc2.
*   DATA: lv_pspid_len3 TYPE numc2.
*   DATA: lv_pspid_len2 TYPE numc2.
*   DATA: lv_pspid_len1 TYPE numc2.
  "DATA: lv_pspid_len_eende TYPE numc2.

*  SET PF-STATUS 'xxxxxxxx'.
*  SET TITLEBAR 'xxx'.

  LOOP AT SCREEN.
    CASE screen-name.
      WHEN 'ZWBS_ITEM-REQUEST'.
        screen-invisible = 1.
        MODIFY SCREEN.
    ENDCASE.
  ENDLOOP.
  CASE sy-tcode.
    WHEN 'ZCJ01'.
      IF zwbs_header-type = 1.
        LOOP AT SCREEN.
          CASE screen-name.
            WHEN 'TC_WBS_INSERT'   OR
                 'TC_WBS_DELETE'   OR
                 'TC_WBS_MARK'     OR
                 'TC_WBS_DEMARK'.
              screen-active = 0.
              MODIFY SCREEN.
          ENDCASE.
        ENDLOOP.
*      ELSEIF zwbs_header-type = 2.
*        IF lv_insr_flag = ' '.
*          LOOP AT SCREEN.
*            CASE screen-name.
*              WHEN 'ZWBS_ITEM-PLSEZ' OR
*                   'ZWBS_ITEM-PLFAZ'.
*                screen-input = 0.
*                MODIFY SCREEN.
*            ENDCASE.
*          ENDLOOP.
*        ENDIF.
      ENDIF.
    WHEN 'ZCJ03'.
      LOOP AT SCREEN.
        CASE screen-name.
          WHEN 'TC_WBS_INSERT'   OR
               'TC_WBS_DELETE'   OR
*               'TC_WBS_TOP'      OR
*               'TC_WBS_PREVIOUS' OR
*               'TC_WBS_NEXT'     OR
*               'TC_WBS_BOTTOM'   OR
               'TC_WBS_MARK'     OR
               'TC_WBS_DEMARK'.
            screen-active = 0.
            MODIFY SCREEN.
        ENDCASE.
      ENDLOOP.
  ENDCASE.

* LOOP AT lt_table ASSIGNING FIELD-SYMBOL(<wa>).
*     IF <wa>-stufe = '5'.
*     ELSEIF <wa>-stufe = '2'.
*       DATA(lv_pspid_new2) = <wa>-pspid.
*       CALL FUNCTION 'FTR_CORR_SWIFT_DELETE_ENDZERO'
*         CHANGING
*           c_value = lv_pspid_new2.
*       lv_pspid_len_eende = strlen( lv_pspid_new2 ).
*     ENDIF.
*   ENDLOOP.
*
*   LOOP AT lt_table INTO DATA(ls_frct_2) WHERE stufe = '2'.
*     LOOP AT lt_table INTO DATA(ls_frct_3) WHERE stufe > '2'.
*       IF ls_frct_3-pspid+0(lv_pspid_len_eende) = ls_frct_2-pspid+0(lv_pspid_len_eende).
*         ls_frct_3-eende = ls_frct_2-eende.
*
*         IF ls_frct_3-eende IS NOT INITIAL.
*           MODIFY lt_table FROM ls_frct_3 TRANSPORTING eende.
*         ENDIF.
*       ENDIF.
*     ENDLOOP.
*   ENDLOOP.
ENDMODULE.
*&---------------------------------------------------------------------*
*&      Form  ITEM_TABLE_FC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LV_FIELD_TC  text
*----------------------------------------------------------------------*
FORM item_table_fc  USING    p_lv_field_tc
                             p_lv_change.

  SELECT SINGLE * FROM zwbs_cf_ctrl_tc
                INTO @DATA(ls_cf_ctrl_tc)
                WHERE fieldname = @p_lv_field_tc
                AND   levels    = @ls_table-stufe
                AND   izwek     = @ls_table-izwek
                AND   bukrs     = @ls_table-pbukr
                AND   crt_chg   = @p_lv_change.
  IF sy-subrc NE 0.
*    IF ls_cf_ctrl_tc-mandatory_flag IS NOT INITIAL.
*      ls_screen-required = 1.
*    ENDIF.
*
*    IF ls_cf_ctrl_tc-editable_flag IS NOT INITIAL.
*      ls_screen-input = 1.
*    ENDIF.
*  ELSE.
    SELECT SINGLE * FROM zwbs_cf_ctrl_tc
              INTO @ls_cf_ctrl_tc
              WHERE fieldname = @p_lv_field_tc
              AND   levels    = '*' "@space
              AND   izwek     = @ls_table-izwek
              AND   bukrs     = @ls_table-pbukr
              AND   crt_chg   = @p_lv_change.
    IF sy-subrc NE 0.
      SELECT SINGLE * FROM zwbs_cf_ctrl_tc
                    INTO @ls_cf_ctrl_tc
                    WHERE fieldname = @p_lv_field_tc
                    AND   levels    = @ls_table-stufe
                    AND   izwek     = '*' "@space
                    AND   bukrs     = @ls_table-pbukr
                    AND   crt_chg   = @p_lv_change.
      IF sy-subrc NE 0.
        SELECT SINGLE * FROM zwbs_cf_ctrl_tc
                   INTO @ls_cf_ctrl_tc
                   WHERE fieldname = @p_lv_field_tc
                   AND   levels    = @ls_table-stufe
                   AND   izwek     = @ls_table-izwek
                   AND   bukrs     = '*' "@space
                   AND   crt_chg   = @p_lv_change.
        IF sy-subrc NE 0.
          SELECT SINGLE * FROM zwbs_cf_ctrl_tc
                    INTO @ls_cf_ctrl_tc
                     WHERE fieldname = @p_lv_field_tc
                     AND   levels    = '*' "@space
                     AND   izwek     = '*' "@space
                     AND   bukrs     = '*' "@space
                     AND   crt_chg   = @p_lv_change.
          IF sy-subrc NE 0.
            SELECT SINGLE * FROM zwbs_cf_ctrl_tc
                      INTO @ls_cf_ctrl_tc
                       WHERE fieldname = @p_lv_field_tc
                       AND   levels    = '*' "@space
                       AND   izwek     = '*' "@space
                       AND   bukrs     = @ls_table-pbukr
                       AND   crt_chg   = @p_lv_change.
            IF sy-subrc NE 0.
              SELECT SINGLE * FROM zwbs_cf_ctrl_tc
                        INTO @ls_cf_ctrl_tc
                         WHERE fieldname = @p_lv_field_tc
                         AND   levels    = @ls_table-stufe
                         AND   izwek     = '*' "@space
                         AND   bukrs     = '*' "@space
                         AND   crt_chg   = @p_lv_change.

              IF sy-subrc NE 0.
                SELECT SINGLE * FROM zwbs_cf_ctrl_tc
                          INTO @ls_cf_ctrl_tc
                          WHERE fieldname = @p_lv_field_tc
                         AND   levels    = @ls_table-stufe
                         AND   izwek     = '*' "@space
                         AND   bukrs     = @ls_table-pbukr
                         AND   crt_chg   = @p_lv_change.
                IF sy-subrc NE 0.
                  SELECT SINGLE * FROM zwbs_cf_ctrl_tc
                          INTO @ls_cf_ctrl_tc
                        WHERE fieldname = @p_lv_field_tc
                  AND   levels    = '*' "@ls_table-stufe
                  AND   izwek     =  @ls_table-izwek
                  AND   bukrs     = '*' "@ls_table-pbukr
                  AND   crt_chg   = @p_lv_change.
                ENDIF.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.
  IF ls_cf_ctrl_tc IS NOT INITIAL.
    IF ls_cf_ctrl_tc-mandatory_flag IS NOT INITIAL.
      "ls_screen-required = 1.
      DATA(lv_req_flag) = 'X'.
    ENDIF.

    IF ls_cf_ctrl_tc-editable_flag IS NOT INITIAL.
      ls_screen-input = 1.
    ENDIF.
    "LSEIF ls_cf_ctrl_tc-fieldname = 'LSTAR'.

  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Module  STATUS_0810  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE status_0810 OUTPUT.
  SET PF-STATUS '810'.
  SET TITLEBAR '810'.

  PERFORM create_appr_log_editor.

ENDMODULE.


*&--------------------------------------------------------------------*
*&  Include           MZWBSTOP
*&--------------------------------------------------------------------*

TYPE-POOLS vrm.

TABLES:zwbs_proj_templ,zwbs_header,zwbs_item,zwbs_material,
       zwbs_wf_control,zwbs_cf_control,zwbs_status,prps,proj,
       zwbs_proj_tem_tc.

TYPES:BEGIN OF ts_bunit,
        b_unit TYPE zzb_unit,
        bustxt TYPE zzbustxt,
        bultxt TYPE zzbultxt,
        div    TYPE zzdiv,  " Changes by AKOTA for EiCR - 729491
      END OF ts_bunit,
      BEGIN OF ts_doc_attach,
        file_desc TYPE so_obj_des,
        file_ext  TYPE so_fileext,
        file_len  TYPE i,
        file_cont TYPE soli_tab,
      END OF ts_doc_attach,
      BEGIN OF ts_project,
        pspid TYPE ps_pspid,
        post1 TYPE ps_post1,
      END OF ts_project,
      BEGIN OF ts_prj_typ,
        izwek      TYPE izwek,
        profidproj TYPE profidproj,
        profi_txt  TYPE profi_txt,
      END OF ts_prj_typ,
*Cost Center table
      BEGIN OF ts_table,
        select TYPE flag.
        INCLUDE TYPE zwbs_item.
TYPES:werks_name    TYPE name1,             "Plant Name
      box_name      TYPE zbox_name,         "Asset Box Name
      zrevstr_name  TYPE z_de_revstr_name,  "Revenue Stream Text
      zarea_name    TYPE z_de_area_name,    "Misc. Categroy Text
      zscopcha_name TYPE z_de_scopcha_name, "Status of Contract Text
      zsynergy_type TYPE zsynergy_type,     "Synergy sales Text
      kunag_name    TYPE ad_name1,          "Sold-to party Name
      maktx         TYPE maktx,             "Material Description
      long_text     TYPE flag,              "Long Text Exists
      updkz         TYPE updkz_d,           "Update Indicator
      status        TYPE flag,     "Status - Closed/Locked/Deleted
      stat_curr     TYPE j_txt04,           "WBS Current Status
      "Insert        TYPE flag,
      END OF ts_table,
      BEGIN OF ts_remarks,
        pspid TYPE ps_pspid,
        thead TYPE thead,
        tline LIKE tline OCCURS 0,
      END OF ts_remarks,
      BEGIN OF ts_text,
        text TYPE tdline,
      END OF ts_text,
      BEGIN OF ts_user,
        bname      TYPE xubname,
        name_textc TYPE ad_namtext,
      END OF ts_user,
      " Begin of Changes by AKOTA for EiCR 787082
      BEGIN OF ts_messg,
        msg_text(256) TYPE c,
      END OF ts_messg,
      " End of Changes by AKOTA for EiCR 787082
      BEGIN OF ts_type_text,
        ddtext     TYPE val_text,
        domvalue_l TYPE domvalue_l,
      END OF ts_type_text.

DATA:lt_wbs_header       TYPE STANDARD TABLE OF zwbs_header,
     lt_wbs_item         TYPE STANDARD TABLE OF zwbs_item,
     lt_wbs_budget       TYPE STANDARD TABLE OF zwbs_item,
     lt_wbs_item_db      TYPE STANDARD TABLE OF zwbs_item,
     lt_zwbs_status      TYPE STANDARD TABLE OF zwbs_status,
     lt_bunit            TYPE STANDARD TABLE OF ts_bunit,
     lt_project          TYPE STANDARD TABLE OF ts_project,
     lt_proj             TYPE STANDARD TABLE OF proj,
     lt_prps             TYPE STANDARD TABLE OF prps,
     lt_prte             TYPE STANDARD TABLE OF prte, "LCHENNA CR 797199
     " Changes by AKOTA for EiCR 787082
     lt_messg            TYPE STANDARD TABLE OF ts_messg,
     lt_table            TYPE STANDARD TABLE OF ts_table,
     lt_table_bp         TYPE STANDARD TABLE OF zwbs_item,
     lt_table_dl         TYPE STANDARD TABLE OF ts_table,
     lt_table_init       TYPE STANDARD TABLE OF ts_table,
     lt_remarks          TYPE STANDARD TABLE OF ts_remarks,
     lt_user             TYPE STANDARD TABLE OF ts_user,
     lt_type_text        TYPE STANDARD TABLE OF ts_type_text,
     lt_t9m49            TYPE STANDARD TABLE OF t9m49,
     lt_fcode            TYPE STANDARD TABLE OF sy-ucomm,
     lt_return           TYPE STANDARD TABLE OF bapiret2,
     lt_treturn          TYPE STANDARD TABLE OF bapiret2,
     ls_return           TYPE bapiret2,
     lt_list_bunit       TYPE vrm_values,
     lt_ip               TYPE vrm_values,
     ls_ip               LIKE LINE OF lt_ip,
     lt_proj_list        TYPE vrm_values,
     ls_list_bunit       LIKE LINE OF lt_list_bunit,
     ls_list_bunit1      LIKE LINE OF lt_list_bunit,
     lt_list_bunit_tc    TYPE STANDARD TABLE OF ts_prj_typ, "vrm_values,
     lt_list             TYPE vrm_values,
     ls_head             TYPE zwbs_header,
     ls_head_db          TYPE zwbs_header,
     ls_head_init        TYPE zwbs_header,
     ls_item             TYPE zwbs_item,
     ls_item_db          TYPE zwbs_item,
     ls_wf_control       TYPE zwbs_wf_control,
     ls_cf_control       TYPE zwbs_cf_control,
     ls_zwbs_status      TYPE zwbs_status,
     ls_proj_templ       TYPE zwbs_proj_templ,
     ls_list             LIKE LINE OF lt_list,
     ls_project          TYPE ts_project,
     ls_table            TYPE ts_table,
     ls_table_bp         TYPE zwbs_item,
     ls_temp             TYPE ts_table,
     ls_default          TYPE ts_table,
     ls_table_init       TYPE ts_table,
     ls_remarks          TYPE ts_remarks,
     ls_type_text        TYPE ts_type_text,
     ls_user             TYPE ts_user,
     ls_proj             TYPE proj,
     ls_prps             TYPE prps,
     ls_prte             TYPE prte, "LCHENNA CR 797199
     ls_t9m49            TYPE t9m49,
     lv_sline            TYPE syst_stepl,
     lv_id               TYPE vrm_id,
     lv_error            TYPE flag,
     lv_cerror           TYPE flag,
     lv_verror           TYPE flag,
     lv_raerror          TYPE flag,
     lv_herror           TYPE flag,
     lv_cflag            TYPE flag,
     lv_ucflag           TYPE flag,
     lv_dflag            TYPE flag,
     lv_oflag            TYPE flag,  "Open Request Exists Already
     lv_sflag            TYPE flag,
     lv_rflag            TYPE flag,
     lv_wf_flag          TYPE flag,
     lv_ag_flag          TYPE flag,
     lv_grp_flag         TYPE flag,
     lv_agrp_flag        TYPE flag,
     lv_rakey_flag       TYPE flag,
     lv_wbs_rakey_flag   TYPE flag,
     lv_grp_allowed      TYPE flag,
     lv_wf_pos_flag      TYPE flag,
     lv_pcba_flag        TYPE flag,
     lv_pcasset_flag     TYPE flag,
     lv_level_flag       TYPE flag,
     lv_init_run         TYPE flag,
     lv_cf_control       TYPE flag,
     lv_cf_control_capex TYPE flag,
     lv_wbs_app_call     TYPE flag,
     lv_abgsl            TYPE zvalue1,
     lv_cond             TYPE string,
     lv_cvalue           TYPE string,
     lv_cursor           TYPE feldname,
     lv_text             TYPE string,
     lv_status           TYPE string,
     lv_no_budget        TYPE flag,
     lv_zibpflag         TYPE prps-zibpflag,
     " Changes by AKOTA EiCR 729491
     lv_wf_status        TYPE char1,
     lv_tline            TYPE i,
     lv_url              TYPE char512,
     lv_answer           TYPE char1,
     lv_req_type         TYPE ktext,
     lv_stat             TYPE zzstatustext,
     lv_fname            TYPE ad_namefir,
     lv_lname            TYPE ad_namelas,
     lv_fullname         TYPE ad_namtext,
     lv_department       TYPE ad_dprtmnt,
     lv_location         TYPE ad_city1,
     lv_prctr            TYPE char4,
     lv_objnr            TYPE j_objnr,
     lv_loevm            TYPE kna1-loevm,
     ""* Changes by AKOTA for CR 668561
     lv_flag             TYPE flag,
     ""* Changes by AKOTA for CR 668561
     lv_messg            TYPE string,
     ""* Changes by AKOTA for CR 668561
     repid               LIKE sy-repid,
     gv_capex            TYPE flag,
     lv_akstl            TYPE zwbs_item-akstl.

DATA:lt_lines   TYPE STANDARD TABLE OF tline,
     ls_lines   TYPE tline,
     ls_header  TYPE thead,
     ls_result  TYPE itcer,
     ls_stxh    TYPE stxh,
     lv_tdname  TYPE tdobname,
     lv_lines   TYPE i,
     lv_rlines  TYPE i,
     lv_rrlines TYPE i,
     lv_mode    TYPE flag,
     lv_rmode   TYPE i.

DATA:lo_proj_tree    TYPE REF TO cl_gui_column_tree,
     lo_html_control TYPE REF TO cl_gui_html_viewer,
     lo_cont_proj    TYPE REF TO cl_gui_custom_container,
     lo_cont_html    TYPE REF TO cl_gui_custom_container,
     lv_bukrs        TYPE bukrs,
     lv_bunit        TYPE zzb_unit,
     lv_profid       TYPE profidproj,
     lv_ir           TYPE char20, "izwek,
     lv_vbukr        TYPE bukrs, " Changes by AKOTA for EiCR-766523
     lv_werks        TYPE werks_d,
     lv_lonzacode    TYPE z_de_prodcod,
     lv_template     TYPE ps_pspid,
     lv_project      TYPE ps_pspid,
     lv_project_new  TYPE ps_pspid,
     lv_project_int  TYPE ps_pspid,
     lv_project_st   TYPE ps_pspid,
     lv_project_str  TYPE string,
     lv_offset       TYPE i,
     lv_rb1          TYPE char1 VALUE 'X',
     lv_rb2          TYPE char1,
     lv_rb3          TYPE char1,
     lv_rb4          TYPE char1,
     lv_rb5          TYPE char1,
     lv_proj_create  TYPE char1,
     lv_wbs_create   TYPE char1,
     lv_wbs_change   TYPE char1,
*     lv_proj1        TYPE char1 VALUE 'X',
*     lv_proj2        TYPE char1,
*     lv_proj3        TYPE char1,
     lv_proj3_type   TYPE char3,
     lv_proj_type    TYPE zzproj_type VALUE 'CZ',
     lv_type         TYPE zzwbs_type,
     ok_code         TYPE syst_ucomm,
     gv_posnr        TYPE impr-posnr.

DATA:lt_items      TYPE cnpb_h_t_rsthie,
     ls_rcwbs      TYPE rcwbs,
     est_proj_mand TYPE cnpb_h_st_proj_mandatory_flds,
     est_prps_mand TYPE cnpb_h_st_prps_mandatory_flds,
     lt_prps_mand  TYPE STANDARD TABLE OF cnpb_h_prps_mandatory_fields.

DATA:lt_treeitm_u            TYPE cnpb_h_t_treeitm_upd,
     lt_treev_node_u         TYPE treev_upno,
     ls_hierarchy_header     TYPE treev_hhdr,
     gt_treeitm              TYPE cnpb_h_t_treeitm,
     gt_treev_node           TYPE cnpb_h_t_treev_node,
     gs_objects_in_tree      TYPE cnpb_h_objects_in_hierarchy,
     ls_objects_in_hierarchy TYPE cnpb_h_objects_in_hierarchy,
     lv_enqueue              TYPE char1,
     lv_drag_drop_handle     TYPE cnpb_h_drag_drop_handle,
     lv_hier_col_is_key      TYPE c.

DATA:lo_editor   TYPE REF TO c_textedit_control,
     lo_clog     TYPE REF TO c_textedit_control,
     lo_alog     TYPE REF TO c_textedit_control,
     lo_rtext    TYPE REF TO c_textedit_control,
     lt_text     TYPE STANDARD TABLE OF ts_text,
     lt_rtext    TYPE STANDARD TABLE OF ts_text,
     gt_log      TYPE STANDARD TABLE OF ts_text,
     gt_rtext    TYPE STANDARD TABLE OF ts_text,
     lt_log      TYPE STANDARD TABLE OF ts_text,
     lt_tlog     TYPE STANDARD TABLE OF ts_text,
     gt_appr_log TYPE STANDARD TABLE OF ts_text,
     ls_text     TYPE ts_text,
     ls_log      TYPE ts_text,
     gs_appr_log TYPE ts_text.

DATA:ls_project_new     TYPE bapi_bus2001_new,
     ls_project_def     TYPE bapi_bus2001_chg,
     ls_project_def_upd TYPE bapi_bus2001_upd,
     lt_methods         TYPE STANDARD TABLE OF bapi_method_project,
     ls_methods         TYPE bapi_method_project,
     lt_wbs_element     TYPE STANDARD TABLE OF bapi_bus2054_chg,
     lt_wbs_celement    TYPE STANDARD TABLE OF bapi_bus2054_new,
     lt_wbs_element_upd TYPE STANDARD TABLE OF bapi_bus2054_upd,
     lt_extensionin     TYPE STANDARD TABLE OF bapiparex,
     lt_cextensionin    TYPE STANDARD TABLE OF bapiparex,
     lt_wbs_elements    TYPE STANDARD TABLE OF bapi_wbs_elements,
     lt_wbs_status      TYPE STANDARD TABLE OF bapi_wbs_system_status,
     ls_wbs_celement    TYPE bapi_bus2054_new,
     ls_wbs_element     TYPE bapi_bus2054_chg,
     ls_wbs_element_upd TYPE bapi_bus2054_upd,
     ls_extensionin     TYPE bapiparex.

*Set WBS Status for Close/Unclose
DATA:lt_wbs_stat TYPE STANDARD TABLE OF bapi_wbs_mnt_system_status,
     lt_ret      TYPE STANDARD TABLE OF bapiret2,
     ls_wbs_stat TYPE bapi_wbs_mnt_system_status,
     ls_ret      TYPE bapireturn1.

*ALV Declarations
TYPE-POOLS slis.

DATA:lt_fieldcat TYPE slis_t_fieldcat_alv,
     ls_layout   TYPE slis_layout_alv.

DATA:BEGIN OF lt_output OCCURS 0,
       request        LIKE zwbs_header-request,
       pspid          LIKE zwbs_header-pspid,
       post1          LIKE zwbs_header-post1,
       proj_type      LIKE zwbs_header-proj_type,
       type           LIKE zwbs_header-type,
       zmaint_sys_h   LIKE zwbs_header-zmaint_sys,
       type_text      LIKE tkt05-ktext,       "Request Type
       status         LIKE zwbs_header-status,
       status_text    LIKE t9m49-text,
       izwek          LIKE zwbs_header-izwek,

       created_by     LIKE zwbs_header-created_by,
       created_name   LIKE adrp-name_text,    "Requester Name
       created_on     LIKE zwbs_header-created_on,
       complete_by    LIKE zkostk-created_by, "Completed by
       complete_name  LIKE adrp-name_text,    "Completed by Name
       complete_on    LIKE qmel-qmdab,        "Completion date
       turntime       LIKE ps2012-anzhl,      "Turnaround

       stufe          LIKE zwbs_item-stufe,
       pspid_wbs      LIKE zwbs_item-pspid_new,
       post1_wbs      LIKE zwbs_item-post1,
       pbukr          LIKE zwbs_item-pbukr,
       pgsbr          LIKE zwbs_item-pgsbr,
       prctr          LIKE zwbs_item-prctr,

       zprj_code_pv   LIKE zwbs_header-zprj_code_pv,
       zstate_code_pv LIKE zwbs_item-zstate_code_pv,
       zmaint_sys     LIKE zwbs_item-zmaint_sys,
     END OF lt_output.
*Workflow Details
DATA:lt_sww_wi2obj   TYPE STANDARD TABLE OF sww_wi2obj,
     lt_swpsteplog   TYPE STANDARD TABLE OF swpsteplog,
     lt_swwwihead    TYPE STANDARD TABLE OF swwwihead,
     lt_sww_wi2obj_c TYPE STANDARD TABLE OF sww_wi2obj,
     lt_swpsteplog_c TYPE STANDARD TABLE OF swpsteplog,
     lt_swwwihead_c  TYPE STANDARD TABLE OF swwwihead,
     ls_output       LIKE LINE OF lt_output,
     ls_sww_wi2obj   TYPE sww_wi2obj,
     ls_swpsteplog   TYPE swpsteplog,
     ls_swwwihead    TYPE swwwihead,
     lv_sdate        TYPE datum,
     lv_stime        TYPE uzeit,
     lv_cdate        TYPE datum,
     lv_ctime        TYPE uzeit,
     lv_timestamp    TYPE tzntstmps,
     lv_timestamps   TYPE string,
     lv_seconds      TYPE sytabix,
     lv_index1       TYPE sytabix,
     lv_index2       TYPE sytabix,
     lv_maint_sys    TYPE zmaint_sys.

FIELD-SYMBOLS:<fs_table>   TYPE ts_table,
              <fs_remarks> TYPE ts_remarks.

*GOS Services
DATA:lo_gos     TYPE REF TO cl_gos_manager,
     lv_rw_mode TYPE sgs_rwmod.

CONSTANTS:
  lc_hierarchy_short_text    TYPE tv_itmname VALUE '          1',
  lc_hierarchy_technical_key TYPE tv_itmname VALUE 'TECH_KEY',
  lc_hier_col_txt            TYPE cnpb_hierarchy_column VALUE '1',
  lc_hier_col_key            TYPE cnpb_hierarchy_column VALUE '2',
  lc_false                   TYPE i         VALUE 0,
  lc_true                    TYPE i         VALUE 1,
  lc_object                  TYPE tdobject  VALUE 'Z_WBS_REQ',
  lc_rem_id                  TYPE tdid      VALUE 'ZREM',
  lc_com_id                  TYPE tdid      VALUE 'ZCOM',
  lc_log_id                  TYPE tdid      VALUE 'ZLOG',
  lc_spras                   TYPE spras     VALUE 'E',
  lc_submit                  TYPE swo_event VALUE 'SUBMITTED'.

*&SPWIZARD: DECLARATION OF TABLECONTROL 'TC_WBS' ITSELF
CONTROLS: tc_wbs TYPE TABLEVIEW USING SCREEN 0500.

*&SPWIZARD: LINES OF TABLECONTROL 'TC_WBS'
DATA:     g_tc_wbs_lines  LIKE sy-loopc.

DATA: gv_at_capex_approver_step   TYPE swp_agent,
      gv_capex_approver_step      TYPE flag,
      gv_at_pm_approver_step      TYPE swp_agent,
      gv_pm_approver_step         TYPE flag,
      gv_at_co_approver_step      TYPE swp_agent,
      gv_co_approver_step         TYPE flag,
      gv_at_r2r_acc_approver_step TYPE swp_agent,
      gv_at_r2r_sr_approver_step  TYPE swp_agent,
      gv_r2r_approver_step        TYPE flag,
      gv_approver_step            TYPE flag,
      gv_auto_approver_step       TYPE flag,
      gv_auto_approver_step_error TYPE flag,
* Begin of change by LCHENNA for CR 797199
      gv_err_mail_flag            TYPE flag,
* End of changes by LCHENNA for CR 797199
      gv_pm_app_response          TYPE flag,
      gv_capex_app_response       TYPE flag,
      gv_co_app_response          TYPE flag,
      gv_mdm_app_response         TYPE flag,
      gv_r2r_acc_app_response     TYPE flag,
      gv_r2r_sr_app_response      TYPE flag.

* data for call of transaction Z_WF_LIST
DATA: lt_rspar       TYPE STANDARD TABLE OF rsparams,
      ls_rspar       TYPE rsparams,
      lc_memory_id_5 TYPE char20 VALUE 'ZCJ04_SELECTION'.

DATA: gv_screen TYPE sydynnr.

*&SPWIZARD: TYPE FOR THE DATA OF TABLECONTROL 'TC_CAPEX'
TYPES: BEGIN OF t_tc_capex,
         select    LIKE ls_table-select,
         pspid_new LIKE zwbs_item-pspid_new,
         stufe     LIKE zwbs_item-stufe,
         post1     LIKE zwbs_item-post1,
         akstl     LIKE zwbs_item-akstl,
         akokr     LIKE zwbs_item-akokr,
         werks     LIKE zwbs_item-werks,
         budget    LIKE zwbs_item-budget,
         belkz     LIKE zwbs_item-belkz,
         plakz     LIKE zwbs_item-plakz,
         plfaz     LIKE zwbs_item-plfaz,
         plsez     LIKE zwbs_item-plsez,
         astna     LIKE zwbs_item-astna,
         verna     LIKE zwbs_item-verna,
         imprf     LIKE zwbs_item-imprf,
       END OF t_tc_capex.

*&SPWIZARD: INTERNAL TABLE FOR TABLECONTROL 'TC_CAPEX'
DATA:     g_tc_capex_itab TYPE t_tc_capex OCCURS 0,
          g_tc_capex_wa   TYPE t_tc_capex. "work area
DATA:     g_tc_capex_copied.           "copy flag

*&SPWIZARD: DECLARATION OF TABLECONTROL 'TC_CAPEX' ITSELF
CONTROLS: tc_capex TYPE TABLEVIEW USING SCREEN 0900.

DATA:     g_tc_capex_lines  LIKE sy-loopc.


DATA:lv_vernr        TYPE xubname,
     lv_astnr        TYPE xubname,
     lv_vgsbr        TYPE zwbs_header-vgsbr,
     lv_plsez        TYPE zwbs_header-plsez,
     lv_end_date     TYPE ps_plsez,
     gv_error_email  TYPE flag,
     lv_insr_flag    TYPE flag,
     lv_insr_flag_up TYPE flag.

TYPES:BEGIN OF ts_kostl,
        kostl TYPE kostl,
        ktext TYPE ktext,
      END OF ts_kostl.

DATA:lt_kostl TYPE STANDARD TABLE OF ts_kostl.
DATA:ls_kostl TYPE  ts_kostl.

DATA: lv_msg_clsd_wbs TYPE char80.
DATA: lv_msg_miss_wbs TYPE char80.
DATA: lv_msg_diff_wbs TYPE char80.
DATA: lv_msg_curr TYPE char80.



*&--------------------------------------------------------------------*
*& Module Pool       SAPMZWBS
*&--------------------------------------------------------------------*

PROGRAM sapmzwbs.

INCLUDE mzwbstop.

SELECTION-SCREEN:BEGIN OF BLOCK b2 WITH FRAME TITLE text-006.
SELECT-OPTIONS:s_req    FOR zwbs_header-request,
               s_type   FOR zwbs_header-type,
               s_prjtyp FOR zwbs_header-proj_type,
               s_status FOR zwbs_header-status,
               s_stufe  FOR zwbs_item-stufe DEFAULT '1',
               s_crton  FOR zwbs_header-created_on,
               s_prdon  FOR zwbs_header-created_on,
               s_vbukr  FOR zwbs_header-vbukr,
               s_prctr  FOR zwbs_header-prctr,
               s_werks  FOR zwbs_header-werks,
               s_code   FOR zwbs_header-zprodcod,
               s_pgman  FOR zwbs_header-zprgman,
               s_pspid  FOR zwbs_header-pspid,
               s_prjcod FOR zwbs_header-zprj_code_pv,
               s_msys   FOR zwbs_item-zmaint_sys,
               s_izwek  FOR zwbs_header-izwek,
               s_crt_by FOR zwbs_header-created_by.
SELECTION-SCREEN:END OF BLOCK b2.

INCLUDE mzwbso01.
INCLUDE mzwbsi01.
INCLUDE mzwbsf01.

START-OF-SELECTION.
  PERFORM get_report_data.

END-OF-SELECTION.
  IF NOT lt_output[] IS INITIAL.
    PERFORM display_data.
  ELSE.
    MESSAGE 'No Data for the above selection' TYPE 'I'.
  ENDIF.

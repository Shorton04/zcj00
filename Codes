METHOD assign_plan_values.
  " FDS Para 302: Assign plan values (reference CJ40)
  " CORRECTED: No GJAHR field in BPGE - use VERSN instead

  DATA: ls_wbs    TYPE ztb_a2r_wbsitem,
        lv_objnr  TYPE j_objnr,
        ls_bpge   TYPE bpge.

  rv_success = abap_false.

  LOOP AT it_wbs_items INTO ls_wbs.

    " Skip WBS without budget
    IF ls_wbs-wert2 IS INITIAL.
      CONTINUE.
    ENDIF.

    " Get WBS object number
    SELECT SINGLE objnr FROM prps
      INTO lv_objnr
      WHERE posid = ls_wbs-posid.

    IF sy-subrc <> 0.
      CONTINUE.
    ENDIF.

    " Check if plan record exists
    " CORRECTED: No GJAHR field! Use VERSN = '0' and OBJNR only
    SELECT SINGLE * FROM bpge INTO ls_bpge
      WHERE objnr = lv_objnr
        AND versn = '0'
        AND wrttp = '01'.        " Plan value type

    IF sy-subrc = 0.
      " Update existing plan
      UPDATE bpge
        SET wtges = ls_wbs-wert2,
            wlges = ls_wbs-wert2
        WHERE objnr = lv_objnr
          AND versn = '0'
          AND wrttp = '01'.
    ELSE.
      " Create new plan record
      CLEAR ls_bpge.
      ls_bpge-mandt = sy-mandt.
      ls_bpge-lednr = '0000'.           " Standard ledger
      ls_bpge-objnr = lv_objnr.
      ls_bpge-posit = '00000000'.       " No commitment item
      ls_bpge-wrttp = '01'.             " Plan values
      ls_bpge-versn = '0'.              " Version 0
      ls_bpge-iwaer = ls_wbs-waers.     " Currency
      ls_bpge-wtges = ls_wbs-wert2.     " Total value
      ls_bpge-wlges = ls_wbs-wert2.     " Overall value
      
      INSERT bpge FROM ls_bpge.
    ENDIF.

    IF sy-subrc <> 0.
      rv_success = abap_false.
      RETURN.
    ENDIF.

  ENDLOOP.

  COMMIT WORK AND WAIT.
  rv_success = abap_true.

ENDMETHOD.





METHOD distribute_im_budget.
  " FDS Para 303: Distribute budget from IM to Level 1 WBS (reference IM52)

  DATA: lv_im_objnr      TYPE j_objnr,
        lv_wbs_objnr     TYPE j_objnr,
        ls_wbs_level1    TYPE ztb_a2r_wbsitem,
        lv_budget_amount TYPE wtgbtr.

  rv_success = abap_false.

  " Find Level 1 WBS
  LOOP AT it_wbs_items INTO ls_wbs_level1.
    IF ls_wbs_level1-stufe = 1.
      EXIT.
    ENDIF.
  ENDLOOP.

  IF ls_wbs_level1 IS INITIAL.
    RETURN.
  ENDIF.

  " Get IM object number
  SELECT SINGLE objnr FROM impr
    INTO lv_im_objnr
    WHERE posnr = is_header-posnr.

  IF sy-subrc <> 0.
    RETURN.
  ENDIF.

  " Get WBS object number
  SELECT SINGLE objnr FROM prps
    INTO lv_wbs_objnr
    WHERE posid = ls_wbs_level1-posid.

  IF sy-subrc <> 0.
    RETURN.
  ENDIF.

  lv_budget_amount = ls_wbs_level1-wert2.

  " Check WBS assignment (FDS Para 181)
  IF check_wbs_im_assignment(
    iv_posnr = is_header-posnr
    iv_posid = ls_wbs_level1-posid
  ) = abap_false.
    MESSAGE e030(zcj00). " WBS not assigned to IM
    RETURN.
  ENDIF.

  " Check budget availability (FDS Para 182)
  IF check_im_budget_availability(
    iv_posnr  = is_header-posnr
    iv_amount = lv_budget_amount
  ) = abap_false.
    MESSAGE e022(zcj00). " Budget exceeds available
    RETURN.
  ENDIF.

  " Distribute budget (update BPGE table directly - simulates IM52)
  " CORRECTED: No GJAHR field!
  UPDATE bpge
    SET wtgev = wtgev + lv_budget_amount
    WHERE objnr = lv_wbs_objnr
      AND versn = '0'
      AND wrttp = '01'.

  IF sy-subrc = 0.
    COMMIT WORK AND WAIT.
    rv_success = abap_true.
  ELSE.
    rv_success = abap_false.
  ENDIF.

ENDMETHOD.




METHOD check_im_budget_availability.
  " FDS Para 182: Alternative implementation for IM_AVAILABILITY_CHECK
  " CORRECTED: No GJAHR in BPGE

  DATA: lv_objnr    TYPE j_objnr,
        lv_plan     TYPE wtgbtr,
        lv_actual   TYPE wtgbtr,
        lv_assigned TYPE wtgbtr,
        lv_avail    TYPE wtgbtr.

  rv_ok = abap_false.

  " Get IM object number
  SELECT SINGLE objnr FROM impr
    INTO lv_objnr
    WHERE posnr = iv_posnr.

  IF sy-subrc <> 0.
    RETURN.
  ENDIF.

  " Get planned budget from BPGE (NO GJAHR!)
  SELECT SINGLE wtges FROM bpge
    INTO lv_plan
    WHERE objnr = lv_objnr
      AND versn = '0'
      AND wrttp = '01'.

  IF sy-subrc <> 0.
    lv_plan = 0.
  ENDIF.

  " Get actual expenditure from BPJA (BPJA has GJAHR, but we need current year)
  SELECT SUM( wtjhr ) FROM bpja
    INTO lv_actual
    WHERE objnr = lv_objnr
      AND gjahr = sy-datum(4).

  IF sy-subrc <> 0.
    lv_actual = 0.
  ENDIF.

  " Get already assigned budget to WBS elements (NO GJAHR!)
  SELECT SUM( b~wtgev ) FROM prhi AS p
    INNER JOIN bpge AS b ON p~down = b~objnr
    INTO lv_assigned
    WHERE p~up = lv_objnr
      AND b~versn = '0'
      AND b~wrttp = '01'.

  IF sy-subrc <> 0.
    lv_assigned = 0.
  ENDIF.

  " Calculate available budget
  lv_avail = lv_plan - lv_actual - lv_assigned.

  " Check if requested amount is available
  IF lv_avail >= iv_amount.
    rv_ok = abap_true.
  ELSE.
    rv_ok = abap_false.
  ENDIF.

ENDMETHOD.





a